<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ä¿ä¿®å» ç«¯ - æ–½å·¥æ ¸éŠ·ç³»çµ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #222; color: #fff; margin: 0; padding: 20px; text-align: center; }
    .card { background: #333; padding: 20px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
    .btn { background: #FF9800; color: #000; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer;}
  </style>
</head>
<body>
  <h2 style="color:#FF9800;">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» æ¥å–®æ ¸éŠ·ç³»çµ±</h2>
  <div id="login-box">
    <p>è«‹è¼¸å…¥æ‚¨çš„ä¿ä¿®å» å°ˆå±¬æˆæ¬Šç¢¼ (ID)</p>
    <input type="number" id="garage-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: 1)" style="width:100%; padding:15px; font-size:18px; box-sizing:border-box; border-radius:8px; margin-bottom:15px;">
    <button class="btn" onclick="login()">ç™»å…¥ç³»çµ±</button>
  </div>
  <div id="dashboard" style="display:none;">
    <h3 id="garage-name"></h3>
    <hr style="border-color:#444; margin-bottom:20px;">
    <h4>å¾…è™•ç†çš„é ç´„å–®</h4>
    <div id="booking-list"></div>
  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let gid = null;

    async function login() {
        gid = document.getElementById('garage-id').value;
        const { data } = await supabaseClient.from('garages').select('*').eq('id', gid).maybeSingle();
        if(data) {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('garage-name').innerText = `åº—åï¼š${data.name}`;
            loadBookings();
        } else alert("æŸ¥ç„¡æ­¤ä¿ä¿®å» ï¼");
    }

    async function loadBookings() {
        const { data } = await supabaseClient.from('bookings').select('*, users(name, car_brand, license_plate)').eq('garage_id', gid).eq('status', 'pending');
        let html = '';
        if(data) data.forEach(b => {
            html += `<div class="card">
                <b>è»Šä¸»ï¼š${b.users.name}</b><br>è»Šæ¬¾ï¼š${b.users.car_brand} (${b.users.license_plate})<br>é ç´„æ—¥ï¼š${b.book_date}
                <button class="btn" style="background:#00e676;" onclick="completeBooking(${b.id}, '${b.user_uid}')">âœ… ç¢ºèªæ–½å·¥å®Œç•¢</button>
            </div>`;
        });
        document.getElementById('booking-list').innerHTML = html || 'ç›®å‰ç„¡é ç´„';
    }

    async function completeBooking(bid, uid) {
        if(confirm("ç¢ºå®šè»Šè¼›å·²å®Œå·¥ä¸¦æ›´æ›æ¿¾ç¶²ï¼Ÿ")) {
            await supabaseClient.from('bookings').update({status: 'completed'}).eq('id', bid);
            // å¯«å…¥æ–½å·¥è²» 100 é»çµ¦ä¿ä¿®å» 
            await supabaseClient.from('rewards').insert([{ user_uid: uid, type: 'garage_install', points: 100, status: 'completed', details: `å» ç«¯æ–½å·¥è²» (å–®è™Ÿ:${bid})` }]);
            alert("çµå–®æˆåŠŸï¼æ–½å·¥çå‹µé‡‘å·²å…¥å¸³ã€‚"); loadBookings();
        }
    }
  </script>
</body>
</html>
