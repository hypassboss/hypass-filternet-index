<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¿¾è¯ç¶² - å» é•·æ¥å–®æ¨¡æ“¬å™¨ V2.2</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; background: #121212; color: #fff; padding: 20px; max-width: 600px; margin: 0 auto; }
    h2 { color: #FF9800; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .card { background: #1e1e1e; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
    select { width: 100%; padding: 12px; margin-bottom: 20px; background: #000; color: #00D100; border: 1px solid #444; border-radius: 8px; font-size: 16px; font-weight: bold; }
    .btn { padding: 10px 15px; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; font-size: 14px; }
    .btn-confirm { background: #FF9800; color: #fff; }
    .btn-complete { background: #00D100; color: #000; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ”§ å» é•·æ¥å–®æ¨¡æ“¬å™¨ (V2.2 å«è»Šä¸»è©•é‘‘)</h2>
  <label style="color:#888; font-size:14px;">è«‹é¸æ“‡æ‚¨è¦æ¨¡æ“¬çš„ä¿ä¿®å» ï¼š</label>
  <select id="garage-select" onchange="loadOrders()">
    <option value="">-- è®€å–åº—å®¶ä¸­ --</option>
  </select>

  <div id="orders-container"><p style="color:#888;">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡åº—å®¶</p></div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    async function initSimulator() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active');
      const select = document.getElementById('garage-select');
      if (data && data.length > 0) {
        select.innerHTML = '<option value="">-- é¸æ“‡æ¨¡æ“¬ä¿ä¿®å»  --</option>';
        data.forEach(g => select.innerHTML += `<option value="${g.id}">${g.name}</option>`);
      }
    }

    async function loadOrders() {
      const gId = document.getElementById('garage-select').value;
      const container = document.getElementById('orders-container');
      if (!gId) { container.innerHTML = '<p style="color:#888;">è«‹é¸æ“‡åº—å®¶</p>'; return; }
      
      container.innerHTML = '<p style="color:#888;">è®€å–ä¸­...</p>';
      const { data } = await supabaseClient.from('appointments').select('*, users(name, license_plate, phone, car_brand, car_model, city)').eq('garage_id', gId).order('appointment_time', { ascending: true });

      if (!data || data.length === 0) { container.innerHTML = '<div class="card"><p style="color:#888; text-align:center;">ç„¡é ç´„å–®</p></div>'; return; }

      let html = '';
      data.forEach(order => {
        let statusHtml = order.status === 'pending' ? '<span class="status-badge" style="background:#444; color:#fff;">å¾…ç¢ºèª</span>' : 
                         order.status === 'confirmed' ? '<span class="status-badge" style="background:#FF9800; color:#fff;">å·²æ¥å–®</span>' : 
                         '<span class="status-badge" style="background:#00D100; color:#000;">å·²å®Œå·¥</span>';
                         
        let buttonsHtml = order.status === 'pending' ? `<button class="btn btn-confirm" onclick="updateOrderStatus(${order.id}, 'confirmed')">ç¢ºèªæ¥å–®</button>` :
                          order.status === 'confirmed' ? `<button class="btn btn-complete" onclick="completeAndRate(${order.id}, '${order.user_uid}', '${order.users.car_brand} ${order.users.car_model}', '${order.users.city}', ${gId})">å®Œå·¥æ ¸éŠ·ä¸¦è©•åˆ†</button>` : 
                          `<span style="color:#888; font-size:12px;">(çµ¦è»Šä¸»çš„è©•åˆ†: ${order.user_rating || 'æœªè©•'} æ˜Ÿ)</span>`;

        html += `<div class="card">${statusHtml}<h4 style="margin: 0 0 10px 0; color: #fff;">ğŸ•’ ${new Date(order.appointment_time).toLocaleString()}</h4>
                 <p style="margin: 5px 0; color: #aaa;">ğŸ‘¤ ${order.users.name} | ğŸ“ ${order.users.phone}</p>
                 <p style="margin: 5px 0 15px 0; color: #aaa;">ğŸš— ${order.users.car_brand} ${order.users.car_model} (${order.users.license_plate})</p>
                 <div>${buttonsHtml}</div></div>`;
      });
      container.innerHTML = html;
    }

    async function updateOrderStatus(orderId, newStatus) {
      await supabaseClient.from('appointments').update({ status: newStatus }).eq('id', orderId); loadOrders(); 
    }

    async function completeAndRate(orderId, userUid, carModel, city, gId) {
      let uidCode = prompt("è«‹è¼¸å…¥è»Šä¸»çš„æ–°æ¿¾ç¶² UID (æ¨¡æ“¬å» é•·æƒç¢¼ï¼Œä¾‹: HP-12345678)ï¼š");
      if(!uidCode) return alert("å¿…é ˆè¼¸å…¥ UID æ‰èƒ½æ ¸éŠ·ï¼");

      let score = prompt("è«‹ç‚ºæ­¤è»Šä¸»è©•åˆ† (1-5æ˜Ÿ)ï¼š\n(è‹¥ä½æ–¼3é¡†æ˜Ÿï¼Œç¸½éƒ¨å°‡å¯©æ ¸æ˜¯å¦åˆ—ç‚ºé»‘åå–®)", "5");
      if(!score || score < 1 || score > 5) return alert("è«‹è¼¸å…¥ 1-5 ä¹‹é–“çš„æ•¸å­—");

      await supabaseClient.from('appointments').update({ status: 'completed', user_rating: parseInt(score) }).eq('id', orderId);
      await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', userUid).eq('status', 'activated');
      await supabaseClient.from('filters_uid').update({ 
        status: 'activated', activated_by_uid: userUid, activated_at: new Date(),
        activation_type: 'Garage', installed_garage_id: gId, installed_car_model: carModel, installed_location: city
      }).eq('uid', uidCode);

      alert('âœ… æ ¸éŠ·èˆ‡è©•åˆ†å®Œæˆï¼'); loadOrders();
    }

    initSimulator();
  </script>
</body>
</html>
