<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¿¾è¯ç¶² - å» é•·æ¥å–®æ¨¡æ“¬å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; background: #121212; color: #fff; padding: 20px; max-width: 600px; margin: 0 auto; }
    h2 { color: #FF9800; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .card { background: #1e1e1e; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #333; }
    select { width: 100%; padding: 12px; margin-bottom: 20px; background: #000; color: #00D100; border: 1px solid #444; border-radius: 8px; font-size: 16px; font-weight: bold; }
    .btn { padding: 10px 15px; border-radius: 5px; font-weight: bold; border: none; cursor: pointer; margin-right: 10px; font-size: 14px; }
    .btn-confirm { background: #FF9800; color: #fff; }
    .btn-complete { background: #00D100; color: #000; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>

  <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶² - å» é•·æ¥å–®æ¨¡æ“¬å™¨</h2>
  <p style="color:#aaa; font-size: 14px;">æ­¤ç‚ºå…§éƒ¨æ¸¬è©¦å°ˆç”¨ç¶²é ï¼Œå…ç™»å…¥å³å¯æ¨¡æ“¬ä»»ä½•åŠ ç›Ÿåº—çš„æ¥å–®ç‹€æ³ã€‚</p>

  <label for="garage-select" style="color:#888; font-size:14px;">è«‹é¸æ“‡æ‚¨è¦æ¨¡æ“¬çš„ä¿ä¿®å» ï¼š</label>
  <select id="garage-select" onchange="loadOrders()">
    <option value="">-- è®€å–åº—å®¶ä¸­ --</option>
  </select>

  <div id="orders-container">
    <p style="color:#888;">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡åº—å®¶</p>
  </div>

  <script>
    // æ‚¨çš„å°ˆå±¬ Supabase é‡‘é‘°
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );

    async function initSimulator() {
      // æŠ“å–æ‰€æœ‰ç‹€æ…‹ç‚º 'active' (å·²é–‹é€š) çš„ä¿ä¿®å» 
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active');
      const select = document.getElementById('garage-select');
      
      if (data && data.length > 0) {
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡è¦æ¨¡æ“¬çš„ä¿ä¿®å»  --</option>';
        data.forEach(g => {
          select.innerHTML += `<option value="${g.id}">${g.name} (ä»£å·¥è²» $${g.labor_fee})</option>`;
        });
      } else {
        select.innerHTML = '<option value="">âŒ ç›®å‰ç„¡å·²é–‹é€šçš„ä¿ä¿®å» ï¼Œè«‹å…ˆè‡³ç¸½éƒ¨å¾Œå°é–‹é€š</option>';
      }
    }

    async function loadOrders() {
      const garageId = document.getElementById('garage-select').value;
      const container = document.getElementById('orders-container');
      
      if (!garageId) {
        container.innerHTML = '<p style="color:#888;">è«‹å…ˆå¾ä¸Šæ–¹é¸æ“‡åº—å®¶</p>';
        return;
      }

      container.innerHTML = '<p style="color:#888;">è®€å–è¨‚å–®ä¸­...</p>';

      // æŠ“å–è©²ä¿ä¿®å» çš„æ‰€æœ‰é ç´„å–®ï¼Œä¸¦é—œè¯è»Šä¸»è³‡æ–™
      const { data } = await supabaseClient.from('appointments')
        .select('*, users(name, license_plate, phone, car_model)')
        .eq('garage_id', garageId)
        .order('appointment_time', { ascending: true });

      if (!data || data.length === 0) {
        container.innerHTML = '<div class="card"><p style="color:#888; text-align:center;">ç›®å‰ç„¡ä»»ä½•é ç´„å–®</p></div>';
        return;
      }

      let html = '';
      data.forEach(order => {
        const time = new Date(order.appointment_time).toLocaleString('zh-TW');
        let statusHtml = '';
        let buttonsHtml = '';

        // ä¾æ“šè¨‚å–®ç‹€æ…‹é¡¯ç¤ºä¸åŒçš„æŒ‰éˆ•èˆ‡æ¨™ç±¤
        if (order.status === 'pending') {
          statusHtml = '<span class="status-badge" style="background:#444; color:#fff;">å¾…ç¢ºèª</span>';
          buttonsHtml = `<button class="btn btn-confirm" onclick="updateOrderStatus(${order.id}, 'confirmed')">ç¢ºèªæ¥å–®</button>`;
        } else if (order.status === 'confirmed') {
          statusHtml = '<span class="status-badge" style="background:#FF9800; color:#fff;">å·²æ¥å–®æ’ç¨‹</span>';
          buttonsHtml = `<button class="btn btn-complete" onclick="updateOrderStatus(${order.id}, 'completed')">å®Œå·¥ä¸¦æ ¸éŠ·</button>`;
        } else if (order.status === 'completed') {
          statusHtml = '<span class="status-badge" style="background:#00D100; color:#000;">å·²å®Œå·¥æ ¸éŠ·</span>';
        }

        html += `
          <div class="card">
            ${statusHtml}
            <h4 style="margin: 0 0 10px 0; color: #fff;">ğŸ•’ é ç´„æ™‚é–“ï¼š${time}</h4>
            <p style="margin: 5px 0; color: #aaa;">ğŸ‘¤ è»Šä¸»å§“åï¼š<span style="color:#fff;">${order.users.name}</span></p>
            <p style="margin: 5px 0; color: #aaa;">ğŸš— è»Šæ¬¾è»Šç‰Œï¼š<span style="color:#fff;">${order.users.car_model} (${order.users.license_plate})</span></p>
            <p style="margin: 5px 0 15px 0; color: #aaa;">ğŸ“ è¯çµ¡é›»è©±ï¼š<span style="color:#fff;">${order.users.phone}</span></p>
            <div>${buttonsHtml}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabaseClient.from('appointments')
        .update({ status: newStatus })
        .eq('id', orderId);
        
      if (!error) {
        alert('âœ… ç‹€æ…‹æ›´æ–°æˆåŠŸï¼');
        loadOrders(); // é‡æ–°è¼‰å…¥ç•«é¢
      } else {
        alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
      }
    }

    // ç¶²é è¼‰å…¥æ™‚åˆå§‹åŒ–
    initSimulator();
  </script>
</body>
</html>
