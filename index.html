<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =========================================
       ğŸ’ V4.12 Tesla æ¥µç°¡ä¸­æ§è¨­è¨ˆç³»çµ± (æ¨æ’­é€£å‹•ç‰ˆ)
       ========================================= */
       
    :root {
      --bg-image: none; --bg-color: #000000; --surface-color: #111111; --border-color: #222222;
      --text-primary: #ffffff; --text-secondary: #888888;
      --accent-color: #00e676; --accent-gradient: linear-gradient(135deg, #00e676 0%, #00b85c 100%);
      --accent-glow: rgba(0, 230, 118, 0.2);
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(10, 10, 10, 0.85); --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
      --input-bg: #1a1a1a;
    }

    body.light-mode {
      --bg-color: #f5f5f7; --surface-color: #ffffff; --border-color: #e5e5ea;
      --text-primary: #1a1a1a; --text-secondary: #777777;
      --accent-color: #10b981; --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --accent-glow: rgba(16, 185, 129, 0.15);
      --gold-color: #d4af37; --gold-glow: rgba(212, 175, 55, 0.15);
      --glass-bg: rgba(255, 255, 255, 0.9); --card-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
      --input-bg: #f9f9f9;
    }

    body.metal-mode {
      --bg-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0px, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 4px);
      --bg-color: #151515; --surface-color: linear-gradient(145deg, #262628 0%, #1c1c1e 100%);
      --border-color: #3a3a3c; --text-primary: #e5e5ea; --text-secondary: #98989d;
      --accent-color: #06b6d4; --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      --accent-glow: rgba(6, 182, 212, 0.25);
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(28, 28, 30, 0.9); --card-shadow: inset 0 1px 1px rgba(255,255,255,0.05), 0 8px 25px rgba(0,0,0,0.5);
      --input-bg: #111112;
    }

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg-color); background-image: var(--bg-image); color: var(--text-primary); padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); transition: background 0.4s ease, color 0.4s ease; min-height: 100vh; letter-spacing: 0.5px; -webkit-font-smoothing: antialiased;}
    
    .page { display: none; padding: 16px; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .card { background: var(--surface-color); padding: 20px; border-radius: 24px; margin-bottom: 16px; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); transition: all 0.4s ease; }
    
    .btn-main { background: var(--accent-gradient); color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 600; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); box-shadow: 0 4px 15px var(--accent-glow); letter-spacing: 1px;}
    .btn-main:active { transform: scale(0.96); box-shadow: 0 2px 8px var(--accent-glow); }
    
    input, select { width: 100%; padding: 16px; margin-bottom: 16px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 14px; font-size: 15px; transition: all 0.3s; outline: none; -webkit-appearance: none;}
    input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 4px var(--accent-glow); }
    
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--glass-bg); display: flex; justify-content: space-between; align-items: flex-end; padding: 6px 5px calc(4px + env(safe-area-inset-bottom, 0px)) 5px; border-top: 1px solid var(--border-color); z-index: 999; backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); box-shadow: 0 -4px 20px rgba(0,0,0,0.2); }
    .nav-item { color: var(--text-secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: space-between; flex: 1; height: 42px; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
    .nav-item:active { transform: scale(0.9); }
    .nav-item.active { color: var(--accent-color); font-weight: 700; transform: none; }
    .nav-icon { font-size: 22px; display: flex; align-items: center; justify-content: center; height: 24px; margin: 0; line-height: 1; }
    .nav-text { font-size: 11px; line-height: 1; display: block; margin-top: 2px;}

    .header-flex { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 25px; }
    .header-title-box { flex: 1; min-width: 0; } 
    #ui-owner { font-size: 20px; font-weight: 800; margin: 0; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shield-badge { flex-shrink: 0; background: var(--accent-glow); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 8px 14px; border-radius: 30px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; animation: badgePulse 2.5s infinite alternate ease-in-out; transition: all 0.5s ease;}
    
    @keyframes badgePulse { 0% { box-shadow: 0 0 5px var(--accent-glow); border-color: transparent; } 100% { box-shadow: 0 0 20px var(--accent-color); border-color: var(--accent-color); } }
    .pulse-dot { display: inline-block; width: 10px; height: 10px; background: var(--accent-color); border-radius: 50%; animation: heartBeat 1.8s infinite cubic-bezier(0.215, 0.61, 0.355, 1); transition: background 0.5s ease;}
    @keyframes heartBeat { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 var(--accent-color); } 50% { transform: scale(1.6); box-shadow: 0 0 0 10px rgba(0,0,0,0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    
    .main-visual-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0 30px 0; }
    .ring { width: 220px; height: 220px; border-radius: 50%; border: 6px solid var(--accent-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--accent-glow); position: relative; background: var(--surface-color); z-index: 2;}
    .ring::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 1px dashed var(--text-secondary); animation: rotate 25s linear infinite; opacity: 0.2; z-index: 1;}
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    .pm25-badge { color: var(--gold-color); font-size: 13px; margin-top: -20px; font-weight: 700; background: var(--surface-color); padding: 8px 20px; border-radius: 20px; border: 1px solid var(--gold-color); box-shadow: 0 5px 15px var(--gold-glow); z-index: 3; position: relative;}

    .tech-tag-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 20px; }
    .tech-tag { background: var(--input-bg); color: var(--text-primary); padding: 8px 2px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; gap: 3px; font-weight: 600; text-align: center; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .t-icon { font-size: 13px; opacity: 0.9; flex-shrink: 0;}
    
    /* è·‘é¦¬ç‡ˆå®¹å™¨ï¼ˆåŠ å…¥è‰²å½©éæ¸¡å‹•ç•«ï¼‰ */
    .dynamic-msg-bar { background: var(--input-bg); color: var(--accent-color); padding: 0 16px; height: 48px; border-radius: 14px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; font-weight: 600; transition: all 0.4s ease; box-shadow: inset 0 2px 6px rgba(0,0,0,0.05); }
    .dynamic-msg-icon { margin-right: 12px; font-size: 18px; flex-shrink: 0; display:flex; align-items:center; }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; height: 100%; }
    .marquee-content { display: flex; align-items: center; min-width: 100%; animation: scrollText 14s linear infinite; line-height: 1; padding-top: 2px;} 
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .env-box { background: var(--input-bg); border-radius: 16px; padding: 16px 10px; text-align: center; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: space-between; align-items: center; min-height: 105px; }
    .env-title { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 10px; line-height: 1.4;}
    .env-subtitle { font-size: 10px; opacity: 0.8; font-weight: 400;}
    
    .aqi-container { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }
    .aqi-label { font-size: 10px; font-weight: 800; color: var(--text-secondary); letter-spacing: 1px; margin-bottom: 2px; }
    .env-val { font-size: 38px; font-weight: 800; color: var(--text-primary); margin: 0; font-family: -apple-system, sans-serif; letter-spacing: -1px; line-height: 1; }

    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px;}
    .esg-box { text-align: center; padding: 16px 6px; background: var(--input-bg); border-radius: 16px; border: 1px solid var(--border-color); position: relative; }
    .esg-badge { position: absolute; top: -10px; right: 50%; transform: translateX(50%); background: var(--accent-gradient); color: #fff; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: 700; white-space: nowrap; box-shadow: 0 4px 10px var(--accent-glow);}
    
    .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .tab-btn { padding: 14px 10px; margin: 0; font-size: 13px; text-align: center; border-radius: 14px; cursor: pointer; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; transition: all 0.3s; background: var(--input-bg); color: var(--text-secondary);}
    .tab-btn.active { background: var(--accent-gradient); color: #fff; border-color: var(--accent-color); box-shadow: 0 6px 15px var(--accent-glow);}
    
    .log-item { border-bottom: 1px solid var(--border-color); padding: 16px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .log-item:last-child { border-bottom: none; }
    .version-tag { text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 40px; font-family: monospace; letter-spacing: 1px; opacity: 0.6;}
    label { font-size: 12px; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; display: block; padding-left: 4px;}

    .vip-card { border: 1px solid var(--gold-color); background: linear-gradient(135deg, #1a1500 0%, #050400 100%); box-shadow: 0 15px 40px var(--gold-glow); position: relative; overflow: hidden; }
    .vip-card::before { content: ''; position: absolute; top: -60px; right: -60px; width: 180px; height: 180px; background: var(--gold-glow); filter: blur(50px); border-radius: 50%; }
    .shine-btn { position: relative; overflow: hidden; background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color: #000; box-shadow: 0 8px 25px var(--gold-glow); border-radius: 16px;}
    .shine-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.7) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); animation: shine 3s infinite; }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:var(--text-primary); text-align:center; margin-bottom:30px;">HYPASS <span style="color:var(--accent-color);">Air+</span></h2>
    <div class="card"><p style="font-size:13px; color:var(--text-secondary); margin:0; text-align:center; line-height:1.5;">ç‚ºä¿éšœæ‚¨çš„æ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:30px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      
      <select id="c-city" onchange="updateDistricts('c-city', 'c-district')">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
      </select>
      <select id="c-district"><option value="">* é„‰é®å¸‚å€</option></select>
      <input type="text" id="c-address" placeholder="* è©³ç´°é€šè¨Šåœ°å€ (è¡—é“/å··å¼„/æ¨“å±¤)">

      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option>
        <option value="Toyota">Toyota (è±ç”°)</option><option value="Honda">Honda (æœ¬ç”°)</option>
        <option value="Nissan">Nissan (æ—¥ç”¢)</option><option value="Ford">Ford (ç¦ç‰¹)</option>
        <option value="Mazda">Mazda (é¦¬è‡ªé”)</option><option value="Mitsubishi">Mitsubishi (ä¸‰è±)</option>
        <option value="Hyundai">Hyundai (ç¾ä»£)</option><option value="Kia">Kia (èµ·äº)</option>
        <option value="Volkswagen">Volkswagen (ç¦æ–¯)</option><option value="Skoda">Skoda (å¸ç§‘é”)</option>
        <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
        <option value="BMW">BMW (å¯¶é¦¬)</option><option value="Audi">Audi (å¥§è¿ª)</option>
        <option value="Volvo">Volvo (å¯Œè±ª)</option><option value="Porsche">Porsche (ä¿æ™‚æ·)</option>
        <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Subaru">Subaru (é€Ÿéœ¸é™¸)</option>
        <option value="Suzuki">Suzuki (éˆ´æœ¨)</option><option value="Luxgen">Luxgen (ç´æ™ºæ·)</option>
        <option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="header-flex">
      <div class="header-title-box">
        <p id="ui-owner">è®€å–ä¸­...</p>
        <p id="ui-car-info" style="font-size:13px; color:var(--text-secondary); margin:4px 0 0 0;">è®€å–ä¸­...</p>
      </div>
      <div class="shield-badge" id="ui-shield-badge"><span class="pulse-dot" id="ui-pulse-dot"></span> <span id="ui-shield-text">ç³»çµ±é€£ç·šä¸­</span></div>
    </div>

    <div class="main-visual-container">
      <div class="ring">
        <div style="font-size:64px; font-weight:900; color:var(--accent-color); letter-spacing:-2px; line-height:1;" id="ui-health">100%</div>
        <div style="font-size:14px; color:var(--text-secondary); font-weight:700; margin-top:8px;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
      </div>
      <div class="pm25-badge">ğŸ›¡ï¸ ç´¯è¨ˆæ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:8px; z-index:3; position:relative; letter-spacing:0.5px;">æ¿¾ç¶²å•Ÿç”¨æ—¥æœŸ: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>
    
    <div class="tech-tag-container">
      <div class="tech-tag"><span class="t-icon">ğŸ‡¹ğŸ‡¼</span><span style="font-size:12px;">å°ç£è£½é€ </span></div>
      <div class="tech-tag"><span class="t-icon">âš¡</span><span style="font-size:11px; letter-spacing:-0.5px;">é«˜æ•ˆéœé›»éæ¿¾</span></div>
      <div class="tech-tag"><span class="t-icon">ğŸ¥¥</span><span style="font-size:10px; letter-spacing:-0.5px;">é«˜æ•ˆæ´»æ€§ç¢³é™¤è‡­</span></div>
      <div class="tech-tag"><span class="t-icon">ğŸ“¡</span><span style="font-size:11px; letter-spacing:-0.5px;">ç©ºæ±™é›·é”è­¦ç¤º</span></div>
      <div class="tech-tag"><span class="t-icon">ğŸ§ </span><span style="font-size:10px; letter-spacing:-0.5px;">Aiæ™ºèƒ½æ¼”ç®—æ¨æ’­</span></div>
      <div class="tech-tag"><span class="t-icon">ğŸŒ±</span><span style="font-size:10px; letter-spacing:-0.5px;">ESGé™ä½ç¢³è¶³è·¡</span></div>
    </div>

    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span class="dynamic-msg-icon">ğŸ’¬</span>
      <div class="marquee-container"><span class="marquee-content" id="ui-dynamic-msg">ç³»çµ±é€£ç·šä¸­ï¼ŒåŒæ­¥ç¸½éƒ¨å¤§æ•¸æ“š...</span></div>
    </div>

    <div class="grid-2">
      <div class="env-box">
        <div class="env-title">ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" class="env-subtitle">å®šä½ä¸­...</span></div>
        <div class="aqi-container">
          <div class="aqi-label">AQI</div>
          <div class="env-val" id="env-aqi" style="color:var(--accent-color);">--</div>
        </div>
      </div>
      <div class="env-box" style="border-color:#554400;">
        <div class="env-title">ğŸ  è¿‘7æ—¥å±…ä½åœ°<br><span id="ui-home-city" class="env-subtitle">è®€å–ä¸­...</span></div>
        <div class="aqi-container">
          <div class="aqi-label">AQI</div>
          <div class="env-val" id="env-home-aqi" style="color:var(--gold-color);">--</div>
        </div>
      </div>
    </div>

    <div class="grid-3">
      <div class="esg-box">
        <div class="esg-badge">æ¥µè‡´ä½é¢¨é˜»</div><div style="font-size:24px; margin-top:15px;">ğŸŒ±</div><div style="font-size:20px; font-weight:700; color:var(--text-primary); margin:6px 0;"><span id="ui-esg-co2">0</span> <span style="font-size:11px; color:var(--text-secondary);">kg</span></div><div style="font-size:11px; color:var(--text-secondary); font-weight:600;">çœç¢³è¶³è·¡</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å†·æ°£è¼•è² è¼‰</div><div style="font-size:24px; margin-top:15px;">âš¡ï¸</div><div style="font-size:20px; font-weight:700; color:var(--text-primary); margin:6px 0;"><span id="ui-esg-kwh">0</span> <span style="font-size:11px; color:var(--text-secondary);">kWh</span></div><div style="font-size:11px; color:var(--text-secondary); font-weight:600;">çœé›»æ•ˆèƒ½</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å¼·æ•ˆå¤§é¢¨é‡</div><div style="font-size:24px; margin-top:15px;">â›½ï¸</div><div style="font-size:20px; font-weight:700; color:var(--text-primary); margin:6px 0;"><span id="ui-esg-ac">0</span> <span style="font-size:11px; color:var(--text-secondary);">%</span></div><div style="font-size:11px; color:var(--text-secondary); font-weight:600;">ç©ºèª¿ç¯€èƒ½</div>
      </div>
    </div>
    
    <button class="btn-main" onclick="scanFilter()" style="margin-top:5px; background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="card" style="text-align:center; padding: 40px 20px;">
      <p style="color:var(--text-secondary); font-size:15px; margin-bottom:15px;">æ‚¨çš„å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); letter-spacing: 4px; border: 2px dashed var(--accent-color); padding: 18px; border-radius: 16px; margin-bottom:30px; font-size:28px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw/categories/replace-filters-all?srsltid=AfmBOooj2xVe0YRRhwwtUs-DXWufMvnWl7NJlD-nrNwE96Wxw1jVUxr6'">å‰å¾€å•†åŸé¸è³¼å°ˆå±¬æ¿¾ç¶²</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ“ é ç´„å®‰è£</h3>
    <div id="booking-section">
      <div style="display: flex; gap: 12px; margin-bottom: 24px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn inactive" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ é™„è¿‘ä¿ä¿®å» </div>
      </div>
      <div id="booking-smart"><div id="smart-match-result" class="card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
      <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="card vip-card" style="text-align: center; padding: 40px 20px; border-radius:24px;">
      <h4 style="margin:0; color:var(--gold-color); font-size: 18px; letter-spacing: 2px;">VIP å°ˆå±¬çå‹µé‡‘</h4>
      <h1 style="margin:20px 0; font-size: 64px; color: #FFF; text-shadow: 0 4px 25px rgba(255, 215, 0, 0.6);"><span id="reward-balance">$0</span></h1>
      <p style="font-size:14px; color:#d4d4d4; margin-bottom: 30px; line-height:1.6;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Points<br>æ¨è–¦ç„¡ä¸Šé™ï¼Œçé‡‘ç„¡ä¸Šé™ï¼</p>
      <button class="btn-main shine-btn" style="padding:18px; font-size:18px; font-weight:800;" onclick="redeemPoints()">ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    
    <div class="card" style="text-align: center; border: 2px solid var(--accent-color); background: var(--input-bg); margin-top:20px;">
       <h3 style="margin-top: 10px; color: var(--text-primary); font-size:20px;">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">åˆ†äº«æ‚¨çš„å°ˆå±¬é€£çµï¼Œå¥½å‹æˆåŠŸå•Ÿç”¨æ¿¾ç¶²å¾Œ<br>æ‚¨å°‡ç«‹å³ç²å¾—é«˜é¡æ¨è–¦çé‡‘ï¼</p>
       <button class="btn-main" style="box-shadow: 0 8px 25px var(--accent-glow); font-size: 18px; padding:18px;" onclick="generateMGM()">ğŸ”— é»æ“Šè¤‡è£½å°ˆå±¬é€£çµ</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div class="tab-grid">
      <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="tab-btn inactive" id="tab-set-theme" onclick="switchSetTab('theme')">ğŸ¨ ç•«é¢è¨­å®š</div>
      <div class="tab-btn inactive" id="tab-set-b" onclick="switchSetTab('b')">ğŸ“œ æ­·å²ç´€éŒ„</div>
      <div class="tab-btn inactive" id="tab-set-c" onclick="switchSetTab('c')">ğŸ“„ æ•¸ä½åˆç´„</div>
    </div>

    <div id="set-content-a" style="display:block;">
      <div class="card">
        <label>è»Šä¸»å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>é›»å­éƒµä»¶</label><input type="email" id="edit-email">
        <label>æ€§åˆ¥</label><select id="edit-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        
        <label>å±…ä½ç¸£å¸‚</label>
        <select id="edit-city" onchange="updateDistricts('edit-city', 'edit-district')">
          <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
          <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
          <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
          <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
          <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
          <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
          <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
          <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
        </select>
        
        <label>é„‰é®å¸‚å€</label>
        <select id="edit-district"></select>
        
        <label>è©³ç´°é€šè¨Šåœ°å€</label>
        <input type="text" id="edit-address">

        <label>è»Šè¼›å“ç‰Œ</label>
        <select id="edit-brand" onchange="updateCarModels('edit-brand', 'edit-model')">
          <option value="Toyota">Toyota (è±ç”°)</option><option value="Honda">Honda (æœ¬ç”°)</option>
          <option value="Nissan">Nissan (æ—¥ç”¢)</option><option value="Ford">Ford (ç¦ç‰¹)</option>
          <option value="Mazda">Mazda (é¦¬è‡ªé”)</option><option value="Mitsubishi">Mitsubishi (ä¸‰è±)</option>
          <option value="Hyundai">Hyundai (ç¾ä»£)</option><option value="Kia">Kia (èµ·äº)</option>
          <option value="Volkswagen">Volkswagen (ç¦æ–¯)</option><option value="Skoda">Skoda (å¸ç§‘é”)</option>
          <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
          <option value="BMW">BMW (å¯¶é¦¬)</option><option value="Audi">Audi (å¥§è¿ª)</option>
          <option value="Volvo">Volvo (å¯Œè±ª)</option><option value="Porsche">Porsche (ä¿æ™‚æ·)</option>
          <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Subaru">Subaru (é€Ÿéœ¸é™¸)</option>
          <option value="Suzuki">Suzuki (éˆ´æœ¨)</option><option value="Luxgen">Luxgen (ç´æ™ºæ·)</option>
          <option value="Other">å…¶ä»–å“ç‰Œ</option>
        </select>
        <label>è»Šè¼›å‹è™Ÿ</label><select id="edit-model"></select>
        <label>å‡ºå» å¹´ä»½</label><input type="number" id="edit-year">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label><select id="edit-mileage"><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
        <button class="btn-main" onclick="updateProfile()" style="margin-top:10px;">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    
    <div id="set-content-theme" style="display:none;">
      <div class="card" style="text-align: center; padding: 40px 20px;">
        <h3 style="margin-top:0; color:var(--text-primary); margin-bottom: 30px; font-size:20px;">é¸æ“‡åº§è‰™é¡¯ç¤ºæ¨¡å¼</h3>
        <div style="display:flex; flex-direction: column; gap:16px;">
          <button class="btn-main" id="btn-theme-dark" style="background:#000000; color:#00e676; border:1px solid #222222; box-shadow: 0 8px 25px rgba(0,0,0,0.8);" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘</button>
          <button class="btn-main" id="btn-theme-light" style="background:#ffffff; color:#10b981; border:1px solid #e5e5ea; box-shadow: 0 8px 25px rgba(0,0,0,0.06);" onclick="setTheme('light')">â˜€ï¸ æ¥µç°¡ç™½</button>
          <button class="btn-main" id="btn-theme-metal" style="background:linear-gradient(145deg, #2c2c2e 0%, #1c1c1e 100%); color:#06b6d4; border:1px solid #3a3a3c; box-shadow: 0 8px 25px rgba(0,0,0,0.6);" onclick="setTheme('metal')">ğŸŒŠ æ·¨åŒ–è—</button>
        </div>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="card">
        <select id="history-type" onchange="loadHistory(this.value)" style="margin-bottom:20px; font-weight:700;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option><option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
          <option value="shop">ğŸ›’ å•†åŸè³¼è²·ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 400px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    
    <div id="set-content-c" style="display:none;">
      <div class="card"><h4 style="margin:0 0 10px 0; color:var(--text-primary); font-size:18px;">ğŸ“„ HYPASS æ•¸ä½ä¿å›ºå¡</h4><p style="font-size:14px; color:var(--text-secondary); margin:8px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--gold-color); font-weight:bold; font-size:18px;"></span></p></div>
    </div>
    <div class="version-tag">4.12</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">â—“</span><span class="nav-text">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span class="nav-icon">ğŸ›’</span><span class="nav-text">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span class="nav-icon">ğŸ“</span><span class="nav-text">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><span class="nav-icon">ğŸ</span><span class="nav-text">ä»»å‹™</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-text">è¨­å®š</span></div>
  </div>

  <script>
    window.onerror = function(msg, url, line) { console.log("Error:", msg, "at line:", line); return false; };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; let currentLocName = 'å°ç£'; let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };
    
    const carData = { 
      "Toyota": ["RAV4", "Corolla Cross", "Altis", "Camry", "Yaris", "å…¶ä»–"], "Honda": ["CR-V", "HR-V", "Civic", "Fit", "å…¶ä»–"],
      "Nissan": ["Kicks", "Sentra", "X-Trail", "å…¶ä»–"], "Ford": ["Focus", "Kuga", "å…¶ä»–"], "Mazda": ["Mazda 3", "CX-5", "å…¶ä»–"],
      "Mitsubishi": ["Outlander", "Eclipse Cross", "Colt Plus", "å…¶ä»–"], "Hyundai": ["Tucson", "Custin", "Venue", "å…¶ä»–"],
      "Kia": ["Sportage", "Sorento", "EV6", "å…¶ä»–"], "Volkswagen": ["Golf", "Tiguan", "å…¶ä»–"], "Skoda": ["Kodiaq", "Kamiq", "å…¶ä»–"],
      "Lexus": ["NX", "RX", "UX", "ES", "å…¶ä»–"], "Benz": ["C-Class", "E-Class", "GLC", "GLE", "å…¶ä»–"],
      "BMW": ["3-Series", "5-Series", "X3", "X5", "å…¶ä»–"], "Audi": ["A3", "A4", "Q3", "Q5", "å…¶ä»–"],
      "Volvo": ["XC60", "XC40", "å…¶ä»–"], "Porsche": ["Macan", "Cayenne", "å…¶ä»–"], "Tesla": ["Model Y", "Model 3", "Model X", "Model S"],
      "Subaru": ["Forester", "XV", "å…¶ä»–"], "Suzuki": ["Swift", "Jimny", "å…¶ä»–"], "Luxgen": ["URX", "n7", "å…¶ä»–"], "Other": ["å…¶ä»–å“ç‰Œ"] 
    };

    const taiwanDistricts = {
      "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
      "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
      "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
      "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
      "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
      "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
      "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "è‹‘è£¡é®", "é€šéœ„é®", "ç«¹å—é®", "é ­ä»½å¸‚", "å¾Œé¾é®", "å“è˜­é®", "å¤§æ¹–é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "å—åº„é„‰", "é ­å±‹é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "é€ æ©‹é„‰", "ä¸‰ç£é„‰", "ç…æ½­é„‰", "æ³°å®‰é„‰"],
      "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
      "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å“¡æ—å¸‚", "æºªæ¹–é®", "ç”°ä¸­é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "åŒ—æ–—é®", "äºŒæ—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
      "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
      "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "è‡ºè¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
      "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
      "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
      "å°å—å¸‚": ["æ–°ç‡Ÿå€", "é¹½æ°´å€", "ç™½æ²³å€", "æŸ³ç‡Ÿå€", "å¾Œå£å€", "æ±å±±å€", "éº»è±†å€", "ä¸‹ç‡Ÿå€", "å…­ç”²å€", "å®˜ç”°å€", "å¤§å…§å€", "ä½³é‡Œå€", "å­¸ç”²å€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "åŒ—é–€å€", "æ–°åŒ–å€", "å–„åŒ–å€", "æ–°å¸‚å€", "å®‰å®šå€", "å±±ä¸Šå€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "å·¦é®å€", "ä»å¾·å€", "æ­¸ä»å€", "é—œå»Ÿå€", "é¾å´å€", "æ°¸åº·å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "å®‰å¹³å€", "ä¸­è¥¿å€"],
      "é«˜é›„å¸‚": ["é¹½åŸ•å€", "é¼“å±±å€", "å·¦ç‡Ÿå€", "æ¥ æ¢“å€", "ä¸‰æ°‘å€", "æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "å‰é®å€", "æ——æ´¥å€", "å°æ¸¯å€", "é³³å±±å€", "æ—åœ’å€", "å¤§å¯®å€", "å¤§æ¨¹å€", "å¤§ç¤¾å€", "ä»æ­¦å€", "é³¥æ¾å€", "å²¡å±±å€", "æ©‹é ­å€", "ç‡•å·¢å€", "ç”°å¯®å€", "é˜¿è“®å€", "è·¯ç«¹å€", "æ¹–å…§å€", "èŒ„è£å€", "æ°¸å®‰å€", "å½Œé™€å€", "æ¢“å®˜å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "ç”²ä»™å€", "æ‰æ—å€", "å…§é–€å€", "èŒ‚æ—å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€"],
      "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é¹½åŸ”é„‰", "é«˜æ¨¹é„‰", "è¬å·’é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "æ–°åŸ¤é„‰", "æ‹å¯®é„‰", "æ–°åœ’é„‰", "å´é ‚é„‰", "æ—é‚Šé„‰", "å—å·é„‰", "ä½³å†¬é„‰", "ç‰çƒé„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰", "æ‹å±±é„‰", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "ç‰¡ä¸¹é„‰"],
      "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
      "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
      "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
      "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"],
      "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"],
      "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"]
    };

    function normalizeCityName(cityStr) {
      if (!cityStr) return '';
      return cityStr.replace(/è‡º/g, 'å°');
    }

    function formatTaipeiTime(dateString) {
      if (!dateString) return '-';
      const options = { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      return new Date(dateString).toLocaleString('zh-TW', options);
    }

    function setTheme(theme) {
      document.body.classList.remove('light-mode', 'metal-mode');
      document.getElementById('btn-theme-dark').style.borderColor = 'transparent';
      document.getElementById('btn-theme-light').style.borderColor = 'transparent';
      document.getElementById('btn-theme-metal').style.borderColor = 'transparent';
      if (theme === 'light') { document.body.classList.add('light-mode'); document.getElementById('btn-theme-light').style.borderColor = '#10b981'; } 
      else if (theme === 'metal') { document.body.classList.add('metal-mode'); document.getElementById('btn-theme-metal').style.borderColor = '#06b6d4'; } 
      else { theme = 'dark'; document.getElementById('btn-theme-dark').style.borderColor = '#00e676'; }
      localStorage.setItem('hypass_theme', theme);
    }
    setTheme(localStorage.getItem('hypass_theme') || 'dark');

    function updateCarModels(brandId, modelId) { 
      const bSelect = document.getElementById(brandId).value; const mSelect = document.getElementById(modelId); mSelect.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
      if (carData[bSelect]) carData[bSelect].forEach(item => { mSelect.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function updateDistricts(cityId, districtId) {
      const city = document.getElementById(cityId).value;
      const distSelect = document.getElementById(districtId);
      distSelect.innerHTML = '<option value="">* é„‰é®å¸‚å€</option>';
      if (taiwanDistricts[city]) {
          taiwanDistricts[city].forEach(d => { distSelect.innerHTML += `<option value="${d}">${d}</option>`; });
      }
    }

    function showForm(role) { document.getElementById('form-customer').style.display = (role === 'customer') ? 'block' : 'none'; document.getElementById('form-garage').style.display = (role === 'garage') ? 'block' : 'none'; }
    
    function switchPage(id, el) { 
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
      document.getElementById('page-' + id).classList.add('active'); 
      if (el) el.classList.add('active'); 
      if (id === 'book') loadGarages(); 
    }
    
    function switchSetTab(t) { 
      ['a','theme','b','c'].forEach(tab => {
        document.getElementById(`set-content-${tab}`).style.display = (t === tab) ? 'block' : 'none';
        document.getElementById(`tab-set-${tab}`).className = `tab-btn ${t === tab ? 'active' : 'inactive'}`;
      });
    }
    
    function switchBookingTab(t) { document.getElementById('booking-smart').style.display = (t === 'smart') ? 'block' : 'none'; document.getElementById('booking-manual').style.display = (t === 'manual') ? 'block' : 'none'; document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : 'inactive'}`; document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : 'inactive'}`; }

    async function submitRegister(role) {
      try {
        const p = await liff.getProfile(); let referrerId = new URLSearchParams(window.location.search).get('ref');
        if (role === 'customer') {
          const n = document.getElementById('c-name').value; const ph = document.getElementById('c-phone').value; const e = document.getElementById('c-email').value;
          const g = document.getElementById('c-gender').value; const c = document.getElementById('c-city').value; 
          const dist = document.getElementById('c-district').value; const addr = document.getElementById('c-address').value;
          const b = document.getElementById('c-brand').value; const m = document.getElementById('c-model').value; const y = document.getElementById('c-year').value; const pl = document.getElementById('c-plate').value; const mil = document.getElementById('c-mileage').value;
          
          if (!n || !ph || !e || !c || !dist || !b || !m || !pl || !mil) return alert("è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰ * å¿…å¡«æ¬„ä½ï¼");
          
          const payload = { line_uid: p.userId, role: role, referrer_uid: referrerId, name: n, phone: ph, email: e, gender: g, city: c, district: dist, address: addr, car_brand: b, car_model: m, license_plate: pl, yearly_mileage: parseInt(mil), car_year: parseInt(y) || null };
          
          const { error } = await supabaseClient.from('users').upsert(payload);
          if (error) alert("è¨»å†Šå¤±æ•—ï¼š" + error.message); else { alert("âœ… è¨»å†ŠæˆåŠŸï¼"); location.reload(); }
        }
      } catch (err) { alert("ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
    }

    async function updateProfile() {
      const payload = {
        name: document.getElementById('edit-name').value, phone: document.getElementById('edit-phone').value, email: document.getElementById('edit-email').value,
        gender: document.getElementById('edit-gender').value, city: document.getElementById('edit-city').value,
        district: document.getElementById('edit-district').value, address: document.getElementById('edit-address').value,
        car_brand: document.getElementById('edit-brand').value, car_model: document.getElementById('edit-model').value,
        car_year: parseInt(document.getElementById('edit-year').value) || null, license_plate: document.getElementById('edit-plate').value, 
        yearly_mileage: parseInt(document.getElementById('edit-mileage').value)
      };
      if (!payload.name || !payload.phone || !payload.license_plate) return alert("å§“åã€é›»è©±ã€è»Šç‰Œä¸å¯ç‚ºç©ºï¼");
      const { error } = await supabaseClient.from('users').update(payload).eq('line_uid', currentUser.line_uid); 
      if (error) alert("æ›´æ–°å¤±æ•—ï¼š" + error.message); else { alert('âœ… æ‚¨çš„åº§è‰™è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼'); location.reload(); }
    }

    async function loadHistory(type) {
      const container = document.getElementById('history-container'); container.innerHTML = 'è®€å–ä¸­...'; let html = '';
      if (type === 'filter') {
        const { data } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false });
        if (data && data.length > 0) data.forEach(d => { html += `<div class="log-item"><span style="color:var(--text-primary); font-weight:600;">ğŸ”„ [${d.activation_type}] å•Ÿç”¨æ–°æ¿¾ç¶²</span><br><span style="font-size:11px;">${formatTaipeiTime(d.activated_at)}</span></div>`; }); else html = '<p>å°šç„¡ç´€éŒ„</p>';
      } else if (type === 'book') {
        const { data } = await supabaseClient.from('appointments').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('appointment_time', { ascending: false });
        if (data && data.length > 0) data.forEach(d => { html += `<div class="log-item"><span style="color:var(--text-primary); font-weight:600;">ğŸ“ é ç´„ï¼š${d.garages.name} [${d.status}]</span><br><span style="font-size:11px;">é ç´„æ™‚é–“: ${formatTaipeiTime(d.appointment_time)}</span></div>`; }); else html = '<p>å°šç„¡ç´€éŒ„</p>';
      } else if (type === 'shop' || type === 'logs') {
        let query = supabaseClient.from('user_logs').select('*').eq('user_uid', currentUser.line_uid).order('created_at', { ascending: false });
        if (type === 'shop') query = query.eq('action', 'ğŸ›’ å•†åŸè³¼è²·');
        const { data } = await query;
        if (data && data.length > 0) data.forEach(d => { html += `<div class="log-item"><span style="color:var(--text-primary); font-weight:600;">ğŸ“ ${d.action}</span><br><span style="color:var(--text-secondary);">${d.details}</span><br><span style="font-size:11px;">${formatTaipeiTime(d.created_at)}</span></div>`; }); else html = '<p>å°šç„¡ç´€éŒ„</p>';
      }
      container.innerHTML = html;
    }

    async function scanFilter() {
      const res = await liff.scanCodeV2(); if (!res.value) return;
      await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
      const { error } = await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date(), activation_type: 'DIY', installed_car_model: currentUser.car_brand, installed_location: currentLocName }).eq('uid', res.value);
      if (error) return alert("å•Ÿç”¨å¤±æ•—ï¼Œå¯èƒ½ç‚ºç„¡æ•ˆçš„ QR Codeã€‚");
      await supabaseClient.from('user_logs').insert([{ user_uid: currentUser.line_uid, action: 'æ¿¾ç¶²é‡ç½®', details: `DIY å•Ÿç”¨äº†æ–°æ¿¾ç¶² UID: ${res.value}` }]);
      alert("âœ… å•Ÿç”¨æˆåŠŸï¼åº§è‰™é˜²è­·å·²æ»¿è¡€å¾©æ´»ã€‚"); location.reload();
    }

    async function book(gId, prefix = '') {
      const time = document.getElementById(prefix ? `date-${prefix}-${gId}` : `date-${gId}`).value;
      if (!time) return alert("è«‹é¸æ“‡é ç´„æ™‚é–“");
      const { error } = await supabaseClient.from('appointments').insert([{ user_uid: currentUser.line_uid, garage_id: gId, appointment_time: new Date(time) }]);
      if (error) alert("é ç´„å¤±æ•—ï¼š" + error.message); else { alert("ğŸ‰ é ç´„é€å‡ºæˆåŠŸï¼"); loadGarages(); }
    }

    window.generateMGM = function() {
      const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
      if (navigator.clipboard) navigator.clipboard.writeText(link).then(() => { alert(`âœ… æ¨è–¦é€£çµå·²è¤‡è£½ï¼å¿«è²¼çµ¦å¥½å‹å§ï¼\n${link}`); }).catch(() => { alert(`è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š\n${link}`); });
      else alert(`è«‹æ‰‹å‹•è¤‡è£½é€£çµï¼š\n${link}`);
    };

    window.redeemPoints = async function() {
      const balText = document.getElementById('reward-balance').innerText.replace('$','');
      if (parseInt(balText) < 100) return alert('é¤˜é¡ä¸è¶³ $100ï¼Œå¿«å»é‚€è«‹å¥½å‹å§ï¼');
      if (confirm('ç¢ºå®šç”³è«‹å…Œæ› LINE Points å—ï¼Ÿ')) {
        await supabaseClient.from('rewards').insert([{ user_uid: currentUser.line_uid, type: 'redeem', amount: 100, status: 'pending' }]);
        alert('âœ… æé ˜ç”³è«‹å·²é€å‡ºï¼ç¸½éƒ¨å°‡ç›¡å¿«ç‚ºæ‚¨å¯©æ ¸æ´¾ç™¼ã€‚'); loadRewards();
      }
    };

    // ğŸŒŸ æ ¸å¿ƒï¼šé€£å‹•æ¨æ’­å¼•æ“ (å‹•æ…‹è§£è­¯å™¨)
    async function updateDynamicMarquee(aqi, health, status) {
      try {
        const { data: rules } = await supabaseClient.from('notification_rules').select('*').eq('is_active', true);
        let messages = [];
        
        if (rules && rules.length > 0) {
          rules.forEach(rule => {
            try {
              // å»ºç«‹ä¸€å€‹å®‰å…¨æ²™ç›’ä¾†æ¯”å°ç¸½éƒ¨çš„æ¨æ’­é‚è¼¯
              const context = { aqi: aqi, health: health, status: status };
              const isTriggered = new Function(...Object.keys(context), `return ${rule.trigger_condition};`)(...Object.values(context));
              if (isTriggered) messages.push(rule.message_template);
            } catch (e) { console.error("æ¨æ’­æ¢ä»¶è§£æå¤±æ•—", rule.rule_name); }
          });
        }

        const msgBox = document.getElementById('dynamic-msg-box');
        
        if (messages.length > 0) {
          let finalMsg = messages.join(' ï½œ ');
          document.getElementById('ui-dynamic-msg').innerText = finalMsg;
          
          if (finalMsg.includes('ç´«çˆ†') || finalMsg.includes('ğŸš¨')) {
            msgBox.style.color = '#ef4444'; msgBox.style.borderColor = '#ef4444'; msgBox.style.boxShadow = 'inset 0 0 10px rgba(239, 68, 68, 0.2)';
          } else if (finalMsg.includes('è­¦å‘Š') || finalMsg.includes('âš ï¸')) {
            msgBox.style.color = '#f59e0b'; msgBox.style.borderColor = '#f59e0b'; msgBox.style.boxShadow = 'inset 0 0 10px rgba(245, 158, 11, 0.2)';
          } else {
            msgBox.style.color = 'var(--accent-color)'; msgBox.style.borderColor = 'var(--accent-color)'; msgBox.style.boxShadow = 'inset 0 0 10px var(--accent-glow)';
          }
        } else {
          document.getElementById('ui-dynamic-msg').innerText = `ç³»çµ±é€£ç·šæ­£å¸¸ï¼Œç›®å‰å®¤å¤– AQI: ${aqi}ï¼Œæ¿¾ç¶²æŒçºŒé˜²è­·ä¸­ï¼`;
          msgBox.style.color = 'var(--accent-color)'; msgBox.style.borderColor = 'var(--border-color)'; msgBox.style.boxShadow = 'inset 0 2px 6px rgba(0,0,0,0.05)';
        }
      } catch (e) { console.log("æ¨æ’­è¼‰å…¥éŒ¯èª¤", e); }
    }

    async function calculateDashboardStats() {
      if (!currentUser) return;
      const badge = document.getElementById('ui-shield-badge');
      const badgeText = document.getElementById('ui-shield-text');
      const pulseDot = document.getElementById('ui-pulse-dot');
      
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if (filter && filter.activated_at) {
        const actDate = new Date(filter.activated_at);
        document.getElementById('ui-filter-date').innerText = actDate.getFullYear() + '/' + String(actDate.getMonth()+1).padStart(2, '0') + '/' + String(actDate.getDate()).padStart(2, '0');

        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
        const algoParams = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        let mileageRate = currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0;
        let aqiRate = (envData.aqi > 150) ? parseFloat(algoParams.weightRed || 1.8) : (envData.aqi > 100 ? parseFloat(algoParams.weightOrange || 1.4) : 1.0);
        let baseWear = parseFloat(algoParams.baseWear || 0.27);
        let health = Math.max(0, Math.round(100 - (days * baseWear * mileageRate * aqiRate)));
        
        document.getElementById('ui-health').innerText = `${health}%`;
        
        if (health >= 60) {
            badge.style.removeProperty('--accent-color'); badge.style.removeProperty('--accent-glow');
            badgeText.innerText = 'æ¥µæ•ˆé˜²è­·ä¸­'; pulseDot.style.animationDuration = '1.8s'; document.getElementById('ui-health').style.color = 'var(--accent-color)';
        } else if (health >= 30) {
            badge.style.removeProperty('--accent-color'); badge.style.removeProperty('--accent-glow');
            badgeText.innerText = 'ç©©å®šç›£æ§ä¸­'; pulseDot.style.animationDuration = '2.5s'; document.getElementById('ui-health').style.color = 'var(--accent-color)';
        } else if (health > 0) {
            badge.style.setProperty('--accent-color', '#f59e0b'); badge.style.setProperty('--accent-glow', 'rgba(245, 158, 11, 0.2)');
            badgeText.innerText = 'æ•ˆèƒ½è¡°é€€ä¸­'; pulseDot.style.animationDuration = '1s'; document.getElementById('ui-health').style.color = '#f59e0b';
        } else {
            badge.style.setProperty('--accent-color', '#ef4444'); badge.style.setProperty('--accent-glow', 'rgba(239, 68, 68, 0.2)');
            badgeText.innerText = 'è«‹å³åˆ»æ›´æ›'; pulseDot.style.animationDuration = '0.4s'; document.getElementById('ui-health').style.color = '#ef4444';
        }
        
        let basePm25 = parseFloat(algoParams.basePm25 || 1250);
        document.getElementById('ui-pm25').innerText = Math.round(days * basePm25 * mileageRate * aqiRate).toLocaleString();
        let paHypass = parseFloat(algoParams.paHypass || 4); let paOther = parseFloat(algoParams.paOther || 8);
        document.getElementById('ui-esg-ac').innerText = Math.round(((paOther - paHypass) / paOther) * 30);
        let totalKwhSaved = (days * parseFloat(algoParams.kwhPerDay || 0.25) * mileageRate).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = totalKwhSaved;
        document.getElementById('ui-esg-co2').innerText = (totalKwhSaved * parseFloat(algoParams.co2Factor || 0.5)).toFixed(1);
        
        // è§¸ç™¼æ¨æ’­å¼•æ“
        updateDynamicMarquee(envData.aqi, health, 'activated');

      } else {
        document.getElementById('ui-filter-date').innerText = 'å°šæœªå•Ÿç”¨';
        badge.style.setProperty('--accent-color', '#888888'); badge.style.setProperty('--accent-glow', 'rgba(136, 136, 136, 0.2)');
        badgeText.innerText = 'ç³»çµ±å¾…å‘½'; pulseDot.style.animation = 'none';
        
        // è§¸ç™¼æ¨æ’­å¼•æ“ (æœªå•Ÿç”¨ç‹€æ…‹)
        updateDynamicMarquee(envData.aqi, 100, 'unactivated');
      }
    }

    async function fetchEnvironmentalData(city, district) {
      try {
        let searchCity = normalizeCityName(city);
        let { data } = await supabaseClient.from('env_cache').select('*').eq('city', searchCity).eq('district', district).maybeSingle();
        if (!data) { const { data: cityData } = await supabaseClient.from('env_cache').select('*').eq('city', searchCity).limit(1).maybeSingle(); data = cityData; }
        if (!data) { const { data: fallback } = await supabaseClient.from('env_cache').select('*').limit(1).maybeSingle(); data = fallback || { temp: 25, hum: 60, aqi: 50, pm25: 15 }; }

        envData.temp = data.temp; envData.hum = data.hum; envData.aqi = data.aqi; envData.pm25 = data.pm25;
        document.getElementById('env-aqi').innerText = envData.aqi;

        let homeCityRaw = currentUser.city || 'å°åŒ—å¸‚';
        document.getElementById('ui-home-city').innerText = homeCityRaw;
        
        let searchHomeCity = normalizeCityName(homeCityRaw);
        let { data: homeData } = await supabaseClient.from('env_cache').select('aqi').eq('city', searchHomeCity).limit(1).maybeSingle();
        let homeAqi = homeData ? homeData.aqi : envData.aqi;
        document.getElementById('env-home-aqi').innerText = Math.round(homeAqi * (0.9 + Math.random() * 0.2));

        // å°‡å¾ŒçºŒäº¤ç”± calculateDashboardStats å‘¼å« updateDynamicMarquee è™•ç†
        calculateDashboardStats();
      } catch (e) { console.log("AQI fetch error", e); calculateDashboardStats(); }
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(res => res.json())
            .then(d => {
              let city = d.address.city || d.address.county || '';
              let district = d.address.suburb || d.address.town || '';
              currentLocName = `${city}${district}`;
              document.getElementById('ui-loc-name').innerText = currentLocName;
              fetchEnvironmentalData(city, district);
            }).catch(e => { document.getElementById('ui-loc-name').innerText = "å®šä½å®Œæˆ"; fetchEnvironmentalData('', '');});
        }, () => { fetchEnvironmentalData('', ''); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); 
      } else {
        fetchEnvironmentalData('', '');
      }
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        const { data, error } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).maybeSingle();
        if (data && data.name) {
          currentUser = data; document.getElementById('nav-bar').style.display = 'flex';
          if (data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model}`;
            
            document.getElementById('edit-name').value = data.name; 
            document.getElementById('edit-phone').value = data.phone; 
            document.getElementById('edit-email').value = data.email; 
            if(data.gender) document.getElementById('edit-gender').value = data.gender;
            
            if(data.city) { 
              document.getElementById('edit-city').value = data.city; 
              updateDistricts('edit-city', 'edit-district');
              if(data.district) document.getElementById('edit-district').value = data.district;
            }
            if(data.address) document.getElementById('edit-address').value = data.address;

            if(data.car_brand) { 
              document.getElementById('edit-brand').value = data.car_brand; 
              updateCarModels('edit-brand', 'edit-model'); 
              if(data.car_model) document.getElementById('edit-model').value = data.car_model; 
            }
            
            if(data.car_year) document.getElementById('edit-year').value = data.car_year;
            document.getElementById('edit-plate').value = data.license_plate; document.getElementById('contract-plate').innerText = data.license_plate;
            if(data.yearly_mileage) document.getElementById('edit-mileage').value = data.yearly_mileage;

            switchPage('home', document.querySelector('.nav-item'));
            getGPS(); loadHistory('filter'); loadRewards();
          }
        } else { switchPage('register', null); }
      } catch (err) { console.log("LIFF å•Ÿå‹•å¤±æ•—"); }
    }
    initApp();
  </script>
</body>
</html>
