<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  
  <script>
    (function captureReferral() {
        try {
            let urlStr = window.location.href;
            let urlObj = new URL(urlStr);
            let ref = urlObj.searchParams.get('ref');
            
            if (!ref) {
                let liffState = urlObj.searchParams.get('liff.state');
                if (liffState) {
                    let stateParams = new URLSearchParams(liffState.startsWith('?') ? liffState : '?' + liffState);
                    ref = stateParams.get('ref');
                }
            }
            if (!ref) {
                let match = urlStr.match(/[?&]ref=([^&#]+)/) || urlStr.match(/ref%3D([^&]+)/);
                if (match && match[1]) ref = decodeURIComponent(match[1]);
            }
            if (ref && ref !== 'null' && ref !== 'undefined') {
                localStorage.setItem('hypass_ref_code', ref);
            }
        } catch(e) {}
    })();
  </script>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <link rel="stylesheet" href="style.css">
</head>
<body class="dark-mode">

  <div id="splash-screen">
    <img id="splash-img" src="splash.png" alt="HYPASS Air+">
  </div>

  <div id="page-register" class="page">
    <h2 style="text-align:center; margin-bottom:30px;">HYPASS <span style="color:var(--accent-color);">Air+</span></h2>
    <div class="g-card">
      <p style="text-align:center; font-size:14px; color:var(--text-secondary); line-height: 1.5; margin:0;">ç‚ºä¿éšœæ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p>
    </div>
    
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none; margin-top:10px;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:30px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      
      <select id="c-city" onchange="updateDistricts('c-city', 'c-district')">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
      </select>
      <select id="c-district"><option value="">* é„‰é®å¸‚å€</option></select>
      <input type="text" id="c-address" placeholder="* è©³ç´°é€šè¨Šåœ°å€ (è¡—é“/å··å¼„/æ¨“å±¤)">

      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option>
        <option value="Toyota">Toyota</option><option value="Lexus">Lexus</option><option value="Honda">Honda</option>
        <option value="Nissan">Nissan</option><option value="Ford">Ford</option><option value="Mazda">Mazda</option>
        <option value="Mitsubishi">Mitsubishi</option><option value="Hyundai">Hyundai</option><option value="Kia">Kia</option>
        <option value="Volkswagen">Volkswagen</option><option value="Skoda">Skoda</option><option value="Benz">Benz (M-Benz)</option>
        <option value="BMW">BMW</option><option value="Audi">Audi</option><option value="Volvo">Volvo</option>
        <option value="Porsche">Porsche</option><option value="Tesla">Tesla</option><option value="Subaru">Subaru</option>
        <option value="Suzuki">Suzuki</option><option value="Luxgen">Luxgen</option><option value="MG">MG</option>
        <option value="CMC">CMC (ä¸­è¯)</option><option value="Peugeot">Peugeot</option><option value="Land Rover">Land Rover</option>
        <option value="Mini">Mini</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* é¸æ“‡è»Šå‹</option></select>
      
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œä»¥ä¸‹</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œä»¥ä¸Š</option></select>
      
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page active">
    <div class="header-flex">
      <div class="header-title-box">
        <p id="ui-owner">è¼‰å…¥ä¸­...</p>
        <p id="ui-car-info" style="font-size:13px; color:var(--text-secondary); margin:4px 0 0 0;">--</p>
      </div>
      <div class="shield-badge" id="ui-shield-badge">
        <span class="pulse-dot" id="ui-pulse-dot"></span> 
        <span id="ui-shield-text">é€£ç·šä¸­...</span>
      </div>
    </div>

    <div class="main-visual-container" style="text-align:center;">
      <div class="ring">
        <div style="font-size:46px; font-weight:900; color:var(--accent-color); letter-spacing:-2px; line-height:1;" id="ui-health">--%</div>
        <div style="font-size:11px; color:var(--text-secondary); font-weight:700; margin-top:5px;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
      </div>
      <div class="pm25-badge">ğŸ›¡ï¸ ç´¯è¨ˆæ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:12px; letter-spacing: 0.5px;">æ¿¾ç¶²å•Ÿç”¨æ—¥æœŸ: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>

    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span style="margin-right: 12px; font-size: 18px;">ğŸ’¬</span>
      <div class="marquee-container">
        <span class="marquee-content" id="ui-dynamic-msg">è¼‰å…¥æœ€æ–°ç’°å¢ƒæ•¸æ“šä¸­...</span>
      </div>
    </div>

    <div class="grid-2">
      <div class="env-box">
        <div style="font-size:12px; color:var(--text-secondary); font-weight:600;">ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" style="color:var(--text-primary); font-size:13px;">å®šä½ä¸­...</span></div>
        <div class="env-val" id="env-aqi" style="color:var(--accent-color);">--</div>
        <div style="font-size:10px; font-weight:800; color:var(--text-secondary); letter-spacing:1px;">AQI</div>
      </div>
      <div class="env-box" style="border-color:var(--gold-color);">
        <div style="font-size:12px; color:var(--text-secondary); font-weight:600;">ğŸ  7æ—¥å±…ä½åœ°<br><span id="ui-home-city" style="color:var(--text-primary); font-size:13px;">è®€å–ä¸­...</span></div>
        <div class="env-val" id="env-home-aqi" style="color:var(--gold-color);">--</div>
        <div style="font-size:10px; font-weight:800; color:var(--text-secondary); letter-spacing:1px;">AQI</div>
      </div>
    </div>

    <div class="grid-3">
      <div class="esg-box">
        <div class="esg-badge">æ¥µè‡´ä½é¢¨é˜»</div><div style="font-size:20px; margin-top:12px;">ğŸŒ±</div>
        <div style="font-size:18px; font-weight:700; margin:4px 0;"><span id="ui-esg-co2">0</span> <span style="font-size:10px; color:var(--text-secondary);">kg</span></div>
        <div style="font-size:10px; color:var(--text-secondary); font-weight:600;">çœç¢³è¶³è·¡</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å†·æ°£è¼•è² è¼‰</div><div style="font-size:20px; margin-top:12px;">âš¡ï¸</div>
        <div style="font-size:18px; font-weight:700; margin:4px 0;"><span id="ui-esg-kwh">0</span> <span style="font-size:10px; color:var(--text-secondary);">kWh</span></div>
        <div style="font-size:10px; color:var(--text-secondary); font-weight:600;">çœé›»æ•ˆèƒ½</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å¼·æ•ˆå¤§é¢¨é‡</div><div style="font-size:20px; margin-top:12px;">â›½ï¸</div>
        <div style="font-size:18px; font-weight:700; margin:4px 0;"><span id="ui-esg-ac">0</span> <span style="font-size:10px; color:var(--text-secondary);">%</span></div>
        <div style="font-size:10px; color:var(--text-secondary); font-weight:600;">ç©ºèª¿ç¯€èƒ½</div>
      </div>
    </div>

    <div class="tech-tag-container">
      <div class="tech-tag">ğŸ‡¹ğŸ‡¼ å°ç£è£½é€ </div><div class="tech-tag">âš¡ éœé›»éæ¿¾</div><div class="tech-tag">ğŸ¥¥ æ´»æ€§ç¢³</div>
      <div class="tech-tag">ğŸ“¡ ç©ºæ±™é›·é”</div><div class="tech-tag">ğŸ§  AI æ¼”ç®—</div><div class="tech-tag">ğŸŒ± ESG æ¸›ç¢³</div>
    </div>

    <div id="bulletin-board-container"></div>

    <button class="btn-main" onclick="openFrontendScanner()" style="margin-top:5px; background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;">ğŸ“· æƒæä¸€ç¶­æ¢ç¢¼ (UID) å•Ÿç”¨æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="g-card" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--text-secondary);">å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); border:2px dashed var(--accent-color); padding:15px; border-radius:12px; letter-spacing: 2px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw'">å‰å¾€å•†åŸé¸è³¼</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ“ é ç´„å®‰è£</h3>
    <div class="tab-grid" style="display: flex; gap: 10px; margin-bottom: 20px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')" style="flex:1;">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn" id="tab-btn-manual" onclick="switchBookingTab('manual')" style="flex:1;">ğŸ“‹ ä¿ä¿®å» æ¸…å–®</div>
    </div>
    <div id="booking-smart"><div id="smart-match-result" class="g-card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
    <div id="booking-manual" style="display:none;"><div id="garage-list">æ¸…å–®è®€å–ä¸­...</div></div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div class="tab-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:6px;">
        <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')" style="padding:10px 5px; font-size:11px;">ğŸ‘¤ è³‡æ–™</div>
        <div class="tab-btn" id="tab-set-theme" onclick="switchSetTab('theme')" style="padding:10px 5px; font-size:11px;">ğŸ¨ ç•«é¢</div>
        <div class="tab-btn" id="tab-set-b" onclick="switchSetTab('b')" style="padding:10px 5px; font-size:11px;">ğŸ“œ ç´€éŒ„</div>
        <div class="tab-btn" id="tab-set-c" onclick="switchSetTab('c')" style="padding:10px 5px; font-size:11px;">ğŸ“„ åˆç´„</div>
    </div>
    
    <div id="set-content-a" style="display:block;">
      <div class="g-card">
        <label>è»Šä¸»å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>é›»å­éƒµä»¶</label><input type="email" id="edit-email">
        <label>æ€§åˆ¥</label><select id="edit-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        
        <label>å±…ä½ç¸£å¸‚</label>
        <select id="edit-city" onchange="updateDistricts('edit-city', 'edit-district')">
          <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
          <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
          <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        </select>
        
        <label>é„‰é®å¸‚å€</label><select id="edit-district"></select>
        <label>è©³ç´°é€šè¨Šåœ°å€</label><input type="text" id="edit-address">

        <label>è»Šè¼›å“ç‰Œ</label>
        <select id="edit-brand" onchange="updateCarModels('edit-brand', 'edit-model')">
          <option value="Toyota">Toyota</option><option value="Lexus">Lexus</option><option value="Honda">Honda</option>
          <option value="Nissan">Nissan</option><option value="Ford">Ford</option><option value="Mazda">Mazda</option>
          <option value="Mitsubishi">Mitsubishi</option><option value="Hyundai">Hyundai</option><option value="Kia">Kia</option>
          <option value="Volkswagen">Volkswagen</option><option value="Skoda">Skoda</option><option value="Benz">Benz (M-Benz)</option>
          <option value="BMW">BMW</option><option value="Audi">Audi</option><option value="Volvo">Volvo</option>
          <option value="Porsche">Porsche</option><option value="Tesla">Tesla</option><option value="Subaru">Subaru</option>
          <option value="Suzuki">Suzuki</option><option value="Luxgen">Luxgen</option><option value="MG">MG</option>
          <option value="CMC">CMC (ä¸­è¯)</option><option value="Peugeot">Peugeot</option><option value="Land Rover">Land Rover</option>
          <option value="Mini">Mini</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
        </select>
        <label>è»Šè¼›å‹è™Ÿ</label><select id="edit-model"></select>
        
        <label>å‡ºå» å¹´ä»½</label><input type="number" id="edit-year">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label>
        <select id="edit-mileage"><option value="10000">10,000 å…¬é‡Œä»¥ä¸‹</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œä»¥ä¸Š</option></select>
        
        <button class="btn-main" onclick="updateProfile()" style="margin-top:10px;">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    
    <div id="set-content-theme" style="display:none;">
      <div class="g-card" style="text-align:center; padding: 40px 20px;">
        <h3 style="margin-top:0; color:var(--text-primary); margin-bottom: 30px;">é¸æ“‡é¡¯ç¤ºæ¨¡å¼</h3>
        <div style="display:flex; flex-direction: column; gap:16px;">
          <button class="btn-main" id="btn-theme-dark" style="background:#000000; color:#00e676; border:1px solid #333;" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘</button>
          <button class="btn-main" id="btn-theme-light" style="background:#ffffff; color:#10b981; border:1px solid #ccc;" onclick="setTheme('light')">â˜€ï¸ æ¥µç°¡ç™½</button>
          <button class="btn-main" id="btn-theme-metal" style="background:linear-gradient(145deg, #2c2c2e 0%, #1c1c1e 100%); color:#06b6d4; border:1px solid #3a3a3c;" onclick="setTheme('metal')">ğŸŒŠ æ·¨åŒ–è—</button>
        </div>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="g-card">
        <select onchange="loadHistory(this.value)" style="margin-bottom: 20px; font-weight: 700;">
            <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option>
            <option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 350px; overflow-y: auto;">è®€å–ä¸­...</div>
      </div>
    </div>

    <div id="set-content-c" style="display:none;">
      <div class="g-card">
          <h4 style="margin:0 0 10px 0; color:var(--accent-color); font-size:18px;">ğŸ“„ HYPASS æ•¸ä½ä¿å›ºå¡</h4>
          <p style="font-size:14px; color:var(--text-secondary); margin:8px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--gold-color); font-weight:bold; font-size:18px;"></span></p>
      </div>
    </div>

    <div class="version-tag">System Ver. V8.3 (å‹•ç•«ä¿®å¾©èˆ‡çå‹µæš«åœç‰ˆ)</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">â—“</span><span class="nav-text">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span class="nav-icon">ğŸ›’</span><span class="nav-text">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span class="nav-icon">ğŸ“</span><span class="nav-text">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-text">è¨­å®š</span></div>
  </div>

  <div class="scanner-modal" id="scanner-modal">
    <div class="scanner-box">
      <div class="scanner-hint">è«‹å°‡é¡é ­å°æº–åŒ…è£ä¸Šçš„ä¸€ç¶­æ¢ç¢¼</div>
      <div id="frontend-reader"></div>
      <button class="btn-main" style="width:100%; margin-top:25px; background:#ef4444; color:#fff; box-shadow:none;" onclick="closeScanner()">âœ– å–æ¶ˆæƒæ</button>
    </div>
  </div>

  <script src="main.js"></script>

</body>
</html>
