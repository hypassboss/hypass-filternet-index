<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #121212; color: #fff; padding-bottom: 80px; }
    .page { display: none; padding: 20px; }
    .page.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .btn-main { background: #00D100; color: #000; border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
    .card { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
    .tech-tag { display: inline-block; background: #2a2a2a; color: #aaa; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin: 2px; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #1e1e1e; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #333; z-index: 999; }
    .nav-item { color: #666; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
    .nav-item.active { color: #00D100; font-weight: bold; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100; margin-bottom: 5px;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card" style="border-color: #444; padding: 15px; margin-bottom: 20px;">
      <p style="font-size:12px; color:#aaa; margin:0;">
        <strong>ã€è³‡æ–™æ”¶é›†å®‰å…¨å®£å‘Šã€‘</strong><br>æœ¬ç³»çµ±è’é›†ä¹‹å§“åã€æ‰‹æ©Ÿã€è»Šç‰Œç­‰å€‹è³‡åƒ…ä¾›ä¿å›ºæŸ¥è©¢èˆ‡é ç´„è¯ç¹«ä½¿ç”¨ï¼Œç¬¦åˆå€‹äººè³‡æ–™ä¿è­·æ³•è¦ç¯„ã€‚<br><br>
        <strong>ã€ç³»çµ±ä¼°ç®—å…è²¬æ¢æ¬¾ã€‘</strong><br>æœ¬ App æä¾›ä¹‹æ¿¾ç¶²å¥åº·åº¦ç‚ºç³»çµ±æ¼”ç®—æ³•ä¼°ç®—å€¼ï¼Œå¯¦éš›ç©ºæ°£å“è³ªå—å¤–åœ¨ç’°å¢ƒå½±éŸ¿ï¼Œæœ¬å…¬å¸ä¸è² çµ•å°æ•¸å€¼ä¿è­‰ä¹‹è²¬ã€‚
      </p>
    </div>
    
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#333; color:#fff;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå®¢äºº</button>

    <div id="form-customer" style="display:none; margin-top:20px; animation: fadeIn 0.3s;">
      <h3 style="color:#00D100; border-bottom: 1px solid #333; padding-bottom: 10px;">è»Šä¸»è³‡æ–™ç™»éŒ„</h3>
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <select id="c-gender">
        <option value="">* é¸æ“‡æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option><option value="O">ä¸é¡˜é€éœ²</option>
      </select>
      <select id="c-city">
        <option value="">* å±…ä½ç¸£å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="å…¶ä»–">å…¶ä»–ç¸£å¸‚</option>
      </select>
      <input type="text" id="c-model" placeholder="* è»Šæ¬¾ (ä¾‹ï¼šTesla Model Y)">
      <input type="number" id="c-year" placeholder="* å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage">
        <option value="">* å¹´é‡Œç¨‹ç¿’æ…£</option>
        <option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option><option value="40000">40,000 å…¬é‡Œ</option><option value="50000">50,000 å…¬é‡Œä»¥ä¸Š</option>
      </select>
      <button class="btn-main" onclick="submitRegister('customer')">åŒæ„æ¢æ¬¾ä¸¦å®Œæˆè¨»å†Š</button>
    </div>

    <div id="form-garage" style="display:none; margin-top:20px; animation: fadeIn 0.3s;">
      <h3 style="color:#00D100; border-bottom: 1px solid #333; padding-bottom: 10px;">åŠ ç›Ÿä¿ä¿®å» è³‡æ–™ç™»éŒ„</h3>
      <input type="text" id="g-name" placeholder="* ä¿ä¿®å» åç¨± (ä¾‹ï¼šæµ·å¸•æ–¯å…§æ¹–ç¶­ä¿®ä¸­å¿ƒ)">
      <select id="g-city">
        <option value="">* æ‰€åœ¨ç¸£å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="å…¶ä»–">å…¶ä»–ç¸£å¸‚</option>
      </select>
      <input type="text" id="g-address" placeholder="* è©³ç´°åœ°å€">
      <input type="text" id="g-contact" placeholder="* è¯çµ¡äººå§“å (å» é•·/è€é—†)">
      <input type="tel" id="g-phone" placeholder="* è¯ç¹«é›»è©±">
      <button class="btn-main" onclick="submitRegister('garage')">é€å‡ºå¯©æ ¸è³‡æ–™</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <h3>HYPASS æ™ºèƒ½åº§è‰™</h3>
    <div class="card" style="text-align:center; border-color:#00D100;">
      <h1 id="health-score" style="color:#00D100; font-size:48px; margin:0 0 10px 0;">100%</h1>
      <p style="color:#00D100; font-weight:bold; margin: 0 0 10px 0; font-size: 16px;">Hypass å°ç£è£½æ±½è»Šå†·æ°£æ¿¾ç¶² é˜²è­·ä¸­</p>
      <div>
        <span class="tech-tag">æœ€æ–°éœé›»çº–ç¶­æŠ€è¡“</span>
        <span class="tech-tag">ç†”å™´è¶…ç´°çº–ç¶­æ¿¾æ</span>
        <span class="tech-tag">æ¤°æ®¼é™¤è‡­æ´»æ€§ç¢³</span>
      </div>
    </div>
    <button class="btn-main" onclick="scanFilter()">ğŸ“· æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    <button class="btn-main" style="background:#333; color:#fff;" onclick="generateMGM()">ğŸ”— ç”¢ç”Ÿæ¨è–¦é€£çµè³ºé»æ•¸</button>
  </div>

  <div id="page-book" class="page">
    <h3>ğŸ“ é ç´„å®‰è£</h3>
    <div id="garage-list">è®€å–ä¸­...</div>
  </div>

  <div id="page-settings" class="page">
    <h3>âš™ï¸ æˆ‘çš„å¸³è™Ÿ</h3>
    <p>ç™»å…¥èº«åˆ†: <span id="role-display" style="color:#00D100;"></span></p>
    
    <div id="b2c-rewards" class="card" style="display:none;">
      <h4 style="margin:0;">æˆ‘çš„çå‹µé‡‘ï¼š<span id="reward-balance" style="color:#00D100;">$0</span></h4>
      <button class="btn-main" style="margin-top:10px;" onclick="redeemPoints()">ç”³è«‹å…Œæ› LINE Points</button>
    </div>

    <div id="b2b-panel" class="card" style="display:none; border-color:#FF9800;">
      <h4 style="color:#FF9800;">ğŸ‘¨â€ğŸ”§ å» é•·æ¥å–®çœ‹æ¿</h4>
      <div id="admin-orders"></div>
    </div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><span>â—“</span>é¦–é </div>
    <div class="nav-item" onclick="switchPage('book', this)"><span>ğŸ“</span>é ç´„</div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span>âš™ï¸</span>è¨­å®š</div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );
    let currentUser = null;
    let referrerId = new URLSearchParams(window.location.search).get('ref');

    async function initApp() {
      await liff.init({ liffId: "2009187567-58hBrZRj" });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      
      const profile = await liff.getProfile();
      
      // åš´æ ¼æª¢æŸ¥ï¼šè©² UID æ˜¯å¦å­˜åœ¨æ–¼è³‡æ–™åº«ï¼Ÿä¸”ã€Œå§“åã€æ˜¯å¦æœ‰å¡«å¯«ï¼Ÿ(é¿å…èˆŠçš„åŠæ®˜è³‡æ–™å¹²æ“¾)
      const { data } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).single();
      
      if (data && data.name) {
        // å·²æœ‰å®Œæ•´è¨»å†Šç´€éŒ„ï¼Œé€²å…¥ç³»çµ±
        currentUser = data;
        document.getElementById('nav-bar').style.display = 'flex';
        document.getElementById('role-display').innerText = data.role === 'customer' ? 'æ¿¾ç¶²å®¢äºº (è»Šä¸»)' : 'æ¿¾è¯ç¶²åŠ ç›Ÿå» é•·';
        switchPage('home', document.querySelector('.nav-item'));
        
        if(data.role === 'customer') {
           document.getElementById('b2c-rewards').style.display = 'block';
           loadGarages();
           loadRewards();
        } else if (data.role === 'garage') {
           loadAdminOrders();
        }
      } else {
        // å…¨æ–°ç”¨æˆ¶ï¼Œåœç•™åœ¨è¨»å†Šé 
        switchPage('register', null);
      }
    }

    function showForm(role) {
      document.getElementById('form-customer').style.display = role === 'customer' ? 'block' : 'none';
      document.getElementById('form-garage').style.display = role === 'garage' ? 'block' : 'none';
    }

    // å®Œæ•´çš„è¨»å†Šè³‡æ–™å¯«å…¥é‚è¼¯
    async function submitRegister(role) {
      const uid = (await liff.getProfile()).userId;
      
      if (role === 'customer') {
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        const gender = document.getElementById('c-gender').value;
        const city = document.getElementById('c-city').value;
        const model = document.getElementById('c-model').value;
        const year = document.getElementById('c-year').value;
        const plate = document.getElementById('c-plate').value;
        const mileage = document.getElementById('c-mileage').value;
        
        if(!name || !phone || !gender || !city || !model || !year || !plate || !mileage) return alert('è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨» * çš„å¿…å¡«æ¬„ä½ï¼');

        const { error } = await supabaseClient.from('users').insert([{
          line_uid: uid, role: 'customer', referrer_uid: referrerId,
          name: name, phone: phone, gender: gender, city: city, car_model: model, car_year: year, license_plate: plate, yearly_mileage: mileage
        }]);
        if(!error) location.reload(); else alert("è¨»å†Šå¤±æ•—:" + error.message);

      } else if (role === 'garage') {
        const gName = document.getElementById('g-name').value;
        const city = document.getElementById('g-city').value;
        const address = document.getElementById('g-address').value;
        const contact = document.getElementById('g-contact').value;
        const phone = document.getElementById('g-phone').value;

        if(!gName || !city || !address || !contact || !phone) return alert('è«‹å¡«å¯«æ‰€æœ‰æ¨™è¨» * çš„å¿…å¡«æ¬„ä½ï¼');

        // 1. å¯«å…¥ users è¡¨
        await supabaseClient.from('users').insert([{ line_uid: uid, role: 'garage', name: contact, phone: phone, city: city }]);
        // 2. å¯«å…¥ garages è¡¨ (ç‹€æ…‹é è¨­ç‚º pending)
        const { error } = await supabaseClient.from('garages').insert([{
          owner_uid: uid, name: gName, city: city, address: address, contact_name: contact, phone: phone, status: 'pending'
        }]);

        if(!error) {
          alert("âœ… è³‡æ–™å·²é€å‡ºï¼è«‹ç­‰å¾… HYPASS ç¸½éƒ¨å¯©æ ¸é–‹é€šã€‚");
          location.reload();
        } else alert("è¨»å†Šå¤±æ•—:" + error.message);
      }
    }

    // --- ä»¥ä¸‹ç‚ºæ ¸å¿ƒåŠŸèƒ½é‚è¼¯ (ç¶­æŒä¸è®Š) ---
    async function scanFilter() {
      const res = await liff.scanCodeV2();
      if (!res.value) return;
      const { data } = await supabaseClient.from('filters_uid').select('*').eq('uid', res.value).single();
      if (!data || data.status === 'activated') return alert("ç„¡æ•ˆæˆ–å·²å•Ÿç”¨çš„æ¿¾ç¶²ï¼");
      await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date() }).eq('uid', res.value);
      if (currentUser.referrer_uid) {
        const check = await supabaseClient.from('rewards').select('*').eq('source_uid', currentUser.line_uid);
        if(check.data.length === 0) await supabaseClient.from('rewards').insert([{ user_uid: currentUser.referrer_uid, type: 'earn', amount: 50, source_uid: currentUser.line_uid }]);
      }
      alert("ğŸ‰ å•Ÿç”¨æˆåŠŸï¼é–‹å§‹ä¿è­·æ‚¨çš„åº§è‰™ç©ºæ°£å“è³ªã€‚");
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active');
      let html = '';
      if(data) data.forEach(g => { html += `<div class="card"><h4 style="margin-top:0;">${g.name}</h4><p style="font-size:14px; color:#888;">ğŸ“ ${g.address}</p><p style="color:#00D100; font-weight:bold;">âš™ï¸ ä»£å·¥è²»: NT$ ${g.labor_fee}</p><input type="datetime-local" id="date-${g.id}"><button class="btn-main" onclick="book(${g.id})">é€å‡ºé ç´„</button></div>`; });
      document.getElementById('garage-list').innerHTML = html || '<p>ç›®å‰å°šç„¡å¯ç”¨çš„åŠ ç›Ÿåº—ã€‚</p>';
    }

    async function book(garageId) {
      const time = document.getElementById('date-'+garageId).value;
      if(!time) return alert("è«‹é¸æ“‡é ç´„æ™‚é–“");
      const { error } = await supabaseClient.from('appointments').insert([{ user_uid: currentUser.line_uid, garage_id: garageId, appointment_time: new Date(time) }]);
      if(!error) alert("ğŸ‰ é ç´„æˆåŠŸï¼å» é•·å°‡æœƒç¢ºèªæ‚¨çš„è¨‚å–®ã€‚"); else alert("é ç´„å¤±æ•—");
    }

    async function loadAdminOrders() {
      document.getElementById('b2b-panel').style.display = 'block';
      const garage = await supabaseClient.from('garages').select('id, status').eq('owner_uid', currentUser.line_uid).single();
      if(!garage.data) return;
      if(garage.data.status === 'pending') { document.getElementById('admin-orders').innerHTML = '<p style="color:#888;">æ‚¨çš„å¸³è™Ÿæ­£åœ¨ç­‰å¾…ç¸½éƒ¨å¯©æ ¸é–‹é€šä¸­...</p>'; return; }
      const { data } = await supabaseClient.from('appointments').select('*, users(name, license_plate)').eq('garage_id', garage.data.id).order('appointment_time', { ascending: true });
      let html = '';
      if(data) data.forEach(o => { html += `<div style="border-bottom:1px solid #444; padding:15px 0;"><p style="margin:0 0 5px 0; color:#fff;">ğŸ•’ ${new Date(o.appointment_time).toLocaleString('zh-TW')}</p><p style="margin:0 0 10px 0; color:#888;">ğŸ‘¤ ${o.users.name} (${o.users.license_plate})</p><button class="btn-main" style="padding:10px; font-size:14px;" onclick="updateOrder(${o.id}, 'completed')">å®Œå·¥ä¸¦æ ¸éŠ·</button></div>`; });
      document.getElementById('admin-orders').innerHTML = html || '<p style="color:#888;">ç›®å‰ç„¡å¾…è™•ç†è¨‚å–®ã€‚</p>';
    }

    async function updateOrder(id, status) {
      await supabaseClient.from('appointments').update({ status: status }).eq('id', id); alert("âœ… è¨‚å–®ç‹€æ…‹å·²æ›´æ–°"); loadAdminOrders();
    }

    function generateMGM() {
      const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
      alert(`è«‹è¤‡è£½å‚³çµ¦å¥½å‹ï¼š\n${link}\n\n(å¥½å‹çµå¸³å¯è¼¸å…¥ HYPASS2026 äº«é¦–è³¼å„ªæƒ )`);
    }

    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('type, amount').eq('user_uid', currentUser.line_uid);
      let total = 0;
      if(data) data.forEach(r => { total += (r.type === 'earn' ? r.amount : -r.amount); });
      document.getElementById('reward-balance').innerText = `$${total}`;
    }

    async function redeemPoints() {
      const balText = document.getElementById('reward-balance').innerText.replace('$','');
      if(parseInt(balText) < 100) return alert('çå‹µé‡‘éœ€æ»¿ $100 æ‰èƒ½ç”³è«‹å…Œæ›å–”ï¼');
      if(!confirm('ç¢ºå®šè¦ç”³è«‹å…Œæ› LINE Points å—ï¼Ÿ')) return;
      const { error } = await supabaseClient.from('rewards').insert([{ user_uid: currentUser.line_uid, type: 'redeem', amount: 100 }]);
      if(!error) { alert('âœ… ç”³è«‹å·²é€å‡ºï¼å®¢æœå°‡ç›¡å¿«æ ¸ç™¼ LINE Points çµ¦æ‚¨ã€‚'); loadRewards(); }
    }

    function switchPage(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-'+id).classList.add('active');
      if(el) el.classList.add('active');
    }

    initApp();
  </script>
</body>
</html>
