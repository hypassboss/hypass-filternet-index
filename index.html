<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HYPASS Air+</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #health-score { font-size: 2em; font-weight: bold; margin: 20px 0; }
  </style>
</head>
<body>

  <div class="card">
    <h2>HYPASS Air+ æ™ºèƒ½åº§è‰™</h2>
    <p id="user-info">æ­£åœ¨é€£ç·šè‡³ LINE...</p>
    <div id="health-score" style="color: #00B900;">æ¿¾ç¶²å¥åº·åº¦ï¼š100%</div>
    <button onclick="scanUID()" style="background:#00B900; color:white; border:none; padding:15px 30px; border-radius:5px; font-size:16px;">
      ğŸ“· æƒææ¿¾ç¶² UID
    </button>
  </div>

  <script>
    // 1. æº–å‚™é€£ç·š Supabase
    const supabaseUrl = 'https://qznvabjtxcbffjryfgqi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // 2. å•Ÿå‹• LINE ç™»å…¥ç³»çµ±
    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          document.getElementById('user-info').innerText = 'æ­¡è¿è»Šä¸»ï¼š' + profile.displayName;
        } else {
          liff.login();
        }
      } catch (err) {
        document.getElementById('user-info').innerText = 'ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹åœ¨ LINE å…§é–‹å•Ÿã€‚';
      }
    }

    // 3. æƒæåŠŸèƒ½
    async function scanUID() {
      try {
        const result = await liff.scanCodeV2();
        const scannedUID = result.value;
        if (!scannedUID) return;

        // æª¢æŸ¥ Supabase è³‡æ–™åº«
        const { data, error } = await supabaseClient
          .from('filters_uid')
          .select('*')
          .eq('uid', scannedUID)
          .single();

        if (error || !data) {
          alert("âŒ é©—è­‰å¤±æ•—ï¼šç„¡æ•ˆçš„ UID");
          return;
        }

        if (data.status === 'activated') {
          alert("âš ï¸ æ­¤æ¿¾ç¶²å·²å•Ÿç”¨é");
        } else {
          // æ›´æ–°ç‹€æ…‹
          await supabaseClient
            .from('filters_uid')
            .update({ status: 'activated', activated_at: new Date().toISOString() })
            .eq('uid', scannedUID);
          alert("ğŸ‰ æ¿¾ç¶²å•Ÿå‹•æˆåŠŸï¼");
        }
      } catch (err) {
        alert("æƒæå‡ºéŒ¯");
      }
    }

    initApp();
  </script>
</body>
</html>
