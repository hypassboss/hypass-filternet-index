<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; padding: 0; background-color: #121212; color: #ffffff; padding-bottom: 80px; }
    .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 20px 0; }
    #user-info { color: #888; font-size: 14px; margin: 0; }
    .car-badge { background: #1e1e1e; padding: 5px 15px; border-radius: 20px; font-size: 12px; color: #00D100; border: 1px solid #333; }
    .dashboard-ring { background: #1e1e1e; border-radius: 20px; padding: 40px 20px; text-align: center; border: 1px solid #2a2a2a; }
    .ring-circle { width: 180px; height: 180px; border-radius: 50%; border: 4px dashed #00D100; margin: 0 auto 20px auto; display: flex; flex-direction: column; justify-content: center; }
    #health-score { font-size: 56px; font-weight: bold; color: #00D100; margin: 0; line-height: 1; }
    .btn-main { background: #00D100; color: #000; border: none; padding: 15px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; }
    .data-card { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; }
    .datetime-picker { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; font-size: 16px; }
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
    .status-pending { background: #FF9800; color: #fff; }
    .status-confirmed { background: #03A9F4; color: #fff; }
    .status-completed { background: #00D100; color: #000; }
    .btn-action { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 5px; width: 48%; cursor: pointer; }
    .btn-action.primary { background: #00D100; color: #000; border: none; }
    .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(30, 30, 30, 0.95); border-radius: 20px; display: flex; justify-content: space-around; padding: 15px 0; border: 1px solid #333; z-index: 1000; }
    .nav-item { color: #666; font-size: 24px; text-decoration: none; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .nav-item.active { color: #00D100; }
    .nav-label { font-size: 10px; margin-top: 4px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="page-home" class="page active">
    <div class="header"><p id="user-info">é€£ç·šä¸­...</p><div class="car-badge">â— å·²é€£ç·š</div></div>
    <div class="dashboard-ring">
      <div class="ring-circle"><div id="health-score">100%</div><div style="color: #888; font-size: 14px; margin-top: 5px;">åº§è‰™é˜²è­·åŠ›</div></div>
      <p style="color:#00D100; font-weight:bold; margin-bottom: 0;">æ¥µæ·¨ãƒ»é˜²ç¦¦ä¸­</p>
    </div>
    <button class="btn-main" onclick="scanUID()">ğŸ“· æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page"><h2 style="color:#00D100;">å®˜æ–¹å•†åŸ</h2><p style="color:#888;">Shopline ä¸²æ¥æº–å‚™ä¸­...</p></div>

  <div id="page-book" class="page">
    <h2 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h2>
    <div id="garage-list"><p style="color:#888;">è³‡æ–™è¼‰å…¥ä¸­...</p></div>
  </div>

  <div id="page-settings" class="page">
    <h2 style="color:#00D100;">âš™ï¸ æˆ‘çš„å¸³è™Ÿ</h2>
    <div id="b2c-settings">
      <button class="btn-main" style="background:#333; color:#fff;" onclick="toggleAdminMode()">åˆ‡æ›è‡³ã€Œå» é•·æ¥å–®å¾Œå°ã€æ¸¬è©¦</button>
    </div>
    <div id="b2b-admin-panel" style="display: none;">
      <h3 style="color:#FF9800;">ğŸ‘¨â€ğŸ”§ å» é•·æ¥å–®çœ‹æ¿</h3>
      <div id="admin-order-list"><p style="color:#888;">è®€å–è¨‚å–®ä¸­...</p></div>
      <button class="btn-main" style="background:#333; color:#fff; margin-top:20px;" onclick="toggleAdminMode()">é€€å‡ºå» é•·æ¨¡å¼</button>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('home', this)"><span>â—“</span><span class="nav-label">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span>ğŸ›’</span><span class="nav-label">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span>ğŸ“</span><span class="nav-label">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span>âš™ï¸</span><span class="nav-label">è¨­å®š</span></div>
  </div>

  <script>
    const supabaseUrl = 'https://qznvabjtxcbffjryfgqi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUserId = null;

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" }); 
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          currentUserId = profile.userId;
          document.getElementById('user-info').innerText = profile.displayName + ' çš„åº§è‰™';
          
          // å˜—è©¦æ›´æ–° user è³‡æ–™ (å°±ç®—å¤±æ•—ä¹Ÿä¸å½±éŸ¿é ç´„)
          await supabaseClient.from('users').upsert({ line_uid: currentUserId, name: profile.displayName });
          loadGarages();
        } else {
          liff.login();
        }
      } catch (err) {
        document.getElementById('user-info').innerText = 'è«‹åœ¨ LINE å…§é–‹å•Ÿ';
      }
    }

    function switchPage(pageId, element) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      element.classList.add('active');
    }

    async function loadGarages() {
      const { data, error } = await supabaseClient.from('garages').select('*');
      if (error || !data) return;
      let html = '';
      data.forEach(g => {
        html += `<div class="data-card"><h3 style="margin:0; color:#fff;">${g.name}</h3><p style="color:#888;">ğŸ“ ${g.address}</p><p style="color:#00D100;">âš™ï¸ ä»£å·¥è²»ï¼šNT$ ${g.labor_fee}</p><input type="datetime-local" id="date-${g.id}" class="datetime-picker" /><button class="btn-main" onclick="submitBooking(${g.id}, '${g.name}')">é€å‡ºé ç´„å–®</button></div>`;
      });
      document.getElementById('garage-list').innerHTML = html;
    }

    async function submitBooking(garageId, garageName) {
      const dateInput = document.getElementById('date-' + garageId).value;
      if (!dateInput) return alert('è«‹å…ˆé¸æ“‡æ™‚é–“ï¼');
      
      // é€å‡ºè³‡æ–™åˆ°è³‡æ–™åº«
      const { data, error } = await supabaseClient.from('appointments').insert([
        { user_id: currentUserId, garage_id: garageId, appointment_time: new Date(dateInput).toISOString(), status: 'pending' }
      ]);

      if (error) {
        // é€™è£¡å°±æ˜¯é—œéµï¼å¦‚æœå‡ºéŒ¯ï¼ŒæŠŠéŒ¯èª¤è¨Šæ¯å®Œæ•´é¡¯ç¤ºå‡ºä¾†
        alert('âŒ é ç´„å¤±æ•—ï¼\néŒ¯èª¤ä»£ç¢¼ï¼š' + error.message + '\nç´°ç¯€ï¼š' + JSON.stringify(error));
        console.error("Supabase éŒ¯èª¤:", error);
      } else {
        alert('ğŸ‰ é ç´„æˆåŠŸï¼');
        document.getElementById('date-' + garageId).value = '';
        if(document.getElementById('b2b-admin-panel').style.display === 'block') loadAdminOrders();
      }
    }

    let isAdminMode = false;
    function toggleAdminMode() {
      isAdminMode = !isAdminMode;
      document.getElementById('b2c-settings').style.display = isAdminMode ? 'none' : 'block';
      document.getElementById('b2b-admin-panel').style.display = isAdminMode ? 'block' : 'none';
      if(isAdminMode) loadAdminOrders();
    }

    async function loadAdminOrders() {
      const { data, error } = await supabaseClient.from('appointments').select('*').order('created_at', { ascending: false });
      if (error || !data || data.length === 0) {
        document.getElementById('admin-order-list').innerHTML = '<p style="color:#888;">ç›®å‰æ²’æœ‰è¨‚å–®ã€‚</p>';
        return;
      }
      let html = '';
      data.forEach(order => {
        const aptTime = new Date(order.appointment_time).toLocaleString('zh-TW');
        html += `<div class="data-card"><p style="color:#fff;">ğŸ•’ ${aptTime}</p><p style="color:#888;">ç‹€æ…‹: ${order.status}</p><div style="display:flex; justify-content:space-between; margin-top:10px;">
          ${order.status === 'pending' ? `<button class="btn-action primary" onclick="updateOrderStatus(${order.id}, 'confirmed')">æ¥å–®</button>` : ''}
          ${order.status === 'confirmed' ? `<button class="btn-action primary" onclick="updateOrderStatus(${order.id}, 'completed')">å®Œå·¥</button>` : ''}
        </div></div>`;
      });
      document.getElementById('admin-order-list').innerHTML = html;
    }

    async function updateOrderStatus(orderId, newStatus) {
      const { error } = await supabaseClient.from('appointments').update({ status: newStatus }).eq('id', orderId);
      if (!error) { alert('âœ… ç‹€æ…‹å·²æ›´æ–°ï¼'); loadAdminOrders(); }
    }

    async function scanUID() {
      if (!liff.scanCodeV2) return alert("è«‹åœ¨ LINE å…§æ“ä½œ");
      const res = await liff.scanCodeV2();
      if (!res.value) return;
      const { data, error } = await supabaseClient.from('filters_uid').select('*').eq('uid', res.value).single();
      if (error || !data) return alert("âŒ ç„¡æ•ˆçš„ UIDï¼");
      if (data.status === 'activated') return alert("âš ï¸ æ­¤æ¿¾ç¶²å·²å•Ÿç”¨éã€‚");
      await supabaseClient.from('filters_uid').update({ status: 'activated' }).eq('uid', res.value);
      alert("ğŸ‰ æ¿¾ç¶²å·²å•Ÿç”¨ï¼");
      document.getElementById('health-score').innerText = '100%';
    }

    initApp();
  </script>
</body>
</html>
