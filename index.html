<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* é ‚ç´šæ·±è‰²ç§‘æŠ€æ„Ÿä¸»é¡Œ */
    body { font-family: -apple-system, sans-serif; margin: 0; background: #0a0a0c; color: #fff; padding-bottom: 90px; }
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .card { background: #16181a; padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #2a2d32; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .btn-main { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; box-shadow: 0 4px 10px rgba(0, 209, 0, 0.2); }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; box-sizing: border-box; font-size: 15px; }
    
    /* å„€è¡¨æ¿å°ˆå±¬ UI */
    .vehicle-title { font-size: 18px; font-weight: bold; margin: 0 0 5px 0; color: #fff; }
    .vehicle-sub { font-size: 13px; color: #888; margin: 0 0 10px 0; }
    .tech-tag { display: inline-block; background: #222; color: #00D100; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px 2px 0 0; border: 1px solid #005500; }
    
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .aqi-box { text-align: center; padding: 15px 10px; background: #1e2124; border-radius: 12px; }
    .aqi-val { font-size: 24px; font-weight: bold; color: #00D100; margin: 5px 0; }
    
    .ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
    .ring { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #00D100; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0, 209, 0, 0.1); }
    .ring-val { font-size: 48px; font-weight: bold; color: #00D100; line-height: 1; margin-bottom: 5px; }
    .pm25-text { color: #FF9800; font-size: 13px; margin-top: 15px; font-weight: bold; background: #221500; padding: 6px 12px; border-radius: 20px; border: 1px solid #553300; }
    
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .esg-box { text-align: center; padding: 12px 5px; background: #1a1e1a; border-radius: 12px; border: 1px solid #253025; }
    .esg-icon { font-size: 20px; margin-bottom: 5px; }
    .esg-val { font-size: 16px; font-weight: bold; color: #fff; }
    .esg-label { font-size: 11px; color: #888; margin-top: 3px; }

    /* åº•éƒ¨å°è¦½åˆ— */
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(22, 24, 26, 0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid #2a2d32; z-index: 999; }
    .nav-item { color: #666; font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; width: 20%; }
    .nav-icon { font-size: 22px; margin-bottom: 3px; }
    .nav-item.active { color: #00D100; }
    
    /* é ç´„é ç±¤ */
    .tab-btn { padding: 12px; margin: 0; font-size: 14px; flex: 1; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #333; }
    .tab-btn.active { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border-color: #00D100; box-shadow: 0 4px 10px rgba(0, 209, 0, 0.2); }
    .tab-btn.inactive { background: #1e1e1e; color: #888; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card"><p style="font-size:12px; color:#aaa; margin:0;"><strong>ã€è³‡æ–™å®‰å…¨èˆ‡å…è²¬å®£å‘Šã€‘</strong><br>æœ¬ç³»çµ±è’é›†ä¹‹å€‹è³‡åƒ…ä¾›ä¿å›ºé ç´„ä½¿ç”¨ã€‚æ¿¾ç¶²å£½å‘½ç‚ºæ¼”ç®—æ³•ä¼°ç®—ï¼Œä¸è² çµ•å°æ•¸å€¼ä¿è­‰ã€‚</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#222; color:#fff;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <h3 style="color:#00D100;">è»Šä¸»è³‡æ–™ç™»éŒ„</h3>
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      <select id="c-city"><option value="">* å±…ä½ç¸£å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option></select>
      <input type="text" id="c-model" placeholder="* è»Šæ¬¾ (ä¾‹ï¼šTesla Model Y)">
      <input type="number" id="c-year" placeholder="* å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage"><option value="">* å¹´é‡Œç¨‹ç¿’æ…£</option><option value="10000">1è¬å…¬é‡Œ</option><option value="20000">2è¬å…¬é‡Œ</option><option value="30000">3è¬å…¬é‡Œ</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">åŒæ„æ¢æ¬¾ä¸¦å®Œæˆè¨»å†Š</button>
    </div>
    
    <div id="form-garage" style="display:none; margin-top:20px;">
      <h3 style="color:#00D100;">ä¿ä¿®å» è³‡æ–™ç™»éŒ„</h3>
      <input type="text" id="g-name" placeholder="* ä¿ä¿®å» åç¨±"><select id="g-city"><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option></select><input type="text" id="g-address" placeholder="* è©³ç´°åœ°å€"><input type="text" id="g-contact" placeholder="* å» é•·å§“å"><input type="tel" id="g-phone" placeholder="* è¯ç¹«é›»è©±">
      <button class="btn-main" onclick="submitRegister('garage')">é€å‡ºå¯©æ ¸</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid #00D100;">
      <p class="vehicle-title" id="ui-owner">è®€å–ä¸­...</p>
      <p class="vehicle-sub" id="ui-car-info">è®€å–ä¸­...</p>
      <div style="margin-bottom: 8px;">
        <span style="font-size:13px; color:#00D100; font-weight:bold;">Hypass å°ç£è£½æ±½è»Šå†·æ°£æ¿¾ç¶²</span>
      </div>
      <div>
        <span class="tech-tag">æœ€æ–°éœé›»çº–ç¶­æŠ€è¡“</span><span class="tech-tag">ç†”å™´è¶…ç´°çº–ç¶­æ¿¾æ</span><span class="tech-tag">æ¤°æ®¼é™¤è‡­æ´»æ€§ç¢³</span>
      </div>
    </div>

    <h4 style="margin: 0 0 10px 5px; color:#aaa; font-size: 13px;">ç©ºæ°£å“è³ª</h4>
    <div class="grid-2 mb-15">
      <div class="aqi-box">
        <div style="font-size:11px; color:#888;">ğŸ“ æ‰€åœ¨åœ° (å³æ™‚)</div>
        <div style="font-size:12px; color:#fff; margin-top:4px;" id="ui-gps-location">å®šä½å–å¾—ä¸­...</div>
        <div class="aqi-val" id="ui-aqi-local">45</div>
        <div style="font-size:10px; color:#00D100;">ğŸŸ¢ è‰¯å¥½</div>
      </div>
      <div class="aqi-box">
        <div style="font-size:11px; color:#888;">ğŸ  å±…ä½åœ° (è¿‘7æ—¥)</div>
        <div style="font-size:12px; color:#fff; margin-top:4px;" id="ui-home-city">è®€å–ä¸­...</div>
        <div class="aqi-val" style="color:#FF9800;" id="ui-aqi-home">68</div>
        <div style="font-size:10px; color:#FF9800;">ğŸŸ¡ æ™®é€š</div>
      </div>
    </div>

    <div class="card" style="text-align: center; margin-top:15px;">
      <div class="ring-container">
        <div class="ring"><div class="ring-val" id="ui-health">100%</div><div style="font-size:12px; color:#888;">æ¿¾ç¶²å£½å‘½</div></div>
        <div class="pm25-text">ğŸ›¡ï¸ å·²æ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      </div>
      <button class="btn-main" onclick="scanFilter()">ğŸ“· æƒæå•Ÿç”¨æ–°æ¿¾ç¶²é‡ç½®</button>
    </div>

    <h4 style="margin: 0 0 10px 5px; color:#aaa; font-size: 13px;">ç¶ èƒ½èˆ‡ ESG è²¢ç»</h4>
    <div class="grid-3">
      <div class="esg-box"><div class="esg-icon">ğŸŒ±</div><div class="esg-val"><span id="ui-esg-co2">0</span> kg</div><div class="esg-label">çœç¢³è¶³è·¡</div></div>
      <div class="esg-box"><div class="esg-icon">âš¡ï¸</div><div class="esg-val"><span id="ui-esg-kwh">0</span> kWh</div><div class="esg-label">çœé›»æ•ˆèƒ½</div></div>
      <div class="esg-box"><div class="esg-icon">â›½ï¸</div><div class="esg-val"><span id="ui-esg-oil">12</span> %</div><div class="esg-label">ç©ºèª¿ç¯€èƒ½æå‡</div></div>
    </div>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:#00D100;">ğŸ›’ HYPASS å®˜æ–¹å•†åŸ</h3>
    <div class="card" style="text-align:center;">
      <p style="color:#aaa;">è»Šä¸»å°ˆå±¬ï¼çµå¸³è¼¸å…¥ä»£ç¢¼äº«å„ªæƒ ï¼š</p>
      <h2 style="color:#00D100; letter-spacing: 2px; border: 1px dashed #00D100; padding: 10px;">AIRPLUS2026</h2>
      <button class="btn-main" style="background:#333; color:#fff;" onclick="alert('Shopline ä¸²æ¥æº–å‚™ä¸­...')">å‰å¾€å•†åŸè³¼ç‰©</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h3>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
      <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
      <div class="tab-btn inactive" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ æ‰‹å‹•é¸å–æ¸…å–®</div>
    </div>

    <div id="booking-smart" style="display: block;">
      <div class="card" style="text-align:center; border-color:#00D100;">
        <h4 style="color:#00D100; margin-top:0;">ç‚ºæ‚¨é…å°æœ€è¿‘çš„æ——è‰¦ä¿ä¿®å» </h4>
        <p style="font-size:13px; color:#888;">ç³»çµ±å°‡ä¾æ“šæ‚¨çš„æ‰€åœ¨åœ°èˆ‡è»Šç¨®ï¼Œæ¨è–¦æœ€é©åˆçš„å°ˆæ¥­æŠ€å¸«ã€‚</p>
        <div id="smart-match-result" style="margin-top: 15px; padding: 15px; background: #000; border-radius: 12px; border: 1px solid #333;">
          åˆ†æå®šä½èˆ‡è»Šå‹ä¸­...
        </div>
      </div>
    </div>

    <div id="booking-manual" style="display: none;">
      <div id="garage-list">è®€å–ä¸­...</div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:#00D100;">ğŸ çå‹µèˆ‡æ¨è–¦</h3>
    <div class="card" style="border-color:#FF9800;">
      <h4 style="margin:0; color:#FF9800;">æˆ‘çš„çå‹µé‡‘é¤˜é¡</h4>
      <h1 style="margin:10px 0; color:#fff;"><span id="reward-balance">$0</span></h1>
      <p style="font-size:12px; color:#888;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Points</p>
      <button class="btn-main" style="background:#FF9800; color:#000;" onclick="redeemPoints()">ç”³è«‹å…Œæ› LINE Points</button>
    </div>
    <div class="card">
      <h4>ğŸ”— æ¨è–¦å¥½å‹è³¼ç¶²</h4>
      <p style="font-size:12px; color:#888;">å¥½å‹é€éé€£çµè³¼è²·ä¸¦å®‰è£ï¼Œæ‚¨å¯ç²å¾— $50 çå‹µé‡‘ï¼</p>
      <button class="btn-main" style="background:#333; color:#fff;" onclick="generateMGM()">è¤‡è£½æˆ‘çš„å°ˆå±¬æ¨è–¦é€£çµ</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:#00D100;">âš™ï¸ è¨­å®šèˆ‡æ•¸ä½ä¿å›º</h3>
    <div class="card">
      <h4 style="margin:0 0 10px 0;">ğŸ“„ æ•¸ä½åˆç´„èˆ‡ä¿å›ºç´€éŒ„</h4>
      <p style="font-size:13px; color:#aaa; margin:5px 0;">ç¶å®šè»Šç‰Œï¼š<span id="set-plate" style="color:#fff;"></span></p>
      <p style="font-size:13px; color:#aaa; margin:5px 0;">æœ€è¿‘å•Ÿç”¨æ—¥æœŸï¼š<span id="set-date" style="color:#fff;">å°šæœªå•Ÿç”¨</span></p>
      <p style="font-size:11px; color:#666; margin-top:15px; padding-top:10px; border-top:1px solid #333;">æœ¬ç”¢å“æä¾›éæ¿¾æ•ˆèƒ½ä¿è­‰ï¼Œæ¿¾ç¶²å£½å‘½è¦–å¯¦éš›ç”¨è»Šç’°å¢ƒè€Œå®šã€‚è³‡æ–™åƒ…ä¾› HYPASS ä¿å›ºæ ¸å°ä½¿ç”¨ã€‚</p>
    </div>
    <div id="b2b-panel" class="card" style="display:none; border-color:#FF9800;">
      <h4 style="color:#FF9800;">ğŸ‘¨â€ğŸ”§ å» é•·æ¥å–®çœ‹æ¿</h4>
      <div id="admin-orders"></div>
    </div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><div class="nav-icon">â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="switchPage('shop', this)"><div class="nav-icon">ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="switchPage('book', this)"><div class="nav-icon">ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><div class="nav-icon">ğŸ</div>çå‹µ</div>
    <div class="nav-item" onclick="switchPage('settings', this)"><div class="nav-icon">âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );
    let currentUser = null;
    let referrerId = new URLSearchParams(window.location.search).get('ref');

    async function initApp() {
      await liff.init({ liffId: "2009187567-58hBrZRj" });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const profile = await liff.getProfile();
      
      const { data } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).single();
      
      if (data && data.name) {
        currentUser = data;
        document.getElementById('nav-bar').style.display = 'flex';
        switchPage('home', document.querySelector('.nav-item'));
        
        if(data.role === 'customer') {
           document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
           document.getElementById('ui-car-info').innerText = `${data.car_model} | ${data.license_plate}`;
           document.getElementById('ui-home-city').innerText = data.city;
           document.getElementById('set-plate').innerText = data.license_plate;
           
           getGPSLocation(); // åŸ·è¡Œæœ€æ–°ç²¾æº–å®šä½è§£æ
           calculateDashboardStats();
           loadGarages();
           loadRewards();
           doSmartMatch();
        } else if (data.role === 'garage') {
           document.getElementById('b2b-panel').style.display = 'block';
           loadAdminOrders();
        }
      } else {
        switchPage('register', null);
      }
    }

    // --- å…¨æ–°è§£ææ¼”ç®—æ³•ï¼šé€éå…è²» API å°‡ç¶“ç·¯åº¦è½‰æ›ç‚ºã€Œç¸£å¸‚ã€å€åŸŸã€ ---
    function getGPSLocation() {
      const locElement = document.getElementById('ui-gps-location');
      if (navigator.geolocation) {
        locElement.innerText = "ğŸ“ å–å¾—å®šä½ä¸­...";
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            try {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              // å‘¼å«é–‹æºé€†åœ°ç†ç·¨ç¢¼ API (OSM Nominatim)
              const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
              const data = await res.json();
              if (data && data.address) {
                // å„ªå…ˆæŠ“å–ç¸£å¸‚èˆ‡é„‰é®å¸‚å€è³‡æ–™
                const city = data.address.city || data.address.county || "å°ç£";
                const district = data.address.suburb || data.address.town || data.address.village || data.address.borough || "";
                
                let locationString = `ğŸ“ ${city}`;
                if (district) locationString += `ã€${district}`;
                locElement.innerText = locationString;
                locElement.style.color = "#00D100";
              } else {
                locElement.innerText = "ğŸ“ GPS å·²é€£ç·š (è§£æä¸­)";
              }
            } catch (e) {
              locElement.innerText = "ğŸ“ å°ç£å®šä½å€ (GPSå·²é€£ç·š)";
            }
          },
          (error) => { locElement.innerText = "âš ï¸ æœªæˆæ¬Šå®šä½ï¼Œä»¥é è¨­å€åŸŸé¡¯ç¤º"; locElement.style.color = "#FF9800"; }
        );
      } else {
        locElement.innerText = "âš ï¸ è£ç½®ä¸æ”¯æ´å®šä½";
      }
    }

    async function calculateDashboardStats() {
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if(filter && filter.activated_at) {
        document.getElementById('set-date').innerText = new Date(filter.activated_at).toLocaleDateString('zh-TW');
        const actDate = new Date(filter.activated_at);
        const daysActive = Math.max(0, Math.floor((new Date() - actDate) / (1000 * 60 * 60 * 24)));
        
        let health = Math.max(0, 100 - (daysActive * 0.27)); 
        let pm25 = daysActive * 1250; 
        let co2 = (daysActive * 0.15).toFixed(1);
        let kwh = (daysActive * 0.3).toFixed(1);
        
        document.getElementById('ui-health').innerText = `${Math.round(health)}%`;
        document.getElementById('ui-health').style.color = health < 30 ? '#FF0000' : (health < 70 ? '#FF9800' : '#00D100');
        document.getElementById('ui-pm25').innerText = pm25.toLocaleString();
        document.getElementById('ui-esg-co2').innerText = co2;
        document.getElementById('ui-esg-kwh').innerText = kwh;
      }
    }

    function showForm(role) {
      document.getElementById('form-customer').style.display = role === 'customer' ? 'block' : 'none';
      document.getElementById('form-garage').style.display = role === 'garage' ? 'block' : 'none';
    }

    async function submitRegister(role) {
      const uid = (await liff.getProfile()).userId;
      if (role === 'customer') {
        const name = document.getElementById('c-name').value;
        const phone = document.getElementById('c-phone').value;
        const city = document.getElementById('c-city').value;
        const model = document.getElementById('c-model').value;
        const plate = document.getElementById('c-plate').value;
        if(!name || !city || !model || !plate) return alert('è«‹å¡«å¯«å¿…å¡«æ¬„ä½ï¼');

        const { error } = await supabaseClient.from('users').insert([{
          line_uid: uid, role: 'customer', referrer_uid: referrerId, name: name, phone: phone, city: city, car_model: model, license_plate: plate
        }]);
        if(!error) location.reload(); else alert("è¨»å†Šå¤±æ•—");
      } else {
        const gName = document.getElementById('g-name').value;
        if(!gName) return alert('è«‹å¡«å¯«å» å');
        await supabaseClient.from('users').insert([{ line_uid: uid, role: 'garage', name: gName }]);
        await supabaseClient.from('garages').insert([{ owner_uid: uid, name: gName, status: 'pending' }]);
        alert("è³‡æ–™å·²é€å‡ºå¯©æ ¸ã€‚"); location.reload();
      }
    }

    async function scanFilter() {
      const res = await liff.scanCodeV2();
      if (!res.value) return;
      const { data } = await supabaseClient.from('filters_uid').select('*').eq('uid', res.value).single();
      if (!data || data.status === 'activated') return alert("ç„¡æ•ˆæˆ–å·²å•Ÿç”¨çš„æ¿¾ç¶²ï¼");
      await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date() }).eq('uid', res.value);
      if (currentUser.referrer_uid) {
        const check = await supabaseClient.from('rewards').select('*').eq('source_uid', currentUser.line_uid);
        if(check.data.length === 0) await supabaseClient.from('rewards').insert([{ user_uid: currentUser.referrer_uid, type: 'earn', amount: 50, source_uid: currentUser.line_uid }]);
      }
      alert("ğŸ‰ å•Ÿç”¨æˆåŠŸï¼é–‹å§‹ä¿è­·æ‚¨çš„åº§è‰™ç©ºæ°£å“è³ªã€‚");
      calculateDashboardStats(); 
    }

    function switchBookingTab(tab) {
      if(tab === 'smart') {
        document.getElementById('booking-smart').style.display = 'block';
        document.getElementById('booking-manual').style.display = 'none';
        document.getElementById('tab-btn-smart').className = 'tab-btn active';
        document.getElementById('tab-btn-manual').className = 'tab-btn inactive';
      } else {
        document.getElementById('booking-smart').style.display = 'none';
        document.getElementById('booking-manual').style.display = 'block';
        document.getElementById('tab-btn-smart').className = 'tab-btn inactive';
        document.getElementById('tab-btn-manual').className = 'tab-btn active';
      }
    }

    async function doSmartMatch() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active').limit(1);
      if(data && data.length > 0) {
        const g = data[0];
        document.getElementById('smart-match-result').innerHTML = `
          <h4 style="margin:0 0 5px 0; color:#fff;">âœ¨ é¦–é¸æ¨è–¦ï¼š${g.name}</h4>
          <p style="font-size:12px; color:#aaa; margin:0 0 10px 0;">ğŸ“ ${g.city} | ä»£å·¥è²» $${g.labor_fee} | è©•åƒ¹ 4.9 â­ï¸</p>
          <input type="datetime-local" id="date-smart-${g.id}" style="margin-bottom:10px; background:#1e1e1e;">
          <button class="btn-main" style="margin:0; padding:12px;" onclick="book(${g.id}, 'smart')">ä¸€éµæ™ºæ…§é ç´„</button>
        `;
      } else {
        document.getElementById('smart-match-result').innerHTML = '<p style="color:#FF9800;">ç›®å‰é™„è¿‘å°šç„¡å¯ç”¨åŠ ç›Ÿåº—ã€‚</p>';
      }
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active');
      let html = '';
      if(data) data.forEach(g => { html += `<div class="card"><h4 style="margin-top:0;">${g.name}</h4><p style="font-size:14px; color:#888;">ğŸ“ ${g.address}</p><p style="color:#00D100; font-weight:bold;">âš™ï¸ ä»£å·¥è²»: NT$ ${g.labor_fee}</p><input type="datetime-local" id="date-${g.id}"><button class="btn-main" onclick="book(${g.id})">é€å‡ºé ç´„</button></div>`; });
      document.getElementById('garage-list').innerHTML = html || '<p>ç›®å‰å°šç„¡å¯ç”¨çš„åŠ ç›Ÿåº—ã€‚</p>';
    }

    async function book(garageId, prefix = '') {
      const inputId = prefix ? `date-${prefix}-${garageId}` : `date-${garageId}`;
      const time = document.getElementById(inputId).value;
      if(!time) return alert("è«‹é¸æ“‡é ç´„æ™‚é–“");
      const { error } = await supabaseClient.from('appointments').insert([{ user_uid: currentUser.line_uid, garage_id: garageId, appointment_time: new Date(time) }]);
      if(!error) alert("ğŸ‰ é ç´„æˆåŠŸï¼å» é•·å°‡æœƒç¢ºèªæ‚¨çš„è¨‚å–®ã€‚"); else alert("é ç´„å¤±æ•—");
    }

    async function loadAdminOrders() {
      const garage = await supabaseClient.from('garages').select('id, status').eq('owner_uid', currentUser.line_uid).single();
      if(!garage.data) return;
      if(garage.data.status === 'pending') { document.getElementById('admin-orders').innerHTML = '<p style="color:#888;">æ‚¨çš„å¸³è™Ÿå¯©æ ¸ä¸­...</p>'; return; }
      const { data } = await supabaseClient.from('appointments').select('*, users(name, license_plate)').eq('garage_id', garage.data.id).order('appointment_time', { ascending: true });
      let html = '';
      if(data) data.forEach(o => { html += `<div style="border-bottom:1px solid #333; padding:15px 0;"><p style="margin:0 0 5px 0; color:#fff;">ğŸ•’ ${new Date(o.appointment_time).toLocaleString('zh-TW')}</p><p style="margin:0 0 10px 0; color:#888;">ğŸ‘¤ ${o.users.name} (${o.users.license_plate})</p><button class="btn-main" style="padding:10px; font-size:14px;" onclick="updateOrder(${o.id}, 'completed')">å®Œå·¥ä¸¦æ ¸éŠ·</button></div>`; });
      document.getElementById('admin-orders').innerHTML = html || '<p style="color:#888;">ç„¡å¾…è™•ç†è¨‚å–®ã€‚</p>';
    }

    async function updateOrder(id, status) {
      await supabaseClient.from('appointments').update({ status: status }).eq('id', id); alert("âœ… ç‹€æ…‹å·²æ›´æ–°"); loadAdminOrders();
    }

    function generateMGM() {
      const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(link).then(() => {
          alert(`âœ… å°ˆå±¬é€£çµå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\nè«‹ç›´æ¥è²¼ä¸Šå‚³çµ¦å¥½å‹å³å¯ã€‚\n\n(å¥½å‹çµå¸³å¯è¼¸å…¥ AIRPLUS2026 äº«é¦–è³¼å„ªæƒ )`);
        }).catch(() => { alert(`è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹é€£çµå‚³çµ¦å¥½å‹ï¼š\n${link}`); });
      } else { alert(`è«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹é€£çµå‚³çµ¦å¥½å‹ï¼š\n${link}`); }
    }

    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('type, amount').eq('user_uid', currentUser.line_uid);
      let total = 0;
      if(data) data.forEach(r => { total += (r.type === 'earn' ? r.amount : -r.amount); });
      document.getElementById('reward-balance').innerText = `$${total}`;
    }

    async function redeemPoints() {
      const balText = document.getElementById('reward-balance').innerText.replace('$','');
      if(parseInt(balText) < 100) return alert('çå‹µé‡‘éœ€æ»¿ $100 æ‰èƒ½å…Œæ›å–”ï¼');
      if(!confirm('ç¢ºå®šç”³è«‹å…Œæ› LINE Pointsï¼Ÿ')) return;
      const { error } = await supabaseClient.from('rewards').insert([{ user_uid: currentUser.line_uid, type: 'redeem', amount: 100 }]);
      if(!error) { alert('âœ… ç”³è«‹å·²é€å‡ºï¼'); loadRewards(); }
    }

    function switchPage(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-'+id).classList.add('active');
      if(el) el.classList.add('active');
    }

    initApp();
  </script>
</body>
</html>
