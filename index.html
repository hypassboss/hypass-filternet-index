<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #0a0a0c; color: #fff; padding-bottom: 90px; }
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .card { background: #16181a; padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #2a2d32; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .btn-main { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; box-sizing: border-box; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(22, 24, 26, 0.95); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid #2a2d32; z-index: 999; }
    .nav-item { color: #666; font-size: 11px; cursor: pointer; text-align: center; width: 20%; }
    .nav-item.active { color: #00D100; font-weight: bold; }
    .tech-tag { display: inline-block; background: #222; color: #00D100; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px 2px 0 0; border: 1px solid #005500; }
    
    /* æ°£è±¡èˆ‡ç©ºæ±™å°ˆå±¬ UI */
    .env-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .env-box { background: #1a1e1a; border-radius: 10px; padding: 12px 5px; text-align: center; border: 1px solid #2a2d32; }
    .env-val { font-size: 22px; font-weight: bold; color: #fff; margin: 5px 0; }
    .alert-danger { background: #ff0000; color: #fff; padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); } }

    .ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
    .ring { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #00D100; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0, 209, 0, 0.1); }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .tab-btn { padding: 12px; margin: 0; font-size: 14px; flex: 1; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #333; }
    .tab-btn.active { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border-color: #00D100; }
    .tab-btn.inactive { background: #1e1e1e; color: #888; }
    .log-item { border-bottom: 1px solid #333; padding: 10px 0; font-size: 13px; color: #aaa; }
    .log-item:last-child { border-bottom: none; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card"><p style="font-size:12px; color:#aaa; margin:0;">æœ¬ç³»çµ±è’é›†è³‡æ–™åƒ…ä¾›ä¿å›ºé ç´„ä½¿ç”¨ã€‚</p></div>
    <button class="btn-main" onclick="window.showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#222; color:#fff;" onclick="window.showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å"><input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼"><input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      <select id="c-city"><option value="">* å±…ä½ç¸£å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option></select>
      <select id="c-brand" onchange="window.updateCarModels('c-brand', 'c-model')"><option value="">* é¸æ“‡å“ç‰Œ</option><option value="Tesla">Tesla</option><option value="Toyota">Toyota</option><option value="Other">å…¶ä»–</option></select>
      <select id="c-model"><option value="">* é¸æ“‡è»Šå‹</option></select>
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½"><input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      <select id="c-mileage"><option value="10000">1è¬å…¬é‡Œ</option><option value="20000" selected>2è¬å…¬é‡Œ</option><option value="30000">3è¬å…¬é‡Œ</option><option value="50000">5è¬å…¬é‡Œä»¥ä¸Š</option></select>
      <button class="btn-main" onclick="window.submitRegister('customer')">å®Œæˆè¨»å†Š</button>
    </div>
    
    <div id="form-garage" style="display:none; margin-top:20px;">
      <input type="text" id="g-name" placeholder="* åº—å"><input type="email" id="g-email" placeholder="* ä¿¡ç®±">
      <select id="g-city"><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option></select>
      <input type="text" id="g-address" placeholder="* åœ°å€"><input type="text" id="g-contact" placeholder="* å» é•·"><input type="tel" id="g-phone" placeholder="* é›»è©±">
      <button class="btn-main" onclick="window.submitRegister('garage')">é€å‡ºå¯©æ ¸</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid #00D100; margin-bottom: 10px;">
      <p id="ui-owner" style="font-size:18px; font-weight:bold; margin:0;">è®€å–ä¸­...</p>
      <p id="ui-car-info" style="font-size:13px; color:#888; margin:5px 0 10px 0;">è®€å–ä¸­...</p>
      <div><span class="tech-tag">é†«ç™‚ç´šéœé›»æŠ€è¡“</span><span class="tech-tag">æ°£å€™é€£å‹•æ¼”ç®—</span></div>
    </div>
    
    <div id="aqi-severe-alert" class="alert-danger">âš ï¸ [ç´«çˆ†è­¦å ±] æ‰€åœ¨å€åŸŸç©ºæ°£å“è³ªæƒ¡åŠ£ï¼Œè«‹ç·Šé–‰è»Šçª—ä¸¦é–‹å•Ÿå…§å¾ªç’°ï¼</div>

    <div style="font-size:12px; color:#aaa; margin-bottom:5px;">ğŸŒ <span id="ui-loc-name">é›·é”é€£ç·šä¸­...</span> å³æ™‚ç’°å¢ƒ</div>
    <div class="env-grid">
      <div class="env-box">
        <div style="font-size:11px; color:#888;">æº«åº¦</div>
        <div class="env-val" id="env-temp">--Â°C</div>
      </div>
      <div class="env-box">
        <div style="font-size:11px; color:#888;">æ¿•åº¦</div>
        <div class="env-val" id="env-hum" style="color:#4fa3ff;">--%</div>
      </div>
      <div class="env-box">
        <div style="font-size:11px; color:#888;">AQI æŒ‡æ•¸</div>
        <div class="env-val" id="env-aqi" style="color:#00D100;">--</div>
      </div>
    </div>

    <div class="card" style="text-align: center; margin-top:5px;">
      <div class="ring-container">
        <div class="ring">
          <div style="font-size:48px; font-weight:bold; color:#00D100;" id="ui-health">100%</div>
          <div style="font-size:12px; color:#888;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
        </div>
        <div style="color:#FF9800; font-size:13px; margin-top:15px; font-weight:bold; background:#221500; padding:6px 12px; border-radius:20px;">
          ğŸ›¡ï¸ å·²æ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg
        </div>
      </div>
      <button class="btn-main" onclick="window.scanFilter()">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    </div>
    
    <div class="grid-3">
      <div class="esg-box"><div style="font-size:20px;">ğŸŒ±</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-co2">0</span> kg</div><div style="font-size:11px; color:#888;">çœç¢³è¶³è·¡</div></div>
      <div class="esg-box"><div style="font-size:20px;">âš¡ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-kwh">0</span> kWh</div><div style="font-size:11px; color:#888;">çœé›»æ•ˆèƒ½</div></div>
      <div class="esg-box"><div style="font-size:20px;">â›½ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;">12 %</div><div style="font-size:11px; color:#888;">ç©ºèª¿ç¯€èƒ½</div></div>
    </div>
  </div>

  <div id="page-shop" class="page"><h3 style="color:#00D100;">ğŸ›’ å•†åŸ</h3><button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw/oauth/line/quick_sign_up'">è‡ªå‹•ç™»å…¥å•†åŸ</button></div>
  <div id="page-book" class="page"><h3 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h3><div id="garage-list">è®€å–ä¸­...</div></div>
  <div id="page-rewards" class="page"><h3 style="color:#00D100;">ğŸ çå‹µ</h3><h1 id="reward-balance">$0</h1><button class="btn-main" onclick="window.redeemPoints()">ç”³è«‹å…Œæ›</button></div>
  <div id="page-settings" class="page"><h3 style="color:#00D100;">âš™ï¸ è¨­å®š</h3><div id="history-container"></div></div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="window.switchPage('home', this)"><div style="font-size:22px;">â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="window.switchPage('shop', this)"><div style="font-size:22px;">ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="window.switchPage('book', this)"><div style="font-size:22px;">ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="window.switchPage('rewards', this)"><div style="font-size:22px;">ğŸ</div>çå‹µ</div>
    <div class="nav-item" onclick="window.switchPage('settings', this)"><div style="font-size:22px;">âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    window.onerror = function(msg) { console.log(msg); return false; };
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    
    let currentUser = null;
    let currentLocName = 'å°ç£';
    
    // å…¨åŸŸç’°å¢ƒåƒæ•¸ (å°‡å½±éŸ¿æ¼”ç®—æ³•)
    let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };

    const carData = { "Tesla": ["Model Y", "Model 3"], "Toyota": ["RAV4", "Corolla Cross"], "Other": ["å…¶ä»–"] };
    window.updateCarModels = function(b, m) { document.getElementById(m).innerHTML = '<option value="">* è»Šå‹</option>'; if(carData[document.getElementById(b).value]) carData[document.getElementById(b).value].forEach(i => document.getElementById(m).innerHTML += `<option value="${i}">${i}</option>`); };
    window.switchPage = function(id, el) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('page-'+id).classList.add('active'); if(el) el.classList.add('active'); };

    // ğŸŒŸ å…¨æ–°ï¼æŠ“å–å³æ™‚å¤©æ°£èˆ‡ç©ºæ±™ API (ä½¿ç”¨å…è²»é–‹æºçš„ Open-Meteo)
    async function fetchEnvironmentalData(lat, lon) {
      try {
        // 1. æŠ“æº«åº¦èˆ‡æ¿•åº¦
        const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m`);
        const weather = await weatherRes.json();
        envData.temp = weather.current.temperature_2m;
        envData.hum = weather.current.relative_humidity_2m;
        
        // 2. æŠ“ AQI èˆ‡ PM2.5
        const aqiRes = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&current=pm2_5,aqi`);
        const aqi = await aqiRes.json();
        envData.pm25 = aqi.current.pm2_5;
        envData.aqi = aqi.current.aqi;

        // 3. æ›´æ–°ç•«é¢ UI
        document.getElementById('env-temp').innerText = `${envData.temp}Â°C`;
        document.getElementById('env-hum').innerText = `${envData.hum}%`;
        document.getElementById('env-aqi').innerText = envData.aqi;
        
        const aqiEl = document.getElementById('env-aqi');
        if(envData.aqi > 150) { aqiEl.style.color = '#ff0000'; document.getElementById('aqi-severe-alert').style.display = 'block'; }
        else if (envData.aqi > 100) { aqiEl.style.color = '#ff9800'; }
        else { aqiEl.style.color = '#00D100'; }

        // 4. æœ‰äº†å³æ™‚æ•¸æ“šï¼Œé‡æ–°è¨ˆç®—æ›´ç²¾æº–çš„å£½å‘½
        calculateDashboardStats();

      } catch (e) { console.log("æ°£è±¡é€£ç·šå¤±æ•—", e); calculateDashboardStats(); }
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude; const lon = pos.coords.longitude;
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
            const d = await res.json();
            currentLocName = `${d.address.city||''}${d.address.suburb||d.address.town||''}`;
            document.getElementById('ui-loc-name').innerText = `ğŸ“ ${currentLocName}`;
            
            // å®šä½æˆåŠŸå¾Œï¼Œè§¸ç™¼æ°£è±¡å¤§æ•¸æ“šå¼•æ“
            fetchEnvironmentalData(lat, lon);
          } catch(e) { document.getElementById('ui-loc-name').innerText = "ğŸ“ GPS é€£ç·šä¸­"; calculateDashboardStats(); }
        }, () => { calculateDashboardStats(); }); // æ‹’çµ•å®šä½å‰‡ç”¨é è¨­å€¼ç®—
      }
    }

    // ğŸŒŸ å…¨æ–°ï¼æ°£å€™é€£å‹•å¤§æ•¸æ“šæ¼”ç®—å¼•æ“
    async function calculateDashboardStats() {
      if(!currentUser) return;
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if(filter && filter.activated_at) {
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000*60*60*24)));
        
        // ã€å‹•æ…‹åƒæ•¸çŸ©é™£ã€‘
        let baseDecay = 0.27; // åŸºç¤æ¯æ—¥è€—æ
        let basePm25 = 1250;  // åŸºç¤æ¯æ—¥æ””æˆªé‡
        
        // 1. é‡Œç¨‹ä¿‚æ•¸ (é–‹å¾—å¤šæè€—å¿«)
        let mileageRate = currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0;
        
        // 2. AQI ç©ºæ±™ä¿‚æ•¸ (ç’°å¢ƒæ„ˆç³Ÿæè€—æ„ˆå¿«)
        let aqiRate = 1.0;
        if(envData.aqi > 150) aqiRate = 1.8;
        else if(envData.aqi > 100) aqiRate = 1.4;
        else if(envData.aqi < 30) aqiRate = 0.8; // å¥½ç©ºæ°£æ¶ˆè€—æ…¢
        
        // 3. æ¿•åº¦ä¿‚æ•¸ (æ¿•åº¦å¤§æ–¼80%ï¼Œç™¼éœ‰é¢¨éšªå¢é«˜ï¼Œå£½å‘½æ‰£æ¸›åŠ é€Ÿ)
        let humRate = envData.hum > 80 ? 1.2 : 1.0;

        // ç¶œåˆé‹ç®—
        let totalMultiplier = mileageRate * aqiRate * humRate;
        
        let finalHealth = 100 - (days * baseDecay * totalMultiplier);
        let finalPm25 = days * basePm25 * mileageRate * aqiRate; // æ¿•åº¦ä¸å½±éŸ¿ç‰©ç†æ””æˆªé‡

        // å¯«å…¥å„€è¡¨æ¿
        const healthEl = document.getElementById('ui-health');
        healthEl.innerText = `${Math.max(0, Math.round(finalHealth))}%`;
        if(finalHealth < 30) healthEl.style.color = '#ff0000';
        
        document.getElementById('ui-pm25').innerText = Math.round(finalPm25).toLocaleString();
        document.getElementById('ui-esg-co2').innerText = (days * 0.15).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = (days * 0.3).toFixed(1);
      }
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const { data } = await supabaseClient.from('users').select('*').eq('line_uid', (await liff.getProfile()).userId).maybeSingle();
        if (data && data.name) {
          currentUser = data; document.getElementById('nav-bar').style.display = 'flex';
          if(data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model}`;
            window.switchPage('home', document.querySelector('.nav-item'));
            getGPS(); // å•Ÿå‹•ä¸€é€£ä¸²çš„ GPS -> å¤©æ°£ -> æ¼”ç®—æ³•è¨ˆç®—
          }
        } else { window.switchPage('register', null); }
      } catch (err) { alert("å•Ÿå‹•å¤±æ•—"); }
    }

    initApp();
  </script>
</body>
</html>
