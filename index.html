<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #0a0a0c; color: #fff; padding-bottom: 90px; }
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .card { background: #16181a; padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #2a2d32; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .btn-main { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; box-sizing: border-box; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(22, 24, 26, 0.95); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid #2a2d32; z-index: 999; }
    .nav-item { color: #666; font-size: 11px; cursor: pointer; text-align: center; width: 20%; }
    .nav-item.active { color: #00D100; font-weight: bold; }
    .tech-tag { display: inline-block; background: #222; color: #00D100; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px 2px 0 0; border: 1px solid #005500; }
    
    .dynamic-msg-bar { background: #1e1e1e; color: #00D100; padding: 10px; border-radius: 8px; font-size: 13px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid #333; }
    .env-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .env-box { background: #1a1e1a; border-radius: 10px; padding: 12px 5px; text-align: center; border: 1px solid #2a2d32; }
    .env-val { font-size: 22px; font-weight: bold; color: #fff; margin: 5px 0; }
    .alert-danger { background: #ff0000; color: #fff; padding: 12px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 15px; display: none; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); } }

    .ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
    .ring { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #00D100; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0, 209, 0, 0.1); }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .esg-box { text-align: center; padding: 12px 5px; background: #1a1e1a; border-radius: 12px; border: 1px solid #253025; }
    .tab-btn { padding: 12px; margin: 0; font-size: 14px; flex: 1; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #333; white-space: nowrap; }
    .tab-btn.active { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border-color: #00D100; }
    .tab-btn.inactive { background: #1e1e1e; color: #888; }
    .log-item { border-bottom: 1px solid #333; padding: 10px 0; font-size: 13px; color: #aaa; }
    .log-item:last-child { border-bottom: none; }
    .version-tag { text-align: center; color: #444; font-size: 11px; margin-top: 30px; font-family: monospace; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card"><p style="font-size:12px; color:#aaa; margin:0;">æœ¬ç³»çµ±è’é›†è³‡æ–™åƒ…ä¾›ä¿å›ºé ç´„èˆ‡å±¥æ­·ç´€éŒ„ä½¿ç”¨ã€‚</p></div>
    
    <button class="btn-main" onclick="window.showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#222; color:#fff;" onclick="window.showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      
      <select id="c-gender">
        <option value="">* æ€§åˆ¥</option>
        <option value="M">ç”·</option>
        <option value="F">å¥³</option>
      </select>
      
      <select id="c-city">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
      </select>
      
      <select id="c-brand" onchange="window.updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option>
        <option value="Toyota">Toyota (è±ç”°)</option><option value="Honda">Honda (æœ¬ç”°)</option>
        <option value="Nissan">Nissan (æ—¥ç”¢)</option><option value="Ford">Ford (ç¦ç‰¹)</option>
        <option value="Mazda">Mazda (é¦¬è‡ªé”)</option><option value="Mitsubishi">Mitsubishi (ä¸‰è±)</option>
        <option value="Hyundai">Hyundai (ç¾ä»£)</option><option value="Kia">Kia (èµ·äº)</option>
        <option value="Volkswagen">Volkswagen (ç¦æ–¯)</option><option value="Skoda">Skoda</option>
        <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
        <option value="BMW">BMW</option><option value="Audi">Audi (å¥§è¿ª)</option>
        <option value="Volvo">Volvo (å¯Œè±ª)</option><option value="Porsche">Porsche (ä¿æ™‚æ·)</option>
        <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Subaru">Subaru (é€Ÿéœ¸é™¸)</option>
        <option value="Suzuki">Suzuki (éˆ´æœ¨)</option><option value="Luxgen">Luxgen (ç´æ™ºæ·)</option>
        <option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      
      <select id="c-mileage">
        <option value="">* å¹´å¹³å‡é‡Œç¨‹ç¿’æ…£</option>
        <option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option>
        <option value="30000">30,000 å…¬é‡Œ</option><option value="40000">40,000 å…¬é‡Œ</option>
        <option value="50000">50,000 å…¬é‡Œä»¥ä¸Š</option>
      </select>
      <button class="btn-main" onclick="window.submitRegister('customer')">å®Œæˆè¨»å†Š</button>
    </div>

    <div id="form-garage" style="display:none; margin-top:20px;">
      <input type="text" id="g-name" placeholder="* ä¿ä¿®å» åç¨±">
      <input type="email" id="g-email" placeholder="* é›»å­éƒµä»¶">
      <select id="g-city">
        <option value="">* æ‰€åœ¨ç¸£å¸‚</option>
        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
        <option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
      </select>
      <input type="text" id="g-address" placeholder="* è©³ç´°åœ°å€">
      <input type="text" id="g-contact" placeholder="* å» é•·å§“å">
      <input type="tel" id="g-phone" placeholder="* è¯ç¹«é›»è©±">
      <button class="btn-main" onclick="window.submitRegister('garage')">é€å‡ºå¯©æ ¸è³‡æ–™</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid #00D100; margin-bottom: 10px;">
      <p id="ui-owner" style="font-size:18px; font-weight:bold; margin:0;">è®€å–ä¸­...</p>
      <p id="ui-car-info" style="font-size:13px; color:#888; margin:5px 0 10px 0;">è®€å–ä¸­...</p>
      <div><span class="tech-tag">é†«ç™‚ç´šéœé›»æŠ€è¡“</span><span class="tech-tag">æ°£å€™é€£å‹•æ¼”ç®—</span></div>
    </div>
    
    <div class="dynamic-msg-bar">
      <span style="margin-right: 8px;">ğŸ’¬</span>
      <marquee scrollamount="4" id="ui-dynamic-msg">æ­£åœ¨å¾å¤§æ•¸æ“šä¸­å¿ƒå–å¾—æ‚¨æ‰€åœ¨åŸå¸‚çš„æœ€æ–°ç’°å¢ƒæ•¸æ“š...</marquee>
    </div>

    <div id="aqi-severe-alert" class="alert-danger">âš ï¸ [ç´«çˆ†è­¦å ±] æ‰€åœ¨å€åŸŸç©ºæ°£å“è³ªæƒ¡åŠ£ï¼Œè«‹ç·Šé–‰è»Šçª—ä¸¦é–‹å•Ÿå…§å¾ªç’°ï¼</div>

    <div class="grid-2">
      <div class="env-box">
        <div style="font-size:11px; color:#888;">ğŸ“ <span id="ui-loc-name">å®šä½ä¸­</span> (å³æ™‚)</div>
        <div class="env-val" id="env-aqi" style="color:#00D100;">--</div>
      </div>
      <div class="env-box" style="border-color:#554400;">
        <div style="font-size:11px; color:#888;">ğŸ  <span id="ui-home-city">è®€å–ä¸­</span> (è¿‘7æ—¥)</div>
        <div class="env-val" id="env-home-aqi" style="color:#FF9800;">--</div>
      </div>
    </div>

    <div class="env-grid">
      <div class="env-box"><div style="font-size:11px; color:#888;">æº«åº¦</div><div class="env-val" id="env-temp">--Â°C</div></div>
      <div class="env-box"><div style="font-size:11px; color:#888;">æ¿•åº¦</div><div class="env-val" id="env-hum" style="color:#4fa3ff;">--%</div></div>
      <div class="env-box"><div style="font-size:11px; color:#888;">PM2.5 æŒ‡æ¨™</div><div class="env-val" id="env-pm25" style="color:#00D100;">--</div></div>
    </div>

    <div class="card" style="text-align: center; margin-top:5px;">
      <div class="ring-container">
        <div class="ring"><div style="font-size:48px; font-weight:bold; color:#00D100;" id="ui-health">100%</div><div style="font-size:12px; color:#888;">å‹•æ…‹å£½å‘½æ¨ä¼°</div></div>
        <div style="color:#FF9800; font-size:13px; margin-top:15px; font-weight:bold; background:#221500; padding:6px 12px; border-radius:20px;">ğŸ›¡ï¸ å·²æ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      </div>
      <button class="btn-main" onclick="window.scanFilter()">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    </div>
    
    <div class="grid-3">
      <div class="esg-box"><div style="font-size:20px;">ğŸŒ±</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-co2">0</span> kg</div><div style="font-size:11px; color:#888;">çœç¢³è¶³è·¡</div></div>
      <div class="esg-box"><div style="font-size:20px;">âš¡ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-kwh">0</span> kWh</div><div style="font-size:11px; color:#888;">çœé›»æ•ˆèƒ½</div></div>
      <div class="esg-box"><div style="font-size:20px;">â›½ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;">12 %</div><div style="font-size:11px; color:#888;">ç©ºèª¿ç¯€èƒ½</div></div>
    </div>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:#00D100;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="card" style="text-align:center;">
      <p style="color:#aaa;">å°ˆå±¬å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:#00D100; letter-spacing: 2px; border: 1px dashed #00D100; padding: 10px;">AIRPLUS2026</h2>
      <button class="btn-main" style="background:#333; color:#fff;" onclick="window.location.href='https://www.hypass.com.tw/oauth/line/quick_sign_up'">å‰å¾€å•†åŸä¸¦è‡ªå‹•ç™»å…¥</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h3>
    <div id="booking-section">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="window.switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn inactive" id="tab-btn-manual" onclick="window.switchBookingTab('manual')">ğŸ“‹ é™„è¿‘ä¿ä¿®å» </div>
      </div>
      <div id="booking-smart"><div id="smart-match-result" class="card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
      <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:#00D100;">ğŸ çå‹µèˆ‡æ¨è–¦</h3>
    <div class="card" style="border-color:#FF9800;">
      <h4 style="margin:0; color:#FF9800;">çå‹µé‡‘é¤˜é¡</h4>
      <h1 style="margin:10px 0;"><span id="reward-balance">$0</span></h1>
      <p style="font-size:12px; color:#888;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Points</p>
      <button class="btn-main" style="background:#FF9800; color:#000;" onclick="window.redeemPoints()">ç”³è«‹å…Œæ› LINE Points</button>
    </div>
    <button class="btn-main" style="background:#333; color:#fff;" onclick="window.generateMGM()">ğŸ”— è¤‡è£½å°ˆå±¬æ¨è–¦é€£çµ</button>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:#00D100;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div style="display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto;">
      <div class="tab-btn active" id="tab-set-a" onclick="window.switchSetTab('a')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="tab-btn inactive" id="tab-set-b" onclick="window.switchSetTab('b')">ğŸ“œ æ­·å²ç´€éŒ„</div>
      <div class="tab-btn inactive" id="tab-set-c" onclick="window.switchSetTab('c')">ğŸ“„ æ•¸ä½åˆç´„</div>
    </div>

    <div id="set-content-a" style="display:block;">
      <div class="card">
        <h4 style="margin:0 0 15px 0; color:#00D100;">è»Šä¸»åŸºæœ¬è³‡æ–™ç¶­è­·</h4>
        
        <label style="font-size:12px; color:#888;">å§“å</label>
        <input type="text" id="edit-name">
        
        <label style="font-size:12px; color:#888;">è¯çµ¡é›»è©±</label>
        <input type="tel" id="edit-phone">
        
        <label style="font-size:12px; color:#888;">é›»å­éƒµä»¶</label>
        <input type="email" id="edit-email">
        
        <label style="font-size:12px; color:#888;">æ€§åˆ¥</label>
        <select id="edit-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        
        <label style="font-size:12px; color:#888;">å±…ä½ç¸£å¸‚</label>
        <select id="edit-city">
          <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
          <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
          <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
          <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
          <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
          <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
          <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        </select>
        
        <label style="font-size:12px; color:#888;">è»Šè¼›å“ç‰Œ</label>
        <select id="edit-brand" onchange="window.updateCarModels('edit-brand', 'edit-model')">
          <option value="Toyota">Toyota (è±ç”°)</option><option value="Honda">Honda (æœ¬ç”°)</option>
          <option value="Nissan">Nissan (æ—¥ç”¢)</option><option value="Ford">Ford (ç¦ç‰¹)</option>
          <option value="Mazda">Mazda (é¦¬è‡ªé”)</option><option value="Mitsubishi">Mitsubishi (ä¸‰è±)</option>
          <option value="Hyundai">Hyundai (ç¾ä»£)</option><option value="Kia">Kia (èµ·äº)</option>
          <option value="Volkswagen">Volkswagen (ç¦æ–¯)</option><option value="Skoda">Skoda</option>
          <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
          <option value="BMW">BMW</option><option value="Audi">Audi (å¥§è¿ª)</option>
          <option value="Volvo">Volvo (å¯Œè±ª)</option><option value="Porsche">Porsche (ä¿æ™‚æ·)</option>
          <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Subaru">Subaru (é€Ÿéœ¸é™¸)</option>
          <option value="Suzuki">Suzuki (éˆ´æœ¨)</option><option value="Luxgen">Luxgen (ç´æ™ºæ·)</option>
          <option value="Other">å…¶ä»–å“ç‰Œ</option>
        </select>
        
        <label style="font-size:12px; color:#888;">è»Šå‹</label>
        <select id="edit-model"><option value="">* é¸æ“‡è»Šå‹</option></select>
        
        <label style="font-size:12px; color:#888;">å‡ºå» å¹´ä»½</label>
        <input type="number" id="edit-year">
        
        <label style="font-size:12px; color:#888;">è»Šç‰Œè™Ÿç¢¼</label>
        <input type="text" id="edit-plate">
        
        <label style="font-size:12px; color:#888;">å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label>
        <select id="edit-mileage">
          <option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option>
          <option value="30000">30,000 å…¬é‡Œ</option><option value="40000">40,000 å…¬é‡Œ</option>
          <option value="50000">50,000 å…¬é‡Œä»¥ä¸Š</option>
        </select>
        
        <button class="btn-main" onclick="window.updateProfile()">å„²å­˜å…¨éƒ¨è³‡æ–™</button>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="card">
        <select id="history-type" onchange="window.loadHistory(this.value)" style="margin-bottom:15px; color:#00D100; font-weight:bold;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option>
          <option value="book">ğŸ“ é ç´„ç´€éŒ„</option>
          <option value="shop">ğŸ›’ å•†åŸè³¼è²·ç´€éŒ„</option>
          <option value="logs">âœï¸ æ“ä½œç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 300px; overflow-y: auto;"></div>
      </div>
    </div>
    
    <div id="set-content-c" style="display:none;">
      <div class="card"><p style="font-size:13px; color:#aaa;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate"></span></p></div>
    </div>
    
    <div class="version-tag">System Ver. V2.6-FULL (DB-Sync Mode)</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="window.switchPage('home', this)"><div style="font-size:22px;">â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="window.switchPage('shop', this)"><div style="font-size:22px;">ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="window.switchPage('book', this)"><div style="font-size:22px;">ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="window.switchPage('rewards', this)"><div style="font-size:22px;">ğŸ</div>çå‹µ</div>
    <div class="nav-item" onclick="window.switchPage('settings', this)"><div style="font-size:22px;">âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    window.onerror = function(msg) { 
      console.log(msg); 
      return false; 
    };

    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );
    
    let currentUser = null; 
    let currentLocName = 'å°ç£';
    let envData = { temp: 25, hum: 60, aqi: 45, pm25: 15 };

    const carData = { 
      "Toyota": ["RAV4", "Corolla Cross", "Altis", "Camry", "Yaris", "å…¶ä»–"], 
      "Honda": ["CR-V", "HR-V", "Civic", "Fit", "å…¶ä»–"],
      "Nissan": ["Kicks", "Sentra", "X-Trail", "å…¶ä»–"], 
      "Ford": ["Focus", "Kuga", "å…¶ä»–"], 
      "Mazda": ["Mazda 3", "CX-5", "å…¶ä»–"],
      "Mitsubishi": ["Outlander", "Eclipse Cross", "Colt Plus", "å…¶ä»–"], 
      "Hyundai": ["Tucson", "Custin", "Venue", "å…¶ä»–"],
      "Kia": ["Sportage", "Sorento", "EV6", "å…¶ä»–"], 
      "Volkswagen": ["Golf", "Tiguan", "å…¶ä»–"], 
      "Skoda": ["Kodiaq", "Kamiq", "å…¶ä»–"],
      "Lexus": ["NX", "RX", "UX", "ES", "å…¶ä»–"], 
      "Benz": ["C-Class", "E-Class", "GLC", "GLE", "å…¶ä»–"],
      "BMW": ["3-Series", "5-Series", "X3", "X5", "å…¶ä»–"], 
      "Audi": ["A3", "A4", "Q3", "Q5", "å…¶ä»–"],
      "Volvo": ["XC60", "XC40", "å…¶ä»–"], 
      "Porsche": ["Macan", "Cayenne", "å…¶ä»–"], 
      "Tesla": ["Model Y", "Model 3", "Model X", "Model S"],
      "Subaru": ["Forester", "XV", "å…¶ä»–"], 
      "Suzuki": ["Swift", "Jimny", "å…¶ä»–"], 
      "Luxgen": ["URX", "n7", "å…¶ä»–"], 
      "Other": ["å…¶ä»–å“ç‰Œ"] 
    };

    window.updateCarModels = function(brandId, modelId, defaultModel = '') { 
      const b = document.getElementById(brandId).value; 
      const m = document.getElementById(modelId);
      m.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
      if (carData[b]) {
        carData[b].forEach(i => {
          let sel = (i === defaultModel) ? 'selected' : '';
          m.innerHTML += `<option value="${i}" ${sel}>${i}</option>`;
        });
      }
    };
    
    window.switchPage = function(id, el) { 
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
      document.getElementById('page-'+id).classList.add('active'); 
      if (el) el.classList.add('active'); 
      if (id === 'book') loadGarages(); 
    };

    window.switchSetTab = function(t) { 
      document.getElementById('set-content-a').style.display = t === 'a' ? 'block' : 'none'; 
      document.getElementById('set-content-b').style.display = t === 'b' ? 'block' : 'none'; 
      document.getElementById('set-content-c').style.display = t === 'c' ? 'block' : 'none'; 
      document.getElementById('tab-set-a').className = `tab-btn ${t === 'a' ? 'active' : 'inactive'}`; 
      document.getElementById('tab-set-b').className = `tab-btn ${t === 'b' ? 'active' : 'inactive'}`; 
      document.getElementById('tab-set-c').className = `tab-btn ${t === 'c' ? 'active' : 'inactive'}`; 
    };

    window.switchBookingTab = function(t) { 
      document.getElementById('booking-smart').style.display = t === 'smart' ? 'block' : 'none'; 
      document.getElementById('booking-manual').style.display = t === 'manual' ? 'block' : 'none'; 
      document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : 'inactive'}`; 
      document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : 'inactive'}`; 
    };

    window.showForm = function(role) {
      document.getElementById('form-customer').style.display = role === 'customer' ? 'block' : 'none';
      document.getElementById('form-garage').style.display = role === 'garage' ? 'block' : 'none';
    };

    window.submitRegister = async function(role) {
      try {
        const p = await liff.getProfile();
        if (role === 'customer') {
          const { error } = await supabaseClient.from('users').upsert({ 
            line_uid: p.userId, 
            role: role, 
            name: document.getElementById('c-name').value, 
            phone: document.getElementById('c-phone').value, 
            email: document.getElementById('c-email').value, 
            gender: document.getElementById('c-gender').value, 
            city: document.getElementById('c-city').value, 
            car_brand: document.getElementById('c-brand').value, 
            car_model: document.getElementById('c-model').value, 
            license_plate: document.getElementById('c-plate').value, 
            yearly_mileage: document.getElementById('c-mileage').value, 
            car_year: document.getElementById('c-year').value 
          });
          if (error) {
            alert("è¨»å†Šå¤±æ•—ï¼Œè«‹é‡è©¦");
          } else {
            alert("âœ… è¨»å†ŠæˆåŠŸï¼"); 
            location.reload();
          }
        }
      } catch (err) { 
        alert("è¨»å†Šç™¼ç”ŸéŒ¯èª¤"); 
      }
    };

    window.updateProfile = async function() {
      const { error } = await supabaseClient.from('users').update({ 
        name: document.getElementById('edit-name').value, 
        phone: document.getElementById('edit-phone').value, 
        email: document.getElementById('edit-email').value, 
        gender: document.getElementById('edit-gender').value,
        city: document.getElementById('edit-city').value,
        car_brand: document.getElementById('edit-brand').value,
        car_model: document.getElementById('edit-model').value,
        car_year: document.getElementById('edit-year').value,
        license_plate: document.getElementById('edit-plate').value, 
        yearly_mileage: document.getElementById('edit-mileage').value 
      }).eq('line_uid', currentUser.line_uid); 
      
      if (error) {
          alert("æ›´æ–°å¤±æ•—ï¼š" + error.message);
      } else {
          alert('âœ… æ›´æ–°æˆåŠŸï¼'); 
          location.reload();
      }
    };

    window.loadHistory = async function(type) {
      const c = document.getElementById('history-container'); 
      c.innerHTML = 'è®€å–ä¸­...'; 
      let h = '';
      
      if (type === 'filter') {
        const { data } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false });
        if (data && data.length) {
            data.forEach(d => h += `<div class="log-item">ğŸ”„ ${new Date(d.activated_at).toLocaleDateString()} - [${d.activation_type}] å•Ÿç”¨</div>`); 
        } else {
            h = '<p>å°šç„¡ç´€éŒ„</p>';
        }
      } else if (type === 'book') {
        const { data } = await supabaseClient.from('appointments').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('appointment_time', { ascending: false });
        if (data && data.length) {
            data.forEach(d => h += `<div class="log-item">ğŸ“ ${new Date(d.appointment_time).toLocaleDateString()} - ${d.garages.name} [${d.status}]</div>`); 
        } else {
            h = '<p>å°šç„¡ç´€éŒ„</p>';
        }
      } else if (type === 'shop' || type === 'logs') {
        let q = supabaseClient.from('user_logs').select('*').eq('user_uid', currentUser.line_uid).order('created_at', { ascending: false });
        if (type === 'shop') {
            q = q.eq('action', 'ğŸ›’ å•†åŸè³¼è²·');
        }
        const { data } = await q;
        if (data && data.length) {
            data.forEach(d => h += `<div class="log-item">ğŸ“ ${new Date(d.created_at).toLocaleDateString()} - ${d.action}: ${d.details}</div>`); 
        } else {
            h = '<p>å°šç„¡ç´€éŒ„</p>';
        }
      }
      c.innerHTML = h;
    };

    window.scanFilter = async function() {
      const res = await liff.scanCodeV2(); 
      if (!res.value) return;
      await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
      const { error } = await supabaseClient.from('filters_uid').update({ 
          status: 'activated', 
          activated_by_uid: currentUser.line_uid, 
          activated_at: new Date(), 
          activation_type: 'DIY', 
          installed_car_model: currentUser.car_brand, 
          installed_location: currentLocName 
      }).eq('uid', res.value);
      
      if (error) {
          alert("å•Ÿç”¨å¤±æ•—ï¼");
      } else {
          alert("âœ… å•Ÿç”¨æˆåŠŸï¼"); 
          location.reload();
      }
    };

    window.book = async function(gId, prefix = '') {
      const time = document.getElementById(prefix ? `date-${prefix}-${gId}` : `date-${gId}`).value;
      if (!time) return alert("è«‹é¸æ“‡æ™‚é–“");
      
      const { error } = await supabaseClient.from('appointments').insert([{ 
          user_uid: currentUser.line_uid, 
          garage_id: gId, 
          appointment_time: new Date(time) 
      }]);
      
      if (error) {
          alert("é ç´„å¤±æ•—ï¼š" + error.message);
      } else {
          alert("ğŸ‰ é ç´„é€å‡ºæˆåŠŸï¼"); 
          loadGarages();
      }
    };

    window.redeemPoints = async function() {
      const balText = document.getElementById('reward-balance').innerText.replace('$','');
      if (parseInt(balText) < 100) return alert('é¤˜é¡ä¸è¶³ $100ï¼Œç„¡æ³•å…Œæ›ï¼');
      if (confirm('ç¢ºå®šç”³è«‹å…Œæ› LINE Points å—ï¼Ÿ')) {
        await supabaseClient.from('rewards').insert([{ user_uid: currentUser.line_uid, type: 'redeem', amount: 100, status: 'pending' }]);
        alert('âœ… ç”³è«‹å·²é€å‡ºï¼'); 
        loadRewards();
      }
    };

    // ğŸŒŸ å®šä½èˆ‡è³‡æ–™åº«è®€å–åˆ†é›¢ï¼Œå¢åŠ ç©©å®šæ€§
    async function getEnvDataFromDB(cityName) {
      if (!cityName) return calculateDashboardStats();
      
      document.getElementById('ui-loc-name').innerText = cityName;
      
      try {
        const { data } = await supabaseClient.from('environmental_data').select('*').eq('city_name', cityName).single();
        if (data) {
          envData.temp = data.temp; 
          envData.hum = data.hum; 
          envData.aqi = data.aqi; 
          envData.pm25 = data.pm25;
          
          document.getElementById('env-temp').innerText = `${envData.temp}Â°C`; 
          document.getElementById('env-hum').innerText = `${envData.hum}%`; 
          document.getElementById('env-aqi').innerText = envData.aqi;
          document.getElementById('env-pm25').innerText = envData.pm25;
          
          let msg = `ğŸŸ¢ ç³»çµ±åŒæ­¥å®Œæˆ | æ‚¨çš„æ‰€åœ¨åœ° ${cityName} ç›®å‰ AQI: ${envData.aqi} | æ¿¾ç¶²æŒçºŒé˜²è­·ä¸­ï¼`;
          if (envData.aqi > 100) { 
              document.getElementById('env-aqi').style.color = '#ff9800'; 
              msg = `âš ï¸ æ³¨æ„ï¼ç›®å‰ç©ºæ°£å“è³ªä¸ä½³ï¼Œè«‹ç¢ºä¿è»Šçª—ç·Šé–‰ã€‚`; 
          }
          if (envData.aqi > 150) { 
              document.getElementById('env-aqi').style.color = '#ff0000'; 
              document.getElementById('aqi-severe-alert').style.display = 'block'; 
              msg = `ğŸš¨ ç´«çˆ†è­¦å‘Šï¼æˆ¶å¤–ç©ºæ°£æ¥µåº¦æƒ¡åŠ£ï¼ŒHYPASS æ­£å…¨åŠ›ç‚ºæ‚¨æ·¨åŒ–åº§è‰™ã€‚`; 
          }
          document.getElementById('ui-dynamic-msg').innerText = msg;
        }
      } catch (e) { 
          console.log("è®€å–ç’°å¢ƒå¿«å–å¤±æ•—"); 
      }
      
      calculateDashboardStats();
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude; 
          const lon = pos.coords.longitude;
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=zh-TW`);
            const d = await res.json(); 
            currentLocName = d.address.city || d.address.county || currentUser.city;
            
            // æ‹¿åˆ°å®šä½å¾Œï¼Œå»è³‡æ–™åº«æ‰¾é€™å€‹åŸå¸‚çš„ç©ºæ°£è³‡æ–™
            getEnvDataFromDB(currentLocName);
            
          } catch(e) { 
            // ç¶²è·¯å¤±æ•—ï¼Œé€€å›ä½¿ç”¨è¨»å†Šç¸£å¸‚
            getEnvDataFromDB(currentUser.city);
          }
        }, () => { 
          // æ‹’çµ•å®šä½ï¼Œé€€å›ä½¿ç”¨è¨»å†Šç¸£å¸‚
          getEnvDataFromDB(currentUser.city); 
        });
      } else {
        getEnvDataFromDB(currentUser.city);
      }
    }

    async function calculateDashboardStats() {
      if (!currentUser) return;
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if (filter && filter.activated_at) {
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000*60*60*24)));
        let tMult = (currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0) * (envData.aqi > 100 ? 1.4 : 1.0);
        let health = 100 - (days * 0.27 * tMult);
        
        document.getElementById('ui-health').innerText = `${Math.max(0, Math.round(health))}%`;
        if (health < 30) {
            document.getElementById('ui-health').style.color = '#ff0000';
        }
        
        document.getElementById('ui-pm25').innerText = Math.round(days * 1250 * tMult).toLocaleString();
        document.getElementById('ui-esg-co2').innerText = (days * 0.15).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = (days * 0.3).toFixed(1);
      }
    }

    async function loadGarages() {
      const { data: myB } = await supabaseClient.from('appointments').select('*, garages(name)').eq('user_uid', currentUser.line_uid).eq('status', 'pending');
      if (myB && myB.length > 0) {
        document.getElementById('booking-section').innerHTML = `<div class="card" style="border-color:#00D100; text-align:center;"><h3 style="color:#00D100; margin-top:0;">âœ… å·²æˆåŠŸé ç´„</h3><p style="font-size:18px; font-weight:bold;">${myB[0].garages.name}</p><p style="color:#aaa;">é ç´„æ™‚é–“ï¼š<br><span style="color:#fff;">${new Date(myB[0].appointment_time).toLocaleString()}</span></p></div>`;
        return;
      }
      
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active');
      let html = '';
      if (data) {
          data.forEach(g => {
              html += `<div class="card"><h4 style="margin-top:0;">${g.name}</h4><p style="font-size:14px; color:#888;">ğŸ“ ${g.address}</p><input type="datetime-local" id="date-${g.id}" style="margin-bottom:10px; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px;"><button class="btn-main" onclick="window.book(${g.id})">é€å‡ºé ç´„</button></div>`;
          });
      }
      document.getElementById('garage-list').innerHTML = html || '<p>ç„¡å¯ç”¨åº—å®¶</p>';

      // æ™ºèƒ½é…å°
      if (data && data.length > 0) {
          document.getElementById('smart-match-result').innerHTML = `
            <h4 style="margin:0 0 5px 0;">âœ¨ æ¨è–¦ï¼š${data[0].name}</h4>
            <input type="datetime-local" id="date-smart-${data[0].id}" style="margin-bottom:10px; background:#000; color:#fff; border:1px solid #333; padding:10px; border-radius:8px; width:100%; box-sizing:border-box;">
            <button class="btn-main" style="margin:0;" onclick="window.book(${data[0].id}, 'smart')">ä¸€éµé ç´„</button>
          `;
      }
    }

    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('*').eq('user_uid', currentUser.line_uid);
      let total = 0; 
      if (data) {
          data.forEach(r => { 
              if(r.status === 'completed') {
                  total += (r.type === 'earn' ? r.amount : -r.amount); 
              }
          });
      }
      document.getElementById('reward-balance').innerText = `$${total}`;
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { 
            liff.login(); 
            return; 
        }
        const profile = await liff.getProfile();
        const { data } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).maybeSingle();
        
        if (data && data.name) {
          currentUser = data; 
          document.getElementById('nav-bar').style.display = 'flex';
          
          if (data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model}`;
            document.getElementById('ui-home-city').innerText = data.city;
            
            // ğŸŒŸ 100% å®Œæ•´å¡«å¯«è¨­å®šé é¢è³‡æ–™
            document.getElementById('edit-name').value = data.name || '';
            document.getElementById('edit-phone').value = data.phone || '';
            document.getElementById('edit-email').value = data.email || '';
            document.getElementById('edit-gender').value = data.gender || '';
            document.getElementById('edit-city').value = data.city || '';
            document.getElementById('edit-brand').value = data.car_brand || '';
            window.updateCarModels('edit-brand', 'edit-model', data.car_model);
            document.getElementById('edit-year').value = data.car_year || '';
            document.getElementById('edit-plate').value = data.license_plate || '';
            document.getElementById('edit-mileage').value = data.yearly_mileage || '20000';
            document.getElementById('contract-plate').innerText = data.license_plate;

            window.switchPage('home', document.querySelector('.nav-item'));
            
            // å•Ÿå‹• GPS èˆ‡è³‡æ–™åº«ç’°å¢ƒæ•¸æ“šæŠ“å–
            getGPS(); 
            window.loadHistory('filter');
            loadRewards();
            loadGarages();
          }
        } else { 
            window.switchPage('register', null); 
        }
      } catch (err) { 
          alert("ç³»çµ±å•Ÿå‹•å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥"); 
      }
    }

    initApp();
  </script>
</body>
</html>
