<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* åŸºç¤æš—é»‘ä¸»é¡Œ */
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 0; background-color: #121212; color: #ffffff; padding-bottom: 80px; }
    .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* é¦–é èˆ‡æŒ‰éˆ•æ¨£å¼ */
    .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 0 20px 0; }
    #user-info { color: #888; font-size: 14px; margin: 0; }
    .car-badge { background: #1e1e1e; padding: 5px 15px; border-radius: 20px; font-size: 12px; color: #00D100; border: 1px solid #333; }
    .dashboard-ring { background: #1e1e1e; border-radius: 20px; padding: 40px 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid #2a2a2a; }
    .ring-circle { width: 180px; height: 180px; border-radius: 50%; border: 4px dashed #00D100; margin: 0 auto 20px auto; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 0 20px rgba(0, 209, 0, 0.2); }
    #health-score { font-size: 56px; font-weight: bold; color: #00D100; margin: 0; line-height: 1; }
    .btn-main { background: #00D100; color: #000; border: none; padding: 15px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px; }
    
    /* å¡ç‰‡æ¨£å¼ (è»Šä¸»é ç´„ç”¨ & å» é•·çœ‹å–®ç”¨) */
    .data-card { background: #1e1e1e; padding: 20px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #333; text-align: left; }
    .card-title { margin: 0 0 5px 0; font-size: 18px; color: #fff; }
    .card-text { margin: 0 0 10px 0; font-size: 14px; color: #888; }
    .datetime-picker { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 15px; background: #000; color: #fff; border: 1px solid #444; border-radius: 8px; font-size: 16px; }

    /* B2B å°ˆå±¬æ¨£å¼ */
    .status-badge { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
    .status-pending { background: #FF9800; color: #fff; }
    .status-confirmed { background: #03A9F4; color: #fff; }
    .status-completed { background: #00D100; color: #000; }
    .btn-action { background: #333; color: #fff; border: 1px solid #555; padding: 10px; border-radius: 5px; width: 48%; font-size: 14px; cursor: pointer; }
    .btn-action.primary { background: #00D100; color: #000; border: none; }

    /* åº•éƒ¨å°è¦½åˆ— */
    .bottom-nav { position: fixed; bottom: 15px; left: 15px; right: 15px; background: rgba(30, 30, 30, 0.95); backdrop-filter: blur(10px); border-radius: 20px; display: flex; justify-content: space-around; padding: 15px 0; border: 1px solid #333; z-index: 1000; }
    .nav-item { color: #666; font-size: 24px; text-decoration: none; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .nav-item.active { color: #00D100; text-shadow: 0 0 10px rgba(0,209,0,0.5); }
    .nav-label { font-size: 10px; margin-top: 4px; font-weight: bold; }
  </style>
</head>
<body>

  <div id="page-home" class="page active">
    <div class="header">
      <p id="user-info">é€£ç·šä¸­...</p>
      <div class="car-badge">â— å·²é€£ç·š</div>
    </div>
    <div class="dashboard-ring">
      <div class="ring-circle">
        <div id="health-score">100%</div>
        <div style="color: #888; font-size: 14px; margin-top: 5px;">åº§è‰™é˜²è­·åŠ›</div>
      </div>
      <p style="color:#00D100; font-weight:bold; margin-bottom: 0;">æ¥µæ·¨ãƒ»é˜²ç¦¦ä¸­</p>
    </div>
    <button class="btn-main" onclick="scanUID()">ğŸ“· æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h2 style="color:#00D100;">å®˜æ–¹å•†åŸ</h2>
    <p style="color:#888;">Shopline ä¸²æ¥æº–å‚™ä¸­...</p>
  </div>

  <div id="page-book" class="page">
    <h2 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h2>
    <p style="color:#888; font-size: 14px;">è«‹é¸æ“‡æ‚¨é™„è¿‘çš„æ¿¾è¯ç¶²åŠ ç›Ÿåº—ï¼š</p>
    <div id="garage-list"><p style="color:#888;">è³‡æ–™è¼‰å…¥ä¸­...</p></div>
  </div>

  <div id="page-settings" class="page">
    <h2 style="color:#00D100;">âš™ï¸ æˆ‘çš„å¸³è™Ÿ</h2>
    
    <div id="b2c-settings">
      <p style="color:#888;">è»Šè¼›è¨­å®šèˆ‡æ­·å²ç´€éŒ„å»ºç½®ä¸­...</p>
      <button class="btn-main" style="background:#333; color:#fff;" onclick="toggleAdminMode()">åˆ‡æ›è‡³ã€Œå» é•·æ¥å–®å¾Œå°ã€æ¸¬è©¦</button>
    </div>

    <div id="b2b-admin-panel" style="display: none;">
      <h3 style="color:#FF9800;">ğŸ‘¨â€ğŸ”§ å» é•·æ¥å–®çœ‹æ¿</h3>
      <p style="color:#888; font-size: 12px;">æ­¤ç•«é¢åƒ…é™ä¿ä¿®å» è€é—†å¯è¦‹</p>
      <div id="admin-order-list">
        <p style="color:#888;">è®€å–è¨‚å–®ä¸­...</p>
      </div>
      <button class="btn-main" style="background:#333; color:#fff; margin-top:20px;" onclick="toggleAdminMode()">é€€å‡ºå» é•·æ¨¡å¼</button>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('home', this)"><span>â—“</span><span class="nav-label">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span>ğŸ›’</span><span class="nav-label">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span>ğŸ“</span><span class="nav-label">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span>âš™ï¸</span><span class="nav-label">è¨­å®š</span></div>
  </div>

  <script>
    const supabaseUrl = 'https://qznvabjtxcbffjryfgqi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUserId = null;
    let currentUserName = null;

    // 1. åˆå§‹åŒ– LINE
    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" }); 
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          currentUserId = profile.userId;
          currentUserName = profile.displayName;
          document.getElementById('user-info').innerText = currentUserName + ' çš„åº§è‰™';
          
          // è‡ªå‹•å°‡ç™»å…¥çš„è»Šä¸»è¨»å†Šé€² users è¡¨ (æ–¹ä¾¿å¾ŒçºŒå» é•·è¯çµ¡)
          await supabaseClient.from('users').upsert({
            line_uid: currentUserId,
            name: currentUserName
          });

          loadGarages(); // è¼‰å…¥ä¿ä¿®å» æ¸…å–® (é ç´„é é¢ç”¨)
        } else {
          liff.login();
        }
      } catch (err) {
        document.getElementById('user-info').innerText = 'è«‹åœ¨ LINE å…§é–‹å•Ÿ';
      }
    }

    // 2. åˆ‡æ›é é¢
    function switchPage(pageId, element) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      element.classList.add('active');
    }

    // ==========================================
    // B2C è»Šä¸»ç«¯åŠŸèƒ½
    // ==========================================

    // è¼‰å…¥ä¿ä¿®å» æ¸…å–® (é ç´„ç”¨)
    async function loadGarages() {
      const { data, error } = await supabaseClient.from('garages').select('*');
      if (error || !data || data.length === 0) return;

      let html = '';
      data.forEach(g => {
        html += `
          <div class="data-card">
            <h3 class="card-title">${g.name}</h3>
            <p class="card-text">ğŸ“ ${g.address}</p>
            <p class="card-text" style="color:#00D100;">âš™ï¸ ä»£å·¥è²»ï¼šNT$ ${g.labor_fee}</p>
            <input type="datetime-local" id="date-${g.id}" class="datetime-picker" />
            <button class="btn-main" onclick="submitBooking(${g.id}, '${g.name}')">é€å‡ºé ç´„å–®</button>
          </div>
        `;
      });
      document.getElementById('garage-list').innerHTML = html;
    }

    // é€å‡ºé ç´„
    async function submitBooking(garageId, garageName) {
      const dateInput = document.getElementById('date-' + garageId).value;
      if (!dateInput) return alert('è«‹å…ˆé¸æ“‡æ™‚é–“ï¼');
      
      const { error } = await supabaseClient.from('appointments').insert([
        { user_id: currentUserId, garage_id: garageId, appointment_time: new Date(dateInput).toISOString(), status: 'pending' }
      ]);

      if (error) alert('é ç´„å¤±æ•—');
      else {
        alert('ğŸ‰ é ç´„æˆåŠŸï¼å» é•·å°‡æœƒè™•ç†ã€‚');
        document.getElementById('date-' + garageId).value = '';
        if(document.getElementById('b2b-admin-panel').style.display === 'block') loadAdminOrders(); // å¦‚æœå» é•·é–‹è‘—å¾Œå°ï¼Œå³æ™‚æ›´æ–°
      }
    }

    // ==========================================
    // B2B å» é•·æ¥å–®ç«¯åŠŸèƒ½
    // ==========================================

    let isAdminMode = false;

    // é–‹é—œå» é•·æ¨¡å¼
    function toggleAdminMode() {
      isAdminMode = !isAdminMode;
      if(isAdminMode) {
        document.getElementById('b2c-settings').style.display = 'none';
        document.getElementById('b2b-admin-panel').style.display = 'block';
        loadAdminOrders(); // æŠ“å–è¨‚å–®
      } else {
        document.getElementById('b2c-settings').style.display = 'block';
        document.getElementById('b2b-admin-panel').style.display = 'none';
      }
    }

    // å» é•·è®€å–é ç´„å–®
    async function loadAdminOrders() {
      // æŠ“å–æ‰€æœ‰é ç´„å–®
      const { data, error } = await supabaseClient
        .from('appointments')
        .select('*')
        .order('created_at', { ascending: false });

      const listDiv = document.getElementById('admin-order-list');

      if (error || !data || data.length === 0) {
        listDiv.innerHTML = '<p style="color:#888;">ç›®å‰æ²’æœ‰ä»»ä½•é ç´„å–®ã€‚</p>';
        return;
      }

      let html = '';
      data.forEach(order => {
        // æ ¼å¼åŒ–æ™‚é–“
        const aptTime = new Date(order.appointment_time).toLocaleString('zh-TW', { month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
        
        // ç‹€æ…‹æ¨™ç±¤åˆ¤æ–·
        let statusHtml = '';
        if(order.status === 'pending') statusHtml = '<span class="status-badge status-pending">ç­‰å¾…ç¢ºèªä¸­</span>';
        if(order.status === 'confirmed') statusHtml = '<span class="status-badge status-confirmed">å·²æ’ç¨‹æ¥å–®</span>';
        if(order.status === 'completed') statusHtml = '<span class="status-badge status-completed">âœ” å·²å®Œå·¥æ ¸éŠ·</span>';

        html += `
          <div class="data-card">
            ${statusHtml}
            <p class="card-text">ğŸ•’ é ç´„æ™‚é–“ï¼š<strong style="color:#fff;">${aptTime}</strong></p>
            <p class="card-text">ğŸ‘¤ è»Šä¸»è­˜åˆ¥ç¢¼ï¼š${order.user_id.substring(0,8)}...</p>
            
            <div style="display:flex; justify-content:space-between; margin-top:15px;">
              ${order.status === 'pending' ? `<button class="btn-action primary" onclick="updateOrderStatus(${order.id}, 'confirmed')">ç¢ºèªæ¥å–®</button>` : ''}
              ${order.status === 'confirmed' ? `<button class="btn-action primary" onclick="updateOrderStatus(${order.id}, 'completed')">å®Œå·¥ä¸¦æ ¸éŠ·</button>` : ''}
              ${order.status !== 'completed' ? `<button class="btn-action" onclick="updateOrderStatus(${order.id}, 'cancelled')">å–æ¶ˆè¨‚å–®</button>` : ''}
            </div>
          </div>
        `;
      });
      listDiv.innerHTML = html;
    }

    // å» é•·æ›´æ–°è¨‚å–®ç‹€æ…‹ (æ¥å–®/å®Œå·¥)
    async function updateOrderStatus(orderId, newStatus) {
      if(!confirm('ç¢ºå®šè¦æ›´æ–°é€™ç­†è¨‚å–®ç‹€æ…‹å—ï¼Ÿ')) return;

      const { error } = await supabaseClient
        .from('appointments')
        .update({ status: newStatus })
        .eq('id', orderId);

      if (error) {
        alert('âŒ æ›´æ–°å¤±æ•—');
      } else {
        alert('âœ… ç‹€æ…‹å·²æ›´æ–°ï¼');
        loadAdminOrders(); // é‡æ–°è®€å–ç•«é¢
      }
    }

    initApp();
  </script>
</body>
</html>
