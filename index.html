<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #0a0a0c; color: #fff; padding-bottom: 90px; }
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .card { background: #16181a; padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #2a2d32; }
    .btn-main { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; box-sizing: border-box; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(22, 24, 26, 0.95); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid #2a2d32; z-index: 999; }
    .nav-item { color: #666; font-size: 11px; cursor: pointer; text-align: center; width: 20%; }
    .nav-item.active { color: #00D100; font-weight: bold; }
    .tech-tag { display: inline-block; background: #222; color: #00D100; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px 2px 0 0; border: 1px solid #005500; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <button class="btn-main" onclick="showForm('customer')">æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#222; color:#fff;" onclick="showForm('garage')">æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <select id="c-city">
        <option value="">* å±…ä½ç¸£å¸‚ (å…­éƒ½å„ªå…ˆ)</option>
        <optgroup label="å…­å¤§éƒ½æœƒå€">
          <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
          <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        </optgroup>
        <optgroup label="å…¶ä»–ç¸£å¸‚">
          <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option>
          <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option><option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
          <option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
          <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
          <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        </optgroup>
      </select>
      
      <select id="c-brand" onchange="updateCarModels()">
        <option value="">* é¸æ“‡å“ç‰Œ</option>
        <option value="Tesla">Tesla (ç‰¹æ–¯æ‹‰)</option><option value="Toyota">Toyota (è±ç”°)</option>
        <option value="Lexus">Lexus (å‡Œå¿—)</option><option value="Benz">Mercedes-Benz (è³“å£«)</option>
        <option value="BMW">BMW (å¯¶é¦¬)</option><option value="Honda">Honda (æœ¬ç”°)</option>
        <option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      
      <select id="c-mileage">
        <option value="">* å¹´é‡Œç¨‹ç¿’æ…£</option>
        <option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option>
        <option value="30000">30,000 å…¬é‡Œ</option><option value="40000">40,000 å…¬é‡Œ</option>
        <option value="50000">50,000 å…¬é‡Œä»¥ä¸Š</option>
      </select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆè¨»å†Š</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid #00D100;">
      <p id="ui-owner" style="font-size:18px; font-weight:bold; margin:0;">è®€å–ä¸­...</p>
      <p id="ui-car-info" style="font-size:13px; color:#888; margin:5px 0 10px 0;">è®€å–ä¸­...</p>
      <div><span class="tech-tag">æœ€æ–°éœé›»çº–ç¶­æŠ€è¡“</span><span class="tech-tag">æ¤°æ®¼é™¤è‡­æ´»æ€§ç¢³</span></div>
    </div>
    <div class="card" style="text-align:center;">
        <div style="font-size:11px; color:#888;">ğŸ“ æ‰€åœ¨åœ° (å³æ™‚)</div>
        <div id="ui-gps-location" style="color:#00D100; font-weight:bold; margin:5px 0;">å®šä½ä¸­...</div>
    </div>
    <div class="card" style="text-align:center;">
      <h1 id="ui-health" style="color:#00D100; font-size:48px; margin:0;">100%</h1>
      <p style="color:#888; font-size:12px;">æ¿¾ç¶²å¥åº·åº¦</p>
      <button class="btn-main" onclick="scanFilter()">ğŸ“· æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    </div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)">åº§è‰™</div>
    <div class="nav-item" onclick="switchPage('book', this)">é ç´„</div>
    <div class="nav-item" onclick="switchPage('rewards', this)">çå‹µ</div>
    <div class="nav-item" onclick="switchPage('settings', this)">è¨­å®š</div>
  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    const carData = { "Tesla": ["Model Y", "Model 3", "Model X"], "Toyota": ["RAV4", "Altis", "Cross"], "Other": ["å…¶ä»–"] };

    function updateCarModels() {
      const b = document.getElementById('c-brand').value;
      const m = document.getElementById('c-model');
      m.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>';
      if(carData[b]) carData[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
    }

    async function initApp() {
      await liff.init({ liffId: "2009187567-58hBrZRj" });
      if (!liff.isLoggedIn()) { liff.login(); return; }
      const p = await liff.getProfile();
      const { data } = await supabaseClient.from('users').select('*').eq('line_uid', p.userId).maybeSingle();
      if (data && data.name) {
        document.getElementById('nav-bar').style.display = 'flex';
        document.getElementById('ui-owner').innerText = data.name + " çš„å°ˆå±¬åº§è‰™";
        document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model} | ${data.license_plate}`;
        switchPage('home', null);
        getGPS();
      } else { switchPage('register', null); }
    }

    function getGPS() {
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`);
        const d = await res.json();
        document.getElementById('ui-gps-location').innerText = `ğŸ“ ${d.address.city || ''}ã€${d.address.suburb || d.address.town || ''}`;
      });
    }

    async function submitRegister(role) {
      const p = await liff.getProfile();
      const { error } = await supabaseClient.from('users').upsert({
        line_uid: p.userId, role: role, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value,
        city: document.getElementById('c-city').value, car_brand: document.getElementById('c-brand').value,
        car_model: document.getElementById('c-model').value, license_plate: document.getElementById('c-plate').value,
        yearly_mileage: parseInt(document.getElementById('c-mileage').value)
      });
      if(!error) location.reload();
    }

    function switchPage(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-'+id).classList.add('active');
    }

    initApp();
  </script>
</body>
</html>
