<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg-image: none; --bg-color: #050505; --text-color: #e0e6ed; --text-muted: #7a8594;
      --card-bg: #121417; --border-color: #22262a; --input-bg: #000000; --input-text: #00ffcc; 
      --input-border: #333b44; --nav-bg: rgba(10, 12, 15, 0.95); --nav-text: #66707a;
      --primary-color: #00e676; --primary-gradient: linear-gradient(135deg, #00e676 0%, #00a355 100%);
      --tag-bg: linear-gradient(90deg, rgba(0, 40, 20, 0.8) 0%, rgba(10, 15, 12, 0.9) 100%);
      --tag-text: #00ffcc; --msg-bar-bg: linear-gradient(to right, #0f1c14, #050505);
      --env-box-bg: #16191c; --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.8);
    }
    body.light-mode {
      --bg-image: none; --bg-color: #f4f7f6; --text-color: #2c3e50; --text-muted: #7f8c8d;
      --card-bg: #ffffff; --border-color: #e0e6ed; --input-bg: #ffffff; --input-text: #2c3e50;
      --input-border: #bdc3c7; --nav-bg: rgba(255, 255, 255, 0.95); --nav-text: #95a5a6;
      --primary-color: #27ae60; --primary-gradient: linear-gradient(135deg, #2ecc71 0%, #229954 100%);
      --tag-bg: #f8fdfa; --tag-text: #1e8449; --msg-bar-bg: #edf7f2;
      --env-box-bg: #ffffff; --card-shadow: 0 8px 24px rgba(149, 157, 165, 0.15); 
    }
    body.metal-mode {
      --bg-image: repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 3px), linear-gradient(145deg, #3a3c42 0%, #1e2024 100%);
      --bg-color: #2b2d31; --text-color: #f0f2f5; --text-muted: #aab0b8;
      --card-bg: linear-gradient(145deg, #32353a 0%, #232529 100%); --border-color: #55595e;
      --input-bg: #1a1b1e; --input-text: #00ffcc; --input-border: #55595e;
      --nav-bg: rgba(35, 37, 41, 0.95); --nav-text: #8b9096; --primary-color: #00e676;
      --primary-gradient: linear-gradient(135deg, #00e676 0%, #00b359 100%);
      --tag-bg: linear-gradient(145deg, #3a3d42 0%, #282a2e 100%); --tag-text: #00ffcc;
      --msg-bar-bg: linear-gradient(to right, #2c3035, #1e2024); --env-box-bg: linear-gradient(145deg, #2f3136 0%, #232529 100%);
      --card-shadow: inset 0 1px 1px rgba(255,255,255,0.1), 0 8px 20px rgba(0,0,0,0.6);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background-color: var(--bg-color); background-image: var(--bg-image); color: var(--text-color); padding-bottom: 90px; transition: background 0.4s, color 0.4s; min-height: 100vh;}
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; } .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .card { background: var(--card-bg); padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid var(--border-color); box-shadow: var(--card-shadow); transition: all 0.4s; }
    .btn-main { background: var(--primary-gradient); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; transition: opacity 0.2s, transform 0.1s; text-shadow: 0 1px 2px rgba(0,0,0,0.3);}
    .btn-main:active { opacity: 0.8; transform: scale(0.98); }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border); border-radius: 10px; box-sizing: border-box; transition: background 0.3s, color 0.3s; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--nav-bg); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid var(--border-color); z-index: 999; backdrop-filter: blur(15px); transition: background 0.3s; }
    .nav-item { color: var(--nav-text); font-size: 11px; cursor: pointer; text-align: center; width: 20%; transition: color 0.3s, transform 0.2s; }
    .nav-item:active { transform: scale(0.9); } .nav-item.active { color: var(--primary-color); font-weight: bold; }
    
    .shield-badge { background: rgba(0, 230, 118, 0.1); border: 1px solid var(--primary-color); color: var(--primary-color); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 12px; animation: badgePulse 1.5s infinite alternate ease-in-out; }
    @keyframes badgePulse { 0% { box-shadow: 0 0 5px rgba(0, 230, 118, 0.2); border-color: rgba(0, 230, 118, 0.4); } 100% { box-shadow: 0 0 25px rgba(0, 230, 118, 0.9), inset 0 0 10px rgba(0, 230, 118, 0.3); border-color: rgba(0, 230, 118, 1); text-shadow: 0 0 5px rgba(0,230,118,0.8); } }
    .pulse-dot { display: inline-block; width: 14px; height: 14px; background: var(--primary-color); border-radius: 50%; animation: superHeartBeat 1.5s infinite cubic-bezier(0.215, 0.61, 0.355, 1); }
    @keyframes superHeartBeat { 0% { transform: scale(0.5); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.9), 0 0 10px rgba(0,230,118,1); } 50% { transform: scale(1.6); box-shadow: 0 0 0 15px rgba(0, 230, 118, 0), 0 0 25px rgba(0,230,118,0.6); } 100% { transform: scale(0.5); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0), 0 0 10px rgba(0,230,118,1); } }
    
    .tech-tag-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
    .tech-tag { background: var(--tag-bg); color: var(--tag-text); padding: 10px 12px; border-radius: 8px; font-size: 12px; border: 1px solid var(--border-color); border-left: 4px solid var(--primary-color); display: flex; align-items: center; gap: 8px; font-weight: bold; letter-spacing: 0.5px; transition: background 0.3s, color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .tech-tag-icon { font-size: 15px; }

    .dynamic-msg-bar { background: var(--msg-bar-bg); color: var(--primary-color); padding: 14px 15px; border-radius: 8px; font-size: 14px; margin-bottom: 15px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; transition: background 0.3s; box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
    .dynamic-msg-icon { margin-right: 12px; font-size: 16px; flex-shrink: 0; }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; }
    .marquee-content { display: inline-block; min-width: 100%; animation: scrollText 12s linear infinite; font-weight: 500; }
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    
    .env-box { background: var(--env-box-bg); border-radius: 10px; padding: 15px 10px; text-align: center; border: 1px solid var(--border-color); transition: background 0.3s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
    .env-val { font-size: 26px; font-weight: bold; color: var(--text-color); margin: 8px 0 0 0; transition: color 0.3s; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

    .ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
    .ring { width: 160px; height: 160px; border-radius: 50%; border: 6px solid var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 25px rgba(0, 230, 118, 0.2); position: relative; }
    .ring::after { content: ''; position: absolute; top: -10px; left: -10px; right: -10px; bottom: -10px; border-radius: 50%; border: 1px dashed rgba(0,230,118,0.4); animation: rotate 8s linear infinite; }
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .esg-box { text-align: center; padding: 12px 5px; background: var(--env-box-bg); border-radius: 12px; border: 1px solid var(--border-color); transition: background 0.3s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); position: relative; }
    .esg-badge { position: absolute; top: -8px; right: -5px; background: var(--primary-color); color: #000; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }
    
    .tab-btn { padding: 12px; margin: 0; font-size: 13px; flex: 1; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid var(--border-color); white-space: nowrap; transition: all 0.3s; }
    .tab-btn.active { background: var(--primary-gradient); color: #fff; border-color: var(--primary-color); text-shadow: 0 1px 2px rgba(0,0,0,0.3);}
    .tab-btn.inactive { background: var(--env-box-bg); color: var(--text-muted); }
    
    .log-item { border-bottom: 1px solid var(--border-color); padding: 10px 0; font-size: 13px; color: var(--text-muted); }
    .log-item:last-child { border-bottom: none; }
    .version-tag { text-align: center; color: var(--text-muted); font-size: 11px; margin-top: 30px; font-family: monospace; }
    label { font-size: 12px; color: var(--text-muted); font-weight: bold; margin-bottom: 4px; display: block; }

    .vip-card { border: 1px solid #553300; background: linear-gradient(135deg, #1f1c0d, #2a2000); box-shadow: 0 10px 30px rgba(255, 152, 0, 0.15); position: relative; overflow: hidden; }
    .vip-card::before { content: ''; position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255, 152, 0, 0.15); filter: blur(30px); border-radius: 50%; }
    .shine-btn { position: relative; overflow: hidden; }
    .shine-btn::after { content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%); transform: skewX(-25deg); animation: shine 3s infinite; }
    @keyframes shine { 0% { left: -100%; } 20% { left: 200%; } 100% { left: 200%; } }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:var(--primary-color);">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card"><p style="font-size:12px; color:var(--text-muted); margin:0;">æœ¬ç³»çµ±è’é›†è³‡æ–™åƒ…ä¾›ä¿å›ºé ç´„èˆ‡å±¥æ­·ç´€éŒ„ä½¿ç”¨ã€‚</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#444; color:#fff;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      <select id="c-city">
        <option value="">* å±…ä½ç¸£å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="å…¶ä»–">å…¶ä»–ç¸£å¸‚</option>
      </select>
      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option><option value="Toyota">Toyota</option><option value="Honda">Honda</option><option value="Tesla">Tesla</option><option value="Benz">Benz</option><option value="BMW">BMW</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆè¨»å†Š</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid var(--primary-color); margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <p id="ui-owner" style="font-size:18px; font-weight:bold; margin:0; color:var(--text-color);">è®€å–ä¸­...</p>
          <p id="ui-car-info" style="font-size:13px; color:var(--text-muted); margin:5px 0 0 0;">è®€å–ä¸­...</p>
        </div>
        <div class="shield-badge"><span class="pulse-dot"></span> é˜²è­·ä¸­ é–‹å•Ÿ</div>
      </div>
      
      <div class="tech-tag-container">
        <div class="tech-tag"><span class="tech-tag-icon">ğŸ‡¹ğŸ‡¼</span> å°ç£è£½é€ </div>
        <div class="tech-tag"><span class="tech-tag-icon">âš¡</span> é«˜æ•ˆéœé›»éæ¿¾</div>
        <div class="tech-tag"><span class="tech-tag-icon">ğŸ¥¥</span> å¼·æ•ˆæ¤°æ®¼é™¤è‡­</div>
        <div class="tech-tag"><span class="tech-tag-icon">ğŸ“¡</span> å³æ™‚ç©ºæ±¡é›·é”</div>
        <div class="tech-tag"><span class="tech-tag-icon">ğŸ§ </span> Aiå‹•æ…‹æ¼”ç®—</div>
        <div class="tech-tag"><span class="tech-tag-icon">ğŸŒ±</span> ESGæ¸›ç¢³è²¢ç»</div>
      </div>
    </div>
    
    <div class="dynamic-msg-bar">
      <span class="dynamic-msg-icon">ğŸ’¬</span>
      <div class="marquee-container">
        <span class="marquee-content" id="ui-dynamic-msg">ç³»çµ±é€£ç·šä¸­ï¼Œæ­£åœ¨ç”±ç¸½éƒ¨å¤§æ•¸æ“šä¸­å¿ƒèª¿å–è³‡æ–™...</span>
      </div>
    </div>

    <div class="grid-2">
      <div class="env-box">
        <div style="font-size:12px; color:var(--text-muted);">ğŸ“ <span id="ui-loc-name">å®šä½ä¸­</span> (å³æ™‚)</div>
        <div class="env-val" id="env-aqi" style="color:var(--primary-color);">--</div>
      </div>
      <div class="env-box" style="border-color:#554400;">
        <div style="font-size:12px; color:var(--text-muted);">ğŸ  <span id="ui-home-city">è®€å–ä¸­</span> (è¿‘7æ—¥)</div>
        <div class="env-val" id="env-home-aqi" style="color:#FF9800;">--</div>
      </div>
    </div>

    <div class="card" style="text-align: center; margin-top:5px;">
      <div class="ring-container">
        <div class="ring">
          <div style="font-size:48px; font-weight:bold; color:var(--primary-color);" id="ui-health">100%</div>
          <div style="font-size:12px; color:var(--text-muted);">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
        </div>
        <div style="color:#FF9800; font-size:13px; margin-top:15px; font-weight:bold; background:rgba(255,152,0,0.1); padding:6px 12px; border-radius:20px; border: 1px solid rgba(255,152,0,0.3);">
          ğŸ›¡ï¸ å·²æ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg
        </div>
      </div>
      <button class="btn-main" onclick="scanFilter()">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    </div>
    
    <div class="grid-3">
      <div class="esg-box">
        <div class="esg-badge">4Paä½é¢¨é˜»</div>
        <div style="font-size:20px; margin-top:5px;">ğŸŒ±</div><div style="font-size:16px; font-weight:bold; color:var(--text-color);"><span id="ui-esg-co2">0</span> kg</div><div style="font-size:11px; color:var(--text-muted);">çœç¢³è¶³è·¡</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">é¼“é¢¨æ©Ÿæ¸›è² </div>
        <div style="font-size:20px; margin-top:5px;">âš¡ï¸</div><div style="font-size:16px; font-weight:bold; color:var(--text-color);"><span id="ui-esg-kwh">0</span> kWh</div><div style="font-size:11px; color:var(--text-muted);">çœé›»æ•ˆèƒ½</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">5.3 CM/S</div>
        <div style="font-size:20px; margin-top:5px;">â›½ï¸</div><div style="font-size:16px; font-weight:bold; color:var(--text-color);"><span id="ui-esg-ac">0</span> %</div><div style="font-size:11px; color:var(--text-muted);">ç©ºèª¿ç¯€èƒ½æå‡</div>
      </div>
    </div>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--primary-color);">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="card" style="text-align:center;">
      <p style="color:var(--text-muted);">å°ˆå±¬å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--primary-color); letter-spacing: 2px; border: 1px dashed var(--primary-color); padding: 10px;">AIRPLUS2026</h2>
      <button class="btn-main" style="background:#333; color:#fff;" onclick="window.location.href='https://www.hypass.com.tw/oauth/line/quick_sign_up'">å‰å¾€å•†åŸä¸¦è‡ªå‹•ç™»å…¥</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--primary-color);">ğŸ“ é ç´„å®‰è£</h3>
    <div id="booking-section">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn inactive" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ é™„è¿‘ä¿ä¿®å» </div>
      </div>
      <div id="booking-smart"><div id="smart-match-result" class="card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
      <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--primary-color);">ğŸ æ¨è–¦ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="card vip-card" style="text-align: center;">
      <h4 style="margin:0; color:#FFB300; font-size: 16px;">âœ¨ æ‚¨çš„çå‹µé‡‘é¤˜é¡</h4>
      <h1 style="margin:10px 0; font-size: 48px; color: #FFF; text-shadow: 0 2px 15px rgba(255, 152, 0, 0.6);"><span id="reward-balance">$0</span></h1>
      <p style="font-size:13px; color:#ddd; margin-bottom: 20px;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Pointsï¼Œç´¯ç©ç„¡ä¸Šé™ï¼</p>
      <button class="btn-main shine-btn" style="background: linear-gradient(135deg, #FFB300, #FF8C00); color: #000; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);" onclick="redeemPoints()">ğŸ’° ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    <div class="card" style="text-align: center; border: 2px dashed var(--primary-color); background: var(--env-box-bg);">
       <h3 style="margin-top: 5px; color: var(--text-color);">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 20px;">åˆ†äº«æ‚¨çš„å°ˆå±¬é€£çµï¼Œå¥½å‹æˆåŠŸå•Ÿç”¨æ¿¾ç¶²ï¼Œæ‚¨å°‡ç«‹å³ç²å¾—é«˜é¡æ¨è–¦çå‹µï¼</p>
       <button class="btn-main shine-btn" style="background: var(--primary-gradient); color: #000; font-size: 18px; letter-spacing: 1px;" onclick="generateMGM()">ğŸ”— é»æˆ‘è¤‡è£½æ¨è–¦é€£çµ ğŸ”—</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--primary-color);">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    <div style="display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;">
      <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="tab-btn inactive" id="tab-set-theme" onclick="switchSetTab('theme')">ğŸ¨ ç•«é¢è¨­å®š</div>
      <div class="tab-btn inactive" id="tab-set-b" onclick="switchSetTab('b')">ğŸ“œ æ­·å²ç´€éŒ„</div>
      <div class="tab-btn inactive" id="tab-set-c" onclick="switchSetTab('c')">ğŸ“„ æ•¸ä½åˆç´„</div>
    </div>

    <div id="set-content-a" style="display:block;">
      <div class="card">
        <label>å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>é›»å­éƒµä»¶</label><input type="email" id="edit-email">
        <label>æ€§åˆ¥</label><select id="edit-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        <label>å±…ä½ç¸£å¸‚</label><select id="edit-city"><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="å…¶ä»–">å…¶ä»–</option></select>
        <label>è»Šè¼›å“ç‰Œ</label><select id="edit-brand" onchange="updateCarModels('edit-brand', 'edit-model')"><option value="Toyota">Toyota</option><option value="Tesla">Tesla</option><option value="Other">å…¶ä»–å“ç‰Œ</option></select>
        <label>è»Šè¼›å‹è™Ÿ</label><select id="edit-model"></select>
        <label>å‡ºå» å¹´ä»½</label><input type="number" id="edit-year">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label><select id="edit-mileage"><option value="10000">10,000</option><option value="20000">20,000</option><option value="30000">30,000</option></select>
        <button class="btn-main" onclick="updateProfile()">å„²å­˜ä¿®æ­£è³‡æ–™</button>
      </div>
    </div>
    
    <div id="set-content-theme" style="display:none;">
      <div class="card" style="text-align: center;">
        <h4 style="margin-top:0; color:var(--text-color);">è«‹é¸æ“‡åº§è‰™é¡¯ç¤ºæ¨¡å¼</h4>
        <div style="display:flex; flex-direction: column; gap:12px; margin-top: 20px;">
          <button class="btn-main" id="btn-theme-dark" style="background:#050505; color:#00e676; border:2px solid transparent; box-shadow: 0 4px 10px rgba(0,230,118,0.2);" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘ (ç§‘æŠ€å†·å…‰)</button>
          <button class="btn-main" id="btn-theme-metal" style="background:linear-gradient(135deg, #4a4d51, #2b2d31); color:#00ffcc; border:2px solid transparent; box-shadow: inset 0 2px 5px rgba(255,255,255,0.1);" onclick="setTheme('metal')">âš™ï¸ éˆ¦é‡‘å±¬ (é‡è£æ©Ÿç”²)</button>
          <button class="btn-main" id="btn-theme-light" style="background:#ffffff; color:#2c3e50; border:2px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.05);" onclick="setTheme('light')">â˜€ï¸ çç ç™½ (å„ªé›…å¥¢è¯)</button>
        </div>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="card">
        <select id="history-type" onchange="loadHistory(this.value)" style="margin-bottom:15px; border-color:var(--primary-color); color:var(--primary-color); font-weight:bold;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option><option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
          <option value="shop">ğŸ›’ å•†åŸè³¼è²·ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 300px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    
    <div id="set-content-c" style="display:none;">
      <div class="card"><h4 style="margin:0 0 10px 0; color:var(--text-color);">ğŸ“„ HYPASS æ•¸ä½ä¿å›ºå¡</h4><p style="font-size:13px; color:var(--text-muted); margin:5px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--primary-color); font-weight:bold;"></span></p></div>
    </div>
    <div class="version-tag">System Ver. V3.9-ç‰©ç†æ¼”ç®—æ³•ç‰ˆ</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><div style="font-size:22px;">â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="switchPage('shop', this)"><div style="font-size:22px;">ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="switchPage('book', this)"><div style="font-size:22px;">ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><div style="font-size:22px;">ğŸ</div>çå‹µ</div>
    <div class="nav-item" onclick="switchPage('settings', this)"><div style="font-size:22px;">âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    window.onerror = function(msg, url, line) { console.log("Error:", msg, "at line:", line); return false; };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; 
    let currentLocName = 'å°ç£'; 
    let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };

    const carData = { "Toyota": ["Model Y", "RAV4", "å…¶ä»–"], "Tesla": ["Model Y", "Model 3", "å…¶ä»–"], "Other": ["å…¶ä»–"] };

    function setTheme(theme) {
      document.body.classList.remove('light-mode', 'metal-mode');
      document.getElementById('btn-theme-dark').style.border = '2px solid transparent';
      document.getElementById('btn-theme-light').style.border = '2px solid transparent';
      document.getElementById('btn-theme-metal').style.border = '2px solid transparent';
      if (theme === 'light') { document.body.classList.add('light-mode'); document.getElementById('btn-theme-light').style.border = '2px solid #27ae60'; } 
      else if (theme === 'metal') { document.body.classList.add('metal-mode'); document.getElementById('btn-theme-metal').style.border = '2px solid #00ffcc'; } 
      else { theme = 'dark'; document.getElementById('btn-theme-dark').style.border = '2px solid #00e676'; }
      localStorage.setItem('hypass_theme', theme);
    }
    setTheme(localStorage.getItem('hypass_theme') || 'dark');

    function updateCarModels(brandId, modelId) { 
      const bSelect = document.getElementById(brandId).value; const mSelect = document.getElementById(modelId); mSelect.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
      if (carData[bSelect]) carData[bSelect].forEach(item => { mSelect.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function showForm(role) { document.getElementById('form-customer').style.display = (role === 'customer') ? 'block' : 'none'; document.getElementById('form-garage').style.display = (role === 'garage') ? 'block' : 'none'; }
    function switchPage(id, el) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('page-' + id).classList.add('active'); if (el) el.classList.add('active'); if (id === 'book') loadGarages(); }
    
    function switchSetTab(t) { 
      ['a','theme','b','c'].forEach(tab => {
        document.getElementById(`set-content-${tab}`).style.display = (t === tab) ? 'block' : 'none';
        document.getElementById(`tab-set-${tab}`).className = `tab-btn ${t === tab ? 'active' : 'inactive'}`;
      });
    }
    function switchBookingTab(t) { document.getElementById('booking-smart').style.display = (t === 'smart') ? 'block' : 'none'; document.getElementById('booking-manual').style.display = (t === 'manual') ? 'block' : 'none'; document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : 'inactive'}`; document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : 'inactive'}`; }

    // ==========================================
    // ğŸŒŸ ç‰©ç† ESG æ¼”ç®—æ³•æ ¸å¿ƒ (å‹•æ…‹è¨ˆç®—)
    // ==========================================
    async function calculateDashboardStats() {
      if (!currentUser) return;
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      
      if (filter && filter.activated_at) {
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
        
        // å–å¾—å¾Œå°æ¼”ç®—æ³•åƒæ•¸ (æ”¯æ´æœ¬æ©Ÿç«¯é™¤éŒ¯æ¨¡æ“¬)
        const algoParams = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        
        // 1. å£½å‘½å¥åº·åº¦æ¼”ç®—æ³•
        let mileageRate = currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0;
        let aqiRate = (envData.aqi > 150) ? parseFloat(algoParams.weightRed || 1.8) : (envData.aqi > 100 ? parseFloat(algoParams.weightOrange || 1.4) : parseFloat(algoParams.weightGreen || 1.0));
        let baseWear = parseFloat(algoParams.baseWear || 0.27);
        let health = 100 - (days * baseWear * mileageRate * aqiRate);
        document.getElementById('ui-health').innerText = `${Math.max(0, Math.round(health))}%`;
        if (health < 30) document.getElementById('ui-health').style.color = '#ff0000';
        
        let basePm25 = parseFloat(algoParams.basePm25 || 1250);
        document.getElementById('ui-pm25').innerText = Math.round(days * basePm25 * mileageRate * aqiRate).toLocaleString();
        
        // ğŸŒŸ 2. ç©ºèª¿ç¯€èƒ½æ¼”ç®—æ³• (ç‰©ç†ï¼šä»–ç‰Œ8Pa vs æœ¬å» 4Pa)
        let paHypass = parseFloat(algoParams.paHypass || 4);
        let paOther = parseFloat(algoParams.paOther || 8);
        // å…¬å¼ï¼š(8 - 4) / 8 * 30% é¼“é¢¨æ©Ÿæ¬Šé‡ = 15% ç©ºèª¿ç¯€èƒ½
        let acSavingPct = Math.round(((paOther - paHypass) / paOther) * 30);
        document.getElementById('ui-esg-ac').innerText = acSavingPct;

        // ğŸŒŸ 3. çœé›»æ•ˆèƒ½æ¼”ç®—æ³• (kWh)
        let kwhPerDay = parseFloat(algoParams.kwhPerDay || 0.25);
        let totalKwhSaved = (days * kwhPerDay * mileageRate).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = totalKwhSaved;

        // ğŸŒŸ 4. çœç¢³è¶³è·¡æ¼”ç®—æ³• (CO2)
        let co2Factor = parseFloat(algoParams.co2Factor || 0.5);
        let totalCo2Saved = (totalKwhSaved * co2Factor).toFixed(1);
        document.getElementById('ui-esg-co2').innerText = totalCo2Saved;
      }
    }

    async function fetchEnvironmentalData(city, district) {
      try {
        let { data } = await supabaseClient.from('env_cache').select('*').eq('city', city).eq('district', district).maybeSingle();
        if (!data) { const { data: fallback } = await supabaseClient.from('env_cache').select('*').limit(1).single(); data = fallback || { temp: 25, hum: 60, aqi: 50, pm25: 15 }; }
        envData.temp = data.temp; envData.hum = data.hum; envData.aqi = data.aqi; envData.pm25 = data.pm25;
        document.getElementById('env-aqi').innerText = envData.aqi;
        document.getElementById('env-home-aqi').innerText = Math.round(envData.aqi * (0.8 + Math.random() * 0.4));

        let msg = `ç³»çµ±é€£ç·šæ­£å¸¸ï¼Œç›®å‰å®¤å¤– AQI: ${envData.aqi}ï¼Œæ¿¾ç¶²æŒçºŒé˜²è­·ä¸­ï¼`;
        if (envData.aqi > 100) { document.getElementById('env-aqi').style.color = '#ff9800'; msg = `âš ï¸ æ³¨æ„ï¼ç›®å‰ç©ºæ°£å“è³ªä¸ä½³ï¼Œè«‹ç¢ºä¿è»Šçª—ç·Šé–‰ï¼Œç³»çµ±å°‡åŠ é€Ÿæ·¨åŒ–ã€‚`; }
        if (envData.aqi > 150) { document.getElementById('env-aqi').style.color = '#ff0000'; msg = `ğŸš¨ ç´«çˆ†è­¦å‘Šï¼æˆ¶å¤–ç©ºæ°£æ¥µåº¦æƒ¡åŠ£ï¼ŒHYPASS æ­£å…¨åŠ›ç‚ºæ‚¨æ””æˆªæ¯’å®³å¾®ç²’ã€‚`; }
        document.getElementById('ui-dynamic-msg').innerText = msg;
        calculateDashboardStats();
      } catch (e) { calculateDashboardStats(); }
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(res => res.json())
            .then(d => {
              let city = d.address.city || d.address.county || '';
              let district = d.address.suburb || d.address.town || '';
              currentLocName = `${city}${district}`;
              document.getElementById('ui-loc-name').innerText = currentLocName;
              fetchEnvironmentalData(city, district);
            }).catch(e => { document.getElementById('ui-loc-name').innerText = "å®šä½å®Œæˆ"; });
        }, () => { calculateDashboardStats(); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); 
      }
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        const { data, error } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).maybeSingle();
        if (data && data.name) {
          currentUser = data; document.getElementById('nav-bar').style.display = 'flex';
          if (data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model}`;
            switchPage('home', document.querySelector('.nav-item'));
            getGPS(); 
          }
        } else { switchPage('register', null); }
      } catch (err) { console.log("LIFF å•Ÿå‹•å¤±æ•—"); }
    }
    initApp();
  </script>
</body>
</html>
