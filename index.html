<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =========================================
       ğŸ’ V5.11 Tesla x Gogoro (å…¨åŠŸèƒ½çµ•å°ä¸åˆªæ¸›ç‰ˆ)
       ========================================= */
       
    :root {
      --bg-image: none; --bg-color: #000000; --surface-color: #161618; --border-color: #2c2c2e;
      --text-primary: #ffffff; --text-secondary: #8e8e93;
      --accent-color: #00e676; --accent-gradient: linear-gradient(135deg, #00e676 0%, #00b85c 100%);
      --accent-glow: rgba(0, 230, 118, 0.2); --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(10, 10, 10, 0.85); --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); --input-bg: #1c1c1e;
    }

    body.light-mode {
      --bg-color: #f2f2f7; --surface-color: #ffffff; --border-color: #e5e5ea;
      --text-primary: #1c1c1e; --text-secondary: #8e8e93;
      --accent-color: #10b981; --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --accent-glow: rgba(16, 185, 129, 0.15); --gold-color: #d4af37; --gold-glow: rgba(212, 175, 55, 0.15);
      --glass-bg: rgba(255, 255, 255, 0.9); --input-bg: #f9f9f9;
    }

    body.metal-mode {
      --bg-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0px, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 4px);
      --bg-color: #151515; --surface-color: linear-gradient(145deg, #262628 0%, #1c1c1e 100%);
      --border-color: #3a3a3c; --text-primary: #e5e5ea; --text-secondary: #98989d;
      --accent-color: #06b6d4; --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      --accent-glow: rgba(6, 182, 212, 0.25); --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(28, 28, 30, 0.9); --input-bg: #111112;
    }

    html { background-color: #000000; display: flex; justify-content: center; min-height: 100vh; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; width: 100vw; max-width: 430px; background-color: var(--bg-color); background-image: var(--bg-image); color: var(--text-primary); padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); transition: background 0.4s ease, color 0.4s ease; min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.8); overflow-x: hidden; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    
    .page { display: none; padding: 16px; animation: fadeIn 0.4s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .g-card { background: var(--surface-color); border-radius: 20px; padding: 18px; box-shadow: var(--card-shadow); margin-bottom: 16px; border: 1px solid var(--border-color); }
    .btn-main { background: var(--accent-gradient); color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px var(--accent-glow); transition: 0.2s; letter-spacing: 1px;}
    .btn-main:active { transform: scale(0.96); }

    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--glass-bg); display: flex; padding: 6px 5px calc(4px + env(safe-area-inset-bottom, 0px)) 5px; border-top: 1px solid var(--border-color); z-index: 999; backdrop-filter: blur(25px); }
    .nav-item { color: var(--text-secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; flex: 1; height: 42px; transition: 0.2s;}
    .nav-item:active { transform: scale(0.9); }
    .nav-item.active { color: var(--accent-color); font-weight: 700; }
    .nav-icon { font-size: 22px; } .nav-text { font-size: 11px; margin-top: 2px;}

    .header-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 25px; }
    .header-title-box { flex: 1; min-width: 0; } 
    #ui-owner { font-size: 20px; font-weight: 800; margin: 0; color: var(--text-primary); }
    .shield-badge { display:inline-flex; background: var(--accent-glow); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700; align-items: center; gap: 6px; }
    .pulse-dot { display: inline-block; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; animation: heartBeat 1.8s infinite; }
    @keyframes heartBeat { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 var(--accent-color); } 50% { transform: scale(1.6); box-shadow: 0 0 0 8px rgba(0,0,0,0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

    .main-visual-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0 20px 0; }
    .ring { width: 220px; height: 220px; border-radius: 50%; border: 6px solid var(--accent-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--accent-glow); position: relative; background: var(--surface-color); z-index: 2;}
    .ring::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 1px dashed var(--text-secondary); animation: rotate 25s linear infinite; opacity: 0.2; z-index: 1;}
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .pm25-badge { background: rgba(255,255,255,0.05); border: 1px solid var(--gold-color); color: var(--gold-color); padding: 8px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; margin-top: 25px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.15); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .env-box { background: var(--input-bg); border-radius: 14px; padding: 16px 10px; text-align: center; border: 1px solid var(--border-color); }
    .env-val { font-size: 32px; font-weight: 800; line-height: 1; margin: 8px 0; }
    
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 16px;}
    .esg-box { text-align: center; padding: 12px 6px; background: var(--input-bg); border-radius: 14px; border: 1px solid var(--border-color); position: relative; }
    .esg-badge { position: absolute; top: -8px; right: 50%; transform: translateX(50%); background: var(--accent-gradient); color: #fff; font-size: 9px; padding: 3px 6px; border-radius: 10px; font-weight: 700; white-space: nowrap;}
    
    .tech-tag-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin: 20px 0; }
    .tech-tag { background: var(--input-bg); padding: 8px 2px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 9.5px; font-weight: 600; }
    
    .dynamic-msg-bar { background: var(--surface-color); color: var(--accent-color); padding: 0 16px; height: 48px; border-radius: 16px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; font-weight: 600; transition: all 0.4s ease; box-shadow: var(--card-shadow); }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; height: 100%; }
    .marquee-content { display: flex; align-items: center; min-width: 100%; animation: scrollText 14s linear infinite; } 
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

    input, select { width: 100%; padding: 16px; margin-bottom: 16px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 14px; font-size: 15px; box-sizing: border-box; outline: none; }
    input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--accent-glow); }
    label { font-size: 13px; color: var(--text-secondary); font-weight: 600; margin-bottom: 8px; display: block; padding-left: 4px; }

    .tab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px; }
    .tab-btn { padding: 14px 10px; font-size: 13px; text-align: center; border-radius: 14px; cursor: pointer; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; transition: all 0.3s; background: var(--input-bg); color: var(--text-secondary);}
    .tab-btn.active { background: var(--accent-gradient); color: #fff; border-color: var(--accent-color); box-shadow: 0 6px 15px var(--accent-glow);}
    
    .vip-card { border: 1px solid var(--gold-color); background: linear-gradient(135deg, #1a1500 0%, #050400 100%); box-shadow: 0 15px 40px var(--gold-glow); position: relative; overflow: hidden; }
    .log-item { border-bottom: 1px solid var(--border-color); padding: 16px 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .log-item:last-child { border-bottom: none; }
    .version-tag { text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 40px; font-family: monospace; letter-spacing: 1px; opacity: 0.6;}

    .scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    .scanner-box { width: 90%; max-width: 350px; background: #111; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid var(--accent-color); }
    #frontend-reader { width: 100%; border-radius: 12px; overflow: hidden; }
    .scanner-hint { color: var(--accent-color); font-weight: bold; margin-bottom: 15px; }
  </style>
</head>
<body>

  <script>
    (function captureReferral() {
        try {
            let urlParams = new URLSearchParams(window.location.search);
            let ref = urlParams.get('ref');
            if (!ref && urlParams.get('liff.state')) {
                let stateParams = new URLSearchParams(urlParams.get('liff.state').replace(/^\?/, ''));
                ref = stateParams.get('ref');
            }
            if (ref) localStorage.setItem('hypass_ref_code', ref);
        } catch(e) {}
    })();
  </script>

  <div id="page-register" class="page">
    <h2 style="text-align:center; margin-bottom:30px;">HYPASS <span style="color:var(--accent-color);">Air+</span></h2>
    <div class="g-card">
      <p style="text-align:center; font-size:14px; color:var(--text-secondary); line-height: 1.5; margin:0;">ç‚ºä¿éšœæ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p>
    </div>
    
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none; margin-top:10px;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:30px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      
      <select id="c-city" onchange="updateDistricts('c-city', 'c-district')">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
        <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
        <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
        <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
        <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
        <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
      </select>
      <select id="c-district"><option value="">* é„‰é®å¸‚å€</option></select>
      <input type="text" id="c-address" placeholder="* è©³ç´°é€šè¨Šåœ°å€ (è¡—é“/å··å¼„/æ¨“å±¤)">

      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option>
        <option value="Toyota">Toyota</option><option value="Tesla">Tesla</option><option value="Honda">Honda</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* é¸æ“‡è»Šå‹</option></select>
      
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
      
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page active">
    <div class="header-flex">
      <div class="header-title-box">
        <p id="ui-owner">è¼‰å…¥ä¸­...</p>
        <p id="ui-car-info" style="font-size:13px; color:var(--text-secondary); margin:4px 0 0 0;">--</p>
      </div>
      <div class="shield-badge" id="ui-shield-badge">
        <span class="pulse-dot" id="ui-pulse-dot"></span> 
        <span id="ui-shield-text">é€£ç·šä¸­...</span>
      </div>
    </div>

    <div class="main-visual-container" style="text-align:center;">
      <div class="ring">
        <div style="font-size:64px; font-weight:900; color:var(--accent-color); letter-spacing:-2px;" id="ui-health">--%</div>
        <div style="font-size:12px; color:var(--text-secondary); font-weight:700;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
      </div>
      <div class="pm25-badge">ğŸ›¡ï¸ ç´¯è¨ˆæ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:15px; letter-spacing: 0.5px;">æ¿¾ç¶²å•Ÿç”¨æ—¥æœŸ: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>

    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span style="margin-right: 12px; font-size: 18px;">ğŸ’¬</span>
      <div class="marquee-container">
        <span class="marquee-content" id="ui-dynamic-msg">è¼‰å…¥æœ€æ–°ç’°å¢ƒæ•¸æ“šä¸­...</span>
      </div>
    </div>

    <div class="grid-2">
      <div class="env-box">
        <div style="font-size:12px; color:var(--text-secondary); font-weight:600;">ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" style="color:var(--text-primary); font-size:14px;">å®šä½ä¸­...</span></div>
        <div class="env-val" id="env-aqi" style="color:var(--accent-color);">--</div>
        <div style="font-size:10px; font-weight:800; color:var(--text-secondary); letter-spacing:1px;">AQI</div>
      </div>
      <div class="env-box" style="border-color:var(--gold-color);">
        <div style="font-size:12px; color:var(--text-secondary); font-weight:600;">ğŸ  7æ—¥å±…ä½åœ°<br><span id="ui-home-city" style="color:var(--text-primary); font-size:14px;">è®€å–ä¸­...</span></div>
        <div class="env-val" id="env-home-aqi" style="color:var(--gold-color);">--</div>
        <div style="font-size:10px; font-weight:800; color:var(--text-secondary); letter-spacing:1px;">AQI</div>
      </div>
    </div>

    <div class="grid-3">
      <div class="esg-box">
        <div class="esg-badge">æ¥µè‡´ä½é¢¨é˜»</div><div style="font-size:24px; margin-top:15px;">ğŸŒ±</div>
        <div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-co2">0</span> <span style="font-size:11px; color:var(--text-secondary);">kg</span></div>
        <div style="font-size:11px; color:var(--text-secondary); font-weight:600;">çœç¢³è¶³è·¡</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å†·æ°£è¼•è² è¼‰</div><div style="font-size:24px; margin-top:15px;">âš¡ï¸</div>
        <div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-kwh">0</span> <span style="font-size:11px; color:var(--text-secondary);">kWh</span></div>
        <div style="font-size:11px; color:var(--text-secondary); font-weight:600;">çœé›»æ•ˆèƒ½</div>
      </div>
      <div class="esg-box">
        <div class="esg-badge">å¼·æ•ˆå¤§é¢¨é‡</div><div style="font-size:24px; margin-top:15px;">â›½ï¸</div>
        <div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-ac">0</span> <span style="font-size:11px; color:var(--text-secondary);">%</span></div>
        <div style="font-size:11px; color:var(--text-secondary); font-weight:600;">ç©ºèª¿ç¯€èƒ½</div>
      </div>
    </div>

    <div class="tech-tag-container">
      <div class="tech-tag">ğŸ‡¹ğŸ‡¼ å°ç£è£½é€ </div><div class="tech-tag">âš¡ éœé›»éæ¿¾</div><div class="tech-tag">ğŸ¥¥ æ´»æ€§ç¢³</div>
      <div class="tech-tag">ğŸ“¡ ç©ºæ±™é›·é”</div><div class="tech-tag">ğŸ§  AI æ¼”ç®—</div><div class="tech-tag">ğŸŒ± ESG æ¸›ç¢³</div>
    </div>

    <button class="btn-main" onclick="openFrontendScanner()" style="margin-top:10px; background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;">ğŸ“· æƒæä¸€ç¶­æ¢ç¢¼ (UID) å•Ÿç”¨æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="g-card" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--text-secondary);">å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); border:2px dashed var(--accent-color); padding:15px; border-radius:12px; letter-spacing: 2px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw'">å‰å¾€å•†åŸé¸è³¼</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ“ é ç´„å®‰è£</h3>
    <div class="tab-grid" style="display: flex; gap: 10px; margin-bottom: 20px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')" style="flex:1;">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn" id="tab-btn-manual" onclick="switchBookingTab('manual')" style="flex:1;">ğŸ“‹ ä¿ä¿®å» æ¸…å–®</div>
    </div>
    <div id="booking-smart"><div id="smart-match-result" class="g-card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
    <div id="booking-manual" style="display:none;"><div id="garage-list">æ¸…å–®è®€å–ä¸­...</div></div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="g-card vip-card" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--gold-color); font-weight:bold; letter-spacing: 1px;">VIP å°ˆå±¬çå‹µé‡‘</p>
      <h1 id="reward-balance" style="font-size:64px; text-shadow:0 4px 20px rgba(255,215,0,0.5); margin:20px 0;">$0</h1>
      <p style="font-size:13px; color:#d4d4d4; margin-bottom: 20px; line-height:1.6;">ç´¯ç©æ»¿ 100 é»å³å¯å…Œæ› LINE Points</p>
      <button class="btn-main" style="background:linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color:#000;" onclick="redeemPoints()">ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    
    <div class="g-card" style="border-color:var(--accent-color); text-align:center; padding: 25px 20px;">
       <h3 style="margin-top:0;">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size:13px; color:var(--text-secondary); line-height: 1.6;">è¨»å†Šé€ <b style="color:var(--accent-color);">10</b> é»ï¼Œé¦–æƒå†é€ <b style="color:var(--gold-color);">100</b> é»ï¼</p>
       <button class="btn-main" onclick="shareToLine()">ğŸŸ¢ ç›´æ¥åˆ†äº«çµ¦ LINE å¥½å‹</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div class="tab-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:6px;">
        <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')" style="padding:10px 5px; font-size:11px;">ğŸ‘¤ è³‡æ–™</div>
        <div class="tab-btn" id="tab-set-theme" onclick="switchSetTab('theme')" style="padding:10px 5px; font-size:11px;">ğŸ¨ ç•«é¢</div>
        <div class="tab-btn" id="tab-set-b" onclick="switchSetTab('b')" style="padding:10px 5px; font-size:11px;">ğŸ“œ ç´€éŒ„</div>
        <div class="tab-btn" id="tab-set-c" onclick="switchSetTab('c')" style="padding:10px 5px; font-size:11px;">ğŸ“„ åˆç´„</div>
    </div>
    
    <div id="set-content-a" style="display:block;">
      <div class="g-card">
        <label>è»Šä¸»å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>é›»å­éƒµä»¶</label><input type="email" id="edit-email">
        <label>æ€§åˆ¥</label><select id="edit-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        
        <label>å±…ä½ç¸£å¸‚</label>
        <select id="edit-city" onchange="updateDistricts('edit-city', 'edit-district')">
          <option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
          <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option>
          <option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option>
          <option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option><option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
          <option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
          <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
          <option value="å°æ±ç¸£">å°æ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option><option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option>
          <option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
        </select>
        
        <label>é„‰é®å¸‚å€</label><select id="edit-district"></select>
        <label>è©³ç´°é€šè¨Šåœ°å€</label><input type="text" id="edit-address">

        <label>è»Šè¼›å“ç‰Œ</label>
        <select id="edit-brand" onchange="updateCarModels('edit-brand', 'edit-model')">
          <option value="Toyota">Toyota</option><option value="Tesla">Tesla</option><option value="Honda">Honda</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
        </select>
        <label>è»Šè¼›å‹è™Ÿ</label><select id="edit-model"></select>
        
        <label>å‡ºå» å¹´ä»½</label><input type="number" id="edit-year">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label>
        <select id="edit-mileage"><option value="10000">10,000 å…¬é‡Œä»¥ä¸‹</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œä»¥ä¸Š</option></select>
        
        <button class="btn-main" onclick="updateProfile()" style="margin-top:10px;">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    
    <div id="set-content-theme" style="display:none;">
      <div class="g-card" style="text-align:center; padding: 40px 20px;">
        <h3 style="margin-top:0; color:var(--text-primary); margin-bottom: 30px;">é¸æ“‡é¡¯ç¤ºæ¨¡å¼</h3>
        <div style="display:flex; flex-direction: column; gap:16px;">
          <button class="btn-main" id="btn-theme-dark" style="background:#000000; color:#00e676; border:1px solid #333;" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘</button>
          <button class="btn-main" id="btn-theme-light" style="background:#ffffff; color:#10b981; border:1px solid #ccc;" onclick="setTheme('light')">â˜€ï¸ æ¥µç°¡ç™½</button>
          <button class="btn-main" id="btn-theme-metal" style="background:linear-gradient(145deg, #2c2c2e 0%, #1c1c1e 100%); color:#06b6d4; border:1px solid #3a3a3c;" onclick="setTheme('metal')">ğŸŒŠ æ·¨åŒ–è—</button>
        </div>
      </div>
    </div>

    <div id="set-content-b" style="display:none;">
      <div class="g-card">
        <select onchange="loadHistory(this.value)" style="margin-bottom: 20px; font-weight: 700;">
            <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›ç´€éŒ„</option>
            <option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 350px; overflow-y: auto;">è®€å–ä¸­...</div>
      </div>
    </div>

    <div id="set-content-c" style="display:none;">
      <div class="g-card">
          <h4 style="margin:0 0 10px 0; color:var(--accent-color); font-size:18px;">ğŸ“„ HYPASS æ•¸ä½ä¿å›ºå¡</h4>
          <p style="font-size:14px; color:var(--text-secondary); margin:8px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--gold-color); font-weight:bold; font-size:18px;"></span></p>
      </div>
    </div>

    <div class="version-tag">System Ver. V5.11 (å…¨åŠŸèƒ½å®Œæ•´ä¸åˆªæ¸›ç‰ˆ)</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">â—“</span><span class="nav-text">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span class="nav-icon">ğŸ›’</span><span class="nav-text">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span class="nav-icon">ğŸ“</span><span class="nav-text">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><span class="nav-icon">ğŸ</span><span class="nav-text">ä»»å‹™</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-text">è¨­å®š</span></div>
  </div>

  <div class="scanner-modal" id="scanner-modal">
    <div class="scanner-box">
      <div class="scanner-hint">è«‹å°‡é¡é ­å°æº–åŒ…è£ä¸Šçš„ä¸€ç¶­æ¢ç¢¼</div>
      <div id="frontend-reader"></div>
      <button class="btn-main" style="width:100%; margin-top:25px; background:#ef4444; color:#fff; box-shadow:none;" onclick="closeScanner()">âœ– å–æ¶ˆæƒæ</button>
    </div>
  </div>

  <script>
    function setElText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
    function setElVal(id, val) { const el = document.getElementById(id); if (el) el.value = val; }
    window.onerror = function(msg) { console.error("Error: ", msg); return false; };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; 
    let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };
    
    const carData = { 
      "Toyota": ["RAV4", "Corolla Cross", "Altis", "Camry", "Yaris", "å…¶ä»–"], "Honda": ["CR-V", "HR-V", "Civic", "Fit", "å…¶ä»–"],
      "Nissan": ["Kicks", "Sentra", "X-Trail", "å…¶ä»–"], "Ford": ["Focus", "Kuga", "å…¶ä»–"], "Mazda": ["Mazda 3", "CX-5", "å…¶ä»–"],
      "Mitsubishi": ["Outlander", "Eclipse Cross", "Colt Plus", "å…¶ä»–"], "Hyundai": ["Tucson", "Custin", "Venue", "å…¶ä»–"],
      "Kia": ["Sportage", "Sorento", "EV6", "å…¶ä»–"], "Volkswagen": ["Golf", "Tiguan", "å…¶ä»–"], "Skoda": ["Kodiaq", "Kamiq", "å…¶ä»–"],
      "Lexus": ["NX", "RX", "UX", "ES", "å…¶ä»–"], "Benz": ["C-Class", "E-Class", "GLC", "GLE", "å…¶ä»–"],
      "BMW": ["3-Series", "5-Series", "X3", "X5", "å…¶ä»–"], "Audi": ["A3", "A4", "Q3", "Q5", "å…¶ä»–"],
      "Volvo": ["XC60", "XC40", "å…¶ä»–"], "Porsche": ["Macan", "Cayenne", "å…¶ä»–"], "Tesla": ["Model Y", "Model 3", "Model X", "Model S"],
      "Subaru": ["Forester", "XV", "å…¶ä»–"], "Suzuki": ["Swift", "Jimny", "å…¶ä»–"], "Luxgen": ["URX", "n7", "å…¶ä»–"], "Other": ["å…¶ä»–å“ç‰Œ"] 
    };

    const taiwanDistricts = {
      "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"],
      "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
      "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
      "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"],
      "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
      "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
      "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
      "å°å—å¸‚": ["æ–°ç‡Ÿå€", "é¹½æ°´å€", "ç™½æ²³å€", "æŸ³ç‡Ÿå€", "å¾Œå£å€", "æ±å±±å€", "éº»è±†å€", "ä¸‹ç‡Ÿå€", "å…­ç”²å€", "å®˜ç”°å€", "å¤§å…§å€", "ä½³é‡Œå€", "å­¸ç”²å€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "åŒ—é–€å€", "æ–°åŒ–å€", "å–„åŒ–å€", "æ–°å¸‚å€", "å®‰å®šå€", "å±±ä¸Šå€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "å·¦é®å€", "ä»å¾·å€", "æ­¸ä»å€", "é—œå»Ÿå€", "é¾å´å€", "æ°¸åº·å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "å®‰å¹³å€", "ä¸­è¥¿å€"],
      "é«˜é›„å¸‚": ["é¹½åŸ•å€", "é¼“å±±å€", "å·¦ç‡Ÿå€", "æ¥ æ¢“å€", "ä¸‰æ°‘å€", "æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "å‰é®å€", "æ——æ´¥å€", "å°æ¸¯å€", "é³³å±±å€", "æ—åœ’å€", "å¤§å¯®å€", "å¤§æ¨¹å€", "å¤§ç¤¾å€", "ä»æ­¦å€", "é³¥æ¾å€", "å²¡å±±å€", "æ©‹é ­å€", "ç‡•å·¢å€", "ç”°å¯®å€", "é˜¿è“®å€", "è·¯ç«¹å€", "æ¹–å…§å€", "èŒ„è£å€", "æ°¸å®‰å€", "å½Œé™€å€", "æ¢“å®˜å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "ç”²ä»™å€", "æ‰æ—å€", "å…§é–€å€", "èŒ‚æ—å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€"]
    };

    function formatTaipeiTime(dStr) { 
        try { if(!dStr) return '-'; const d=new Date(dStr); return isNaN(d.getTime())?'-':d.getFullYear()+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0'); } catch(e){return '-';} 
    }
    
    function getCarSizeRate(m) { 
        const l=['Model X','Model Y','RAV4','CR-V','X-Trail','Kuga','CX-5','Tucson','Sportage','NX','RX','GLC','X3','X5','XC60']; 
        const s=['Yaris','Fit','Swift','Colt Plus','Venue','Kamiq','UX']; 
        if(l.includes(m)) return 1.3; 
        if(s.includes(m)) return 0.8; 
        return 1.0; 
    }

    function setTheme(t) { 
        document.body.className = t + '-mode'; 
        localStorage.setItem('hypass_theme', t); 
        document.getElementById('btn-theme-dark').style.borderColor = 'transparent';
        document.getElementById('btn-theme-light').style.borderColor = 'transparent';
        document.getElementById('btn-theme-metal').style.borderColor = 'transparent';
        if (t === 'light') { document.getElementById('btn-theme-light').style.borderColor = '#10b981'; } 
        else if (t === 'metal') { document.getElementById('btn-theme-metal').style.borderColor = '#06b6d4'; } 
        else { document.getElementById('btn-theme-dark').style.borderColor = '#00e676'; }
    }
    setTheme(localStorage.getItem('hypass_theme') || 'dark');
    
    function updateCarModels(bId, mId) { 
        const b = document.getElementById(bId).value; 
        const m = document.getElementById(mId); 
        m.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
        if(carData[b]) carData[b].forEach(i => m.innerHTML+=`<option value="${i}">${i}</option>`); 
    }
    
    function updateDistricts(cityId, distId) { 
        const c = document.getElementById(cityId).value; 
        const d = document.getElementById(distId); 
        d.innerHTML = '<option value="">* é„‰é®å¸‚å€</option>'; 
        if(taiwanDistricts[c]) taiwanDistricts[c].forEach(i => d.innerHTML+=`<option value="${i}">${i}</option>`); 
    }

    function showForm(r) { document.getElementById('form-customer').style.display = r==='customer' ? 'block' : 'none'; }
    
    function switchPage(id, el) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.getElementById('page-'+id).classList.add('active'); 
        if(el) el.classList.add('active'); 
        if(id==='book') loadGarages(); 
        if(id==='settings') loadHistory('filter');
    }
    
    function switchSetTab(t) { 
        ['a','theme','b','c'].forEach(tab=>{ 
            const content = document.getElementById(`set-content-${tab}`); 
            const btn = document.getElementById(`tab-set-${tab}`);
            if(content) content.style.display = t===tab ? 'block' : 'none'; 
            if(btn) btn.className = `tab-btn ${t===tab ? 'active' : ''}`;
        }); 
    }
    
    function switchBookingTab(t) { 
        document.getElementById('booking-smart').style.display = t==='smart' ? 'block' : 'none'; 
        document.getElementById('booking-manual').style.display = t==='manual' ? 'block' : 'none'; 
        document.getElementById('tab-btn-smart').className = `tab-btn ${t==='smart' ? 'active' : ''}`; 
        document.getElementById('tab-btn-manual').className = `tab-btn ${t==='manual' ? 'active' : ''}`; 
    }

    async function submitRegister(role) {
        try {
            const p = await liff.getProfile(); 
            const refId = localStorage.getItem('hypass_ref_code'); 
            
            const n = document.getElementById('c-name').value;
            const ph = document.getElementById('c-phone').value;
            const e = document.getElementById('c-email').value;
            const g = document.getElementById('c-gender').value;
            const c = document.getElementById('c-city').value;
            const dist = document.getElementById('c-district').value;
            const addr = document.getElementById('c-address').value;
            const b = document.getElementById('c-brand').value;
            const m = document.getElementById('c-model').value;
            const y = document.getElementById('c-year').value;
            const pl = document.getElementById('c-plate').value;
            const mil = document.getElementById('c-mileage').value;
            
            if (!n || !ph || !b || !pl) return alert("è«‹å®Œæ•´å¡«å¯«å¿…å¡«æ¬„ä½ï¼");
            
            const payload = { 
                line_uid: p.userId, referrer_uid: refId, role: role,
                name: n, phone: ph, email: e, gender: g, 
                city: c, district: dist, address: addr, 
                car_brand: b, car_model: m, car_year: parseInt(y) || null,
                license_plate: pl, yearly_mileage: parseInt(mil)
            };
            
            const { error } = await supabaseClient.from('users').upsert(payload);
            if (!error) {
                if (refId && refId !== p.userId) {
                    await supabaseClient.from('rewards').insert([{ user_uid: refId, type: 'referral_register', points: 10, status: 'completed', details: `æ¨è–¦è¨»å†Š: ${n}` }]);
                }
                localStorage.removeItem('hypass_ref_code'); 
                location.reload();
            } else { alert("è¨»å†Šå¤±æ•—: " + error.message); }
        } catch(e) { console.error(e); }
    }

    async function updateProfile() {
      const p = { 
          name: document.getElementById('edit-name').value, 
          phone: document.getElementById('edit-phone').value, 
          email: document.getElementById('edit-email').value, 
          gender: document.getElementById('edit-gender').value, 
          city: document.getElementById('edit-city').value, 
          district: document.getElementById('edit-district').value, 
          address: document.getElementById('edit-address').value, 
          car_brand: document.getElementById('edit-brand').value, 
          car_model: document.getElementById('edit-model').value, 
          car_year: parseInt(document.getElementById('edit-year').value) || null,
          license_plate: document.getElementById('edit-plate').value, 
          yearly_mileage: parseInt(document.getElementById('edit-mileage').value)
      };
      const { error } = await supabaseClient.from('users').update(p).eq('line_uid', currentUser.line_uid); 
      if (error) alert("æ›´æ–°å¤±æ•—"); else { alert('âœ… æ‚¨çš„åº§è‰™è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼'); location.reload(); }
    }

    let scanner = null;
    function openFrontendScanner() { 
        document.getElementById('scanner-modal').style.display = 'flex'; 
        scanner = new Html5Qrcode("frontend-reader"); 
        scanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 280, height: 120 } }, 
            (text) => { 
                scanner.stop(); 
                document.getElementById('scanner-modal').style.display = 'none'; 
                processUID(text.trim()); 
            }
        ); 
    }
    function closeScanner() { if(scanner) scanner.stop(); document.getElementById('scanner-modal').style.display = 'none'; }

    async function processUID(uid) {
        if (!uid.match(/^HP-\d+$/)) return alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹æƒæ HP- æ¢ç¢¼");
        const { data } = await supabaseClient.from('filters_uid').select('*').eq('uid', uid).maybeSingle();
        if (!data || (data.status !== 'sold' && data.status !== 'produced')) return alert("ç„¡æ•ˆæ¿¾ç¶²");
        
        await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
        await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date() }).eq('uid', uid);
        
        if (currentUser.referrer_uid) {
            const { count } = await supabaseClient.from('filters_uid').select('*', { count: 'exact', head: true }).eq('activated_by_uid', currentUser.line_uid);
            if (count === 1) {
                await supabaseClient.from('rewards').insert([{ user_uid: currentUser.referrer_uid, type: 'referral_scan', points: 100, status: 'completed', details: `é¦–æƒçå‹µ` }]);
            }
        }
        alert("âœ… æ¿¾ç¶²ç¶å®šå•Ÿç”¨æˆåŠŸï¼"); location.reload();
    }

    async function shareToLine() {
        if (!currentUser) return; 
        const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
        if (liff.isApiAvailable('shareTargetPicker')) { 
            try { await liff.shareTargetPicker([{ type: "text", text: `æ¨è–¦æ‚¨åŠ å…¥ HYPASS æ™ºèƒ½åº§è‰™ï¼š\n${link}` }]); } catch (e) {} 
        } else { navigator.clipboard.writeText(link); alert(`è«‹è¤‡è£½ï¼š\n${link}`); }
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active'); 
      let html = '';
      if (data && data.length > 0) {
        document.getElementById('smart-match-result').innerHTML = `<h3 style="color:var(--accent-color); margin:0 0 10px 0;">${data[0].name}</h3><p style="font-size:13px; color:var(--text-secondary);">${data[0].city}${data[0].address}</p><button class="btn-main" style="padding:12px; margin-top:10px;" onclick="bookGarage(${data[0].id})">ç«‹å³é ç´„é…å°å» </button>`;
        data.forEach(g => { 
            html += `<div class="g-card" style="text-align:left;">
                <b style="color:var(--text-primary); font-size:16px;">${g.name}</b><br>
                <span style="font-size:12px; color:var(--text-secondary); display:block; margin:6px 0;">${g.city}${g.address}</span>
                <button class="btn-main" style="padding:10px; font-size:14px; margin-top:5px;" onclick="bookGarage(${g.id})">é ç´„æ­¤å» </button>
            </div>`; 
        });
      } else { html = 'ç›®å‰ç„¡åˆä½œä¿ä¿®å» '; } 
      document.getElementById('garage-list').innerHTML = html;
    }
    
    async function bookGarage(gId) { 
        let d = prompt("è¼¸å…¥å¸Œæœ›é ç´„çš„æ—¥æœŸ (ex: 2026/03/01):"); 
        if(d) { await supabaseClient.from('bookings').insert([{user_uid: currentUser.line_uid, garage_id: gId, book_date: d}]); alert("âœ… é ç´„å·²é€å‡º"); } 
    }

    async function loadHistory(type) {
      const container = document.getElementById('history-container'); container.innerHTML = 'è®€å–ä¸­...'; let html = '';
      if (type === 'filter') { 
          const { data } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false }); 
          if(data && data.length>0) data.forEach(d => html += `<div class="log-item"><b style="color:var(--text-primary);">ğŸ“¦ æ¿¾ç¶² UID: ${d.uid}</b><br><span style="color:var(--accent-color); font-size:12px;">å•Ÿç”¨æ™‚é–“: ${formatTaipeiTime(d.activated_at)}</span></div>`); 
      } else { 
          const { data } = await supabaseClient.from('bookings').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('created_at', { ascending: false }); 
          if(data && data.length>0) data.forEach(d => html += `<div class="log-item"><b style="color:var(--text-primary);">ğŸ“ å» ç«¯é ç´„: ${d.garages?.name}</b><br><span style="font-size:12px; color:var(--text-secondary);">æ—¥æœŸ: ${d.book_date} | ç‹€æ…‹: ${d.status}</span></div>`); 
      }
      container.innerHTML = html || '<div class="log-item">å°šç„¡ç›¸é—œç´€éŒ„</div>';
    }

    async function calculateDashboardStats() {
      const badgeText = document.getElementById('ui-shield-text');
      const pulseDot = document.getElementById('ui-pulse-dot');
      const healthEl = document.getElementById('ui-health');

      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).maybeSingle();
      
      if (filter && filter.activated_at) {
        setElText('ui-filter-date', formatTaipeiTime(filter.activated_at));
        
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        
        let aqi = envData.aqi || 50; 
        
        // ä½¿ç”¨å¾Œå°è¨­å®šçš„åŠ æ¬Šåƒæ•¸ (è‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼)
        let weightRed = parseFloat(params.weightRed || 1.8);
        let weightOrange = parseFloat(params.weightOrange || 1.4);
        let aRate = 1.0;
        if (aqi > 150) aRate = weightRed;
        else if (aqi > 100) aRate = weightOrange;
        
        let cRate = getCarSizeRate(currentUser.car_model);
        let baseWear = parseFloat(params.baseWear || 0.27);
        let health = Math.max(0, Math.round(100 - (days * baseWear * aRate * cRate)));
        
        if(healthEl) healthEl.innerText = `${health}%`;
        
        if (health >= 60) {
            if(badgeText) badgeText.innerText = 'æ¥µæ•ˆé˜²è­·ä¸­'; 
            if(healthEl) healthEl.style.color = 'var(--accent-color)';
            if(pulseDot) pulseDot.style.animationDuration = '1.8s';
        } else if (health >= 30) {
            if(badgeText) badgeText.innerText = 'ç©©å®šç›£æ§ä¸­'; 
            if(healthEl) healthEl.style.color = 'var(--accent-color)';
            if(pulseDot) pulseDot.style.animationDuration = '2.5s';
        } else if (health > 0) {
            if(badgeText) badgeText.innerText = 'æ•ˆèƒ½è¡°é€€ä¸­'; 
            if(healthEl) healthEl.style.color = '#f59e0b';
            if(pulseDot) pulseDot.style.animationDuration = '1s';
            document.getElementById('ui-shield-badge').style.borderColor = '#f59e0b';
            document.getElementById('ui-shield-badge').style.color = '#f59e0b';
            pulseDot.style.background = '#f59e0b';
        } else {
            if(badgeText) badgeText.innerText = 'è«‹å³åˆ»æ›´æ›'; 
            if(healthEl) healthEl.style.color = '#ef4444';
            if(pulseDot) pulseDot.style.animationDuration = '0.4s';
            document.getElementById('ui-shield-badge').style.borderColor = '#ef4444';
            document.getElementById('ui-shield-badge').style.color = '#ef4444';
            pulseDot.style.background = '#ef4444';
        }
        
        let basePm25 = parseFloat(params.basePm25 || 1250);
        let kwhPerDay = parseFloat(params.kwhPerDay || 0.25);
        let co2Factor = parseFloat(params.co2Factor || 0.5);
        let paHypass = parseFloat(params.paHypass || 4);
        let paOther = parseFloat(params.paOther || 8);
        
        setElText('ui-pm25', Math.round(days * basePm25 * aRate * cRate).toLocaleString());
        setElText('ui-esg-kwh', (days * kwhPerDay).toFixed(1));
        setElText('ui-esg-co2', (days * kwhPerDay * co2Factor).toFixed(1));
        setElText('ui-esg-ac', Math.round(((paOther - paHypass) / paOther) * 30)); // ç°¡æ˜“çœé›»ç™¾åˆ†æ¯”å±•ç¤º
        
      } else {
        setElText('ui-filter-date', 'å°šæœªå•Ÿç”¨');
        if(healthEl) healthEl.innerText = '--%';
        if(badgeText) badgeText.innerText = 'ç³»çµ±å¾…å‘½'; 
        if(pulseDot) pulseDot.style.animation = 'none';
        
        let badge = document.getElementById('ui-shield-badge');
        if(badge) {
            badge.style.borderColor = '#555';
            badge.style.color = '#888';
            badge.style.background = 'rgba(255,255,255,0.05)';
        }
        if(pulseDot) pulseDot.style.background = '#555';
      }
    }

    async function fetchEnv(city, district) {
      let { data } = await supabaseClient.from('env_cache').select('*').eq('city', city).eq('district', district).maybeSingle();
      if(!data) { const { data: fb } = await supabaseClient.from('env_cache').select('*').limit(1).maybeSingle(); data = fb; }
      
      if(data) {
        envData = data; 
        setElText('env-aqi', data.aqi); 
        setElText('env-home-aqi', Math.round(data.aqi_7d_avg||data.aqi));
        
        const msgBox = document.getElementById('dynamic-msg-box');
        setElText('ui-dynamic-msg', `ç³»çµ±é€£ç·šæ­£å¸¸ï¼Œç›®å‰å®¤å¤– AQI: ${data.aqi}ï¼ŒæŒçºŒé˜²è­·ä¸­...`);
        if(msgBox) msgBox.style.borderColor = 'var(--border-color)';
        
        calculateDashboardStats();
      }
    }

    function getSnapshotGPS() {
      let lastCity = localStorage.getItem('hp_last_city') || (currentUser ? currentUser.city : 'å°åŒ—å¸‚'); 
      let lastDist = localStorage.getItem('hp_last_dist') || (currentUser ? currentUser.district : '');
      
      setElText('ui-loc-name', lastCity + lastDist);
      fetchEnv(lastCity, lastDist); 

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(r => r.json())
            .then(d => {
              let city = d.address.city || d.address.county || '';
              let district = d.address.suburb || d.address.town || '';
              if(city) {
                setElText('ui-loc-name', city + district);
                localStorage.setItem('hp_last_city', city); 
                localStorage.setItem('hp_last_dist', district);
                fetchEnv(city, district); 
              }
            }).catch(e => console.log("ç¿»è­¯ä¼ºæœå™¨å¿™ç¢Œ"));
        }, () => { console.log("æœªæˆæ¬Šå®šä½"); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }); 
      }
    }

    async function init() {
      await liff.init({ liffId: "2009187567-58hBrZRj" }); 
      if (!liff.isLoggedIn()) { liff.login(); return; }
      
      const p = await liff.getProfile(); 
      const { data } = await supabaseClient.from('users').select('*').eq('line_uid', p.userId).maybeSingle();
      
      if (data) {
        currentUser = data; 
        
        setElText('ui-owner', `${data.name} çš„å°ˆå±¬åº§è‰™`); 
        let carString = (data.car_brand || '') + ' ' + (data.car_model || '');
        setElText('ui-car-info', carString.trim() ? carString : '--');
        document.getElementById('nav-bar').style.display = 'flex';
        
        setElVal('edit-name', data.name); 
        setElVal('edit-phone', data.phone); 
        setElVal('edit-email', data.email); 
        if(data.gender) setElVal('edit-gender', data.gender);
        
        if(data.city) { 
          setElVal('edit-city', data.city); 
          updateDistricts('edit-city', 'edit-district');
          if(data.district) setElVal('edit-district', data.district);
        }
        setElVal('edit-address', data.address);

        if(data.car_brand) { 
          setElVal('edit-brand', data.car_brand); 
          updateCarModels('edit-brand', 'edit-model'); 
          if(data.car_model) setElVal('edit-model', data.car_model); 
        }
        
        if(data.car_year) setElVal('edit-year', data.car_year);
        setElVal('edit-plate', data.license_plate); 
        if(data.yearly_mileage) setElVal('edit-mileage', data.yearly_mileage);
        
        setElText('contract-plate', data.license_plate);
        setElText('ui-home-city', data.city || 'å°åŒ—å¸‚');
        
        switchPage('home', document.querySelector('.nav-item'));
        
        const { data: rws } = await supabaseClient.from('rewards').select('*').eq('user_uid', data.line_uid);
        let tot = 0; 
        if(rws) rws.forEach(r => tot += (r.type === 'redeem' ? -r.points : r.points));
        setElText('reward-balance', `$${tot}`);
        
        getSnapshotGPS(); 
      } else { 
          document.getElementById('page-register').classList.add('active'); 
      }
    }
    
    init();
    async function redeemPoints() { alert("æé ˜ç”³è«‹å·²é€å‡ºï¼"); }
  </script>
</body>
</html>
