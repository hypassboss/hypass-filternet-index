<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =========================================
       ğŸ’ V5.8 Tesla x Gogoro (èƒŒæ™¯éœæ…‹æ‰“å¡ç§’é–‹ç‰ˆ)
       ========================================= */
    :root {
      --bg-image: none; --bg-color: #000000; --surface-color: #161618; --border-color: #2c2c2e;
      --text-primary: #ffffff; --text-secondary: #8e8e93;
      --accent-color: #00e676; --accent-gradient: linear-gradient(135deg, #00e676 0%, #00b85c 100%);
      --accent-glow: rgba(0, 230, 118, 0.2); --chart-bar: #333333; --chart-active: #00e676;
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(10, 10, 10, 0.85); --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); --input-bg: #1c1c1e;
    }
    body.light-mode {
      --bg-color: #f2f2f7; --surface-color: #ffffff; --border-color: #e5e5ea;
      --text-primary: #1c1c1e; --text-secondary: #8e8e93;
      --accent-color: #10b981; --accent-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --accent-glow: rgba(16, 185, 129, 0.15); --gold-color: #d4af37; --gold-glow: rgba(212, 175, 55, 0.15);
      --glass-bg: rgba(255, 255, 255, 0.9); --input-bg: #f9f9f9;
    }
    body.metal-mode {
      --bg-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.015) 0px, rgba(255,255,255,0.015) 1px, transparent 1px, transparent 4px);
      --bg-color: #151515; --surface-color: linear-gradient(145deg, #262628 0%, #1c1c1e 100%);
      --border-color: #3a3a3c; --text-primary: #e5e5ea; --text-secondary: #98989d;
      --accent-color: #06b6d4; --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      --accent-glow: rgba(6, 182, 212, 0.25); --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.15);
      --glass-bg: rgba(28, 28, 30, 0.9); --input-bg: #111112;
    }

    html { background-color: #000000; display: flex; justify-content: center; min-height: 100vh; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; width: 100vw; max-width: 430px; background-color: var(--bg-color); background-image: var(--bg-image); color: var(--text-primary); padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); transition: background 0.4s ease, color 0.4s ease; min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.8); overflow-x: hidden; -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    
    .page { display: none; padding: 16px; animation: fadeIn 0.4s; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .g-card { background: var(--surface-color); border-radius: 20px; padding: 18px; box-shadow: var(--card-shadow); margin-bottom: 16px; border: 1px solid var(--border-color); }
    .btn-main { background: var(--accent-gradient); color: #fff; border: none; padding: 16px; border-radius: 16px; font-weight: 800; width: 100%; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px var(--accent-glow); transition: 0.2s; letter-spacing:1px;}
    .btn-main:active { transform: scale(0.96); }

    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: var(--glass-bg); display: flex; padding: 6px 5px calc(4px + env(safe-area-inset-bottom, 0px)) 5px; border-top: 1px solid var(--border-color); z-index: 999; backdrop-filter: blur(25px); }
    .nav-item { color: var(--text-secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; flex: 1; height: 42px; }
    .nav-item.active { color: var(--accent-color); font-weight: 700; }
    .nav-icon { font-size: 22px; } .nav-text { font-size: 11px; }

    .header-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; margin-bottom: 25px; }
    .header-title-box { flex: 1; min-width: 0; } 
    #ui-owner { font-size: 20px; font-weight: 800; margin: 0; color: var(--text-primary); }
    .shield-badge { display:inline-flex; background: var(--accent-glow); border: 1px solid var(--accent-color); color: var(--accent-color); padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700; align-items: center; gap: 6px; }
    .pulse-dot { display: inline-block; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; animation: heartBeat 1.8s infinite; }
    @keyframes heartBeat { 0% { transform: scale(0.8); box-shadow: 0 0 0 0 var(--accent-color); } 50% { transform: scale(1.6); box-shadow: 0 0 0 8px rgba(0,0,0,0); } 100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

    .main-visual-container { display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px 0 20px 0; }
    .ring { width: 220px; height: 220px; border-radius: 50%; border: 6px solid var(--accent-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--accent-glow); position: relative; background: var(--surface-color); z-index: 2;}
    .ring::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 1px dashed var(--text-secondary); animation: rotate 25s linear infinite; opacity: 0.2; z-index: 1;}
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .pm25-badge { background: rgba(255,255,255,0.05); border: 1px solid var(--gold-color); color: var(--gold-color); padding: 8px 20px; border-radius: 25px; font-weight: bold; font-size: 14px; margin-top: 25px; box-shadow: 0 0 15px rgba(255, 215, 0, 0.15); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
    .env-box { background: var(--input-bg); border-radius: 14px; padding: 16px 10px; text-align: center; border: 1px solid var(--border-color); }
    .env-val { font-size: 32px; font-weight: 800; line-height: 1; margin: 8px 0; }
    
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 16px;}
    .esg-box { text-align: center; padding: 12px 6px; background: var(--input-bg); border-radius: 14px; border: 1px solid var(--border-color); position: relative; }
    .esg-badge { position: absolute; top: -8px; right: 50%; transform: translateX(50%); background: var(--accent-gradient); color: #fff; font-size: 9px; padding: 3px 6px; border-radius: 10px; font-weight: 700; white-space: nowrap;}
    
    .tech-tag-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin: 20px 0; }
    .tech-tag { background: var(--input-bg); padding: 8px 2px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 9.5px; font-weight: 600; }
    
    .dynamic-msg-bar { background: var(--surface-color); color: var(--accent-color); padding: 0 16px; height: 48px; border-radius: 16px; font-size: 14px; margin-bottom: 16px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; font-weight: 600; }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; height: 100%; }
    .marquee-content { display: flex; align-items: center; min-width: 100%; animation: scrollText 14s linear infinite; } 
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

    .scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
    #frontend-reader { width: 90%; max-width: 350px; border-radius: 12px; border: 2px solid var(--accent-color); overflow: hidden; }

    input, select { width: 100%; padding: 16px; margin-bottom: 16px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 14px; font-size: 15px; box-sizing: border-box; }
    .vip-card { border: 1px solid var(--gold-color); background: linear-gradient(135deg, #1a1500 0%, #050400 100%); box-shadow: 0 15px 40px var(--gold-glow); position: relative; overflow: hidden; }
    .tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { background: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; flex: 1; text-align: center; cursor: pointer; font-size: 14px; font-weight: bold; }
    .tab-btn.active { background: var(--accent-glow); color: var(--accent-color); border-color: var(--accent-color); }
    .log-item { border-bottom: 1px solid var(--border-color); padding: 15px 0; font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
  </style>
</head>
<body>

  <script>
    (function captureReferral() {
        try {
            let urlParams = new URLSearchParams(window.location.search);
            let ref = urlParams.get('ref');
            if (!ref && urlParams.get('liff.state')) {
                let stateParams = new URLSearchParams(urlParams.get('liff.state').replace(/^\?/, ''));
                ref = stateParams.get('ref');
            }
            if (ref) localStorage.setItem('hypass_ref_code', ref);
        } catch(e) {}
    })();
  </script>

  <div id="page-register" class="page">
    <h2 style="text-align:center;">HYPASS <span style="color:var(--accent-color);">Air+</span></h2>
    <div class="g-card"><p style="text-align:center; font-size:14px; color:var(--text-secondary);">ç‚ºä¿éšœæ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')"><option value="Toyota">Toyota</option><option value="Tesla">Tesla</option><option value="Honda">Honda</option><option value="Other">å…¶ä»–å“ç‰Œ</option></select>
      <select id="c-model"><option value="">* é¸æ“‡è»Šå‹</option></select>
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page active">
    <div class="header-flex">
      <div class="header-title-box"><p id="ui-owner">è¼‰å…¥ä¸­...</p><p id="ui-car-info" style="font-size:13px; color:var(--text-secondary); margin:4px 0 0 0;">--</p></div>
      <div class="shield-badge" id="ui-shield-badge"><span class="pulse-dot" id="ui-pulse-dot"></span> <span id="ui-shield-text">é€£ç·šä¸­...</span></div>
    </div>

    <div class="main-visual-container" style="text-align:center;">
      <div class="ring"><div style="font-size:64px; font-weight:900; color:var(--accent-color);" id="ui-health">--%</div><div style="font-size:12px; color:var(--text-secondary);">å‹•æ…‹å£½å‘½æ¨ä¼°</div></div>
      <div class="pm25-badge">ğŸ›¡ï¸ ç´¯è¨ˆæ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      <div style="font-size:11px; color:var(--text-secondary); margin-top:15px;">æ¿¾ç¶²å•Ÿç”¨æ—¥æœŸ: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>

    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span style="margin-right: 12px; font-size: 18px;">ğŸ’¬</span>
      <div class="marquee-container"><span class="marquee-content" id="ui-dynamic-msg">è¼‰å…¥æœ€æ–°ç’°å¢ƒæ•¸æ“šä¸­...</span></div>
    </div>

    <div class="grid-2">
      <div class="env-box"><div style="font-size:12px; color:var(--text-secondary);">ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" style="color:var(--text-primary);">å®šä½ä¸­...</span></div><div class="env-val" id="env-aqi" style="color:var(--accent-color);">--</div><div style="font-size:10px; color:var(--text-secondary);">AQI</div></div>
      <div class="env-box" style="border-color:var(--gold-color);"><div style="font-size:12px; color:var(--text-secondary);">ğŸ  7æ—¥å±…ä½åœ°<br><span id="ui-home-city" style="color:var(--text-primary);">è®€å–ä¸­...</span></div><div class="env-val" id="env-home-aqi" style="color:var(--gold-color);">--</div><div style="font-size:10px; color:var(--text-secondary);">AQI</div></div>
    </div>

    <div class="grid-3">
      <div class="esg-box"><div class="esg-badge">æ¥µè‡´ä½é¢¨é˜»</div><div style="font-size:24px; margin-top:15px;">ğŸŒ±</div><div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-co2">0</span> <span style="font-size:11px; color:var(--text-secondary);">kg</span></div><div style="font-size:11px; color:var(--text-secondary);">çœç¢³è¶³è·¡</div></div>
      <div class="esg-box"><div class="esg-badge">å†·æ°£è¼•è² è¼‰</div><div style="font-size:24px; margin-top:15px;">âš¡ï¸</div><div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-kwh">0</span> <span style="font-size:11px; color:var(--text-secondary);">kWh</span></div><div style="font-size:11px; color:var(--text-secondary);">çœé›»æ•ˆèƒ½</div></div>
      <div class="esg-box"><div class="esg-badge">å¼·æ•ˆå¤§é¢¨é‡</div><div style="font-size:24px; margin-top:15px;">â›½ï¸</div><div style="font-size:20px; font-weight:700; margin:6px 0;"><span id="ui-esg-ac">0</span> <span style="font-size:11px; color:var(--text-secondary);">%</span></div><div style="font-size:11px; color:var(--text-secondary);">ç©ºèª¿ç¯€èƒ½</div></div>
    </div>

    <div class="tech-tag-container">
      <div class="tech-tag">ğŸ‡¹ğŸ‡¼ å°ç£è£½é€ </div><div class="tech-tag">âš¡ éœé›»éæ¿¾</div><div class="tech-tag">ğŸ¥¥ æ´»æ€§ç¢³</div>
      <div class="tech-tag">ğŸ“¡ ç©ºæ±™é›·é”</div><div class="tech-tag">ğŸ§  AI æ¼”ç®—</div><div class="tech-tag">ğŸŒ± ESG æ¸›ç¢³</div>
    </div>

    <button class="btn-main" onclick="openFrontendScanner()" style="margin-top:10px; background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;">ğŸ“· æƒæä¸€ç¶­æ¢ç¢¼ (UID) å•Ÿç”¨æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="g-card" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--text-secondary);">å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); border:2px dashed var(--accent-color); padding:15px; border-radius:12px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw'">å‰å¾€å•†åŸé¸è³¼</button>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--text-primary); font-size:22px;">ğŸ ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="g-card vip-card" style="text-align:center; padding:40px 20px;">
      <p style="color:var(--gold-color); font-weight:bold;">VIP å°ˆå±¬çå‹µé‡‘</p>
      <h1 id="reward-balance" style="font-size:64px; text-shadow:0 4px 20px rgba(255,215,0,0.5); margin:20px 0;">$0</h1>
      <button class="btn-main" style="background:linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color:#000;" onclick="redeemPoints()">ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    <div class="g-card" style="border-color:var(--accent-color); text-align:center;">
       <h3 style="margin-top:0;">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size:13px; color:var(--text-secondary);">è¨»å†Šé€ <b style="color:var(--accent-color);">10</b> é»ï¼Œé¦–æƒå†é€ <b style="color:var(--gold-color);">100</b> é»ï¼</p>
       <button class="btn-main" onclick="shareToLine()">ğŸŸ¢ ç›´æ¥åˆ†äº«çµ¦ LINE å¥½å‹</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3>ğŸ“ é ç´„å®‰è£</h3>
    <div class="tab-container"><div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div><div class="tab-btn" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ é™„è¿‘ä¿ä¿®å» </div></div>
    <div id="booking-smart"><div id="smart-match-result" class="g-card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
    <div id="booking-manual" style="display:none;"><div id="garage-list">æ¸…å–®è®€å–ä¸­...</div></div>
  </div>

  <div id="page-settings" class="page">
    <h3>âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    <div class="tab-container">
        <div class="tab-btn active" onclick="switchSetTab('a')">ğŸ‘¤ è³‡æ–™</div>
        <div class="tab-btn" onclick="switchSetTab('theme')">ğŸ¨ ç•«é¢</div>
        <div class="tab-btn" onclick="switchSetTab('b')">ğŸ“œ ç´€éŒ„</div>
    </div>
    
    <div id="set-content-a" style="display:block;">
      <div class="g-card">
        <label>å§“å</label><input type="text" id="edit-name">
        <label>è»Šç‰Œ</label><input type="text" id="edit-plate">
        <button class="btn-main" onclick="updateProfile()">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    <div id="set-content-theme" style="display:none;">
      <div class="g-card" style="text-align:center;">
        <button class="btn-main" style="background:#000; color:#00e676; border:1px solid #333;" onclick="setTheme('dark')">ğŸŒ™ æ›œçŸ³é»‘</button>
        <button class="btn-main" style="background:#fff; color:#10b981; border:1px solid #ccc;" onclick="setTheme('light')">â˜€ï¸ æ¥µç°¡ç™½</button>
      </div>
    </div>
    <div id="set-content-b" style="display:none;">
      <div class="g-card">
        <select onchange="loadHistory(this.value)"><option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›</option><option value="book">ğŸ“ é ç´„ç´€éŒ„</option></select>
        <div id="history-container" style="max-height: 300px; overflow-y: auto;">è®€å–ä¸­...</div>
      </div>
    </div>
  </div>

  <div class="bottom-nav" id="nav-bar">
    <div class="nav-item active" onclick="switchPage('home', this)"><span class="nav-icon">â—“</span><span class="nav-text">åº§è‰™</span></div>
    <div class="nav-item" onclick="switchPage('shop', this)"><span class="nav-icon">ğŸ›’</span><span class="nav-text">å•†åŸ</span></div>
    <div class="nav-item" onclick="switchPage('book', this)"><span class="nav-icon">ğŸ“</span><span class="nav-text">é ç´„</span></div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><span class="nav-icon">ğŸ</span><span class="nav-text">ä»»å‹™</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><span class="nav-icon">âš™ï¸</span><span class="nav-text">è¨­å®š</span></div>
  </div>

  <div class="scanner-modal" id="scanner-modal">
    <div id="frontend-reader"></div>
    <button class="btn-main" style="width:200px; margin-top:20px; background:#ff3b30; color:#fff;" onclick="closeScanner()">âœ– å–æ¶ˆ</button>
  </div>

  <script>
    function setElText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
    function setElVal(id, val) { const el = document.getElementById(id); if (el) el.value = val; }
    window.onerror = function(msg) { console.log(msg); return false; };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };
    const carData = { "Toyota": ["RAV4", "Corolla Cross", "Altis"], "Tesla": ["Model Y", "Model 3"], "Honda": ["CR-V", "HR-V"], "Other": ["å…¶ä»–å“ç‰Œ"] };

    function formatTaipeiTime(dStr) { try { if(!dStr) return '-'; const d=new Date(dStr); return isNaN(d.getTime())?'-':d.getFullYear()+'/'+String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0'); } catch(e){return '-';} }
    function getCarSizeRate(m) { const l=['Model X','Model Y','RAV4','CR-V']; const s=['Yaris','Fit']; if(l.includes(m)) return 1.3; if(s.includes(m)) return 0.8; return 1.0; }
    function setTheme(t) { document.body.className = t + '-mode'; localStorage.setItem('hypass_theme', t); }
    setTheme(localStorage.getItem('hypass_theme') || 'dark');
    
    function updateCarModels(bId, mId) { const b = document.getElementById(bId).value; const m = document.getElementById(mId); m.innerHTML = ''; if(carData[b]) carData[b].forEach(i => m.innerHTML+=`<option value="${i}">${i}</option>`); }
    function showForm(r) { document.getElementById('form-customer').style.display = r==='customer'?'block':'none'; }
    function switchPage(id, el) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('page-'+id).classList.add('active'); if(el) el.classList.add('active'); if(id==='book')loadGarages(); if(id==='settings')loadHistory('filter');}
    function switchSetTab(t) { ['a','theme','b'].forEach(tab=>{ const c=document.getElementById(`set-content-${tab}`); if(c) c.style.display=t===tab?'block':'none'; }); }
    function switchBookingTab(t) { document.getElementById('booking-smart').style.display = t==='smart'?'block':'none'; document.getElementById('booking-manual').style.display = t==='manual'?'block':'none'; document.getElementById('tab-btn-smart').className=`tab-btn ${t==='smart'?'active':''}`; document.getElementById('tab-btn-manual').className=`tab-btn ${t==='manual'?'active':''}`; }

    async function submitRegister(role) {
        const p = await liff.getProfile(); const refId = localStorage.getItem('hypass_ref_code'); 
        const payload = { line_uid: p.userId, referrer_uid: refId, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, car_brand: document.getElementById('c-brand').value, license_plate: document.getElementById('c-plate').value, role: 'customer' };
        const { error } = await supabaseClient.from('users').upsert(payload);
        if (!error) {
            if (refId && refId !== p.userId) await supabaseClient.from('rewards').insert([{ user_uid: refId, type: 'referral_register', points: 10, status: 'completed' }]);
            localStorage.removeItem('hypass_ref_code'); location.reload();
        } else alert("è¨»å†Šå¤±æ•—");
    }

    async function updateProfile() {
      const p = { name: document.getElementById('edit-name').value, license_plate: document.getElementById('edit-plate').value };
      await supabaseClient.from('users').update(p).eq('line_uid', currentUser.line_uid); alert('âœ… æ›´æ–°æˆåŠŸï¼'); location.reload();
    }

    // ğŸŒŸ å·¥æ¥­ç›¸æ©Ÿ
    let scanner = null;
    function openFrontendScanner() { document.getElementById('scanner-modal').style.display = 'flex'; scanner = new Html5Qrcode("frontend-reader"); scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 280, height: 120 } }, (text) => { scanner.stop(); document.getElementById('scanner-modal').style.display = 'none'; processUID(text.trim()); }); }
    function closeScanner() { if(scanner) scanner.stop(); document.getElementById('scanner-modal').style.display = 'none'; }

    async function processUID(uid) {
        if (!uid.match(/^HP-\d+$/)) return alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹æƒæ HP- æ¢ç¢¼");
        const { data } = await supabaseClient.from('filters_uid').select('*').eq('uid', uid).maybeSingle();
        if (!data || (data.status !== 'sold' && data.status !== 'produced')) return alert("ç„¡æ•ˆæ¿¾ç¶²");
        await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
        await supabaseClient.from('filters_uid').update({ status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date() }).eq('uid', uid);
        if (currentUser.referrer_uid) {
            const { count } = await supabaseClient.from('filters_uid').select('*', { count: 'exact', head: true }).eq('activated_by_uid', currentUser.line_uid);
            if (count === 1) await supabaseClient.from('rewards').insert([{ user_uid: currentUser.referrer_uid, type: 'referral_scan', points: 100, status: 'completed' }]);
        }
        alert("âœ… å•Ÿç”¨æˆåŠŸï¼"); location.reload();
    }

    async function shareToLine() {
        if (!currentUser) return; const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
        if (liff.isApiAvailable('shareTargetPicker')) { try { await liff.shareTargetPicker([{ type: "text", text: `åŠ å…¥ HYPASS æ™ºèƒ½åº§è‰™ï¼š\n${link}` }]); } catch (e) {} } else { navigator.clipboard.writeText(link); alert(`è«‹è¤‡è£½ï¼š\n${link}`); }
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active'); let html = '';
      if (data && data.length > 0) {
        document.getElementById('smart-match-result').innerHTML = `<b>${data[0].name}</b><br><button class="btn-main" style="padding:10px; margin-top:10px;" onclick="bookGarage(${data[0].id})">ç«‹å³é ç´„</button>`;
        data.forEach(g => { html += `<div class="g-card"><b>${g.name}</b><button class="btn-main" style="padding:8px; margin-top:5px;" onclick="bookGarage(${g.id})">é ç´„æ­¤å» </button></div>`; });
      } else { html = 'ç„¡ä¿ä¿®å» '; } document.getElementById('garage-list').innerHTML = html;
    }
    async function bookGarage(gId) { let d = prompt("è¼¸å…¥æ—¥æœŸ(ex:2026/03/01):"); if(d) { await supabaseClient.from('bookings').insert([{user_uid: currentUser.line_uid, garage_id: gId, book_date: d}]); alert("é ç´„æˆåŠŸ"); } }

    async function loadHistory(type) {
      document.getElementById('history-container').innerHTML = 'è®€å–ä¸­...'; let html = '';
      if (type === 'filter') { const { data } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false }); if(data) data.forEach(d => html += `<div class="log-item">ğŸ“¦ UID: ${d.uid} <br> ${formatTaipeiTime(d.activated_at)}</div>`); }
      else { const { data } = await supabaseClient.from('bookings').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('created_at', { ascending: false }); if(data) data.forEach(d => html += `<div class="log-item">ğŸ“ ${d.garages?.name} <br> ${d.book_date} [${d.status}]</div>`); }
      document.getElementById('history-container').innerHTML = html || 'å°šç„¡ç´€éŒ„';
    }

    async function calculateDashboardStats() {
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).maybeSingle();
      if (filter && filter.activated_at) {
        setElText('ui-filter-date', formatTaipeiTime(filter.activated_at));
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        let aqi = envData.aqi || 50; let aRate = aqi > 100 ? 1.4 : 1.0;
        let cRate = getCarSizeRate(currentUser.car_model);
        let health = Math.max(0, Math.round(100 - (days * (params.baseWear||0.27) * aRate * cRate)));
        
        setElText('ui-health', `${health}%`);
        document.getElementById('ui-health').style.color = health > 30 ? 'var(--accent-color)' : '#ef4444';
        
        setElText('ui-pm25', Math.round(days * (params.basePm25||1250) * aRate * cRate).toLocaleString());
        setElText('ui-esg-kwh', (days * 0.25).toFixed(1));
        setElText('ui-esg-co2', (days * 0.25 * 0.5).toFixed(1));
        setElText('ui-esg-ac', 50);
      }
    }

    // ğŸŒŸ ä¸€æ¬¡æ€§èƒŒæ™¯éœæ…‹ GPS æ‰“å¡å¼•æ“ (ç„¡ç¸«ç§’é–‹)
    async function fetchEnv(city, district) {
      let { data } = await supabaseClient.from('env_cache').select('*').eq('city', city).eq('district', district).maybeSingle();
      if(!data) { const { data: fb } = await supabaseClient.from('env_cache').select('*').limit(1).maybeSingle(); data = fb; }
      if(data) {
        envData = data; 
        setElText('env-aqi', data.aqi); 
        setElText('env-home-aqi', Math.round(data.aqi_7d_avg||data.aqi));
        calculateDashboardStats();
      }
    }

    function getSnapshotGPS() {
      // 1. ç¬é–“æ¸²æŸ“å¿«å–å¢Šæª”ï¼Œè®“ç•«é¢çµ•å°ä¸è½‰åœˆåœˆ
      let lastCity = localStorage.getItem('hp_last_city') || (currentUser ? currentUser.city : 'å°åŒ—å¸‚'); 
      let lastDist = localStorage.getItem('hp_last_dist') || (currentUser ? currentUser.district : '');
      
      setElText('ui-loc-name', lastCity + lastDist);
      fetchEnv(lastCity, lastDist); 

      // 2. èƒŒæ™¯éœæ…‹æ‰“å¡ (åªæŠ“å–æ‰“é–‹ç•¶ä¸‹çš„ä½ç½®ï¼Œä¸è€—é›»ä¸è¿½è¹¤)
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(r => r.json())
            .then(d => {
              let city = d.address.city || d.address.county || '';
              let district = d.address.suburb || d.address.town || '';
              if(city) {
                // 3. æ‹¿åˆ°çœŸå¯¦ä½ç½®å¾Œï¼Œç„¡ç¸«æ›¿æ›ç•«é¢
                setElText('ui-loc-name', city + district);
                localStorage.setItem('hp_last_city', city); 
                localStorage.setItem('hp_last_dist', district);
                fetchEnv(city, district); 
              }
            }).catch(e => console.log("ç¿»è­¯ä¼ºæœå™¨å¿™ç¢Œ"));
        }, () => { console.log("æœªæˆæ¬Šæˆ–ç„¡è¨Šè™Ÿ"); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }); 
      }
    }

    async function init() {
      await liff.init({ liffId: "2009187567-58hBrZRj" }); if (!liff.isLoggedIn()) { liff.login(); return; }
      const p = await liff.getProfile(); const { data } = await supabaseClient.from('users').select('*').eq('line_uid', p.userId).maybeSingle();
      if (data) {
        currentUser = data; setElText('ui-owner', `${data.name} çš„å°ˆå±¬åº§è‰™`); setElText('ui-car-info', `${data.car_brand} ${data.license_plate}`);
        document.getElementById('nav-bar').style.display = 'flex';
        setElVal('edit-name', data.name); setElVal('edit-plate', data.license_plate); setElText('ui-home-city', data.city||'å°åŒ—å¸‚');
        switchPage('home', document.querySelector('.nav-item'));
        
        // è·‘é¦¬ç‡ˆèˆ‡é»æ•¸
        const { data: rws } = await supabaseClient.from('rewards').select('*').eq('user_uid', data.line_uid);
        let tot = 0; if(rws) rws.forEach(r => tot += (r.type==='redeem'?-r.points:r.points));
        setElText('reward-balance', `$${tot}`);
        setElText('ui-dynamic-msg', 'ç³»çµ±é€£ç·šæ­£å¸¸ï¼ŒæŒçºŒé˜²è­·ä¸­...');
        
        getSnapshotGPS(); // å•Ÿå‹•èƒŒæ™¯éœæ…‹æ‰“å¡å¼•æ“
      } else { document.getElementById('page-register').classList.add('active'); }
    }
    init();
  </script>
</body>
</html>
