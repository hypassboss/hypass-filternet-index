<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* =========================================
       ğŸ’ V4.26 Tesla æ¥µç°¡åº§è‰™ (é˜²å½ˆå®¹éŒ¯ç‰ˆ)
       ========================================= */
    :root {
      --bg-color: #000000; --surface-color: #111111; --border-color: #333333;
      --text-primary: #ffffff; --text-secondary: #aaaaaa;
      --accent-color: #00e676; --accent-glow: rgba(0, 230, 118, 0.3);
      --gold-color: #FFD700; --gold-glow: rgba(255, 215, 0, 0.3);
      --glass-bg: rgba(10, 10, 10, 0.85); --input-bg: #1a1a1a;
    }

    html { background-color: #0a0a0c; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      margin: 0 auto; width: 100%; max-width: 450px; 
      background-color: var(--bg-color); color: var(--text-primary); 
      padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); 
      min-height: 100vh; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .page { display: none; padding: 20px; animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .card { background: var(--surface-color); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); margin-bottom: 20px; border: 1px solid var(--border-color); }
    
    .btn-main { background: linear-gradient(135deg, #00e676 0%, #00b85c 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: 800; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; box-shadow: 0 4px 15px var(--accent-glow); letter-spacing: 1px; transition: all 0.2s;}
    .btn-main:active { transform: scale(0.96); box-shadow: 0 2px 8px var(--accent-glow); }
    
    input, select { width: 100%; padding: 15px; margin-bottom: 15px; background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; -webkit-appearance: none; }
    input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-glow); }
    
    .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; background: var(--glass-bg); display: flex; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom, 0px)) 0; border-top: 1px solid var(--border-color); z-index: 999; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .nav-item { color: var(--text-secondary); cursor: pointer; display: flex; flex-direction: column; align-items: center; font-size: 11px; flex: 1; transition: all 0.2s; -webkit-tap-highlight-color: transparent;}
    .nav-item.active { color: var(--accent-color); font-weight: bold; }
    .nav-item div { font-size: 24px; margin-bottom: 4px; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h2 { margin: 0; font-size: 22px; font-weight: 800; }
    .badge { background: var(--accent-glow); color: var(--accent-color); border: 1px solid var(--accent-color); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
    .pulse { width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 var(--accent-glow); } 70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

    .main-visual-container { display: flex; flex-direction: column; align-items: center; margin: 40px 0 30px 0; }
    .ring { width: 240px; height: 240px; border-radius: 50%; border: 6px solid var(--accent-color); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--accent-glow); position: relative; background: var(--surface-color); z-index:2;}
    .ring::after { content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px; border-radius: 50%; border: 1px dashed var(--text-secondary); animation: rotate 25s linear infinite; opacity: 0.3; z-index:1;}
    @keyframes rotate { 100% { transform: rotate(360deg); } }
    
    .dynamic-msg-bar { background: var(--surface-color); color: var(--accent-color); padding: 12px 16px; border-radius: 12px; font-size: 14px; margin-bottom: 20px; display: flex; align-items: center; border: 1px solid var(--border-color); overflow: hidden; font-weight: bold; }
    .marquee-container { flex: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; }
    .marquee-content { display: inline-block; animation: scrollText 12s linear infinite; }
    @keyframes scrollText { from { transform: translateX(100%); } to { transform: translateX(-100%); } }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .env-box { background: var(--surface-color); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid var(--border-color); display: flex; flex-direction: column; justify-content: center;}
    .env-box h4 { margin: 0 0 8px 0; color: var(--text-secondary); font-size: 12px; }
    .env-box .val { font-size: 28px; font-weight: 800; margin: 0; color: var(--text-primary); letter-spacing: -1px;}
    
    .esg-card { background: var(--surface-color); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); text-align: center; }
    .esg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
    .esg-item { background: var(--input-bg); padding: 15px; border-radius: 8px; }

    .vip-card { background: linear-gradient(135deg, #2a2000 0%, #000000 100%); border: 1px solid var(--gold-color); box-shadow: 0 4px 25px var(--gold-glow); padding: 30px 20px; text-align: center; border-radius: 16px; position: relative; overflow: hidden;}
    .vip-card::before { content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: var(--gold-glow); filter: blur(40px); border-radius: 50%; }

    .tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab-btn { background: var(--surface-color); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 12px; border-radius: 10px; flex: 1; text-align: center; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s;}
    .tab-btn.active { background: var(--accent-glow); color: var(--accent-color); border-color: var(--accent-color); }
    
    .log-item { border-bottom: 1px solid var(--border-color); padding: 15px 0; font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
    .log-item:last-child { border-bottom: none; }
    label { font-size: 13px; color: var(--text-secondary); margin-bottom: 5px; display: block; font-weight: bold;}
    .version-tag { text-align: center; color: var(--text-secondary); font-size: 11px; margin-top: 30px; font-family: monospace; letter-spacing: 1px; opacity: 0.5;}
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <div style="text-align:center; margin-bottom:40px; margin-top:20px;">
        <h1 style="color:var(--text-primary); margin-bottom:5px; font-size:32px; letter-spacing:2px;">HYPASS</h1>
        <h2 style="color:var(--accent-color); margin:0; letter-spacing:1px;">Air+ æ™ºèƒ½åº§è‰™</h2>
    </div>
    <div class="card"><p style="font-size:14px; color:var(--text-secondary); margin:0; text-align:center; line-height:1.6;">ç‚ºä¿éšœæ‚¨çš„æ•¸ä½å±¥æ­·èˆ‡å°ˆå±¬ä¿å›º<br>è«‹å®Œæˆé¦–æ¬¡åº§è‰™æˆæ¬Š</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:var(--input-bg); color:var(--text-primary); border:1px solid var(--border-color); box-shadow:none;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:30px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="é›»å­éƒµä»¶ (é¸å¡«)">
      <select id="c-gender"><option value="">* æ€§åˆ¥</option><option value="M">ç”·</option><option value="F">å¥³</option></select>
      <select id="c-city" onchange="updateDistricts('c-city', 'c-district')">
        <option value="">* å±…ä½ç¸£å¸‚</option><option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option><option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="å…¶ä»–">å…¶ä»–ç¸£å¸‚</option>
      </select>
      <select id="c-district"><option value="">* é„‰é®å¸‚å€</option></select>
      <input type="text" id="c-address" placeholder="* è©³ç´°é€šè¨Šåœ°å€ (è¡—é“/å··å¼„/æ¨“å±¤)">
      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡è»Šè¼›å“ç‰Œ</option><option value="Toyota">Toyota</option><option value="Honda">Honda</option><option value="Tesla">Tesla</option><option value="Benz">Benz</option><option value="BMW">BMW</option><option value="Other">å…¶ä»–å“ç‰Œ</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="number" id="c-year" placeholder="* å‡ºå» å¹´ä»½ (ä¾‹ï¼š2023)">
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼ (ä¾‹ï¼šABC-1234)">
      <select id="c-mileage"><option value="">* å¹´å¹³å‡é‡Œç¨‹</option><option value="10000">10,000 å…¬é‡Œä»¥ä¸‹</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œä»¥ä¸Š</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆæˆæ¬Šä¸¦å•Ÿç”¨åº§è‰™</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="header">
      <h2 id="ui-owner">è®€å–ä¸­...</h2>
      <div class="badge" id="ui-shield-badge"><div class="pulse" id="ui-pulse-dot"></div> <span id="ui-shield-text">é€£ç·šä¸­</span></div>
    </div>
    
    <div style="font-family:monospace; color:var(--text-secondary); font-size:14px; text-align:center;">è»Šç‰Œç¶å®šï¼š<span id="ui-plate-tag" style="color:var(--text-primary); font-weight:bold;">è®€å–ä¸­</span></div>

    <div class="main-visual-container">
      <div class="ring">
        <div style="font-size:72px; font-weight:900; color:var(--accent-color); letter-spacing:-2px; line-height:1; text-shadow: 0 0 20px var(--accent-glow);" id="ui-health">100%</div>
        <div style="font-size:14px; color:var(--text-secondary); font-weight:bold; margin-top:8px;">å‹•æ…‹å£½å‘½æ¨ä¼°</div>
      </div>
      <div style="font-size:12px; color:var(--text-secondary); margin-top:25px; letter-spacing:1px;">ä¿å›ºå•Ÿç”¨æ—¥æœŸ: <span id="ui-filter-date" style="font-weight:bold; color:var(--text-primary);">è®€å–ä¸­...</span></div>
    </div>
    
    <div class="dynamic-msg-bar" id="dynamic-msg-box">
      <span style="margin-right: 12px; font-size: 18px;">ğŸ’¬</span>
      <div class="marquee-container"><span class="marquee-content" id="ui-dynamic-msg">ç³»çµ±é€£ç·šæ­£å¸¸ï¼ŒæŒçºŒç‚ºæ‚¨ç›£æ§åº§è‰™ç©ºæ°£å“è³ª...</span></div>
    </div>

    <div class="grid-2">
      <div class="env-box">
        <h4>ğŸ“ å³æ™‚æ‰€åœ¨åœ°<br><span id="ui-loc-name" style="color:var(--text-primary); font-size:14px;">å®šä½ä¸­...</span></h4>
        <div style="display:flex; align-items:baseline; justify-content:center; gap:4px;">
           <span style="font-size:12px; color:var(--text-secondary); font-weight:bold;">AQI</span>
           <p class="val" id="env-aqi" style="color:var(--accent-color);">--</p>
        </div>
      </div>
      <div class="env-box">
        <h4>ğŸ  é è¨­å±…ä½åœ° (7æ—¥å‡å€¼)<br><span id="ui-home-city" style="color:var(--text-primary); font-size:14px;">è®€å–ä¸­...</span></h4>
        <div style="display:flex; align-items:baseline; justify-content:center; gap:4px;">
           <span style="font-size:12px; color:var(--text-secondary); font-weight:bold;">AQI</span>
           <p class="val" id="env-home-aqi" style="color:var(--gold-color);">--</p>
        </div>
      </div>
    </div>

    <div class="esg-card">
      <h3 style="margin:0 0 10px 0; font-size:16px;">ğŸŒ± ç¶ èƒ½æ¸›ç¢³æˆå°±</h3>
      <p style="font-size:13px; color:var(--text-secondary); margin:0;">æ­è¼‰å†·æ°£è¼•è² è¼‰æŠ€è¡“ï¼Œç‚ºåœ°çƒç›¡ä¸€ä»½å¿ƒåŠ›</p>
      <div class="esg-grid">
        <div class="esg-item">
          <div style="font-size:24px; margin-bottom:5px;">âš¡ï¸</div>
          <div style="font-size:20px; font-weight:bold; color:var(--accent-color);"><span id="ui-esg-kwh">0</span> <span style="font-size:12px; color:var(--text-secondary);">kWh</span></div>
          <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">ç¯€çœé›»åŠ›</div>
        </div>
        <div class="esg-item">
          <div style="font-size:24px; margin-bottom:5px;">ğŸŒ²</div>
          <div style="font-size:20px; font-weight:bold; color:var(--accent-color);"><span id="ui-esg-co2">0</span> <span style="font-size:12px; color:var(--text-secondary);">kg</span></div>
          <div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">æ¸›å°‘ç¢³æ’</div>
        </div>
      </div>
    </div>
    
    <button class="btn-main" onclick="scanFilter()" style="margin-top:20px; font-size:18px; padding:18px;">ğŸ“· æƒæä¸€ç¶­æ¢ç¢¼ (UID) å•Ÿç”¨æ¿¾ç¶²</button>
  </div>

  <div id="page-shop" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ›’ å®˜æ–¹å•†åŸ</h3>
    <div class="card" style="text-align:center; padding: 40px 20px;">
      <p style="color:var(--text-secondary); font-size:15px; margin-bottom:15px;">æ‚¨çš„å°ˆå±¬éš±è—å„ªæƒ ç¢¼ï¼š</p>
      <h2 style="color:var(--accent-color); letter-spacing: 4px; border: 2px dashed var(--accent-color); padding: 18px; border-radius: 12px; margin-bottom:30px; font-size:28px;">AIRPLUS2026</h2>
      <button class="btn-main" onclick="window.location.href='https://www.hypass.com.tw/categories/replace-filters-all'">å‰å¾€å•†åŸé¸è³¼å°ˆå±¬æ¿¾ç¶²</button>
    </div>
  </div>

  <div id="page-book" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ“ é ç´„å®‰è£</h3>
    <div class="tab-container">
      <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
      <div class="tab-btn" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ å…¨å°ä¿ä¿®å» </div>
    </div>
    <div id="booking-smart"><div id="smart-match-result" class="card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
    <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">ğŸ ä»»å‹™èˆ‡çå‹µ</h3>
    <div class="vip-card">
      <h4 style="margin:0; color:var(--gold-color); font-size: 16px; letter-spacing: 2px;">VIP å°ˆå±¬çå‹µé‡‘</h4>
      <h1 style="margin:20px 0; font-size: 56px; color: #FFF; text-shadow: 0 4px 20px rgba(255, 215, 0, 0.5);"><span id="reward-balance">$0</span></h1>
      <p style="font-size:13px; color:#aaa; margin-bottom: 25px; line-height:1.6;">ç´¯ç©æ»¿ $100 å³å¯å…Œæ› LINE Points<br>æ¨è–¦ç„¡ä¸Šé™ï¼Œçé‡‘ç„¡ä¸Šé™ï¼</p>
      <button class="btn-main" style="background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); color:#000; box-shadow: 0 4px 15px var(--gold-glow);" onclick="redeemPoints()">ç”³è«‹æé ˜é»æ•¸</button>
    </div>
    
    <div class="card" style="text-align: center; border: 1px solid var(--accent-color); margin-top:20px;">
       <h3 style="margin-top: 5px; color: var(--text-primary); font-size:18px;">ğŸš€ é‚€è«‹è»Šå‹åŠ å…¥åº§è‰™</h3>
       <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5;">åˆ†äº«å°ˆå±¬é€£çµï¼Œå¥½å‹æˆåŠŸå•Ÿç”¨æ¿¾ç¶²å¾Œ<br>æ‚¨å°‡ç«‹å³ç²å¾—æ¨è–¦çé‡‘ï¼</p>
       <button class="btn-main" onclick="generateMGM()">ğŸ”— é»æ“Šè¤‡è£½å°ˆå±¬é€£çµ</button>
    </div>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:var(--text-primary); font-size:22px; margin-bottom:20px;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    
    <div class="tab-container">
      <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')">ğŸ‘¤ åŸºæœ¬è³‡æ–™</div>
      <div class="tab-btn" id="tab-set-b" onclick="switchSetTab('b')">ğŸ“œ æ­·å²ç´€éŒ„</div>
      <div class="tab-btn" id="tab-set-c" onclick="switchSetTab('c')">ğŸ“„ æ•¸ä½åˆç´„</div>
    </div>

    <div id="set-content-a" style="display:block;">
      <div class="card">
        <label>è»Šä¸»å§“å</label><input type="text" id="edit-name">
        <label>è¯çµ¡é›»è©±</label><input type="tel" id="edit-phone">
        <label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <label>å¹´å¹³å‡è¡Œé§›é‡Œç¨‹</label>
        <select id="edit-mileage"><option value="10000">10,000 å…¬é‡Œä»¥ä¸‹</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œä»¥ä¸Š</option></select>
        <button class="btn-main" onclick="updateProfile()" style="margin-top:15px;">å„²å­˜è®Šæ›´</button>
      </div>
    </div>
    
    <div id="set-content-b" style="display:none;">
      <div class="card">
        <select id="history-type" onchange="loadHistory(this.value)" style="margin-bottom:15px;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²æ›´æ›èˆ‡å•Ÿç”¨ç´€éŒ„</option><option value="book">ğŸ“ ä¿ä¿®å» é ç´„ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 350px; overflow-y: auto;">è®€å–ä¸­...</div>
      </div>
    </div>
    
    <div id="set-content-c" style="display:none;">
      <div class="card"><h4 style="margin:0 0 10px 0; color:var(--accent-color); font-size:18px;">ğŸ“„ HYPASS æ•¸ä½ä¿å›º</h4><p style="font-size:14px; color:var(--text-secondary); margin:8px 0;">èªè­‰è»Šç‰Œï¼š<span id="contract-plate" style="color:var(--text-primary); font-weight:bold; font-size:16px;"></span></p></div>
    </div>
    <div class="version-tag">System Ver. V4.26 (é˜²è­·å‡ç´šç‰ˆ)</div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><div>â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="switchPage('shop', this)"><div>ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="switchPage('book', this)"><div>ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><div>ğŸ</div>ä»»å‹™</div>
    <div class="nav-item" onclick="switchPage('settings', this)"><div>âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    // ğŸ›¡ï¸ è»è¦ç´šéŒ¯èª¤æ•æ‰ï¼Œé¿å…ç™½ç•«é¢
    window.onerror = function(msg, url, line) { 
        console.error("System Error:", msg, "at line:", line); 
        alert("ç³»çµ±ç™¼ç”Ÿæš«æ™‚æ€§ç•°å¸¸ï¼Œæ­£åœ¨ç‚ºæ‚¨å˜—è©¦æ¢å¾©ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ (" + msg + ")");
        return false; 
    };

    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null; let currentLocName = 'å°ç£'; let envData = { temp: 25, hum: 60, aqi: 50, pm25: 15 };
    
    const carData = { "Toyota": ["RAV4", "Corolla Cross", "Altis", "å…¶ä»–"], "Honda": ["CR-V", "HR-V", "Fit", "å…¶ä»–"], "Tesla": ["Model Y", "Model 3", "å…¶ä»–"], "Other": ["å…¶ä»–å“ç‰Œ"] };

    function normalizeCityName(cityStr) { return cityStr ? cityStr.replace(/è‡º/g, 'å°') : ''; }
    function formatTaipeiTime(dateString) { try { if (!dateString) return '-'; const d = new Date(dateString); if (isNaN(d.getTime())) return '-'; return d.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei', hour12: false }); } catch(e){ return '-';} }
    function getCarSizeRate(model) { if (!model) return 1.0; const lModels = ['Model X', 'Model Y', 'RAV4', 'CR-V']; const sModels = ['Yaris', 'Fit', 'Swift']; if (lModels.includes(model)) return 1.3; if (sModels.includes(model)) return 0.8; return 1.0; }

    function updateCarModels(brandId, modelId) { 
      const bSelect = document.getElementById(brandId).value; const mSelect = document.getElementById(modelId); mSelect.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>'; 
      if (carData[bSelect]) carData[bSelect].forEach(item => { mSelect.innerHTML += `<option value="${item}">${item}</option>`; });
    }

    function showForm(role) { document.getElementById('form-customer').style.display = (role === 'customer') ? 'block' : 'none'; }
    function switchPage(id, el) { 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); 
        document.getElementById('page-' + id).classList.add('active'); 
        if (el) el.classList.add('active'); 
        if (id === 'book') loadGarages(); 
        if (id === 'settings') loadHistory('filter');
    }
    function switchSetTab(t) { ['a','b','c'].forEach(tab => { document.getElementById(`set-content-${tab}`).style.display = (t === tab) ? 'block' : 'none'; document.getElementById(`tab-set-${tab}`).className = `tab-btn ${t === tab ? 'active' : ''}`; }); }
    function switchBookingTab(t) { document.getElementById('booking-smart').style.display = (t === 'smart') ? 'block' : 'none'; document.getElementById('booking-manual').style.display = (t === 'manual') ? 'block' : 'none'; document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : ''}`; document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : ''}`; }

    // ğŸ›¡ï¸ API é˜²è­·åŒ…è¦† 
    async function updateProfile() {
      try {
          const payload = { name: document.getElementById('edit-name').value, phone: document.getElementById('edit-phone').value, license_plate: document.getElementById('edit-plate').value, yearly_mileage: parseInt(document.getElementById('edit-mileage').value) };
          if (!payload.name || !payload.phone || !payload.license_plate) return alert("å§“åã€é›»è©±ã€è»Šç‰Œä¸å¯ç‚ºç©ºï¼");
          const { error } = await supabaseClient.from('users').update(payload).eq('line_uid', currentUser.line_uid); 
          if (error) throw new Error(error.message); 
          alert('âœ… æˆåŠŸæ›´æ–°è³‡æ–™ï¼'); location.reload();
      } catch (err) { alert("æ›´æ–°å¤±æ•—ï¼š" + err.message); }
    }

    async function loadHistory(type) {
      const container = document.getElementById('history-container'); container.innerHTML = 'è®€å–ä¸­...';
      try {
          if (type === 'filter') {
            const { data, error } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false });
            if (error) throw new Error(error.message);
            let html = '';
            if (data && data.length > 0) {
               data.forEach(d => { html += `<div class="log-item"><b>ğŸ“¦ æ¿¾ç¶² UIDï¼š${d.uid}</b><br><span style="color:var(--accent-color);">å•Ÿç”¨æ™‚é–“ï¼š${formatTaipeiTime(d.activated_at)}</span><br>ç‹€æ…‹ï¼š${d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'âšªï¸ å·²æ›¿æ›'}</div>`; });
            } else { html = '<div class="log-item">å°šç„¡æ›´æ›ç´€éŒ„</div>'; }
            container.innerHTML = html;
          } else if (type === 'book') {
            const { data, error } = await supabaseClient.from('bookings').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('created_at', { ascending: false });
            if (error) throw new Error(error.message);
            let html = '';
            if (data && data.length > 0) {
               data.forEach(d => { html += `<div class="log-item"><b>ğŸ“ ${d.garages?.name || 'ä¿ä¿®å» '}</b><br>é ç´„æ™‚é–“ï¼š${d.book_date}<br>ç‹€æ…‹ï¼š${d.status}</div>`; });
            } else { html = '<div class="log-item">å°šç„¡é ç´„ç´€éŒ„</div>'; }
            container.innerHTML = html;
          }
      } catch(e) { container.innerHTML = `<div class="log-item" style="color:red;">è¼‰å…¥å¤±æ•—ï¼š${e.message}</div>`; }
    }

    async function loadGarages() {
      try {
          const { data, error } = await supabaseClient.from('garages').select('*').eq('status', 'active');
          if (error) throw new Error(error.message);
          let html = '';
          if (data && data.length > 0) {
            document.getElementById('smart-match-result').innerHTML = `ç‚ºæ‚¨é…å°åˆ°æœ€è¿‘çš„ä¿ä¿®å» ï¼š<br><h3 style="color:var(--accent-color);">${data[0].name}</h3><p>${data[0].city}${data[0].address}</p><button class="btn-main" onclick="bookGarage(${data[0].id})">ç«‹å³é ç´„</button>`;
            data.forEach(g => {
              html += `<div class="card" style="margin-bottom:10px;">
                <h4 style="margin:0 0 5px 0; color:var(--text-primary);">${g.name}</h4>
                <p style="font-size:13px; color:var(--text-secondary); margin:0 0 10px 0;">${g.city}${g.address}</p>
                <button class="btn-main" style="padding:10px; font-size:14px;" onclick="bookGarage(${g.id})">é ç´„æ­¤å» </button>
              </div>`;
            });
          } else { html = 'ç›®å‰å°šç„¡åˆä½œä¿ä¿®å» '; document.getElementById('smart-match-result').innerHTML = 'ç›®å‰å°šç„¡é…å°çµæœ'; }
          document.getElementById('garage-list').innerHTML = html;
      } catch(e) { document.getElementById('garage-list').innerHTML = `<div style="color:red;">æ¸…å–®è¼‰å…¥å¤±æ•—</div>`; }
    }

    async function bookGarage(garageId) {
      let date = prompt("è«‹è¼¸å…¥å¸Œæœ›é ç´„çš„æ—¥æœŸ (ä¾‹å¦‚: 2026/03/01):");
      if(!date) return;
      try {
          const { error } = await supabaseClient.from('bookings').insert([{ user_uid: currentUser.line_uid, garage_id: garageId, book_date: date, status: 'pending' }]);
          if (error) throw error;
          alert("âœ… é ç´„è«‹æ±‚å·²é€å‡ºï¼Œè«‹ç­‰å€™ä¿ä¿®å» è¯çµ¡ç¢ºèªï¼");
      } catch(e) { alert("ç³»çµ±ç•°å¸¸ï¼š" + e.message); }
    }

    function generateMGM() {
        if(!currentUser) return alert("è«‹å…ˆç™»å…¥");
        const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
        alert("è¤‡è£½æˆåŠŸï¼è«‹å°‡ä»¥ä¸‹å°ˆå±¬é€£çµå‚³çµ¦è»Šå‹ï¼š\n\n" + link + "\n\nè»Šå‹é€éæ­¤é€£çµå•Ÿç”¨æ¿¾ç¶²ï¼Œæ‚¨å³å¯ç²å¾—çé‡‘ï¼");
    }
    
    async function redeemPoints() { alert("æé ˜ç”³è«‹å·²é€å‡ºï¼ç¸½éƒ¨å¯©æ ¸å¾Œå°‡æœƒæ´¾ç™¼ LINE Points çµ¦æ‚¨ã€‚"); }

    // ğŸŒŸ ä¸€ç¶­æ¢ç¢¼æƒæèˆ‡é›²ç«¯é˜²å‘†
    async function scanFilter() {
      try {
          // åˆ¤æ–·æ˜¯å¦åœ¨é›»è…¦ç€è¦½å™¨æ‰“é–‹ (é˜²å‘†)
          if (!liff.isInClient()) {
              alert("âš ï¸ æƒæåŠŸèƒ½é™å®šæ–¼æ‰‹æ©Ÿ LINE App å…§ä½¿ç”¨ï¼\nè«‹å°‡æ­¤ç¶²å€è²¼åœ¨ LINE èŠå¤©å®¤ä¸­é»é–‹ã€‚");
              return;
          }

          const res = await liff.scanCodeV2(); 
          if (!res || !res.value) return;
          const scannedUid = res.value.trim();

          if (!scannedUid.match(/^HP-\d+$/)) {
              return alert("âŒ æ¢ç¢¼æ ¼å¼éŒ¯èª¤ï¼\nè«‹å°æº–æ¿¾ç¶²åŒ…è£ä¸Šã€ŒHP-ã€é–‹é ­çš„ä¸€ç¶­æ¢ç¢¼é€²è¡Œæƒæã€‚");
          }

          const { data: filterData, error: checkErr } = await supabaseClient.from('filters_uid').select('status, activated_by_uid').eq('uid', scannedUid).maybeSingle();
          if (checkErr || !filterData) return alert("âŒ æŸ¥ç„¡æ­¤æ¿¾ç¶²æ¢ç¢¼ï¼Œè«‹ç¢ºèªæ˜¯å¦ç‚ºåŸå» æ­£å“ï¼");
          if (filterData.status === 'activated' || filterData.status === 'replaced') return alert("âŒ æ””æˆªï¼æ­¤æ¿¾ç¶²å·²ç¶“è¢«å•Ÿç”¨éäº†ï¼Œç„¡æ³•é‡è¤‡ç¶å®šï¼");

          // å•Ÿç”¨ç¨‹åº
          await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
          
          const { error } = await supabaseClient.from('filters_uid').update({ 
              status: 'activated', 
              activated_by_uid: currentUser.line_uid, 
              activated_at: new Date(), 
              activation_type: 'DIY', 
              installed_car_model: currentUser.car_brand, 
              installed_location: currentLocName 
          }).eq('uid', scannedUid);
          if (error) throw error;
          
          alert(`âœ… æ­å–œï¼æ–°æ¿¾ç¶² [${scannedUid}] å·²æˆåŠŸç¶å®šä¸¦å•Ÿç”¨ï¼`); 
          location.reload();
          
      } catch (err) {
          if(err.message !== "scanCode:fail cancel" && !err.message.includes("cancel")) { 
              alert("æƒæç™¼ç”Ÿç•°å¸¸ï¼š" + err.message); 
          }
      }
    }

    async function calculateDashboardStats() {
      try {
          if (!currentUser) return;
          const badge = document.getElementById('ui-shield-badge'); const badgeText = document.getElementById('ui-shield-text'); const pulseDot = document.getElementById('ui-pulse-dot');
          
          const { data: filter, error } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).maybeSingle();
          if (error) throw error;
          
          if (filter && filter.activated_at) {
            const actDate = new Date(filter.activated_at); document.getElementById('ui-filter-date').innerText = actDate.getFullYear() + '/' + String(actDate.getMonth()+1).padStart(2, '0') + '/' + String(actDate.getDate()).padStart(2, '0');
            const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000 * 60 * 60 * 24)));
            const algoParams = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
            
            let mileageRate = currentUser.yearly_mileage ? (currentUser.yearly_mileage / 20000) : 1.0;
            let aqiRate = (envData.aqi > 150) ? 1.8 : (envData.aqi > 100 ? 1.4 : 1.0);
            let carSizeRate = getCarSizeRate(currentUser.car_model);
            let tempRate = envData.temp > 28 ? 1.2 : (envData.temp < 20 ? 0.8 : 1.0);
            let totalMultiplier = mileageRate * aqiRate * carSizeRate * tempRate;

            let baseWear = parseFloat(algoParams.baseWear || 0.27);
            let health = Math.max(0, Math.round(100 - (days * baseWear * totalMultiplier)));
            document.getElementById('ui-health').innerText = `${health}%`;
            
            if (health >= 60) { badgeText.innerText = 'æ¥µæ•ˆé˜²è­·ä¸­'; document.getElementById('ui-health').style.color = 'var(--accent-color)';} 
            else if (health >= 30) { badgeText.innerText = 'ç©©å®šç›£æ§ä¸­'; document.getElementById('ui-health').style.color = 'var(--accent-color)';} 
            else if (health > 0) { badge.style.setProperty('--accent-color', '#f59e0b'); badgeText.innerText = 'æ•ˆèƒ½è¡°é€€ä¸­'; document.getElementById('ui-health').style.color = '#f59e0b';} 
            else { badge.style.setProperty('--accent-color', '#ef4444'); badgeText.innerText = 'è«‹å³åˆ»æ›´æ›'; document.getElementById('ui-health').style.color = '#ef4444'; pulseDot.style.animation = 'none';}
            
            let totalKwhSaved = (days * parseFloat(algoParams.kwhPerDay || 0.25) * mileageRate).toFixed(1);
            document.getElementById('ui-esg-kwh').innerText = totalKwhSaved;
            let totalCo2 = (totalKwhSaved * parseFloat(algoParams.co2Factor || 0.5)).toFixed(1);
            document.getElementById('ui-esg-co2').innerText = totalCo2;
          } else {
            document.getElementById('ui-filter-date').innerText = 'å°šæœªå•Ÿç”¨';
            document.getElementById('ui-health').innerText = '--%';
            badge.style.setProperty('--accent-color', '#555555'); badgeText.innerText = 'ç³»çµ±å¾…å‘½'; pulseDot.style.animation = 'none';
          }
      } catch(e) { console.error(e); }
    }

    async function fetchEnvironmentalData(city, district) {
      try {
        let searchCity = normalizeCityName(city);
        let { data } = await supabaseClient.from('env_cache').select('*').eq('city', searchCity).eq('district', district).maybeSingle();
        if (!data) { const { data: fallback } = await supabaseClient.from('env_cache').select('*').limit(1).maybeSingle(); data = fallback || { temp: 25, hum: 60, aqi: 50, pm25: 15 }; }

        envData.temp = data.temp; envData.hum = data.hum; envData.aqi = data.aqi; envData.pm25 = data.pm25;
        document.getElementById('env-aqi').innerText = envData.aqi;
        
        let homeCityRaw = currentUser.city || 'å°åŒ—å¸‚'; document.getElementById('ui-home-city').innerText = homeCityRaw;
        
        // ğŸŒŸ è®€å– 7æ—¥å‡å€¼ (è‹¥ç‚ºç©ºå‰‡ç”¨ç•¶ä¸‹ AQI ä»£æ›¿é˜²ç©ºç™½)
        let aqi7d = (data.aqi_7d_avg !== undefined && data.aqi_7d_avg !== null) ? data.aqi_7d_avg : data.aqi;
        document.getElementById('env-home-aqi').innerText = Math.round(aqi7d);

        calculateDashboardStats();
      } catch (e) { calculateDashboardStats(); }
    }

    function getGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`)
            .then(res => res.json())
            .then(d => {
              let city = d.address.city || d.address.county || ''; let district = d.address.suburb || d.address.town || '';
              currentLocName = `${city}${district}`; document.getElementById('ui-loc-name').innerText = currentLocName;
              fetchEnvironmentalData(city, district);
            }).catch(e => { document.getElementById('ui-loc-name').innerText = "å®šä½å®Œæˆ"; fetchEnvironmentalData('', '');});
        }, () => { fetchEnvironmentalData('', ''); }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }); 
      }
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const profile = await liff.getProfile();
        
        const { data, error } = await supabaseClient.from('users').select('*').eq('line_uid', profile.userId).maybeSingle();
        if (error) throw error;

        if (data && data.name) {
          currentUser = data; 
          document.getElementById('nav-bar').style.display = 'flex';
          
          if (data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-plate-tag').innerText = data.license_plate || 'æœªç¶å®šè»Šç‰Œ';
            document.getElementById('edit-name').value = data.name; 
            document.getElementById('edit-phone').value = data.phone; 
            document.getElementById('edit-plate').value = data.license_plate; 
            document.getElementById('contract-plate').innerText = data.license_plate;
            if(data.yearly_mileage) document.getElementById('edit-mileage').value = data.yearly_mileage;

            switchPage('home', document.querySelector('.nav-item'));
            getGPS();
          }
        } else { switchPage('register', null); }
      } catch (err) { 
          console.error("LIFF/DB å•Ÿå‹•å¤±æ•—", err); 
          document.getElementById('ui-owner').innerText = "ç³»çµ±é€£ç·šç•°å¸¸";
      }
    }
    
    // ç³»çµ±å•Ÿå‹•
    initApp();
  </script>
</body>
</html>
