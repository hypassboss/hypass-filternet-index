<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, sans-serif; margin: 0; background: #0a0a0c; color: #fff; padding-bottom: 90px; }
    .page { display: none; padding: 15px; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
    .card { background: #16181a; padding: 15px; border-radius: 16px; margin-bottom: 15px; border: 1px solid #2a2d32; }
    .btn-main { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border: none; padding: 16px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 10px; font-size: 16px; }
    input, select { width: 100%; padding: 14px; margin-bottom: 12px; background: #000; color: #fff; border: 1px solid #333; border-radius: 10px; box-sizing: border-box; }
    .bottom-nav { position: fixed; bottom: 0; width: 100%; background: rgba(22, 24, 26, 0.95); display: flex; justify-content: space-around; padding: 12px 0 25px 0; border-top: 1px solid #2a2d32; z-index: 999; }
    .nav-item { color: #666; font-size: 11px; cursor: pointer; text-align: center; width: 20%; }
    .nav-item.active { color: #00D100; font-weight: bold; }
    .tech-tag { display: inline-block; background: #222; color: #00D100; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin: 2px 2px 0 0; border: 1px solid #005500; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .aqi-box { text-align: center; padding: 15px 10px; background: #1e2124; border-radius: 12px; }
    .ring-container { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px 0; }
    .ring { width: 160px; height: 160px; border-radius: 50%; border: 6px solid #00D100; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(0, 209, 0, 0.1); }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .esg-box { text-align: center; padding: 12px 5px; background: #1a1e1a; border-radius: 12px; border: 1px solid #253025; }
    .tab-btn { padding: 12px; margin: 0; font-size: 14px; flex: 1; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 1px solid #333; white-space: nowrap; }
    .tab-btn.active { background: linear-gradient(135deg, #00D100 0%, #009900 100%); color: #000; border-color: #00D100; }
    .tab-btn.inactive { background: #1e1e1e; color: #888; }
    .log-item { border-bottom: 1px solid #333; padding: 10px 0; font-size: 13px; color: #aaa; }
    .log-item:last-child { border-bottom: none; }
    .alert-box { background: #550000; color: #ffcccc; padding: 15px; border-radius: 10px; border: 1px solid #ff0000; text-align: center; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="page-register" class="page">
    <h2 style="color:#00D100;">HYPASS é¦–æ¬¡ç™»å…¥æˆæ¬Š</h2>
    <div class="card"><p style="font-size:12px; color:#aaa; margin:0;">æœ¬ç³»çµ±è’é›†è³‡æ–™åƒ…ä¾›ä¿å›ºé ç´„ä½¿ç”¨ã€‚</p></div>
    <button class="btn-main" onclick="showForm('customer')">A. æˆ‘æ˜¯æ¿¾ç¶²å®¢äºº (è»Šä¸»)</button>
    <button class="btn-main" style="background:#222; color:#fff;" onclick="showForm('garage')">B. æˆ‘æ˜¯ä¿ä¿®å» åŠ ç›Ÿå¤¥ä¼´</button>

    <div id="form-customer" style="display:none; margin-top:20px;">
      <input type="text" id="c-name" placeholder="* å§“å">
      <input type="tel" id="c-phone" placeholder="* æ‰‹æ©Ÿè™Ÿç¢¼">
      <input type="email" id="c-email" placeholder="* é›»å­éƒµä»¶">
      <select id="c-city">
        <option value="">* å±…ä½ç¸£å¸‚</option>
        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
        <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option><option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
        <option value="å…¶ä»–">å…¶ä»–ç¸£å¸‚</option>
      </select>
      <select id="c-brand" onchange="updateCarModels('c-brand', 'c-model')">
        <option value="">* é¸æ“‡å“ç‰Œ</option><option value="Tesla">Tesla</option><option value="Toyota">Toyota</option><option value="BMW">BMW</option><option value="Benz">Benz</option><option value="Other">å…¶ä»–</option>
      </select>
      <select id="c-model"><option value="">* è«‹å…ˆé¸æ“‡å“ç‰Œ</option></select>
      <input type="text" id="c-plate" placeholder="* è»Šç‰Œè™Ÿç¢¼">
      <select id="c-mileage"><option value="20000">* å¹´é‡Œç¨‹ (é è¨­2è¬)</option></select>
      <button class="btn-main" onclick="submitRegister('customer')">å®Œæˆè¨»å†Š</button>
    </div>
    
    <div id="form-garage" style="display:none; margin-top:20px;">
      <input type="text" id="g-name" placeholder="* ä¿ä¿®å» åç¨±"><input type="email" id="g-email" placeholder="* é›»å­éƒµä»¶">
      <select id="g-city"><option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option><option value="å°å—å¸‚">å°å—å¸‚</option></select>
      <input type="text" id="g-address" placeholder="* è©³ç´°åœ°å€"><input type="text" id="g-contact" placeholder="* å» é•·å§“å"><input type="tel" id="g-phone" placeholder="* é›»è©±">
      <button class="btn-main" onclick="submitRegister('garage')">é€å‡ºå¯©æ ¸</button>
    </div>
  </div>

  <div id="page-home" class="page">
    <div class="card" style="border-left: 4px solid #00D100;">
      <p id="ui-owner" style="font-size:18px; font-weight:bold; margin:0;">è®€å–ä¸­...</p>
      <p id="ui-car-info" style="font-size:13px; color:#888; margin:5px 0 10px 0;">è®€å–ä¸­...</p>
      <div><span class="tech-tag">æœ€æ–°éœé›»çº–ç¶­æŠ€è¡“</span><span class="tech-tag">æ¤°æ®¼é™¤è‡­æ´»æ€§ç¢³</span></div>
    </div>
    <div class="grid-2 mb-15">
      <div class="aqi-box"><div style="font-size:11px; color:#888;">ğŸ“ æ‰€åœ¨åœ°</div><div style="font-size:12px; color:#fff; margin-top:4px;" id="ui-gps-location">å®šä½ä¸­...</div><div style="font-size:24px; font-weight:bold; color:#00D100; margin:5px 0;">45</div></div>
      <div class="aqi-box"><div style="font-size:11px; color:#888;">ğŸ  å±…ä½åœ°</div><div style="font-size:12px; color:#fff; margin-top:4px;" id="ui-home-city">è®€å–ä¸­...</div><div style="font-size:24px; font-weight:bold; color:#FF9800; margin:5px 0;">68</div></div>
    </div>
    <div class="card" style="text-align: center; margin-top:15px;">
      <div class="ring-container">
        <div class="ring"><div style="font-size:48px; font-weight:bold; color:#00D100;" id="ui-health">100%</div><div style="font-size:12px; color:#888;">æ¿¾ç¶²å£½å‘½</div></div>
        <div style="color:#FF9800; font-size:13px; margin-top:15px; font-weight:bold; background:#221500; padding:6px 12px; border-radius:20px;">ğŸ›¡ï¸ æ””æˆª PM2.5: <span id="ui-pm25">0</span> Âµg</div>
      </div>
      <button class="btn-main" onclick="scanFilter()">ğŸ“· DIY æƒæå•Ÿç”¨æ–°æ¿¾ç¶²</button>
    </div>
    <div class="grid-3">
      <div class="esg-box"><div style="font-size:20px;">ğŸŒ±</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-co2">0</span> kg</div><div style="font-size:11px; color:#888;">çœç¢³è¶³è·¡</div></div>
      <div class="esg-box"><div style="font-size:20px;">âš¡ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;"><span id="ui-esg-kwh">0</span> kWh</div><div style="font-size:11px; color:#888;">çœé›»æ•ˆèƒ½</div></div>
      <div class="esg-box"><div style="font-size:20px;">â›½ï¸</div><div style="font-size:16px; font-weight:bold; color:#fff;">12 %</div><div style="font-size:11px; color:#888;">ç©ºèª¿ç¯€èƒ½</div></div>
    </div>
  </div>

  <div id="page-shop" class="page"><h3 style="color:#00D100;">ğŸ›’ å®˜æ–¹å•†åŸ</h3><div class="card" style="text-align:center;"><p style="color:#aaa;">å°ˆå±¬å„ªæƒ ç¢¼ï¼š</p><h2 style="color:#00D100; letter-spacing: 2px; border: 1px dashed #00D100; padding: 10px;">AIRPLUS2026</h2><button class="btn-main" style="background:#333; color:#fff;" onclick="alert('Shopline ä¸²æ¥ä¸­...')">å‰å¾€å•†åŸ</button></div></div>

  <div id="page-book" class="page">
    <h3 style="color:#00D100;">ğŸ“ é ç´„å®‰è£</h3>
    <div id="blacklist-warning" class="alert-box" style="display:none;">âš ï¸ æ‚¨çš„å¸³è™Ÿå› å¤šæ¬¡æœªä¾ç´„å‰å¾€ï¼Œç›®å‰å·²è¢«é™åˆ¶é ç´„åŠŸèƒ½ã€‚å¦‚æœ‰ç–‘å•è«‹æ´½å®¢æœã€‚</div>
    <div id="booking-section">
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div class="tab-btn active" id="tab-btn-smart" onclick="switchBookingTab('smart')">ğŸ¤– æ™ºèƒ½é…å°</div>
        <div class="tab-btn inactive" id="tab-btn-manual" onclick="switchBookingTab('manual')">ğŸ“‹ æ‰‹å‹•é¸å–</div>
      </div>
      <div id="booking-smart"><div id="smart-match-result" class="card" style="text-align:center;">å®šä½é…å°ä¸­...</div></div>
      <div id="booking-manual" style="display: none;"><div id="garage-list">è®€å–æ¸…å–®ä¸­...</div></div>
    </div>
  </div>

  <div id="page-rewards" class="page">
    <h3 style="color:#00D100;">ğŸ çå‹µèˆ‡æ¨è–¦</h3>
    <div class="card" style="border-color:#FF9800;"><h4 style="margin:0; color:#FF9800;">çå‹µé‡‘é¤˜é¡</h4><h1 style="margin:10px 0;"><span id="reward-balance">$0</span></h1><button class="btn-main" style="background:#FF9800; color:#000;" onclick="redeemPoints()">ç”³è«‹å…Œæ› LINE Points</button></div>
    <button class="btn-main" style="background:#333; color:#fff;" onclick="generateMGM()">ğŸ”— è¤‡è£½å°ˆå±¬æ¨è–¦é€£çµ</button>
  </div>

  <div id="page-settings" class="page">
    <h3 style="color:#00D100;">âš™ï¸ è¨­å®šèˆ‡ç´€éŒ„</h3>
    <div style="display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto;">
      <div class="tab-btn active" id="tab-set-a" onclick="switchSetTab('a')">ğŸ‘¤ è³‡æ–™</div>
      <div class="tab-btn inactive" id="tab-set-b" onclick="switchSetTab('b')">ğŸ“œ ç´€éŒ„</div>
      <div class="tab-btn inactive" id="tab-set-c" onclick="switchSetTab('c')">ğŸ“„ åˆç´„</div>
    </div>
    <div id="set-content-a" style="display:block;">
      <div class="card">
        <label style="font-size:12px; color:#888;">è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="edit-plate">
        <button class="btn-main" onclick="updateProfile()">å„²å­˜ä¿®æ­£</button>
      </div>
    </div>
    <div id="set-content-b" style="display:none;">
      <div class="card">
        <select id="history-type" onchange="loadHistory(this.value)" style="margin-bottom:15px; color:#00D100; font-weight:bold;">
          <option value="filter">ğŸ”„ æ¿¾ç¶²ç´€éŒ„</option><option value="book">ğŸ“ é ç´„è©•åƒ¹ç´€éŒ„</option>
        </select>
        <div id="history-container" style="max-height: 300px; overflow-y: auto;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    <div id="set-content-c" style="display:none;">
      <div class="card"><p style="font-size:13px; color:#aaa;">è»Šç‰Œï¼š<span id="contract-plate"></span></p></div>
    </div>
  </div>

  <div class="bottom-nav" id="nav-bar" style="display:none;">
    <div class="nav-item active" onclick="switchPage('home', this)"><div style="font-size:22px;">â—“</div>åº§è‰™</div>
    <div class="nav-item" onclick="switchPage('shop', this)"><div style="font-size:22px;">ğŸ›’</div>å•†åŸ</div>
    <div class="nav-item" onclick="switchPage('book', this)"><div style="font-size:22px;">ğŸ“</div>é ç´„</div>
    <div class="nav-item" onclick="switchPage('rewards', this)"><div style="font-size:22px;">ğŸ</div>çå‹µ</div>
    <div class="nav-item" onclick="switchPage('settings', this)"><div style="font-size:22px;">âš™ï¸</div>è¨­å®š</div>
  </div>

  <script>
    window.onerror = function(msg) { alert("ç³»çµ±éŒ¯èª¤: " + msg); return false; };
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    let currentUser = null;
    let currentLocation = 'å°ç£';
    const carData = { "Tesla": ["Model Y", "Model 3"], "Toyota": ["RAV4", "Corolla Cross"], "BMW": ["3-Series", "X3"], "Benz": ["C-Class", "GLC"], "Other": ["å…¶ä»–"] };

    function updateCarModels(brandId, modelId) {
      const b = document.getElementById(brandId).value;
      const m = document.getElementById(modelId);
      m.innerHTML = '<option value="">* é¸æ“‡è»Šå‹</option>';
      if(carData[b]) carData[b].forEach(i => m.innerHTML += `<option value="${i}">${i}</option>`);
    }

    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" });
        if (!liff.isLoggedIn()) { liff.login(); return; }
        const { data, error } = await supabaseClient.from('users').select('*').eq('line_uid', (await liff.getProfile()).userId).maybeSingle();
        if(error) throw error;
        
        if (data && data.name) {
          currentUser = data;
          document.getElementById('nav-bar').style.display = 'flex';
          
          if(data.role === 'customer') {
            document.getElementById('ui-owner').innerText = `${data.name} çš„å°ˆå±¬åº§è‰™`;
            document.getElementById('ui-car-info').innerText = `${data.car_brand} ${data.car_model} | ${data.license_plate}`;
            document.getElementById('ui-home-city').innerText = data.city;
            document.getElementById('edit-plate').value = data.license_plate;
            document.getElementById('contract-plate').innerText = data.license_plate;

            // é»‘åå–®é˜»æ“‹é‚è¼¯
            if(data.is_blacklisted) {
              document.getElementById('blacklist-warning').style.display = 'block';
              document.getElementById('booking-section').style.display = 'none';
            }

            switchPage('home', document.querySelector('.nav-item'));
            getGPSLocation(); calculateDashboardStats(); loadGarages(); loadRewards(); doSmartMatch(); loadHistory('filter');
          }
        } else { switchPage('register', null); }
      } catch (err) { alert("å•Ÿå‹•å¤±æ•—ï¼š" + err.message); }
    }

    function getGPSLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&accept-language=zh-TW`);
            const d = await res.json();
            currentLocation = d.address.city || 'å°ç£';
            document.getElementById('ui-gps-location').innerText = `ğŸ“ ${currentLocation}`;
          } catch(e) { document.getElementById('ui-gps-location').innerText = "ğŸ“ GPS é€£ç·šä¸­"; }
        });
      }
    }

    async function submitRegister(role) {
      try {
        const p = await liff.getProfile();
        if(role === 'customer') {
          const { error } = await supabaseClient.from('users').upsert({
            line_uid: p.userId, role: role, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, email: document.getElementById('c-email').value,
            city: document.getElementById('c-city').value, car_brand: document.getElementById('c-brand').value, car_model: document.getElementById('c-model').value, license_plate: document.getElementById('c-plate').value, yearly_mileage: 20000
          });
          if(error) throw error; alert("âœ… è¨»å†ŠæˆåŠŸï¼"); location.reload();
        } else {
          await supabaseClient.from('users').upsert({ line_uid: p.userId, role: 'garage', name: document.getElementById('g-contact').value, email: document.getElementById('g-email').value });
          await supabaseClient.from('garages').insert([{ owner_uid: p.userId, name: document.getElementById('g-name').value, city: document.getElementById('g-city').value, address: document.getElementById('g-address').value, contact_name: document.getElementById('g-contact').value, phone: document.getElementById('g-phone').value }]);
          alert("åŠ ç›Ÿè³‡æ–™é€å‡ºï¼"); location.reload();
        }
      } catch (err) { alert("å¯«å…¥å¤±æ•—ï¼š" + err.message); }
    }

    function switchSetTab(t) {
      document.getElementById('set-content-a').style.display = t === 'a' ? 'block' : 'none';
      document.getElementById('set-content-b').style.display = t === 'b' ? 'block' : 'none';
      document.getElementById('set-content-c').style.display = t === 'c' ? 'block' : 'none';
      document.getElementById('tab-set-a').className = `tab-btn ${t === 'a' ? 'active' : 'inactive'}`;
      document.getElementById('tab-set-b').className = `tab-btn ${t === 'b' ? 'active' : 'inactive'}`;
      document.getElementById('tab-set-c').className = `tab-btn ${t === 'c' ? 'active' : 'inactive'}`;
    }

    async function updateProfile() {
      const { error } = await supabaseClient.from('users').update({ license_plate: document.getElementById('edit-plate').value }).eq('line_uid', currentUser.line_uid);
      if(!error) { alert('âœ… æ›´æ–°æˆåŠŸï¼'); location.reload(); }
    }

    // æ­·å²ç´€éŒ„èˆ‡è»Šä¸»è©•åˆ†ç³»çµ±
    async function loadHistory(type) {
      const container = document.getElementById('history-container');
      container.innerHTML = 'è®€å–ä¸­...'; let html = '';
      if (type === 'filter') {
        const { data } = await supabaseClient.from('filters_uid').select('*').eq('activated_by_uid', currentUser.line_uid).order('activated_at', { ascending: false });
        if(data && data.length > 0) data.forEach(d => html += `<div class="log-item">ğŸ”„ ${new Date(d.activated_at).toLocaleDateString()} - [${d.activation_type}] å•Ÿç”¨ (${d.uid})</div>`);
        else html = '<p>å°šç„¡ç´€éŒ„</p>';
      } else if (type === 'book') {
        const { data } = await supabaseClient.from('appointments').select('*, garages(name)').eq('user_uid', currentUser.line_uid).order('appointment_time', { ascending: false });
        if(data && data.length > 0) {
          data.forEach(d => {
            let rateBtn = (d.status === 'completed' && !d.garage_rating) ? `<button onclick="rateGarage(${d.id})" style="background:#FF9800; color:#000; border:none; border-radius:5px; padding:3px 8px; margin-top:5px; cursor:pointer;">â­ çµ¦äºˆä¿ä¿®å» è©•åƒ¹</button>` : '';
            let ratingTxt = d.garage_rating ? `<span style="color:#FF9800;">(æ‚¨å·²è©•åˆ†: ${d.garage_rating}æ˜Ÿ)</span>` : '';
            html += `<div class="log-item">ğŸ“ ${new Date(d.appointment_time).toLocaleDateString()} - ${d.garages.name} [${d.status}] ${ratingTxt}<br>${rateBtn}</div>`;
          });
        } else html = '<p>å°šç„¡ç´€éŒ„</p>';
      }
      container.innerHTML = html;
    }

    async function rateGarage(appId) {
      let score = prompt("è«‹ç‚ºä¿ä¿®å» çš„æœå‹™è©•åˆ† (1-5æ˜Ÿ)ï¼š\n1: æ¥µå·® / 5: æ¥µä½³", "5");
      if(score && score >= 1 && score <= 5) {
        await supabaseClient.from('appointments').update({ garage_rating: parseInt(score) }).eq('id', appId);
        alert("æ„Ÿè¬æ‚¨çš„è©•åƒ¹ï¼"); loadHistory('book');
      } else if(score) { alert("è«‹è¼¸å…¥ 1 åˆ° 5 ä¹‹é–“çš„æ•¸å­—ã€‚"); }
    }

    async function calculateDashboardStats() {
      const { data: filter } = await supabaseClient.from('filters_uid').select('activated_at').eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated').order('activated_at', { ascending: false }).limit(1).single();
      if(filter && filter.activated_at) {
        document.getElementById('contract-date').innerText = new Date(filter.activated_at).toLocaleDateString('zh-TW');
        const days = Math.max(0, Math.floor((new Date() - new Date(filter.activated_at)) / (1000*60*60*24)));
        document.getElementById('ui-health').innerText = `${Math.max(0, 100 - Math.round(days * 0.27))}%`;
        document.getElementById('ui-pm25').innerText = (days * 1250).toLocaleString();
        document.getElementById('ui-esg-co2').innerText = (days * 0.15).toFixed(1);
        document.getElementById('ui-esg-kwh').innerText = (days * 0.3).toFixed(1);
      }
    }

    // V2 DIY æƒç¢¼ (å¯«å…¥ activation_type èˆ‡ Location)
    async function scanFilter() {
      const res = await liff.scanCodeV2();
      if (!res.value) return;
      
      // 1. å°‡èˆŠçš„æ¿¾ç¶²æ¨™è¨˜ç‚º Replaced
      await supabaseClient.from('filters_uid').update({ status: 'replaced', deactivated_at: new Date() }).eq('activated_by_uid', currentUser.line_uid).eq('status', 'activated');
      
      // 2. å•Ÿç”¨æ–°æ¿¾ç¶² (æ¨™è¨˜ç‚º DIY)
      await supabaseClient.from('filters_uid').update({ 
        status: 'activated', activated_by_uid: currentUser.line_uid, activated_at: new Date(),
        activation_type: 'DIY', installed_car_model: currentUser.car_brand + ' ' + currentUser.car_model, installed_location: currentLocation
      }).eq('uid', res.value);
      
      alert("âœ… DIY å•Ÿç”¨æˆåŠŸï¼å·²å¯«å…¥å±¥æ­·ã€‚"); location.reload();
    }

    function switchBookingTab(t) {
      document.getElementById('booking-smart').style.display = t === 'smart' ? 'block' : 'none';
      document.getElementById('booking-manual').style.display = t === 'manual' ? 'block' : 'none';
      document.getElementById('tab-btn-smart').className = `tab-btn ${t === 'smart' ? 'active' : 'inactive'}`;
      document.getElementById('tab-btn-manual').className = `tab-btn ${t === 'manual' ? 'active' : 'inactive'}`;
    }

    async function doSmartMatch() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active').eq('is_blacklisted', false).limit(1);
      if(data && data.length > 0) {
        document.getElementById('smart-match-result').innerHTML = `<h4 style="margin:0 0 5px 0; color:#fff;">âœ¨ é¦–é¸æ¨è–¦ï¼š${data[0].name}</h4><input type="datetime-local" id="date-smart-${data[0].id}" style="margin-bottom:10px;"><button class="btn-main" onclick="book(${data[0].id}, 'smart')">ä¸€éµé ç´„</button>`;
      }
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').eq('status', 'active').eq('is_blacklisted', false);
      let html = '';
      if(data) data.forEach(g => html += `<div class="card"><h4 style="margin-top:0;">${g.name}</h4><p style="font-size:14px; color:#888;">ğŸ“ ${g.address}</p><input type="datetime-local" id="date-${g.id}"><button class="btn-main" onclick="book(${g.id})">é€å‡ºé ç´„</button></div>`);
      document.getElementById('garage-list').innerHTML = html || '<p>ç„¡å¯ç”¨åº—å®¶</p>';
    }

    async function book(gId, prefix = '') {
      const time = document.getElementById(prefix ? `date-${prefix}-${gId}` : `date-${gId}`).value;
      if(!time) return alert("è«‹é¸æ“‡æ™‚é–“");
      await supabaseClient.from('appointments').insert([{ user_uid: currentUser.line_uid, garage_id: gId, appointment_time: new Date(time) }]);
      alert("ğŸ‰ é ç´„æˆåŠŸï¼");
    }

    function generateMGM() {
      const link = `https://liff.line.me/2009187567-58hBrZRj?ref=${currentUser.line_uid}`;
      navigator.clipboard.writeText(link).then(() => alert(`âœ… é€£çµå·²è¤‡è£½ï¼`)).catch(() => alert(`è¤‡è£½å¤±æ•—`));
    }

    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('*').eq('user_uid', currentUser.line_uid);
      let total = 0; if(data) data.forEach(r => { if(r.status === 'completed') total += (r.type === 'earn' ? r.amount : -r.amount); });
      document.getElementById('reward-balance').innerText = `$${total}`;
    }

    async function redeemPoints() {
      if(parseInt(document.getElementById('reward-balance').innerText.replace('$','')) < 100) return alert('é¤˜é¡ä¸è¶³ï¼');
      await supabaseClient.from('rewards').insert([{ user_uid: currentUser.line_uid, type: 'redeem', amount: 100, status: 'pending' }]);
      alert('âœ… ç”³è«‹å·²é€å‡ºï¼'); loadRewards();
    }

    function switchPage(id, el) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('page-'+id).classList.add('active');
      if(el) el.classList.add('active');
    }

    initApp();
  </script>
</body>
</html>
