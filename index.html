<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HYPASS Air+ æ™ºèƒ½åº§è‰™</title>
  
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; color: #333; }
    .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
    .btn { background: #00B900; color: white; border: none; padding: 15px 20px; border-radius: 8px; font-size: 18px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
    #health-score { font-size: 48px; font-weight: bold; color: #00B900; margin: 20px 0; }
    #user-info { color: #666; font-size: 14px; }
  </style>
</head>
<body>

  <div class="card">
    <img src="https://www.hypass.com.tw/favicon.ico" width="50" style="margin-bottom: 10px;">
    <h2>HYPASS Air+</h2>
    <p id="user-info">é€£ç·šä¸­...</p>
    
    <div id="health-score">100%</div>
    <p>åº§è‰™ç©ºæ°£é˜²è­·åŠ›</p>

    <button class="btn" onclick="scanUID()">ğŸ“· æƒææ¿¾ç¶² UID æ¢ç¢¼</button>
  </div>

  <script>
    // 1. åˆå§‹åŒ– Supabase
    const supabaseUrl = 'https://qznvabjtxcbffjryfgqi.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // 2. åˆå§‹åŒ– LINE LIFF
    async function initApp() {
      try {
        await liff.init({ liffId: "2009187567-58hBrZRj" }); 
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          document.getElementById('user-info').innerText = 'æ­¡è¿è»Šä¸»ï¼š' + profile.displayName;
        } else {
          liff.login();
        }
      } catch (err) {
        document.getElementById('user-info').innerText = 'è«‹åœ¨ LINE App å…§é–‹å•Ÿæ­¤é é¢';
      }
    }

    // 3. æƒæèˆ‡é©—è­‰ UID
    async function scanUID() {
      if (!liff.scanCodeV2) {
        alert("è«‹ç¢ºä¿åœ¨æ‰‹æ©Ÿ LINE å…§æ“ä½œæƒæåŠŸèƒ½ã€‚");
        return;
      }

      try {
        const result = await liff.scanCodeV2();
        const scannedUID = result.value;
        if (!scannedUID) return;

        // å‘ Supabase é©—è­‰ UID
        const { data, error } = await supabaseClient
          .from('filters_uid')
          .select('*')
          .eq('uid', scannedUID)
          .single();

        if (error || !data) {
          alert("âŒ ç„¡æ•ˆçš„ UID æ¢ç¢¼ï¼");
          return;
        }

        if (data.status === 'activated') {
          alert("âš ï¸ æ­¤æ¿¾ç¶²å·²åœ¨ " + new Date(data.activated_at).toLocaleDateString() + " å•Ÿç”¨éã€‚");
          return;
        }

        // æˆåŠŸæ›´æ–°ç‹€æ…‹ç‚ºå·²å•Ÿç”¨
        await supabaseClient
          .from('filters_uid')
          .update({ 
            status: 'activated', 
            activated_at: new Date().toISOString() 
          })
          .eq('uid', scannedUID);

        alert("ğŸ‰ é©—è­‰æˆåŠŸï¼æ¿¾ç¶²å·²å•Ÿç”¨ï¼Œé˜²è­·åŠ›é‡ç½®ã€‚");
        document.getElementById('health-score').innerText = '100%';

      } catch (err) {
        alert("æƒæå‡ºéŒ¯ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    initApp();
  </script>
</body>
</html>
