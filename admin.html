<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HYPASS V7.0 ç¸½éƒ¨æˆ°æƒ…å®¤ (ä¸Šå¸æ¨¡å¼èˆ‡å‡ºè²¨éŒ„å½±)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    
    /* å´é‚Šå°è¦½åˆ— */
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar-title { color: #00e676; padding: 25px 20px 20px 20px; font-size: 20px; font-weight: 900; margin: 0; letter-spacing: 1px;}
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 15px; border-left: 4px solid transparent; transition: 0.2s;}
    .nav-btn:hover { background: #222; color: #fff; }
    .nav-btn.active { color: #00e676; border-left-color: #00e676; background: #1a1e1a; font-weight: bold; }
    
    /* ä¸»å…§å®¹å€ */
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    h2 { margin-top: 0; color: #111; font-size: 22px; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;}
    
    /* è¡¨æ ¼è¨­è¨ˆ */
    table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px;}
    th, td { border: 1px solid #eee; padding: 12px 15px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; font-weight: 600; white-space: nowrap;}
    tr:hover { background: #fdfdfd; }
    
    /* æŒ‰éˆ•è¨­è¨ˆ */
    .btn { background: #00e676; color: #000; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s;}
    .btn:hover { filter: brightness(1.1); transform: scale(0.98);}
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-warn { background: #f59e0b; color: #fff; }
    .btn-primary { background: #3b82f6; color: #fff; }
    
    /* ğŸ“¦ æƒæèˆ‡éŒ„å½±å‡ºè²¨å°ˆå€ */
    .dispatch-container { background: #111; padding: 25px; border-radius: 12px; color: white; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);}
    .scan-input { width: 100%; padding: 16px; font-size: 20px; border-radius: 8px; background: #222; color: #00e676; text-align: center; border: 1px solid #444; margin-bottom: 15px; box-sizing: border-box; font-family: monospace; outline: none;}
    .scan-input:focus { border-color: #00e676; box-shadow: 0 0 10px rgba(0, 230, 118, 0.3);}
    #scanner-box { width: 100%; max-width: 450px; margin: 0 auto 20px auto; overflow: hidden; border-radius: 12px; display: none; border: 2px solid #00e676;}
    #video-box { width: 100%; max-width: 450px; background: #000; border-radius: 12px; border: 2px solid #ef4444; display: none; margin: 0 auto 20px auto;}
    .recording-dot { color: #ef4444; font-weight: bold; animation: blink 1s infinite; display: none; margin-left: 10px;}
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2 class="sidebar-title">HYPASS Admin</h2>
    <button class="nav-btn active" onclick="switchTab('dispatch', this)">ğŸ“¦ å‡ºè²¨éŒ„å½±ç«™</button>
    <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç† (CRM)</button>
    <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘å¯©æ ¸</button>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel active">
      <h2>ğŸ“¦ B2C è‡ªå‹•æƒæèˆ‡å‡ºè²¨éŒ„å½± (é˜²å½å­˜è­‰ç³»çµ±)</h2>
      <div class="dispatch-container">
        
        <div id="scanner-box"></div>
        <video id="video-box" autoplay muted playsinline></video>

        <h3 id="flow-status" style="text-align:center; color:#00e676; margin-bottom:20px; font-size:18px;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ä½œæ¥­</h3>
        
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:1;">
                <label style="color:#aaa; font-size:13px; margin-bottom:5px; display:block;">ğŸ“ Shopline è¨‚å–®è™Ÿç¢¼</label>
                <input type="text" id="inp-order" class="scan-input" readonly placeholder="ç­‰å¾…æƒæ...">
            </div>
            <div style="flex:1;">
                <label style="color:#aaa; font-size:13px; margin-bottom:5px; display:block;">ğŸ“¦ æ¿¾ç¶² UID</label>
                <input type="text" id="inp-uid" class="scan-input" readonly placeholder="ç­‰å¾…æƒæ...">
            </div>
        </div>

        <div style="text-align:center; margin-top: 10px;">
            <button id="btn-scan" class="btn btn-primary" style="font-size:16px; padding: 14px 24px;" onclick="startScanFlow()">1. å•Ÿå‹•é¡é ­æƒææ¢ç¢¼</button>
            <button id="btn-record" class="btn btn-warn" style="font-size:16px; padding: 14px 24px; display:none;" onclick="startRecording()">ğŸ¥ 2. é–‹å§‹åŒ…è£éŒ„å½± <span class="recording-dot" id="rec-dot">âº REC</span></button>
            <button id="btn-stop" class="btn btn-danger" style="font-size:16px; padding: 14px 24px; display:none;" onclick="stopAndSave()">ğŸ›‘ 3. çµæŸéŒ„å½±ä¸¦ä¸‹è¼‰å­˜æª”</button>
        </div>
        
        <p style="text-align:center; color:#777; font-size:12px; margin-top:20px; line-height:1.5;">
          ç³»çµ±æ©Ÿåˆ¶ï¼šæƒæå®Œæˆå¾Œå•Ÿå‹•éŒ„å½±ã€‚é»æ“Šã€ŒçµæŸã€æ™‚ï¼Œ<br>ç³»çµ±æœƒå°‡å½±ç‰‡å‘½åç‚º <strong style="color:#ddd;">[è¨‚å–®è™Ÿç¢¼]_[UID].webm</strong>ï¼Œä¸¦è‡ªå‹•ä¸‹è¼‰è‡³æ‚¨çš„è¨­å‚™ã€‚
        </p>
      </div>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ï¼šå¼·åˆ¶é€£é–æ‹”é™¤)</h2>
      <table id="crm-table">
        <thead>
          <tr>
            <th>å®¢æˆ¶è³‡è¨Š</th>
            <th>è»Šè¼›é…ç½®</th>
            <th>ç³»çµ±æ•¸æ“š</th>
            <th style="text-align:center;">ä¸Šå¸æ“ä½œ (éœ€å¯†ç¢¼)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ç®¡ç† (ç”Ÿç”¢èˆ‡ä¸Šå¸éŠ·æ¯€)</h2>
      <button class="btn btn-primary" style="margin-bottom: 15px;" onclick="generateSequentialUIDs()">âš™ï¸ ä¸€éµç”¢ç”Ÿ 50 çµ„æ–° UID (å·¥å» å…¥åº«)</button>
      <table id="uid-table">
        <thead>
          <tr>
            <th>UID æ¢ç¢¼</th>
            <th>ç›®å‰ç‹€æ…‹</th>
            <th>ç¶å®šæ“æœ‰è€…</th>
            <th>å•Ÿç”¨æ™‚é–“</th>
            <th style="text-align:center;">ä¸Šå¸æ“ä½œ (éœ€å¯†ç¢¼)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table">
        <thead>
          <tr>
            <th>ç”³è«‹è»Šä¸»</th>
            <th>ç”³è«‹æ‰£é™¤é»æ•¸</th>
            <th>ç”³è«‹æ™‚é–“</th>
            <th style="text-align:center;">å¯©æ ¸æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    // åˆå§‹åŒ– Supabase
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    // åˆ‡æ›é ç±¤
    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); 
      btn.classList.add('active');
      if (id === 'crm') loadCRM(); 
      if (id === 'uid') loadUIDs();
      if (id === 'rewards') loadRewards();
    }

    // ==============================================
    // ğŸ¥ 1. å‡ºè²¨éŒ„å½±èˆ‡æƒæç³»çµ± (Web API)
    // ==============================================
    let html5QrcodeScanner = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let currentOrder = "";
    let currentUID = "";
    let videoStream = null;

    // å•Ÿå‹•æ¢ç¢¼æƒæ
    function startScanFlow() {
        currentOrder = ""; currentUID = "";
        document.getElementById('inp-order').value = ""; 
        document.getElementById('inp-uid').value = "";
        
        document.getElementById('btn-scan').style.display = 'none';
        document.getElementById('scanner-box').style.display = 'block';
        document.getElementById('flow-status').innerText = "ç¬¬ä¸€æ­¥ï¼šè«‹å°‡é¡é ­å°æº– Shopline è¨‚å–®æ¢ç¢¼";
        
        html5QrcodeScanner = new Html5Qrcode("scanner-box");
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 280, height: 100 } }, 
            (text) => {
                const scannedText = text.trim();
                if (!currentOrder) {
                    // ç¬¬ä¸€æ®µæƒæï¼šè¨‚å–®è™Ÿ (å‡è¨­è¨‚å–®ä¸æ˜¯ HP- é–‹é ­)
                    if(!scannedText.startsWith('HP-')) {
                        currentOrder = scannedText;
                        document.getElementById('inp-order').value = currentOrder;
                        document.getElementById('flow-status').innerText = "âœ… è¨‚å–® OKï¼ç¬¬äºŒæ­¥ï¼šè«‹æƒææ¿¾ç¶² UID (HP- é–‹é ­)";
                    }
                } else if (!currentUID) {
                    // ç¬¬äºŒæ®µæƒæï¼šæ¿¾ç¶² UID
                    if(scannedText.startsWith('HP-')) {
                        currentUID = scannedText;
                        document.getElementById('inp-uid').value = currentUID;
                        
                        // å…©è€…çš†å®Œæˆï¼Œé—œé–‰æƒæå™¨ï¼Œé¡¯ç¤ºéŒ„å½±æŒ‰éˆ•
                        html5QrcodeScanner.stop().then(() => {
                            document.getElementById('scanner-box').style.display = 'none';
                            document.getElementById('flow-status').innerText = "âœ… æƒæå®Œæˆï¼è«‹é»æ“Šã€é–‹å§‹åŒ…è£éŒ„å½±ã€é€²è¡Œè£ç®±";
                            document.getElementById('btn-record').style.display = 'inline-block';
                        });
                    }
                }
            }, 
            (err) => { /* å¿½ç•¥é›œè¨Š */ }
        ).catch(err => {
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹å…è¨±æ¬Šé™ï¼");
            document.getElementById('btn-scan').style.display = 'inline-block';
            document.getElementById('scanner-box').style.display = 'none';
        });
    }

    // å•Ÿå‹•éŒ„å½±
    async function startRecording() {
        try {
            // è¦æ±‚ç›¸æ©ŸéŒ„å½±æ¬Šé™ (å«å½±åƒèˆ‡è²éŸ³ï¼Œè‹¥ä¸éœ€è²éŸ³å¯è¨­ audio: false)
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            
            const videoElement = document.getElementById('video-box');
            videoElement.style.display = 'block';
            videoElement.srcObject = videoStream;
            
            mediaRecorder = new MediaRecorder(videoStream);
            mediaRecorder.ondataavailable = function(e) { 
                if (e.data.size > 0) recordedChunks.push(e.data); 
            };
            mediaRecorder.start();
            
            document.getElementById('btn-record').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('rec-dot').style.display = 'inline';
            document.getElementById('flow-status').innerText = "ğŸ¥ éŒ„å½±ä¸­... è«‹é–‹å§‹åŒ…è²¨ã€‚å®Œæˆå¾Œé»æ“ŠçµæŸ";
        } catch (err) { 
            alert("ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™éŒ„å½±ï¼š" + err.message); 
        }
    }

    // åœæ­¢éŒ„å½±ã€ä¸‹è¼‰æª”æ¡ˆä¸¦å¯«å…¥è³‡æ–™åº«
    async function stopAndSave() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            document.getElementById('flow-status').innerText = "ğŸ”„ è™•ç†å½±ç‰‡èˆ‡å¯«å…¥è³‡æ–™åº«ä¸­...";
            document.getElementById('btn-stop').style.display = 'none';
            document.getElementById('rec-dot').style.display = 'none';

            mediaRecorder.stop();
            
            mediaRecorder.onstop = async function() {
                // 1. åˆæˆå½±ç‰‡ Blob ä¸¦è§¸ç™¼æœ¬åœ°ä¸‹è¼‰
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = `${currentOrder}_${currentUID}.webm`; // æ ¸å¿ƒï¼šè¨‚å–®è™Ÿç¢¼_UID å‘½åæ³•
                a.click();
                recordedChunks = [];
                
                // é—œé–‰ç›¸æ©Ÿæ¨¡çµ„
                videoStream.getTracks().forEach(track => track.stop());
                document.getElementById('video-box').style.display = 'none';

                // 2. æ›´æ–°è³‡æ–™åº«å‡ºè²¨ç‹€æ…‹
                try {
                    // å˜—è©¦ç”¨è¨‚å–®è™Ÿ(æ‰‹æ©Ÿ)åæŸ¥æœƒå“¡ UIDï¼Œè‹¥æŸ¥ç„¡å‰‡ç•™ç©º
                    const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', currentOrder).maybeSingle(); 
                    
                    const payload = { 
                        status: 'sold', 
                        shopline_order_id: currentOrder 
                    };
                    if(user) payload.activated_by_uid = user.line_uid;
                    
                    const { error } = await supabaseClient.from('filters_uid').update(payload).eq('uid', currentUID);
                    if (error) throw error;

                    alert("âœ… å‡ºè²¨æˆåŠŸï¼å½±ç‰‡å·²ä¸‹è¼‰è‡³æ‚¨çš„è£ç½®ã€‚");
                } catch(dbErr) {
                    alert("âš ï¸ å½±ç‰‡å·²ä¸‹è¼‰ï¼Œä½†è³‡æ–™åº«æ›´æ–°å¤±æ•—ï¼š" + dbErr.message);
                }
                
                // 3. é‡ç½® UI æº–å‚™ä¸‹ä¸€å–®
                document.getElementById('btn-scan').style.display = 'inline-block';
                document.getElementById('flow-status').innerText = "æº–å‚™å°±ç·’ã€‚è«‹å•Ÿå‹•é¡é ­æƒæä¸‹ä¸€ç­†";
                document.getElementById('inp-order').value = ""; 
                document.getElementById('inp-uid').value = "";
            };
        }
    }

    // ==============================================
    // ğŸ‘¥ 2. CRM ä¸Šå¸æ¨¡å¼ (é€£é–æ‹”é™¤)
    // ==============================================
    async function loadCRM() {
      document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr>';
      
      // æ¥µé€Ÿä¸¦è¡ŒæŠ“å–
      const [resUsers, resFilters, resRewards] = await Promise.all([
          supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false }),
          supabaseClient.from('filters_uid').select('activated_by_uid'),
          supabaseClient.from('rewards').select('user_uid')
      ]);
      
      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });
      let rCounts = {}; resRewards.data?.forEach(r => { if(r.user_uid) rCounts[r.user_uid] = (rCounts[r.user_uid] || 0) + 1; });

      let html = '';
      resUsers.data?.forEach(u => {
          html += `<tr>
            <td>
              <div style="font-weight:bold; color:#1976d2; font-size:16px;">${u.name}</div>
              <div style="color:#666; margin-top:4px;">${u.phone}</div>
              <div style="color:#aaa; font-size:12px;">${u.city}${u.district}</div>
            </td>
            <td><b>${u.car_brand}</b><br><span style="color:#f59e0b; font-family:monospace; font-size:16px;">${u.license_plate}</span></td>
            <td>ç¶å®šæ¿¾ç¶²: <b>${pCounts[u.line_uid]||0}</b><br>çå‹µç´€éŒ„: <b>${rCounts[u.line_uid]||0}</b></td>
            <td style="text-align:center;">
              <button class="btn btn-warn" onclick="godModeEdit('${u.line_uid}', '${u.name}')">âœï¸ ä¿®æ”¹</button>
              <button class="btn btn-danger" style="margin-left:5px;" onclick="godModeDelete('${u.line_uid}', '${u.name}')">ğŸ—‘ï¸ éŠ·æ¯€</button>
            </td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    // ğŸš¨ ä¸Šå¸æ¨¡å¼ï¼šé€£é–æ‹”é™¤åˆªé™¤è¡“
    async function godModeDelete(uid, name) {
        const pwd = prompt(`ã€æœ€é«˜æ¬Šé™ã€‘æ‚¨å³å°‡æ°¸ä¹…éŠ·æ¯€å®¢æˆ¶ã€${name}ã€‘ã€‚\nè«‹è¼¸å…¥ä¸Šå¸å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–ï¼");
        
        if (confirm(`âš ï¸ æœ€çµ‚è­¦å‘Šï¼šç¢ºå®šè¦æ‘§æ¯€ ${name} å—ï¼Ÿ\né€™å°‡åŒæ™‚åˆªé™¤ä»–çš„çå‹µé‡‘ã€é ç´„å–®ï¼Œä¸¦è§£é™¤æ¿¾ç¶²ç¶å®šï¼æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
            try {
                // 1. æ®ºå…‰é—œè¯è¡¨
                await supabaseClient.from('rewards').delete().eq('user_uid', uid);
                await supabaseClient.from('bookings').delete().eq('user_uid', uid);
                await supabaseClient.from('user_logs').delete().eq('user_uid', uid);
                
                // 2. è§£é™¤æ¿¾ç¶²ç¶å®š (æŠŠæ“æœ‰è€…æ¸…ç©º)
                await supabaseClient.from('filters_uid').update({ activated_by_uid: null, status: 'sold' }).eq('activated_by_uid', uid);
                
                // 3. æ®ºæ‰ä¸»é«”
                const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
                if (error) throw error; 
                
                alert("âœ… ç›®æ¨™å·²å¾¹åº•éŠ·æ¯€ï¼"); 
                loadCRM();
            } catch (err) { 
                alert("æ‘§æ¯€å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«é—œè¯ï¼š" + err.message); 
            }
        }
    }

    async function godModeEdit(uid, currentName) {
        const pwd = prompt(`ğŸ› ï¸ é€²å…¥ä¿®æ”¹æ¨¡å¼ (ç›®æ¨™: ${currentName})ã€‚\nè«‹è¼¸å…¥ä¸Šå¸å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");
        
        const newPhone = prompt(`è¼¸å…¥æ–°æ‰‹æ©Ÿè™Ÿç¢¼ (ç•™ç©ºä¸ä¿®æ”¹)ï¼š`);
        const newPlate = prompt(`è¼¸å…¥æ–°è»Šç‰Œè™Ÿç¢¼ (ç•™ç©ºä¸ä¿®æ”¹)ï¼š`);
        
        let updates = {}; 
        if (newPhone) updates.phone = newPhone; 
        if (newPlate) updates.license_plate = newPlate;
        
        if (Object.keys(updates).length > 0) {
            await supabaseClient.from('users').update(updates).eq('line_uid', uid); 
            alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); 
            loadCRM();
        }
    }

    // ==============================================
    // ğŸ·ï¸ 3. UID åº«å­˜ç®¡ç† (ç”Ÿç”¢èˆ‡ä¿®æ”¹)
    // ==============================================
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
        let html = '';
        if(data) {
            data.forEach(d => { 
                html += `<tr>
                <td style="font-family:monospace; font-size:16px;"><b>${d.uid}</b></td>
                <td><span style="background:#eee; padding:4px 8px; border-radius:4px; font-size:12px;">${d.status}</span></td>
                <td>${d.users?.name || '-'}</td>
                <td>${d.activated_at ? new Date(d.activated_at).toLocaleDateString() : '-'}</td>
                <td style="text-align:center;">
                  <button class="btn btn-warn" onclick="godModeEditUID('${d.uid}')">ä¿®æ”¹ç‹€æ…‹</button>
                  <button class="btn btn-danger" onclick="godModeDeleteUID('${d.uid}')">å¼·åˆ¶åˆªé™¤</button>
                </td></tr>`; 
            });
        }
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function generateSequentialUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; 
        for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); 
        alert("âœ… 50 çµ„æ–° UID å·²å…¥åº«ï¼"); 
        loadUIDs();
    }

    async function godModeDeleteUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥å¼·åˆ¶åˆªé™¤ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        await supabaseClient.from('filters_uid').delete().eq('uid', uid);
        alert("âœ… å¼·åˆ¶åˆªé™¤æˆåŠŸï¼"); loadUIDs();
    }
    
    async function godModeEditUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥ä¿®æ”¹ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        const newStatus = prompt("è«‹è¼¸å…¥æ–°ç‹€æ…‹ (produced / sold / activated / replaced)ï¼š");
        if(newStatus) {
            await supabaseClient.from('filters_uid').update({status: newStatus}).eq('uid', uid);
            alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); loadUIDs();
        }
    }

    // ==============================================
    // ğŸ 4. çå‹µé‡‘å¯©æ ¸
    // ==============================================
    async function loadRewards() {
        const { data } = await supabaseClient.from('rewards').select('*, users(name)').eq('type', 'redeem').eq('status', 'pending');
        let html = ''; 
        if(data) {
            data.forEach(r => { 
                html += `<tr>
                <td><b>${r.users?.name}</b></td>
                <td style="color:#ef4444; font-weight:bold;">-${r.points} é»</td>
                <td>${new Date(r.created_at).toLocaleString()}</td>
                <td style="text-align:center;"><button class="btn" onclick="approveReward(${r.id})">âœ… æ ¸ç™¼é»æ•¸ä¸¦çµæ¡ˆ</button></td>
                </tr>`; 
            });
        }
        document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç›®å‰ç„¡å¾…å¯©æ ¸ç”³è«‹</td></tr>';
    }
    async function approveReward(id) { 
        if(confirm("ç¢ºèªå·²åŒ¯å‡º LINE Points çµ¦è©²è»Šä¸»ï¼Ÿ")) {
            await supabaseClient.from('rewards').update({status:'completed'}).eq('id',id); 
            alert("âœ… å·²çµæ¡ˆï¼"); 
            loadRewards(); 
        }
    }

    // å•Ÿå‹•åŠ è¼‰
    loadCRM(); 
  </script>
</body>
</html>
