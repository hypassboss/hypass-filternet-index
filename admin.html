<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V2.2 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; padding: 20px 0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; }
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }
    .op-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .op-card h3 { margin: 0 0 10px 0; color: #555; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2 style="color:#00D100; padding: 0 20px; border:none; font-size:18px;">HYPASS ADMIN V2.2</h2>
    <button class="nav-btn active" onclick="switchTab('esg', this)">ğŸŒ ESG æˆ°æƒ…å®¤</button>
    <button class="nav-btn" onclick="switchTab('stats', this)">ğŸ“Š ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</button>
    <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ CRM å®¢æˆ¶ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» å¯©æ ¸</button>
    <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID é˜²å½åº«å­˜</button>
    <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘æ´¾ç™¼</button>
  </div>

  <div class="main-content">
    
    <div id="panel-esg" class="panel active">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card" style="margin-right:0;"><h1><span id="esg-active">0</span> ç‰‡</h1><p>é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š å…¨å°ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="op-card" style="border-top: 4px solid #00D100;">
          <h3>æ¿¾ç¶²æœƒå“¡ç¸½æ•¸</h3><h1 id="stat-total-users" style="font-size: 48px; margin: 10px 0; color: #00D100;">0</h1><p style="color:#888; margin:0; font-size:12px;">å·²å®Œæˆè¨»å†Šä¹‹è»Šä¸»</p>
        </div>
        <div class="op-card" style="border-top: 4px solid #FF9800;">
          <h3>é–‹é€šä¿ä¿®å» ç¸½æ•¸</h3><h1 id="stat-total-garages" style="font-size: 48px; margin: 10px 0; color: #FF9800;">0</h1><p style="color:#888; margin:0; font-size:12px;">ç›®å‰ä¸Šæ¶ç‡Ÿæ¥­ä¸­</p>
        </div>
      </div>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;"><h3 style="color:#333;">ğŸ‘¥ æœƒå“¡ç¸£å¸‚ç†±å€åˆ†ä½ˆ</h3><table id="stat-users-city"><thead><tr><th>å±…ä½ç¸£å¸‚</th><th>æœƒå“¡äººæ•¸</th></tr></thead><tbody></tbody></table></div>
        <div style="flex: 1;"><h3 style="color:#333;">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» ä½ˆé»åˆ†ä½ˆ</h3><table id="stat-garages-city"><thead><tr><th>æ‰€åœ¨ç¸£å¸‚</th><th>åˆä½œå®¶æ•¸</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM</h2>
      <table id="crm-table"><thead><tr><th>å§“å/Email</th><th>é›»è©±</th><th>è»Šæ¬¾/è»Šç‰Œ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>å¹³å‡è©•åˆ†</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID ç”Ÿå‘½é€±æœŸ</h2>
      <button class="btn" onclick="generateUIDs(5)">+ ç”Ÿç”¢ 5 çµ„æ–° UID</button>
      <table id="uid-table" style="margin-top:15px;"><thead><tr><th>UID ç¢¼</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹</th><th>ç¶å®šè»Šå‹/åœ°é»</th><th>æ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points äººå·¥å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-'+id).classList.add('active');
      btn.classList.add('active');
      
      if(id==='esg') loadESG();
      if(id==='stats') loadStats();
      if(id==='crm') loadCRM();
      if(id==='garage') loadGarages();
      if(id==='uid') loadUIDs();
      if(id==='rewards') loadRewards();
    }

    async function loadESG() {
      const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status', 'activated');
      if(data) {
        let totalDays = 0;
        data.forEach(d => { if(d.activated_at) totalDays += Math.floor((new Date() - new Date(d.activated_at)) / (1000*60*60*24)); });
        document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString();
        document.getElementById('esg-co2').innerText = (totalDays * 0.15).toFixed(1);
        document.getElementById('esg-active').innerText = data.length;
      }
    }

    async function loadStats() {
      const { data: users } = await supabaseClient.from('users').select('city').eq('role', 'customer');
      if (users) {
        document.getElementById('stat-total-users').innerText = users.length;
        const counts = {}; users.forEach(u => { const c = u.city || 'æœªå¡«å¯«'; counts[c] = (counts[c] || 0) + 1; });
        let userHtml = ''; Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => userHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#00D100;">${count} äºº</td></tr>`);
        document.getElementById('stat-users-city').querySelector('tbody').innerHTML = userHtml || '<tr><td colspan="2">ç„¡è³‡æ–™</td></tr>';
      }
      const { data: garages } = await supabaseClient.from('garages').select('city').eq('status', 'active');
      if (garages) {
        document.getElementById('stat-total-garages').innerText = garages.length;
        const counts = {}; garages.forEach(g => { const c = g.city || 'æœªå¡«å¯«'; counts[c] = (counts[c] || 0) + 1; });
        let garageHtml = ''; Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => garageHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#FF9800;">${count} å®¶</td></tr>`);
        document.getElementById('stat-garages-city').querySelector('tbody').innerHTML = garageHtml || '<tr><td colspan="2">ç„¡è³‡æ–™</td></tr>';
      }
    }

    async function loadCRM() {
      const { data } = await supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
      let html = '';
      if(data) data.forEach(u => {
        let status = u.is_blacklisted ? '<span style="color:red; font-weight:bold;">é»‘åå–®</span>' : '<span style="color:green;">æ­£å¸¸</span>';
        let action = u.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist('${u.line_uid}', false, 'users')">è§£é™¤é»‘åå–®</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist('${u.line_uid}', true, 'users')">è¨­ç‚ºé»‘åå–®</button>`;
        html += `<tr><td>${u.name}<br><span style="font-size:11px; color:#888;">${u.email||''}</span></td><td>${u.phone}</td><td>${u.car_brand} ${u.car_model} (${u.license_plate})</td><td>${status}</td><td>${action}</td></tr>`;
      });
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*, appointments(garage_rating)').order('created_at', { ascending: false });
      let html = '';
      if(data) data.forEach(g => {
        let ratings = g.appointments.map(a => a.garage_rating).filter(r => r);
        let avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : 'ç„¡è©•åˆ†';
        let status = g.status === 'pending' ? 'å¾…å¯©æ ¸' : (g.is_blacklisted ? '<span style="color:red;">åœæ¬Š</span>' : '<span style="color:green;">ç‡Ÿæ¥­ä¸­</span>');
        let action = g.status === 'pending' ? `<button class="btn" onclick="approveGarage(${g.id})">æ ¸å‡†</button>` : 
                     (g.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist(${g.id}, false, 'garages')">è§£é™¤åœæ¬Š</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist(${g.id}, true, 'garages')">åœæ¬Š</button>`);
        html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${avg} â­</td><td>${status}</td><td>${action}</td></tr>`;
      });
      document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
    }

    async function approveGarage(id) { await supabaseClient.from('garages').update({ status: 'active' }).eq('id', id); loadGarages(); }
    async function toggleBlacklist(id, isBlack, table) { 
      if(table === 'users') await supabaseClient.from('users').update({ is_blacklisted: isBlack }).eq('line_uid', id);
      else await supabaseClient.from('garages').update({ is_blacklisted: isBlack }).eq('id', id);
      table === 'users' ? loadCRM() : loadGarages(); 
    }

    function makeId(length) { let r = ''; const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; for(let i=0; i<length; i++) r += c.charAt(Math.floor(Math.random() * c.length)); return r; }
    async function generateUIDs(count) {
      let ins = []; for(let i=0; i<count; i++) ins.push({ uid: 'HP-' + makeId(8) });
      await supabaseClient.from('filters_uid').insert(ins); alert('ç”Ÿç”¢å®Œæˆ'); loadUIDs();
    }
    async function loadUIDs() {
      const { data } = await supabaseClient.from('filters_uid').select('*').order('created_at', { ascending: false }).limit(50);
      let html = '';
      if(data) data.forEach(d => {
        let status = d.status === 'produced' ? 'ğŸ·ï¸ æœªä½¿ç”¨' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°';
        html += `<tr><td><b>${d.uid}</b></td><td>${status}</td><td>${d.activation_type||'-'}</td><td>${d.installed_car_model ? d.installed_car_model+' ('+d.installed_location+')' : '-'}</td><td>${d.activated_at ? new Date(d.activated_at).toLocaleString() : '-'}</td></tr>`;
      });
      document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('*, users(name, phone)').eq('type', 'redeem').eq('status', 'pending').order('created_at', { ascending: true });
      let html = '';
      if(data) data.forEach(r => html += `<tr><td>${r.users.name} (${r.users.phone})</td><td>å…Œæ› 100 é»</td><td>${new Date(r.created_at).toLocaleString()}</td><td><button class="btn" onclick="completeReward(${r.id})">âœ… çµæ¡ˆ</button></td></tr>`);
      document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4">ç„¡å¾…è™•ç†ç”³è«‹</td></tr>';
    }

    async function completeReward(id) { await supabaseClient.from('rewards').update({ status: 'completed' }).eq('id', id); alert('å·²çµæ¡ˆï¼'); loadRewards(); }

    loadESG();
  </script>
</body>
</html>
