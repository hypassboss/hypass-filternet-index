<html lang="zh-TW">
<head>
<meta charset="UTF-8">
  <title>HYPASS V5.9 ç¸½éƒ¨æˆ°æƒ…å®¤ (å®Œæ•´ä¸Šå¸æ¨¡å¼ç‰ˆ)</title>
  <title>HYPASS V5.11 ç¸½éƒ¨æˆ°æƒ…å®¤ (åƒæ•¸ä¸éš±è—å®Œæ•´ç‰ˆ)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
@@ -51,6 +51,13 @@
.stat-card { background: #0f172a; color: #00e676; padding: 30px 20px; border-radius: 12px; text-align: center; flex: 1; border: 1px solid #1e293b; box-shadow: 0 10px 25px rgba(0,0,0,0.1);}
.stat-card h1 { font-size: 42px; margin: 10px 0; }
.stat-card p { color: #94a3b8; font-size: 14px; margin: 0; }

    /* æ¼”ç®—æ³•åƒæ•¸æ§åˆ¶å€ */
    .param-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;}
    .param-group { display: flex; flex-direction: column; }
    .param-group label { font-size: 12px; color: #64748b; font-weight: bold; margin-bottom: 5px; }
    .param-group input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; }
    .param-group input:focus { border-color: #00e676; }
</style>
</head>
<body>
@@ -150,18 +157,22 @@ <h1><span id="esg-kwh">0</span> <span style="font-size:16px;">kWh</span></h1>
</div>

<div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸å¾®èª¿</h2>
      <div style="background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; display:flex; gap:20px; align-items:flex-end;">
        <div style="flex:1;">
          <label style="font-size:12px; color:#64748b; font-weight:bold;">æ¯æ—¥åŸºç¤è€—æç‡ (é è¨­ 0.27)</label>
          <input type="text" id="p-wear" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; margin-top:5px;" value="0.27">
        </div>
        <div style="flex:1;">
          <label style="font-size:12px; color:#64748b; font-weight:bold;">æ¯æ—¥PM2.5æ””æˆªåŸºæº– (é è¨­ 1250)</label>
          <input type="text" id="p-pm25" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; margin-top:5px;" value="1250">
        </div>
        <button class="btn" style="padding:10px 20px; height:40px;" onclick="saveParams()">å„²å­˜ä¸¦ç™¼å¸ƒè‡³å…¨ç¶²</button>
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸å®Œæ•´å¾®èª¿æ§åˆ¶å°</h2>
      <p style="color:#64748b; font-size:14px; margin-top:-10px;">é€™è£¡ä¿®æ”¹çš„æ•¸å€¼æœƒç›´æ¥å½±éŸ¿å…¨ç¶²è»Šä¸»å‰å°çš„å„€è¡¨æ¿è¨ˆç®—çµæœã€‚</p>
      
      <div class="param-grid">
        <div class="param-group"><label>æ¯æ—¥åŸºç¤è€—æç‡ (%)</label><input type="text" id="p-wear" value="0.27"></div>
        <div class="param-group"><label>æ¯æ—¥ PM2.5 æ””æˆªåŸºæº– (Âµg)</label><input type="text" id="p-pm25" value="1250"></div>
        <div class="param-group"><label>AQI æ©˜å®³åŠ æ¬Šä¿‚æ•¸</label><input type="text" id="p-orange" value="1.4"></div>
        
        <div class="param-group"><label>AQI ç´«çˆ†åŠ æ¬Šä¿‚æ•¸</label><input type="text" id="p-red" value="1.8"></div>
        <div class="param-group"><label>HYPASS é¢¨é˜» (mmH2O)</label><input type="text" id="p-hypass" value="4"></div>
        <div class="param-group"><label>ä»–ç‰Œå¹³å‡é¢¨é˜» (mmH2O)</label><input type="text" id="p-other" value="8"></div>
        
        <div class="param-group"><label>æ¯æ—¥ç¯€çœé›»è€— (kWh)</label><input type="text" id="p-kwh" value="0.25"></div>
        <div class="param-group"><label>ç¢³æ’æ›ç®—ä¿‚æ•¸ (kg/kWh)</label><input type="text" id="p-co2" value="0.5"></div>
</div>
      <button class="btn" style="padding:12px 25px; font-size:15px; width:100%;" onclick="saveParams()">ğŸ’¾ å„²å­˜æ‰€æœ‰åƒæ•¸ä¸¦ç™¼å¸ƒè‡³å…¨ç¶²å‰å°</button>

<h3 style="margin-top:40px; border-bottom:2px solid #e2e8f0; padding-bottom:10px;">ğŸ‡¹ğŸ‡¼ å…¨å° 368 é„‰é®ç’°å¢ƒå¿«å–æ±  (Top 50 æ±¡æŸ“å€)</h3>
<table id="env-table">
@@ -312,7 +323,6 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
}

if(confirm(`æœ€çµ‚ç¢ºèªï¼šç¢ºå®šè¦è®“ã€${name}ã€‘å¾è³‡æ–™åº«å¾¹åº•æ¶ˆå¤±å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
            // å¿…é ˆå…ˆè§£é™¤æ¿¾ç¶²ç¶å®šï¼Œä»¥ç¶­æŒè³‡æ–™åº«é—œè¯
await supabaseClient.from('filters_uid').update({activated_by_uid: null}).eq('activated_by_uid', uid);
const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
if (error) alert("åˆªé™¤å¤±æ•—ï¼š" + error.message); 
@@ -326,11 +336,9 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œå­˜å–è¢«æ‹’ï¼");
}

        // å»è³‡æ–™åº«æŠ“å–ä»–æ‰€æœ‰çš„è³‡æ–™
const { data: user, error } = await supabaseClient.from('users').select('*').eq('line_uid', uid).maybeSingle();
if (error || !user) return alert("ç„¡æ³•è®€å–æ­¤å®¢æˆ¶è³‡æ–™");

        // å¡«å…¥ Modal è£¡é¢
document.getElementById('god-uid').value = user.line_uid;
document.getElementById('god-name').value = user.name || '';
document.getElementById('god-phone').value = user.phone || '';
@@ -345,7 +353,6 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
document.getElementById('god-address').value = user.address || '';
document.getElementById('god-mileage').value = user.yearly_mileage || 10000;

        // é¡¯ç¤º Modal
document.getElementById('god-mode-modal').style.display = 'flex';
}

@@ -378,12 +385,12 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
} else {
alert("âœ… æ‰€æœ‰è³‡æ–™å·²å¼·åˆ¶æ›´æ–°æˆåŠŸï¼");
closeGodModeEdit();
            loadCRM(); // é‡æ–°æ•´ç†è¡¨æ ¼
            loadCRM(); 
}
}

// ==============================================
    // ğŸŒŸ å€‰å„²å‡ºè²¨æƒææ¨¡çµ„ (é›™å¼•æ“)
    // ğŸŒŸ å€‰å„²å‡ºè²¨æƒææ¨¡çµ„
// ==============================================
let html5QrCodeAdmin = null;
function startContinuousScanner() {
@@ -393,7 +400,6 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
{ facingMode: "environment" }, 
{ fps: 10, qrbox: { width: 250, height: 120 } },
(decodedText) => {
                // ç›¸æ©Ÿæƒåˆ°å¾Œï¼ŒæŠŠå€¼å¡é€²è¼¸å…¥æ¡†ä¸¦è§¸ç™¼ Enter é‚è¼¯
if (scanState === 'uid') {
document.getElementById('scan-uid-input').value = decodedText;
handleScan({key: 'Enter', target: {value: decodedText}}, 'uid');
@@ -430,17 +436,15 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
async function processOrder(uid, order) {
document.getElementById('scan-status-msg').innerText = "ğŸ”„ é›²ç«¯å¯«å…¥ç¶å®šä¸­...";

        // å˜—è©¦åæŸ¥æ˜¯å¦å®¢äººå·²ç¶“è¨»å†Š (ç”¨æ‰‹æ©Ÿè™Ÿç¢¼æŸ¥)
const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', order).maybeSingle();

const payload = { status: 'sold', shopline_order_id: order };
        if(user) payload.activated_by_uid = user.line_uid; // å¦‚æœæŸ¥åˆ°å®¢äººï¼Œç›´æ¥å…ˆå¹«ä»–ç¶å®š
        if(user) payload.activated_by_uid = user.line_uid; 

await supabaseClient.from('filters_uid').update(payload).eq('uid', uid);

document.getElementById('scan-status-msg').innerHTML = `<span style="color:#059669;">âœ… æˆåŠŸï¼æ¿¾ç¶² <b>${uid}</b> å·²é…å°è‡³è¨‚å–® <b>${order}</b><br>è«‹ç›´æ¥æƒæä¸‹ä¸€ç‰‡æ¿¾ç¶²ï¼</span>`;

        // é‡ç½®ç‹€æ…‹ï¼Œç¹¼çºŒä¸‹ä¸€ç‰‡
document.getElementById('scan-uid-input').value = ''; 
document.getElementById('scan-order-input').value = '';
document.getElementById('scan-uid-input').disabled = false; 
@@ -469,15 +473,13 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
}

async function generateSequentialUIDs() {
        document.querySelector('#panel-uid button').innerText = "ç”¢ç”Ÿä¸­...";
const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
let ins = []; 
for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });

await supabaseClient.from('filters_uid').insert(ins); 
alert("âœ… æˆåŠŸç”¢ç”Ÿ 50 çµ„å…¨æ–° UIDï¼"); 
        document.querySelector('#panel-uid button').innerText = "âš™ï¸ ä¸€éµç”¢ç”Ÿ 50 çµ„å…¨æ–° UID";
loadUIDs();
}

@@ -499,16 +501,32 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
if(x.activated_at) totalDays += Math.floor((new Date() - new Date(x.activated_at)) / 86400000);
});

        // ä¾ç…§åƒæ•¸è¨ˆç®—
        document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString(); 
        document.getElementById('esg-kwh').innerText = (totalDays * 0.25).toFixed(1); 
        document.getElementById('esg-co2').innerText = (totalDays * 0.125).toFixed(1);
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        let basePm25 = parseFloat(params.basePm25 || 1250);
        let kwhPerDay = parseFloat(params.kwhPerDay || 0.25);
        let co2Factor = parseFloat(params.co2Factor || 0.5);

        document.getElementById('esg-pm25').innerText = (totalDays * basePm25).toLocaleString(); 
        document.getElementById('esg-kwh').innerText = (totalDays * kwhPerDay).toFixed(1); 
        document.getElementById('esg-co2').innerText = (totalDays * kwhPerDay * co2Factor).toFixed(1);
}

// ==============================================
    // ğŸŒŸ æ¼”ç®—æ³•èˆ‡ç’°å¢ƒå¿«å–æ¨¡çµ„
    // ğŸŒŸ æ¼”ç®—æ³•èˆ‡ç’°å¢ƒå¿«å–æ¨¡çµ„ (çµ•å°ä¸éš±è—åƒæ•¸ç‰ˆ)
// ==============================================
async function loadEnv() {
        // è®€å–ç›®å‰çš„åƒæ•¸é¡¯ç¤ºåœ¨è¼¸å…¥æ¡†
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        document.getElementById('p-wear').value = params.baseWear || '0.27';
        document.getElementById('p-pm25').value = params.basePm25 || '1250';
        document.getElementById('p-orange').value = params.weightOrange || '1.4';
        document.getElementById('p-red').value = params.weightRed || '1.8';
        document.getElementById('p-hypass').value = params.paHypass || '4';
        document.getElementById('p-other').value = params.paOther || '8';
        document.getElementById('p-kwh').value = params.kwhPerDay || '0.25';
        document.getElementById('p-co2').value = params.co2Factor || '0.5';

        // è®€å–ç’°å¢ƒæ± 
const { data } = await supabaseClient.from('env_cache').select('*').order('aqi', {ascending:false}).limit(50);
let html = ''; 
data?.forEach(d => { 
@@ -525,9 +543,15 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
function saveParams() { 
localStorage.setItem('hypass_algo_params', JSON.stringify({
baseWear: document.getElementById('p-wear').value, 
            basePm25: document.getElementById('p-pm25').value
            basePm25: document.getElementById('p-pm25').value,
            weightOrange: document.getElementById('p-orange').value,
            weightRed: document.getElementById('p-red').value,
            paHypass: document.getElementById('p-hypass').value,
            paOther: document.getElementById('p-other').value,
            kwhPerDay: document.getElementById('p-kwh').value,
            co2Factor: document.getElementById('p-co2').value
})); 
        alert("âœ… æ¼”ç®—æ³•åƒæ•¸å·²å„²å­˜ä¸¦ç”Ÿæ•ˆæ–¼å…¨ç¶²å‰å°ï¼"); 
        alert("âœ… æ‰€æœ‰æ¼”ç®—æ³•åƒæ•¸å·²å„²å­˜ï¼Œå°‡å³åˆ»å½±éŸ¿å…¨ç¶²å‰å°å„€è¡¨æ¿çš„è¨ˆç®—çµæœï¼"); 
}

// ==============================================
@@ -570,7 +594,6 @@ <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
}

    // ç³»çµ±å•Ÿå‹•ï¼Œé è¨­è¼‰å…¥ CRM
loadCRM();
</script>
</body>
