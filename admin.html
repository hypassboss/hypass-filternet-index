<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V2 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; padding: 20px 0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; }
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    /* å‡ºè²¨ç«™å°ˆå±¬æ¨£å¼ */
    .scan-box { background: #1e1e1e; color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #00D100; }
    .scan-input { width: 100%; padding: 15px; font-size: 18px; border-radius: 5px; border: 2px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; }
    .scan-input:focus { border-color: #00D100; outline: none; }
    .success-msg { color: #00D100; font-weight: bold; padding: 10px 0; border-bottom: 1px dashed #333; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2 style="color:#00D100; padding: 0 20px; border:none;">HYPASS ADMIN</h2>
    <button class="nav-btn active" onclick="switchTab('esg', this)">ğŸŒ ESG æˆ°æƒ…å®¤</button>
    <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ æƒæå‡ºè²¨ç«™</button>
    <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID é˜²å½åº«å­˜</button>
    <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ CRM å®¢æˆ¶ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» å¯©æ ¸</button>
  </div>

  <div class="main-content">
    
    <div id="panel-esg" class="panel active">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <p>æˆ°æƒ…å®¤æ•¸æ“šè¼‰å…¥ä¸­...</p>
    </div>

    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C æƒæå‡ºè²¨å·¥ä½œç«™</h2>
      <p style="color:#666;">æ”¯æ´æƒææ§ã€‚è«‹å…ˆæƒæ/è¼¸å…¥å®¢äººæ‰‹æ©Ÿè™Ÿç¢¼é–å®šè¨‚å–®ï¼Œæ¥è‘—é€£çºŒæƒææ¿¾ç¶² UID é€²è¡Œç¶å®šã€‚</p>
      
      <div class="scan-box">
        <label style="color:#aaa; font-size:14px;">ç¬¬ 1 æ­¥ï¼šå®šä½è¨‚å–® (è«‹è¼¸å…¥è»Šä¸»æ‰‹æ©Ÿè™Ÿç¢¼ä¸¦æŒ‰ Enter)</label>
        <input type="text" id="scan-phone" class="scan-input" placeholder="ä¾‹å¦‚ï¼š0912345678" onkeypress="handlePhoneScan(event)">
        <div id="dispatch-user-info" style="color:#FF9800; font-size:18px; margin-bottom: 10px; min-height: 25px;"></div>

        <label style="color:#aaa; font-size:14px;">ç¬¬ 2 æ­¥ï¼šç¶å®šå•†å“ (è«‹ç”¨æƒææ§é€£çºŒæƒææ¿¾ç¶² QR Code)</label>
        <input type="text" id="scan-uid" class="scan-input" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleUidScan(event)" disabled>
      </div>

      <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
        <h4 style="margin-top:0;">æœ¬æ¬¡å‡ºè²¨ç¶å®šç´€éŒ„ï¼š</h4>
        <div id="dispatch-log" style="max-height: 200px; overflow-y:auto;"></div>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID ç”Ÿå‘½é€±æœŸç®¡ç†</h2>
      <button class="btn" onclick="generateUIDs(5)">+ æ‰¹æ¬¡ç”Ÿç”¢ 5 çµ„æ–° UID</button>
      <table id="uid-table"><thead><tr><th>UID ç¢¼</th><th>ç‹€æ…‹</th><th>æ“æœ‰è€…/å•Ÿç”¨é¡å‹</th><th>æ“ä½œæ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-crm" class="panel"><h2>ğŸ‘¥ CRM å®¢æˆ¶ç®¡ç†</h2><table id="crm-table"><thead><tr><th>å§“å</th><th>é›»è©±</th><th>è»Šç‰Œ</th></tr></thead><tbody></tbody></table></div>
    <div id="panel-garage" class="panel"><h2>ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» å¯©æ ¸</h2><table id="garage-table"><thead><tr><th>åº—å</th><th>ç‹€æ…‹</th></tr></thead><tbody></tbody></table></div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');
    
    // å‡ºè²¨ç«™å…¨åŸŸè®Šæ•¸
    let currentDispatchUser = null;

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-'+id).classList.add('active');
      btn.classList.add('active');
      if(id === 'uid') loadUIDs();
    }

    // --- ğŸ“¦ å‡ºè²¨ç«™æƒæé‚è¼¯ ---
    async function handlePhoneScan(e) {
      if (e.key === 'Enter') {
        const phone = document.getElementById('scan-phone').value.trim();
        if(!phone) return;
        
        document.getElementById('dispatch-user-info').innerText = "æœå°‹è»Šä¸»ä¸­...";
        const { data, error } = await supabaseClient.from('users').select('*').eq('phone', phone).single();
        
        if(data) {
          currentDispatchUser = data;
          document.getElementById('dispatch-user-info').innerText = `âœ… ç›®å‰å‡ºè²¨å°è±¡ï¼š${data.name} (${data.car_brand} ${data.car_model})`;
          document.getElementById('scan-uid').disabled = false;
          document.getElementById('scan-uid').focus(); // è‡ªå‹•è·³åˆ° UID æ¡†æº–å‚™é€¼é€¼
        } else {
          currentDispatchUser = null;
          document.getElementById('dispatch-user-info').innerText = "âŒ æ‰¾ä¸åˆ°è©²æ‰‹æ©Ÿè™Ÿç¢¼çš„è»Šä¸»ï¼Œè«‹ç¢ºèªæ˜¯å¦å·²è¨»å†Š Appã€‚";
          document.getElementById('scan-uid').disabled = true;
        }
      }
    }

    async function handleUidScan(e) {
      if (e.key === 'Enter') {
        const uid = document.getElementById('scan-uid').value.trim();
        document.getElementById('scan-uid').value = ''; // æ¸…ç©ºæº–å‚™æƒä¸‹ä¸€å€‹
        
        if(!uid || !currentDispatchUser) return;

        // ç¶å®š UID åˆ°è©²è»Šä¸»ï¼Œç‹€æ…‹æ”¹ç‚º Sold
        const { error } = await supabaseClient.from('filters_uid')
          .update({ status: 'sold', activated_by_uid: currentDispatchUser.line_uid })
          .eq('uid', uid);

        const logDiv = document.getElementById('dispatch-log');
        if(!error) {
          logDiv.innerHTML = `<div class="success-msg">âœ”ï¸ ${uid} å·²æˆåŠŸç¶å®šçµ¦ ${currentDispatchUser.name}</div>` + logDiv.innerHTML;
          // é †ä¾¿å¯«å…¥ä¸€ç­†æ­·å²ç´€éŒ„çµ¦å®¢äººçœ‹
          await supabaseClient.from('user_logs').insert([{ user_uid: currentDispatchUser.line_uid, action: 'ğŸ›’ å•†åŸå‡ºè²¨', details: `ç¸½éƒ¨å·²å‡ºè²¨æ¿¾ç¶²ï¼š${uid}` }]);
        } else {
          logDiv.innerHTML = `<div style="color:red; padding:5px 0;">âŒ ${uid} ç¶å®šå¤±æ•—ï¼š${error.message}</div>` + logDiv.innerHTML;
        }
      }
    }

    // --- UID åº«å­˜ ---
    function makeId(length) { let r = ''; const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; for(let i=0; i<length; i++) r += c.charAt(Math.floor(Math.random() * c.length)); return r; }
    async function generateUIDs(count) {
      let ins = []; for(let i=0; i<count; i++) ins.push({ uid: 'HP-' + makeId(8) });
      await supabaseClient.from('filters_uid').insert(ins); alert('ç”Ÿç”¢å®Œæˆ'); loadUIDs();
    }
    async function loadUIDs() {
      const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('created_at', { ascending: false }).limit(50);
      let html = '';
      if(data) data.forEach(d => {
        let status = d.status === 'produced' ? 'ğŸ·ï¸ åº«å­˜ä¸­' : d.status === 'sold' ? 'ğŸšš å·²å‡ºè²¨æœªå®‰è£' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°';
        let owner = d.users ? d.users.name : '-';
        html += `<tr><td><b>${d.uid}</b></td><td>${status}</td><td>${owner}</td><td>${new Date(d.created_at).toLocaleString()}</td></tr>`;
      });
      document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

  </script>
</body>
</html>
