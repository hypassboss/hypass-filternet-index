<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V5.8 ç¸½éƒ¨å¤§è…¦ (ä¸Šå¸æ¨¡å¼)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; position: sticky; top: 0;}
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div style="padding-top: 20px;"><h2 style="color:#00D100; padding: 0 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn active" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
      <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ ç¶ èƒ½ç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•ç›£æ§</button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» </button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-crm" class="panel active">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ç‰ˆ)</h2>
      <table id="crm-table"><thead><tr><th>å®¢æˆ¶è³‡è¨Š</th><th>è»Šè¼›</th><th>åœ°å€</th><th>çµ±è¨ˆ</th><th>æ“ä½œ (éœ€å¯†ç¢¼)</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨</h2>
      <div style="display:flex; gap:10px;"><input type="text" id="scan-uid" placeholder="1. æƒæ UID" style="padding:10px; font-size:18px;"><input type="text" id="scan-order" placeholder="2. æƒæè¨‚å–®è™Ÿ" style="padding:10px; font-size:18px;"><button class="btn" onclick="processOrder()">ç¢ºèªå‡ºè²¨</button></div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ç®¡ç†</h2>
      <button class="btn" onclick="generateUIDs()">âš™ï¸ ç”¢ç”Ÿ 50 çµ„</button>
      <table id="uid-table"><thead><tr><th>UID</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ ç¶ èƒ½ç¸½è¦½</h2>
      <div style="display:flex;"><div class="stat-card"><h1><span id="esg-pm25">0</span></h1><p>å…¨ç¶²æ””æˆª PM2.5</p></div><div class="stat-card"><h1><span id="esg-co2">0</span></h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’</p></div></div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸</h2>
      <label>åŸºæº–è€—æç‡: <input type="text" id="p-wear" value="0.27"></label>
      <label>PM2.5åŸºæº–: <input type="text" id="p-pm25" value="1250"></label>
      <button class="btn" onclick="saveParams()">å„²å­˜ä¸¦ç™¼å¸ƒ</button>
      <h3 style="margin-top:20px;">å…¨å°å¿«å–æ±  (7æ—¥å‡å€¼)</h3>
      <table id="env-table"><thead><tr><th>ç¸£å¸‚é„‰é®</th><th>å³æ™‚ AQI</th><th>7æ—¥å‡å€¼</th><th>æ›´æ–°æ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ çå‹µé‡‘å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>ç‹€æ…‹</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); btn.classList.add('active');
      if(id==='crm')loadCRM(); if(id==='uid')loadUIDs(); if(id==='esg')loadESG(); if(id==='monitor')loadEnv(); if(id==='rewards')loadRewards(); if(id==='garage')loadGarages();
    }

    // ğŸŒŸ CRM ä¸Šå¸æ¨¡å¼
    async function loadCRM() {
      const [resUsers, resFilters] = await Promise.all([
          supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false }),
          supabaseClient.from('filters_uid').select('activated_by_uid')
      ]);
      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });
      let html = '';
      resUsers.data?.forEach(u => {
          html += `<tr><td><b>${u.name}</b><br>${u.phone}</td><td>${u.car_brand}<br>${u.license_plate}</td><td>${u.city}${u.district}</td><td>å•Ÿç”¨: ${pCounts[u.line_uid]||0}</td>
            <td><button class="btn" onclick="godModeEdit('${u.line_uid}', '${u.name}')">ä¿®æ”¹</button> <button class="btn btn-danger" onclick="godModeDelete('${u.line_uid}', '${u.name}')">åˆªé™¤</button></td></tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }
    async function godModeDelete(uid, name) {
        if(prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š") !== "hypass888") return alert("å¯†ç¢¼éŒ¯èª¤");
        if(confirm(`åˆªé™¤ ${name}?`)) { await supabaseClient.from('filters_uid').update({activated_by_uid:null}).eq('activated_by_uid', uid); await supabaseClient.from('users').delete().eq('line_uid', uid); loadCRM(); }
    }
    async function godModeEdit(uid, name) {
        if(prompt("è«‹è¼¸å…¥å¯†ç¢¼ï¼š") !== "hypass888") return alert("å¯†ç¢¼éŒ¯èª¤");
        let p = prompt("æ–°è»Šç‰Œï¼š"); if(p) { await supabaseClient.from('users').update({license_plate:p}).eq('line_uid', uid); loadCRM(); }
    }

    async function generateUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); alert("âœ… æˆåŠŸ"); loadUIDs();
    }
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*').order('uid', { ascending: false }).limit(50);
        let html = ''; data?.forEach(d => { html += `<tr><td>${d.uid}</td><td>${d.status}</td><td>${d.activated_at||'-'}</td><td><button class="btn btn-danger" onclick="if(prompt('å¯†ç¢¼')==='hypass888'){supabaseClient.from('filters_uid').delete().eq('uid','${d.uid}'); setTimeout(loadUIDs,500);}">åˆªé™¤</button></td></tr>`; });
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function processOrder() {
        let u = document.getElementById('scan-uid').value; let o = document.getElementById('scan-order').value;
        if(u && o) { await supabaseClient.from('filters_uid').update({status:'sold', shopline_order_id:o}).eq('uid',u); alert("å‡ºè²¨æˆåŠŸ"); document.getElementById('scan-uid').value=''; document.getElementById('scan-order').value=''; }
    }

    async function loadESG() {
        const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status','activated');
        let d = 0; data?.forEach(x => d += Math.floor((new Date()-new Date(x.activated_at))/86400000));
        document.getElementById('esg-pm25').innerText = (d*1250).toLocaleString(); document.getElementById('esg-co2').innerText = (d*0.125).toFixed(1);
    }

    async function loadEnv() {
        const { data } = await supabaseClient.from('env_cache').select('*').order('aqi', {ascending:false}).limit(50);
        let html = ''; data?.forEach(d => { html += `<tr><td>${d.city}${d.district}</td><td>${d.aqi}</td><td style="color:#f59e0b; font-weight:bold;">${Math.round(d.aqi_7d_avg||d.aqi)}</td><td>${new Date(d.updated_at).toLocaleString()}</td></tr>`; });
        document.getElementById('env-table').querySelector('tbody').innerHTML = html;
    }

    function saveParams() { localStorage.setItem('hypass_algo_params', JSON.stringify({baseWear: document.getElementById('p-wear').value, basePm25: document.getElementById('p-pm25').value})); alert("å„²å­˜æˆåŠŸ"); }

    async function loadRewards() {
        const { data } = await supabaseClient.from('rewards').select('*, users(name)').eq('type', 'redeem').eq('status', 'pending');
        let html = ''; data?.forEach(r => { html += `<tr><td>${r.users?.name}</td><td>å…Œæ› 100 é»</td><td>${new Date(r.created_at).toLocaleString()}</td><td><button class="btn" onclick="supabaseClient.from('rewards').update({status:'completed'}).eq('id',${r.id}); setTimeout(loadRewards,500);">çµæ¡ˆ</button></td></tr>`; });
        document.getElementById('reward-table').querySelector('tbody').innerHTML = html;
    }
    
    async function loadGarages() {
        const { data } = await supabaseClient.from('garages').select('*');
        let html = ''; data?.forEach(g => { html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${g.status}</td></tr>`; });
        document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
    }

    loadCRM();
  </script>
</body>
</html>
