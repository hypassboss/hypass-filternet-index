<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V2 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; padding: 20px 0; overflow-y: auto; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; }
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    /* ESG æ¨£å¼ */
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card:last-child { margin-right: 0; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }

    /* å‡ºè²¨ç«™æ¨£å¼ */
    .scan-box { background: #1e1e1e; color: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #00D100; }
    .scan-input { width: 100%; padding: 15px; font-size: 18px; border-radius: 5px; border: 2px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; }
    .scan-input:focus { border-color: #00D100; outline: none; }
    .success-msg { color: #00D100; font-weight: bold; padding: 10px 0; border-bottom: 1px dashed #333; }

    /* æ¨æ’­å¼•æ“æ¨£å¼ */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; background:#e0e0e0; color:#333; display: inline-block; text-align: center; min-width: 60px;}
    .badge.aqi { background: #ffebee; color: #d32f2f; }
    .badge.weather { background: #e3f2fd; color: #1976d2; }
    .badge.health { background: #e8f5e9; color: #388e3c; }
    .badge.o2o { background: #fff3e0; color: #f57c00; }
    .badge.esg { background: #e8f5e9; color: #2e7d32; }
    .badge.mgm { background: #fff3e0; color: #ef6c00; }
    .badge.festival { background: #fce4ec; color: #c2185b; }
    .badge.time { background: #f3e5f5; color: #6a1b9a; }
    .badge.promo { background: #e0f7fa; color: #006064; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-content textarea { width: 100%; height: 120px; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-family: sans-serif; font-size: 14px; box-sizing: border-box; resize: vertical; }
    .modal-content select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2 style="color:#00D100; padding: 0 20px; border:none;">HYPASS ADMIN</h2>
    <button class="nav-btn active" onclick="switchTab('esg', this)">ğŸŒ ESG æˆ°æƒ…å®¤</button>
    <button class="nav-btn" onclick="switchTab('push', this)">ğŸ’¬ æ™ºæ…§æ¨æ’­å¼•æ“</button>
    <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ æƒæå‡ºè²¨ç«™</button>
    <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID é˜²å½åº«å­˜</button>
    <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ CRM å®¢æˆ¶ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» å¯©æ ¸</button>
    <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘æ´¾ç™¼</button>
  </div>

  <div class="main-content">
    
    <div id="panel-esg" class="panel active">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card"><h1><span id="esg-active">0</span> ç‰‡</h1><p>ç›®å‰é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-push" class="panel">
      <h2>ğŸ’¬ AI æ™ºæ…§æ¨æ’­å¼•æ“ (å‹•æ…‹æƒ…å¢ƒåº«)</h2>
      <p style="color:#666;">ç³»çµ±å°‡æ–¼æ¯æ—¥èƒŒæ™¯è‡ªå‹•æƒæå…¨å°è»Šä¸»ç‹€æ…‹ï¼Œè‹¥ç¬¦åˆæ¢ä»¶å°‡è‡ªå‹•ç™¼é€ LINE é€šçŸ¥ã€‚æ‚¨å¯é»æ“Šç·¨è¼¯ä¿®æ”¹æ–‡æ¡ˆã€‚</p>
      <table id="push-table">
        <thead>
          <tr>
            <th style="width: 80px;">é¡åˆ¥</th>
            <th style="width: 150px;">æƒ…å¢ƒè¦å‰‡åç¨±</th>
            <th style="width: 200px;">è§¸ç™¼é‚è¼¯æ¢ä»¶</th>
            <th>è‡ªå‹•æ¨æ’­æ–‡æ¡ˆå…§å®¹</th>
            <th style="width: 80px;">ç‹€æ…‹</th>
            <th style="width: 80px;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="edit-modal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="edit-title" style="margin-top:0; color:#333; border-bottom:2px solid #00D100; padding-bottom:10px;">ç·¨è¼¯æ¨æ’­æ–‡æ¡ˆ</h3>
        <input type="hidden" id="edit-rule-id">
        <label style="font-size:13px; color:#555; font-weight:bold;">æ¨æ’­æ–‡æ¡ˆå…§å®¹</label>
        <p style="font-size:11px; color:#888; margin:2px 0 8px 0;">(å¯éˆæ´»ç·¨å¯«ï¼Œå¸å¼•è»Šä¸»é ç´„æˆ–å›è³¼)</p>
        <textarea id="edit-message"></textarea>
        <label style="font-size:13px; color:#555; font-weight:bold; display:block; margin-top:15px;">æ˜¯å¦å•Ÿç”¨æ­¤æ¨æ’­</label>
        <select id="edit-status">
          <option value="true">ğŸŸ¢ å•Ÿç”¨ä¸­ (ç³»çµ±å°‡è‡ªå‹•åµæ¸¬ç™¼é€)</option>
          <option value="false">ğŸ”´ åœç”¨ (æš«åœç™¼é€æ­¤æƒ…å¢ƒ)</option>
        </select>
        <div style="margin-top: 20px; display:flex; gap:10px; justify-content: flex-end;">
          <button class="btn" style="background:#eee; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="btn" onclick="savePushRule()">å„²å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C æƒæå‡ºè²¨å·¥ä½œç«™</h2>
      <p style="color:#666;">æ”¯æ´æƒææ§ã€‚è«‹å…ˆæƒæ/è¼¸å…¥å®¢äººæ‰‹æ©Ÿè™Ÿç¢¼é–å®šè¨‚å–®ï¼Œæ¥è‘—é€£çºŒæƒææ¿¾ç¶² UID é€²è¡Œç¶å®šã€‚</p>
      <div class="scan-box">
        <label style="color:#aaa; font-size:14px;">ç¬¬ 1 æ­¥ï¼šå®šä½è¨‚å–® (è«‹è¼¸å…¥è»Šä¸»æ‰‹æ©Ÿè™Ÿç¢¼ä¸¦æŒ‰ Enter)</label>
        <input type="text" id="scan-phone" class="scan-input" placeholder="ä¾‹å¦‚ï¼š0912345678" onkeypress="handlePhoneScan(event)">
        <div id="dispatch-user-info" style="color:#FF9800; font-size:18px; margin-bottom: 10px; min-height: 25px;"></div>

        <label style="color:#aaa; font-size:14px;">ç¬¬ 2 æ­¥ï¼šç¶å®šå•†å“ (è«‹ç”¨æƒææ§é€£çºŒæƒææ¿¾ç¶² QR Code)</label>
        <input type="text" id="scan-uid" class="scan-input" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleUidScan(event)" disabled>
      </div>
      <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
        <h4 style="margin-top:0;">æœ¬æ¬¡å‡ºè²¨ç¶å®šç´€éŒ„ï¼š</h4>
        <div id="dispatch-log" style="max-height: 200px; overflow-y:auto;"></div>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID ç”Ÿå‘½é€±æœŸç®¡ç†</h2>
      <button class="btn" onclick="generateUIDs(5)">+ æ‰¹æ¬¡ç”Ÿç”¢ 5 çµ„æ–° UID</button>
      <table id="uid-table" style="margin-top:15px;">
        <thead><tr><th>UID ç¢¼</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹/æ“æœ‰è€…</th><th>å®‰è£è»Šæ¬¾/åœ°é»</th><th>æ“ä½œæ™‚é–“</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (å«é»‘åå–®ç®¡ç†)</h2>
      <table id="crm-table">
        <thead><tr><th>å§“å</th><th>é›»è©±</th><th>è»Šæ¬¾/è»Šç‰Œ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table">
        <thead><tr><th>åº—å</th><th>åœ°å€</th><th>è¯çµ¡äºº/é›»è©±</th><th>å¹³å‡è©•åˆ†</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points äººå·¥å…Œæ›å¯©æ ¸</h2>
      <p style="color:#666; font-size:14px;">è«‹æ–¼ LINE å®˜æ–¹å¸³è™Ÿç™¼é€é»æ•¸åºè™Ÿçµ¦è»Šä¸»å¾Œï¼Œåœ¨æ­¤é»æ“Šã€Œå®Œæˆç™¼æ”¾çµæ¡ˆã€ã€‚</p>
      <table id="reward-table">
        <thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>ç”³è«‹æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );

    // å…¨åŸŸè®Šæ•¸
    let currentDispatchUser = null;

    // --- é ç±¤åˆ‡æ› ---
    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-'+id).classList.add('active');
      btn.classList.add('active');
      
      if(id === 'esg') loadESG();
      if(id === 'push') loadPushRules();
      if(id === 'uid') loadUIDs();
      if(id === 'crm') loadCRM();
      if(id === 'garage') loadGarages();
      if(id === 'rewards') loadRewards();
    }

    // --- 1. ESG è¨ˆç®— ---
    async function loadESG() {
      const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status', 'activated');
      if(data) {
        let totalDays = 0;
        data.forEach(d => { if(d.activated_at) totalDays += Math.floor((new Date() - new Date(d.activated_at)) / (1000*60*60*24)); });
        document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString();
        document.getElementById('esg-co2').innerText = (totalDays * 0.15).toFixed(1);
        document.getElementById('esg-active').innerText = data.length;
      }
    }

    // --- 2. æ™ºæ…§æ¨æ’­å¼•æ“ ---
    async function loadPushRules() {
      const { data } = await supabaseClient.from('notification_rules').select('*').order('id', { ascending: true });
      let html = '';
      if(data) {
        data.forEach(r => {
          let badgeCls = r.category.toLowerCase();
          let statusHtml = r.is_active ? '<span style="color:green; font-weight:bold;">ğŸŸ¢ å•Ÿç”¨</span>' : '<span style="color:red;">ğŸ”´ åœç”¨</span>';
          let safeMessage = r.message_template.replace(/'/g, "\\'").replace(/"/g, "&quot;");
          html += `<tr>
            <td><span class="badge ${badgeCls}">${r.category}</span></td>
            <td style="font-weight:bold; color:#333;">${r.rule_name}</td>
            <td style="font-family:monospace; color:#888; font-size:12px;">${r.trigger_condition}</td>
            <td style="color:#555;">${r.message_template}</td>
            <td>${statusHtml}</td>
            <td><button class="btn" style="padding: 6px 10px; font-size:12px; background:#333; color:#00D100;" onclick="openEditModal(${r.id}, '${r.rule_name}', '${safeMessage}', ${r.is_active})">âœï¸ ç·¨è¼¯</button></td>
          </tr>`;
        });
      }
      document.getElementById('push-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="6" style="text-align:center;">è®€å–ä¸­...</td></tr>';
    }

    function openEditModal(id, ruleName, message, isActive) {
      document.getElementById('edit-rule-id').value = id;
      document.getElementById('edit-title').innerText = `ç·¨è¼¯ï¼š${ruleName}`;
      document.getElementById('edit-message').value = message;
      document.getElementById('edit-status').value = isActive ? "true" : "false";
      document.getElementById('edit-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    
    async function savePushRule() {
      const id = document.getElementById('edit-rule-id').value;
      const newMessage = document.getElementById('edit-message').value;
      const newStatus = document.getElementById('edit-status').value === "true";
      if(!newMessage.trim()) return alert("æ–‡æ¡ˆå…§å®¹ä¸å¯ç‚ºç©ºï¼");
      const { error } = await supabaseClient.from('notification_rules').update({ message_template: newMessage, is_active: newStatus }).eq('id', id);
      if(error) alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
      else { alert("âœ… å„²å­˜æˆåŠŸï¼æ–°æ–‡æ¡ˆå·²ç”Ÿæ•ˆã€‚"); closeModal(); loadPushRules(); }
    }

    // --- 3. æƒæå‡ºè²¨ç«™é‚è¼¯ ---
    async function handlePhoneScan(e) {
      if (e.key === 'Enter') {
        const phone = document.getElementById('scan-phone').value.trim();
        if(!phone) return;
        document.getElementById('dispatch-user-info').innerText = "æœå°‹è»Šä¸»ä¸­...";
        const { data, error } = await supabaseClient.from('users').select('*').eq('phone', phone).single();
        if(data) {
          currentDispatchUser = data;
          document.getElementById('dispatch-user-info').innerText = `âœ… ç›®å‰å‡ºè²¨å°è±¡ï¼š${data.name} (${data.car_brand} ${data.car_model})`;
          document.getElementById('scan-uid').disabled = false;
          document.getElementById('scan-uid').focus(); 
        } else {
          currentDispatchUser = null;
          document.getElementById('dispatch-user-info').innerText = "âŒ æ‰¾ä¸åˆ°è©²æ‰‹æ©Ÿè™Ÿç¢¼çš„è»Šä¸»ï¼Œè«‹ç¢ºèªæ˜¯å¦å·²è¨»å†Š Appã€‚";
          document.getElementById('scan-uid').disabled = true;
        }
      }
    }

    async function handleUidScan(e) {
      if (e.key === 'Enter') {
        const uid = document.getElementById('scan-uid').value.trim();
        document.getElementById('scan-uid').value = ''; 
        if(!uid || !currentDispatchUser) return;
        const { error } = await supabaseClient.from('filters_uid').update({ status: 'sold', activated_by_uid: currentDispatchUser.line_uid }).eq('uid', uid);
        const logDiv = document.getElementById('dispatch-log');
        if(!error) {
          logDiv.innerHTML = `<div class="success-msg">âœ”ï¸ ${uid} å·²æˆåŠŸç¶å®šçµ¦ ${currentDispatchUser.name}</div>` + logDiv.innerHTML;
          await supabaseClient.from('user_logs').insert([{ user_uid: currentDispatchUser.line_uid, action: 'ğŸ›’ å•†åŸå‡ºè²¨', details: `ç¸½éƒ¨å·²å‡ºè²¨æ¿¾ç¶²ï¼š${uid}` }]);
        } else {
          logDiv.innerHTML = `<div style="color:red; padding:5px 0;">âŒ ${uid} ç¶å®šå¤±æ•—ï¼š${error.message}</div>` + logDiv.innerHTML;
        }
      }
    }

    // --- 4. UID é˜²å½åº«å­˜ ---
    function makeId(length) { let r = ''; const c = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; for(let i=0; i<length; i++) r += c.charAt(Math.floor(Math.random() * c.length)); return r; }
    
    async function generateUIDs(count) {
      let ins = []; for(let i=0; i<count; i++) ins.push({ uid: 'HP-' + makeId(8) });
      await supabaseClient.from('filters_uid').insert(ins); alert('ç”Ÿç”¢å®Œæˆ'); loadUIDs();
    }

    async function loadUIDs() {
      const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('created_at', { ascending: false }).limit(50);
      let html = '';
      if(data) data.forEach(d => {
        let status = d.status === 'produced' ? 'ğŸ·ï¸ ç¸½éƒ¨åº«å­˜' : d.status === 'sold' ? 'ğŸšš å·²å‡ºè²¨æœªå•Ÿç”¨' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°';
        let owner = d.users ? d.users.name : '-';
        let typeInfo = d.activation_type ? d.activation_type : owner;
        let carInfo = d.installed_car_model ? `${d.installed_car_model} (${d.installed_location})` : '-';
        let time = d.activated_at ? new Date(d.activated_at).toLocaleString() : new Date(d.created_at).toLocaleString();
        html += `<tr><td><b>${d.uid}</b></td><td>${status}</td><td>${typeInfo}</td><td>${carInfo}</td><td>${time}</td></tr>`;
      });
      document.getElementById('uid-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="5">ç„¡è³‡æ–™</td></tr>';
    }

    // --- 5. CRM å®¢æˆ¶ç®¡ç† ---
    async function loadCRM() {
      const { data } = await supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
      let html = '';
      if(data) data.forEach(u => {
        let status = u.is_blacklisted ? '<span style="color:red; font-weight:bold;">é»‘åå–®</span>' : '<span style="color:green;">æ­£å¸¸</span>';
        let action = u.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist('${u.line_uid}', false, 'users')">è§£é™¤é»‘åå–®</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist('${u.line_uid}', true, 'users')">è¨­ç‚ºé»‘åå–®</button>`;
        html += `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.car_brand} ${u.car_model} (${u.license_plate})</td><td>${status}</td><td>${action}</td></tr>`;
      });
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="5">ç„¡è³‡æ–™</td></tr>';
    }

    // --- 6. ä¿ä¿®å» å¯©æ ¸ ---
    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*, appointments(garage_rating)').order('created_at', { ascending: false });
      let html = '';
      if(data) data.forEach(g => {
        let ratings = g.appointments.map(a => a.garage_rating).filter(r => r);
        let avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : 'å°šç„¡è©•åˆ†';
        let status = g.status === 'pending' ? 'å¾…å¯©æ ¸' : (g.is_blacklisted ? '<span style="color:red;">åœæ¬Š/é»‘åå–®</span>' : '<span style="color:green;">ç‡Ÿæ¥­ä¸­</span>');
        let action = g.status === 'pending' ? `<button class="btn" onclick="approveGarage(${g.id})">æ ¸å‡†é–‹é€š</button>` : 
                     (g.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist(${g.id}, false, 'garages')">è§£é™¤åœæ¬Š</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist(${g.id}, true, 'garages')">å¼·åˆ¶åœæ¬Š</button>`);
        html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${g.contact_name} / ${g.phone}</td><td>${avg} â­</td><td>${status}</td><td>${action}</td></tr>`;
      });
      document.getElementById('garage-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="6">ç„¡è³‡æ–™</td></tr>';
    }

    async function approveGarage(id) { await supabaseClient.from('garages').update({ status: 'active' }).eq('id', id); loadGarages(); }
    
    async function toggleBlacklist(id, isBlack, table) { 
      if(table === 'users') await supabaseClient.from('users').update({ is_blacklisted: isBlack }).eq('line_uid', id);
      else await supabaseClient.from('garages').update({ is_blacklisted: isBlack }).eq('id', id);
      table === 'users' ? loadCRM() : loadGarages(); 
    }

    // --- 7. çå‹µé‡‘å…Œæ› ---
    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('*, users(name, phone)').eq('type', 'redeem').eq('status', 'pending').order('created_at', { ascending: true });
      let html = '';
      if(data) data.forEach(r => {
        html += `<tr><td>${r.users.name} (${r.users.phone})</td><td>å…Œæ› LINE Point 100é»</td><td>${new Date(r.created_at).toLocaleString()}</td><td><button class="btn" onclick="completeReward(${r.id})">âœ… å®Œæˆç™¼æ”¾çµæ¡ˆ</button></td></tr>`;
      });
      document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç›®å‰ç„¡å¾…è™•ç†ç”³è«‹</td></tr>';
    }

    async function completeReward(id) {
      await supabaseClient.from('rewards').update({ status: 'completed' }).eq('id', id); alert('å·²çµæ¡ˆï¼'); loadRewards();
    }

    // åˆå§‹åŒ–é è¨­ç•«é¢
    loadESG();
  </script>
</body>
</html>
