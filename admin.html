<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V3.6 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; position: sticky; top: 0; z-index: 2;}
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card:last-child { margin-right: 0; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }
    .op-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .op-card h3 { margin: 0 0 10px 0; color: #555; }

    /* ğŸŒŸ æƒæç«™å°ˆå±¬ UI */
    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; align-items: flex-start; }
    .scan-input-group { flex: 1; }
    .scan-input { width: 100%; padding: 18px; font-size: 20px; border-radius: 5px; border: 2px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; transition: border-color 0.3s; }
    .scan-input:focus { border-color: #00D100; outline: none; box-shadow: 0 0 10px rgba(0,209,0,0.3); }
    .scan-label { color: #aaa; font-size: 13px; font-weight: bold; margin-bottom: 5px; display: block; }

    .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: #00D100; margin-right: 8px; }
    .status-row { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 20px;">
      <h2 style="color:#00D100; padding: 0 20px; border:none; margin-bottom: 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn active" onclick="switchTab('esg', this)">ğŸŒ ESG æˆ°æƒ…å®¤</button>
      <button class="nav-btn" onclick="switchTab('stats', this)">ğŸ“Š ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•èˆ‡è³‡æ–™åº«ç›£æ§</button>
      <button class="nav-btn" onclick="switchTab('push', this)">ğŸ’¬ æ™ºæ…§æ¨æ’­å¼•æ“</button>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID é˜²å½åº«å­˜</button>
      <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ CRM å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» å¯©æ ¸</button>
    </div>
    <div style="margin-top: auto; padding: 20px; color: #666; font-size: 12px; font-family: monospace; border-top: 1px solid #222;">
      System Ver.<br><strong style="color: #00D100; font-size: 14px;">V3.6-å€‰å„²å‡ç´šç‰ˆ</strong>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-esg" class="panel active">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card"><h1><span id="esg-active">0</span> ç‰‡</h1><p>ç›®å‰é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š å…¨å°ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="op-card" style="border-top: 4px solid #00D100;"><h3>æ¿¾ç¶²æœƒå“¡ç¸½æ•¸</h3><h1 id="stat-total-users" style="font-size: 48px; margin: 10px 0; color: #00D100;">0</h1></div>
        <div class="op-card" style="border-top: 4px solid #FF9800;"><h3>é–‹é€šä¿ä¿®å» ç¸½æ•¸</h3><h1 id="stat-total-garages" style="font-size: 48px; margin: 10px 0; color: #FF9800;">0</h1></div>
      </div>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;"><table id="stat-users-city"><thead><tr><th>å±…ä½ç¸£å¸‚</th><th>æœƒå“¡äººæ•¸</th></tr></thead><tbody></tbody></table></div>
        <div style="flex: 1;"><table id="stat-garages-city"><thead><tr><th>æ‰€åœ¨ç¸£å¸‚</th><th>åˆä½œå®¶æ•¸</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•èˆ‡è³‡æ–™åº«ç›£æ§å° (Data Health)</h2>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <input type="text" id="monitor-search" placeholder="ğŸ” æœå°‹ç¸£å¸‚æˆ–é„‰é® (ä¾‹å¦‚: å°åŒ—ã€å¤§å®‰å€)" onkeyup="filterMonitorTable()" style="padding: 8px; width: 300px; border-radius: 5px; border: 1px solid #ccc;">
        <div>
          <span id="monitor-count" style="font-size: 13px; color: #00D100; font-weight: bold; margin-right: 15px;">å…± 0 ç­†</span>
          <button class="btn" id="btn-force-update" style="background: #333; color: #fff;" onclick="forceUpdateCache()">âš¡ å¼·åˆ¶æŠ“å– 368 é„‰é®</button>
        </div>
      </div>
      <div style="height: 550px; overflow-y: auto; border: 1px solid #eee;">
        <table id="monitor-table" style="margin-top: 0;">
          <thead>
            <tr>
              <th>ç¸£å¸‚ / é„‰é®</th>
              <th>æº«åº¦ / æ¿•åº¦</th>
              <th>AQI æŒ‡æ•¸</th>
              <th>PM2.5 (Âµg)</th>
              <th>æ¼”ç®—æ³•è€—æå€ç‡</th>
              <th style="background:#e8f5e9; color:#2e7d32;">ğŸ’¡ ç‡Ÿé‹ç­–ç•¥å»ºè­°</th>
              <th>æœ€å¾Œæ›´æ–°æ™‚é–“</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="7" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="panel-push" class="panel">
      <h2>ğŸ’¬ AI æ™ºæ…§æ¨æ’­å¼•æ“ (å‹•æ…‹æƒ…å¢ƒåº«)</h2>
      <table id="push-table"><thead><tr><th>é¡åˆ¥</th><th>æƒ…å¢ƒè¦å‰‡åç¨±</th><th>è§¸ç™¼é‚è¼¯æ¢ä»¶</th><th>è‡ªå‹•æ¨æ’­æ–‡æ¡ˆå…§å®¹</th><th>ç‹€æ…‹</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C å€‰å„²ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
      <p style="color:#666; font-size:13px;">è«‹ä½¿ç”¨æ¢ç¢¼æƒææ§ã€‚æ¸¸æ¨™æœƒè‡ªå‹•è·³è½‰ï¼Œå®Œæˆç¶å®šå¾Œæœƒç™¼å‡ºã€Œå—¶ã€è²ä¸¦è‡ªå‹•æº–å‚™ä¸‹ä¸€ç­†ã€‚</p>
      
      <div class="scan-container">
        <div class="scan-input-group">
          <label class="scan-label">ç¬¬ 1 æ­¥ï¼šæƒæå¯¦é«”æ¿¾ç¶² UID æ¢ç¢¼</label>
          <input type="text" id="scan-uid-input" class="scan-input" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleUIDScan(event)">
        </div>
        <div class="scan-input-group">
          <label class="scan-label">ç¬¬ 2 æ­¥ï¼šæƒæå‡ºè²¨å–®ä¹‹æ‰‹æ©Ÿè™Ÿç¢¼/è¨‚å–®æ¢ç¢¼</label>
          <input type="text" id="scan-order-input" class="scan-input" placeholder="ç­‰å¾…æƒææ‰‹æ©Ÿè™Ÿç¢¼..." onkeypress="handleOrderScan(event)">
        </div>
      </div>
      
      <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:#333;">ğŸ“‹ æœ¬æ¬¡æƒæå‡ºè²¨ç´€éŒ„</h3>
        <span id="scan-status-msg" style="font-weight:bold; font-size:14px;"></span>
      </div>
      
      <div style="max-height: 350px; overflow-y:auto; border: 1px solid #ddd; margin-top:10px;">
        <table>
          <thead style="position:sticky; top:0; background:#f4f6f8;">
            <tr><th>æ¿¾ç¶² UID</th><th>ç¶å®šè™Ÿç¢¼ (è¨‚å–®)</th><th>å®¢æˆ¶ç‹€æ…‹</th><th>ä½œæ¥­çµæœ</th><th>æƒææ™‚é–“</th></tr>
          </thead>
          <tbody id="dispatch-log-tbody">
            </tbody>
        </table>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID æ™ºæ…§æµæ°´è™Ÿç”Ÿæˆ</h2>
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight:bold;">é è¨ˆç”¢å‡ºçµ„æ•¸ï¼š</label>
        <input type="number" id="uid-gen-count" value="50" style="width: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ è‡ªå‹•æ¥çºŒç”¢å‡ºæ–° UID</button>
      </div>
      <table id="uid-table" style="margin-top:15px;"><thead><tr><th>UID æµæ°´è™Ÿ</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹/æ“æœ‰è€…</th><th>å®‰è£è»Šæ¬¾/åœ°é»</th><th>æ“ä½œæ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM</h2>
      <table id="crm-table"><thead><tr><th>å§“å</th><th>é›»è©±</th><th>è»Šæ¬¾/è»Šç‰Œ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>è¯çµ¡äºº/é›»è©±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );

    let fullMonitorData = []; 

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active');
      btn.classList.add('active');
      
      if (id === 'esg') loadESG(); 
      if (id === 'stats') loadStats(); 
      if (id === 'monitor') loadMonitor(); 
      if (id === 'push') loadPushRules();
      if (id === 'uid') loadUIDs(); 
      if (id === 'crm') loadCRM(); 
      if (id === 'garage') loadGarages(); 
      
      // åˆ‡æ›åˆ°æƒæç«™æ™‚ï¼Œè‡ªå‹•å°ç„¦ç¬¬ä¸€æ ¼
      if (id === 'dispatch') setTimeout(() => document.getElementById('scan-uid-input').focus(), 100);
    }

    // ==========================================
    // ğŸŒŸ å…¨å°å¿«å–æ±  (æ–°å¢æº«æ¿•åº¦èˆ‡è¡ŒéŠ·ç­–ç•¥å»ºè­°)
    // ==========================================
    async function loadMonitor() {
      const { data } = await supabaseClient.from('env_cache').select('*').limit(400).order('aqi', { ascending: false });
      if (data) {
        fullMonitorData = data;
        renderMonitorTable(fullMonitorData);
      }
    }

    function renderMonitorTable(dataToRender) {
      let html = '';
      document.getElementById('monitor-count').innerText = `å…± ${dataToRender.length} ç­†è³‡æ–™`;
      
      dataToRender.forEach(d => {
        let weight = '1.0 å€ (æ¨™æº–)'; let wColor = '#555';
        let marketing = '<span style="color:#666;">å¸¸è¦ç™¼é€ä¿é¤Šæé†’</span>';
        
        if (d.aqi > 150) { 
          weight = '1.8 å€ (åš´é‡è€—æ)'; wColor = '#d32f2f'; 
          marketing = '<span style="color:#d32f2f; font-weight:bold;">ğŸ”¥ å»ºè­°æ¨æ’­ç´«çˆ†é˜²è­·è­¦å‘Š</span>';
        } else if (d.aqi > 100) { 
          weight = '1.4 å€ (åŠ é€Ÿè€—æ)'; wColor = '#f57c00'; 
          marketing = '<span style="color:#f57c00; font-weight:bold;">âš ï¸ ä¸»æ¨æ´»æ€§ç¢³é™¤è‡­å‡ç´šç‰ˆ</span>';
        } else if (d.aqi < 30) { 
          weight = '0.8 å€ (æ¸›ç·©è€—æ)'; wColor = '#388e3c'; 
          marketing = '<span style="color:#388e3c;">ğŸƒ é©åˆæ¨å»£ç¯€èƒ½çœç¢³æ´»å‹•</span>';
        }

        let aqiColor = d.aqi > 150 ? '#d32f2f' : (d.aqi > 100 ? '#f57c00' : '#388e3c');
        
        html += `<tr>
          <td style="font-weight:bold;">${d.city} ${d.district}</td>
          <td>${d.temp}Â°C / ${d.hum}%</td>
          <td style="color:${aqiColor}; font-weight:bold; font-size:18px;">${d.aqi}</td>
          <td>${d.pm25}</td>
          <td style="color:${wColor}; font-weight:bold;">${weight}</td>
          <td style="background:#fafffa;">${marketing}</td>
          <td style="font-size:12px; color:#888;">${new Date(d.updated_at).toLocaleString()}</td>
        </tr>`;
      });
      document.getElementById('monitor-table').querySelector('tbody').innerHTML = html;
    }

    function filterMonitorTable() {
      const keyword = document.getElementById('monitor-search').value.trim().toLowerCase();
      if (!keyword) { renderMonitorTable(fullMonitorData); return; }
      const filtered = fullMonitorData.filter(d => (d.city && d.city.toLowerCase().includes(keyword)) || (d.district && d.district.toLowerCase().includes(keyword)));
      renderMonitorTable(filtered);
    }

    async function forceUpdateCache() {
      const btn = document.getElementById('btn-force-update');
      btn.innerText = 'â³ 368é„‰é®å¤§æ•¸æ“šæŠ“å–ä¸­ (ç´„éœ€30ç§’)...';
      btn.disabled = true;
      try {
        const res = await fetch('https://qznvabjtxcbffjryfgqi.supabase.co/functions/v1/webhook?action=update_cache', { method: 'POST' });
        if (res.ok) { alert('âœ… å¿«å–æ± æ›´æ–°æˆåŠŸï¼'); loadMonitor(); }
      } catch (e) { alert('å‘¼å«å¤±æ•—ï¼š' + e.message); } 
      finally { btn.innerText = 'âš¡ å¼·åˆ¶æŠ“å– 368 é„‰é®'; btn.disabled = false; }
    }

    // ==========================================
    // ğŸŒŸ UID æ™ºæ…§æµæ°´è™Ÿè‡ªå‹•ç”Ÿæˆ (HP-000001)
    // ==========================================
    async function generateSequentialUIDs() {
      const count = parseInt(document.getElementById('uid-gen-count').value) || 50;
      if(count <= 0 || count > 500) return alert("è«‹è¼¸å…¥ 1 ~ 500 ä¹‹é–“çš„æ•¸é‡");

      // å–å¾—ç›®å‰è³‡æ–™åº«æœ€å¾Œä¸€ç­†åºè™Ÿ
      const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(200);
      let maxNum = 0;
      if (data && data.length > 0) {
        const regex = /^HP-(\d+)$/;
        data.forEach(d => {
          const match = d.uid.match(regex);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
          }
        });
      }
      
      let ins = [];
      for(let i=1; i<=count; i++) {
         let nextNum = maxNum + i;
         let newUid = 'HP-' + nextNum.toString().padStart(6, '0');
         ins.push({ uid: newUid });
      }
      
      await supabaseClient.from('filters_uid').insert(ins);
      alert(`âœ… æˆåŠŸæ¥çºŒç”¢å‡º ${count} çµ„æ–°æµæ°´è™Ÿï¼(è¿„è‡³ ${ins[ins.length-1].uid})`);
      loadUIDs();
    }

    async function loadUIDs() {
      const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
      let html = ''; if (data) { data.forEach(d => { let status = d.status === 'produced' ? 'ğŸ·ï¸ ç¸½éƒ¨åº«å­˜' : d.status === 'sold' ? 'ğŸšš å·²å‡ºè²¨' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°'; html += `<tr><td style="font-family:monospace; font-size:16px;"><b>${d.uid}</b></td><td>${status}</td><td>${d.activation_type || (d.users ? d.users.name : '-')}</td><td>${d.installed_car_model || '-'}</td><td>${d.activated_at ? new Date(d.activated_at).toLocaleString() : new Date(d.created_at).toLocaleString()}</td></tr>`; }); }
      document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    // ==========================================
    // ğŸŒŸ ç„¡é–“æ–·æƒæå‡ºè²¨ç«™ (æƒææ§æµç¨‹ & æç¤ºéŸ³)
    // ==========================================
    let currentScanUid = '';
    
    // Web Audio API ç”¢ç”Ÿã€Œå—¶ã€è²
    function playSuccessBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gainNode = ctx.createGain();
      osc.connect(gainNode); gainNode.connect(ctx.destination);
      osc.type = 'sine'; osc.frequency.setValueAtTime(1000, ctx.currentTime);
      gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
      osc.start(); osc.stop(ctx.currentTime + 0.15);
    }

    function handleUIDScan(e) {
      if (e.key === 'Enter') {
        currentScanUid = e.target.value.trim();
        if (currentScanUid) {
          // æƒå®Œç¬¬ä¸€æ ¼ï¼Œè‡ªå‹•è·³è½‰ç¬¬äºŒæ ¼
          document.getElementById('scan-order-input').focus();
        }
      }
    }

    async function handleOrderScan(e) {
      if (e.key === 'Enter') {
        const orderPhone = e.target.value.trim();
        if (!orderPhone || !currentScanUid) return;
        
        document.getElementById('scan-status-msg').innerHTML = "<span style='color:#FF9800;'>ğŸ”„ é›²ç«¯æ¯”å°è™•ç†ä¸­...</span>";
        
        // 1. åˆ¤æ–·æ˜¯å¦ç‚ºæ–°èˆŠå®¢
        const { data: user } = await supabaseClient.from('users').select('line_uid, name').eq('phone', orderPhone).maybeSingle();
        let isOldCustomer = !!user;
        let customerLabel = isOldCustomer ? `<span style="color:#00D100; font-weight:bold;">ğŸŸ¢ èˆŠå®¢ (${user.name})</span>` : `<span style="color:#FF9800; font-weight:bold;">ğŸŸ  æ–°å®¢ (ç­‰å¾…è»Šä¸»æƒç¢¼è¨»å†Š)</span>`;
        
        // 2. æ›´æ–°æ¿¾ç¶²ç‹€æ…‹ (å°‡è™Ÿç¢¼å¯«å…¥ shopline_order_id ä»¥ä¾›è¿½è¹¤)
        const updatePayload = { status: 'sold', shopline_order_id: orderPhone };
        if (isOldCustomer) { updatePayload.activated_by_uid = user.line_uid; }
        
        const { error } = await supabaseClient.from('filters_uid').update(updatePayload).eq('uid', currentScanUid);
        
        // 3. ç•«é¢åé¥‹èˆ‡é‡ç½®
        if (!error) {
          playSuccessBeep(); // ç™¼å‡ºæˆåŠŸè²éŸ¿
          
          const logHtml = `<tr>
            <td style="font-family:monospace; font-size:16px;"><b>${currentScanUid}</b></td>
            <td>${orderPhone}</td>
            <td>${customerLabel}</td>
            <td style="color:#00D100; font-weight:bold;">âœ… ç¶å®šæˆåŠŸ</td>
            <td style="font-size:12px; color:#888;">${new Date().toLocaleTimeString()}</td>
          </tr>`;
          document.getElementById('dispatch-log-tbody').insertAdjacentHTML('afterbegin', logHtml);
          document.getElementById('scan-status-msg').innerHTML = `<span style="color:#00D100;">âœ”ï¸ ä¸Šä¸€ç­†å‡ºè²¨æˆåŠŸï¼š${currentScanUid}</span>`;
          
          if (isOldCustomer) {
             await supabaseClient.from('user_logs').insert([{ user_uid: user.line_uid, action: 'ğŸ“¦ ç¸½éƒ¨å‡ºè²¨', details: `å·²å‡ºè²¨æ¿¾ç¶²ï¼š${currentScanUid}` }]);
          }
        } else {
          document.getElementById('scan-status-msg').innerHTML = `<span style="color:red;">âŒ ç¶å®šå¤±æ•—ï¼š${error.message}</span>`;
        }
        
        // 4. ç„¡ç¸«é‡ç½®è¿´åœˆï¼šæ¸…ç©ºé›™æ¬„ä½ä¸¦è·³å›ç¬¬ä¸€æ ¼
        currentScanUid = '';
        document.getElementById('scan-uid-input').value = '';
        e.target.value = '';
        document.getElementById('scan-uid-input').focus();
      }
    }

    // --- å…¶é¤˜å¸¸è¦è¼‰å…¥å‡½æ•¸ ---
    async function loadESG() {
      const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status', 'activated');
      if (data) {
        let totalDays = 0; data.forEach(d => { if (d.activated_at) { totalDays += Math.floor((new Date() - new Date(d.activated_at)) / (1000 * 60 * 60 * 24)); } });
        document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString(); document.getElementById('esg-co2').innerText = (totalDays * 0.15).toFixed(1); document.getElementById('esg-active').innerText = data.length;
      }
    }

    async function loadStats() {
      const { data: users } = await supabaseClient.from('users').select('city').eq('role', 'customer');
      if (users) {
        document.getElementById('stat-total-users').innerText = users.length;
        const cityCounts = {}; users.forEach(u => { const c = u.city || 'æœªå¡«å¯«'; cityCounts[c] = (cityCounts[c] || 0) + 1; });
        let userHtml = ''; Object.entries(cityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { userHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#00D100;">${count} äºº</td></tr>`; });
        document.getElementById('stat-users-city').querySelector('tbody').innerHTML = userHtml;
      }
      const { data: garages } = await supabaseClient.from('garages').select('city').eq('status', 'active');
      if (garages) {
        document.getElementById('stat-total-garages').innerText = garages.length;
        const gCityCounts = {}; garages.forEach(g => { const c = g.city || 'æœªå¡«å¯«'; gCityCounts[c] = (gCityCounts[c] || 0) + 1; });
        let garageHtml = ''; Object.entries(gCityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { garageHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#FF9800;">${count} å®¶</td></tr>`; });
        document.getElementById('stat-garages-city').querySelector('tbody').innerHTML = garageHtml;
      }
    }

    async function loadPushRules() {
      const { data } = await supabaseClient.from('notification_rules').select('*').order('id', { ascending: true });
      let html = '';
      if (data) {
        data.forEach(r => {
          let statusHtml = r.is_active ? '<span style="color:green; font-weight:bold;">ğŸŸ¢ å•Ÿç”¨</span>' : '<span style="color:red;">ğŸ”´ åœç”¨</span>';
          html += `<tr><td><span style="background:#e3f2fd; color:#1976d2; padding:4px; border-radius:4px; font-size:12px;">${r.category}</span></td><td style="font-weight:bold;">${r.rule_name}</td><td style="color:#888; font-family:monospace;">${r.trigger_condition}</td><td>${r.message_template}</td><td>${statusHtml}</td></tr>`;
        });
      }
      document.getElementById('push-table').querySelector('tbody').innerHTML = html;
    }

    async function loadCRM() {
      const { data } = await supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
      let html = ''; if (data) { data.forEach(u => { html += `<tr><td>${u.name}</td><td>${u.phone}</td><td>${u.car_brand} ${u.car_model}</td><td>æ­£å¸¸</td><td>-</td></tr>`; }); }
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').order('created_at', { ascending: false });
      let html = ''; if (data) { data.forEach(g => { html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${g.contact_name}</td><td>${g.status==='pending' ? 'å¾…å¯©æ ¸' : 'ç‡Ÿæ¥­ä¸­'}</td><td>-</td></tr>`; }); }
      document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
    }

    loadESG();
  </script>
</body>
</html>
