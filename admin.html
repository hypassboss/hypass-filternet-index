<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HYPASS V7.0 ç¸½éƒ¨æˆ°æƒ…å®¤ (çµ‚æ¥µéŒ„å½±èˆ‡ä¸Šå¸æ¨¡å¼)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; }
    .btn { background: #00D100; color: #000; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    .btn-warn { background: #ff9800; color: #fff; }
    
    /* æƒæèˆ‡éŒ„å½±å€å¡Š */
    .dispatch-container { background: #1e1e1e; padding: 25px; border-radius: 12px; color: white; margin-top:20px; }
    .scan-input { width: 100%; padding: 15px; font-size: 20px; border-radius: 5px; background: #000; color: #00D100; text-align: center; border:1px solid #555; margin-bottom:15px; box-sizing:border-box;}
    #scanner-box { width: 100%; max-width: 400px; margin: 0 auto 20px auto; overflow: hidden; border-radius: 10px; display:none; }
    #video-box { width: 100%; max-width: 400px; background: #000; border-radius: 8px; border: 2px solid #555; display:none; margin: 0 auto 20px auto;}
    .recording-dot { color: red; font-weight: bold; animation: blink 1s infinite; display:none; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div style="padding-top: 20px;"><h2 style="color:#00D100; padding: 0 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn active" onclick="switchTab('dispatch', this)">ğŸ“¦ å‡ºè²¨éŒ„å½±ç«™</button>
      <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel active">
      <h2>ğŸ“¦ B2C è‡ªå‹•æƒæèˆ‡å‡ºè²¨éŒ„å½±</h2>
      <div class="dispatch-container">
        
        <div id="scanner-box"></div>
        <video id="video-box" autoplay muted playsinline></video>

        <h3 id="flow-status" style="text-align:center; color:#00D100; margin-bottom:20px;">ç¬¬ä¸€æ­¥ï¼šè«‹æƒæ Shopline è¨‚å–®æ¢ç¢¼</h3>
        
        <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:1;"><label>è¨‚å–®è™Ÿç¢¼</label><input type="text" id="inp-order" class="scan-input" readonly placeholder="ç­‰å¾…æƒæ..."></div>
            <div style="flex:1;"><label>æ¿¾ç¶² UID</label><input type="text" id="inp-uid" class="scan-input" readonly placeholder="ç­‰å¾…æƒæ..."></div>
        </div>

        <div style="text-align:center;">
            <button id="btn-scan" class="btn" style="background:#1976d2; color:white; font-size:18px;" onclick="startScanFlow()">1. å•Ÿå‹•é¡é ­æƒææ¢ç¢¼</button>
            <button id="btn-record" class="btn-warn" style="font-size:18px; display:none;" onclick="startRecording()">ğŸ¥ 2. é–‹å§‹åŒ…è£éŒ„å½± <span class="recording-dot" id="rec-dot">âº éŒ„å½±ä¸­</span></button>
            <button id="btn-stop" class="btn-danger" style="font-size:18px; display:none;" onclick="stopAndSave()">ğŸ“¦ 3. çµæŸéŒ„å½±ä¸¦ä¸‹è¼‰å­˜æª”</button>
        </div>
        <p style="text-align:center; color:#888; font-size:12px; margin-top:15px;">ç³»çµ±é™åˆ¶æé†’ï¼šéŒ„å½±æª”å°‡ä»¥ã€Œè¨‚å–®_UID.webmã€å‘½åï¼Œé»æ“ŠçµæŸå¾Œæœƒè§¸ç™¼ç€è¦½å™¨ä¸‹è¼‰è‡³æ‰‹æ©Ÿæˆ–é›»è…¦ä¸­ï¼Œè«‹è‡ªè¡Œåˆ†é¡ä¿ç®¡ã€‚</p>
      </div>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ï¼šå¼·åˆ¶é€£é–æ‹”é™¤)</h2>
      <table id="crm-table"><thead><tr><th>å®¢æˆ¶è³‡è¨Š</th><th>è»Šè¼›</th><th>çµ±è¨ˆ</th><th>ä¸Šå¸æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ (ä¸Šå¸æ¨¡å¼ï¼šç„¡æ¢ä»¶éŠ·æ¯€)</h2>
      <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ ç”¢ç”Ÿ 50 çµ„æ–° UID</button>
      <table id="uid-table"><thead><tr><th>UID</th><th>ç‹€æ…‹</th><th>æ“æœ‰è€…</th><th>ä¸Šå¸æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); btn.classList.add('active');
      if (id === 'crm') loadCRM(); if (id === 'uid') loadUIDs();
    }

    // ==============================================
    // ğŸŒŸ 1. å‡ºè²¨æµç¨‹ (æƒè¨‚å–® -> æƒUID -> éŒ„å½± -> ä¸‹è¼‰)
    // ==============================================
    let html5QrcodeScanner = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let currentOrder = "";
    let currentUID = "";
    let videoStream = null;

    function startScanFlow() {
        currentOrder = ""; currentUID = "";
        document.getElementById('inp-order').value = ""; document.getElementById('inp-uid').value = "";
        document.getElementById('btn-scan').style.display = 'none';
        document.getElementById('scanner-box').style.display = 'block';
        document.getElementById('flow-status').innerText = "è«‹å°‡é¡é ­å°æº– Shopline è¨‚å–®æ¢ç¢¼";
        
        html5QrcodeScanner = new Html5Qrcode("scanner-box");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 100 } }, 
        (text) => {
            if (!currentOrder) {
                // å‡è¨­è¨‚å–®ä¸æ˜¯ HP- é–‹é ­
                if(!text.startsWith('HP-')) {
                    currentOrder = text;
                    document.getElementById('inp-order').value = currentOrder;
                    document.getElementById('flow-status').innerText = "âœ… è¨‚å–®æƒææˆåŠŸï¼è«‹æ¥è‘—æƒææ¿¾ç¶² UID (HP-é–‹é ­)";
                }
            } else if (!currentUID) {
                if(text.startsWith('HP-')) {
                    currentUID = text;
                    document.getElementById('inp-uid').value = currentUID;
                    html5QrcodeScanner.stop().then(() => {
                        document.getElementById('scanner-box').style.display = 'none';
                        document.getElementById('flow-status').innerText = "âœ… æƒæå®Œæˆï¼è«‹é»æ“Šã€é–‹å§‹åŒ…è£éŒ„å½±ã€";
                        document.getElementById('btn-record').style.display = 'inline-block';
                    });
                }
            }
        }, (err) => {});
    }

    async function startRecording() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            const videoElement = document.getElementById('video-box');
            videoElement.style.display = 'block';
            videoElement.srcObject = videoStream;
            
            mediaRecorder = new MediaRecorder(videoStream);
            mediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.start();
            
            document.getElementById('btn-record').style.display = 'none';
            document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('rec-dot').style.display = 'inline';
            document.getElementById('flow-status').innerText = "ğŸ¥ éŒ„å½±ä¸­ï¼Œè«‹é€²è¡ŒåŒ…è£...";
        } catch (err) { alert("ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™éŒ„å½±ï¼š" + err.message); }
    }

    async function stopAndSave() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            mediaRecorder.onstop = async function() {
                // 1. è§¸ç™¼å½±ç‰‡ä¸‹è¼‰
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = `${currentOrder}_${currentUID}.webm`; // æª”åï¼šè¨‚å–®è™Ÿç¢¼_UID
                a.click();
                recordedChunks = [];
                
                // é—œé–‰ç›¸æ©Ÿ
                videoStream.getTracks().forEach(track => track.stop());
                document.getElementById('video-box').style.display = 'none';
                document.getElementById('rec-dot').style.display = 'none';

                // 2. å¯«å…¥è³‡æ–™åº«
                document.getElementById('flow-status').innerText = "ğŸ”„ å¯«å…¥è³‡æ–™åº«ä¸­...";
                const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', currentOrder).maybeSingle(); // å‡è¨­è¨‚å–®æ¢ç¢¼æ˜¯æ‰‹æ©Ÿè™Ÿï¼Œæˆ–éœ€æ›¿æ›é‚è¼¯
                const payload = { status: 'sold', shopline_order_id: currentOrder };
                if(user) payload.activated_by_uid = user.line_uid;
                await supabaseClient.from('filters_uid').update(payload).eq('uid', currentUID);

                alert("âœ… å‡ºè²¨èˆ‡éŒ„å½±å­˜æª”å®Œæˆï¼");
                
                // é‡ç½® UI
                document.getElementById('btn-stop').style.display = 'none';
                document.getElementById('btn-scan').style.display = 'inline-block';
                document.getElementById('flow-status').innerText = "ç¬¬ä¸€æ­¥ï¼šè«‹æƒæ Shopline è¨‚å–®æ¢ç¢¼";
                document.getElementById('inp-order').value = ""; document.getElementById('inp-uid').value = "";
            };
        }
    }


    // ==============================================
    // ğŸŒŸ 2. CRM ä¸Šå¸æ¨¡å¼ (è§£æ±ºåˆªé™¤å¤±æ•—ï¼Œå¼·åˆ¶é€£é–æ‹”é™¤)
    // ==============================================
    async function loadCRM() {
      document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="4">è®€å–ä¸­...</td></tr>';
      const [resUsers, resFilters] = await Promise.all([
          supabaseClient.from('users').select('*').eq('role', 'customer'),
          supabaseClient.from('filters_uid').select('activated_by_uid')
      ]);
      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });

      let html = '';
      resUsers.data?.forEach(u => {
          html += `<tr>
            <td><b>${u.name}</b><br>${u.phone}</td>
            <td>${u.car_brand} (${u.license_plate})</td>
            <td>æ¿¾ç¶²: ${pCounts[u.line_uid]||0}</td>
            <td><button class="btn btn-danger" onclick="godModeDelete('${u.line_uid}', '${u.name}')">ğŸ—‘ï¸ éŠ·æ¯€</button></td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDelete(uid, name) {
        const pwd = prompt(`ã€æœ€é«˜æ¬Šé™ã€‘æ‚¨å°‡å¾¹åº•æ‘§æ¯€ ${name} çš„è³‡æ–™ã€‚\nè«‹è¼¸å…¥å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");
        
        if (confirm(`ç¢ºå®šè¦æ‘§æ¯€ ${name} å—ï¼Ÿæ­¤å‹•ä½œå°‡æ‹”é™¤ä»–æ‰€æœ‰çš„æ­·å²ç´€éŒ„ï¼`)) {
            try {
                // ğŸš¨ çµ‚æ¥µé€£é–æ‹”é™¤è¡“
                await supabaseClient.from('rewards').delete().eq('user_uid', uid);
                await supabaseClient.from('bookings').delete().eq('user_uid', uid);
                await supabaseClient.from('user_logs').delete().eq('user_uid', uid);
                // æœ‰äº›èˆŠç‰ˆå¯èƒ½å« appointmentsï¼Œç‚ºäº†é˜²å‘†ä¹Ÿåˆªä¸€ä¸‹
                try { await supabaseClient.from('appointments').delete().eq('user_uid', uid); } catch(e){}
                
                await supabaseClient.from('filters_uid').update({ activated_by_uid: null }).eq('activated_by_uid', uid);
                
                const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
                if (error) throw error; 
                alert("âœ… éŠ·æ¯€æˆåŠŸï¼"); loadCRM();
            } catch (err) { alert("æ‘§æ¯€å¤±æ•—ï¼Œè«‹æª¢æŸ¥è³‡æ–™åº«ç´„æŸï¼š" + err.message); }
        }
    }

    // ==============================================
    // ğŸŒŸ 3. UID ä¸Šå¸æ¨¡å¼ (å¼·åˆ¶éŠ·æ¯€èˆ‡ä¿®æ”¹)
    // ==============================================
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
        let html = '';
        if(data) data.forEach(d => { 
            html += `<tr><td><b>${d.uid}</b></td><td>${d.status}</td><td>${d.users?.name||'-'}</td>
            <td>
              <button class="btn btn-warn" style="padding:4px;" onclick="godModeEditUID('${d.uid}')">âœï¸ ä¿®æ”¹</button>
              <button class="btn btn-danger" style="padding:4px;" onclick="godModeDeleteUID('${d.uid}')">ğŸ—‘ï¸ å¼·åˆ¶åˆªé™¤</button>
            </td></tr>`; 
        });
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDeleteUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥å¼·åˆ¶åˆªé™¤ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        await supabaseClient.from('filters_uid').delete().eq('uid', uid);
        alert("âœ… å¼·åˆ¶åˆªé™¤æˆåŠŸï¼"); loadUIDs();
    }
    
    async function godModeEditUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥ä¿®æ”¹ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        const newStatus = prompt("è«‹è¼¸å…¥æ–°ç‹€æ…‹ (produced / sold / activated / replaced)ï¼š");
        if(newStatus) {
            await supabaseClient.from('filters_uid').update({status: newStatus}).eq('uid', uid);
            alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); loadUIDs();
        }
    }

    async function generateSequentialUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); alert("âœ… ç”¢ç”ŸæˆåŠŸï¼"); loadUIDs();
    }

    loadCRM(); 
  </script>
</body>
</html>
