<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V6.0 ç¸½éƒ¨æˆ°æƒ…å®¤ (ä¸Šå¸éŒ„å½±ç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; }
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    .btn-warn { background: #ff9800; color: #fff; }
    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; margin-top:20px;}
    .scan-input { width: 100%; padding: 18px; font-size: 22px; border-radius: 5px; background: #000; color: #00D100; text-align: center;}
    
    /* ğŸŒŸ éŒ„å½±æ©Ÿ UI */
    .video-container { background: #222; padding: 15px; border-radius: 8px; color: white; display: flex; align-items: center; gap: 20px; margin-top: 20px;}
    #live-video { width: 320px; height: 180px; background: #000; border-radius: 8px; border: 2px solid #555; }
    .recording-dot { display: none; color: red; font-weight: bold; animation: blink 1s infinite; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <div style="padding-top: 20px;"><h2 style="color:#00D100; padding: 0 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn active" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel active">
      <h2>ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨ç«™ (å«éŒ„å½±é˜²å½)</h2>
      
      <div class="video-container">
        <video id="live-video" autoplay muted></video>
        <div>
            <h3 style="margin:0 0 10px 0;">ğŸ¥ è£ç®±éŒ„å½±æ©Ÿ <span class="recording-dot" id="rec-dot">âº éŒ„å½±ä¸­</span></h3>
            <button class="btn" style="background:#1976d2; color:white;" onclick="startRecording()">1. é–‹å•Ÿé¡é ­ä¸¦é–‹å§‹éŒ„å½±</button>
            <button class="btn btn-danger" onclick="stopRecording()">2. åœæ­¢ä¸¦ä¸‹è¼‰å­˜æª”</button>
            <p style="font-size:12px; color:#aaa; margin-top:10px;">æ“ä½œèªªæ˜ï¼šåŒ…è²¨å‰é»æ“Šé–‹å§‹ï¼ŒåŒ…è£å°ç®±å¾Œé»æ“Šåœæ­¢ä¸¦ä¸‹è¼‰å½±ç‰‡ä½œç‚ºå­˜è­‰ã€‚</p>
        </div>
      </div>

      <div class="scan-container">
        <div style="flex:1;"><label style="color:#aaa;">1. æƒæ UID</label><input type="text" id="scan-uid-input" class="scan-input" onkeypress="handleScan(event, 'uid')"></div>
        <div style="flex:1;"><label style="color:#aaa;">2. æƒæ Shopline è¨‚å–®</label><input type="text" id="scan-order-input" class="scan-input" disabled onkeypress="handleScan(event, 'order')"></div>
      </div>
      <h3 id="scan-status-msg" style="color:#333; margin-top:15px;">ç­‰å¾…æƒæ...</h3>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM</h2>
      <table id="crm-table"><thead><tr><th>å®¢æˆ¶è³‡è¨Š</th><th>è»Šè¼›</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ (ä¸Šå¸æ¨¡å¼)</h2>
      <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ ç”¢ç”Ÿ 50 çµ„æ–° UID</button>
      <table id="uid-table"><thead><tr><th>UID</th><th>ç‹€æ…‹</th><th>æ“æœ‰è€…</th><th>ä¸Šå¸æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); btn.classList.add('active');
      if (id === 'crm') loadCRM(); if (id === 'uid') loadUIDs();
    }

    // ==============================================
    // ğŸŒŸ 3. å‡ºè²¨éŒ„å½±åŠŸèƒ½ (Web API)
    // ==============================================
    let mediaRecorder; let recordedChunks = [];
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            document.getElementById('live-video').srcObject = stream;
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = function() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                // æª”ååŠ ä¸Šæ™‚é–“æˆ³è¨˜é˜²æ’å
                a.download = `å‡ºè²¨éŒ„å½±_${new Date().getTime()}.webm`; 
                a.click();
                recordedChunks = [];
            };
            mediaRecorder.start();
            document.getElementById('rec-dot').style.display = 'inline';
        } catch (err) { alert("ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™ï¼š" + err.message); }
    }
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('rec-dot').style.display = 'none';
            document.getElementById('live-video').srcObject.getTracks().forEach(track => track.stop()); // é—œé–‰ç›¸æ©Ÿç‡ˆè™Ÿ
        }
    }

    // ==============================================
    // ğŸŒŸ 2. CRM ä¸Šå¸æ¨¡å¼ (è§£æ±ºåˆªé™¤å¤±æ•—)
    // ==============================================
    async function loadCRM() {
      const { data } = await supabaseClient.from('users').select('*').eq('role', 'customer');
      let html = '';
      data.forEach(u => {
          html += `<tr>
            <td><b>${u.name}</b><br>${u.phone}</td>
            <td>${u.car_brand} (${u.license_plate})</td>
            <td><button class="btn btn-danger" onclick="godModeDelete('${u.line_uid}', '${u.name}')">ğŸ—‘ï¸ éŠ·æ¯€</button></td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDelete(uid, name) {
        const pwd = prompt(`ã€æœ€é«˜æ¬Šé™ã€‘æ‚¨å°‡å¾¹åº•æ‘§æ¯€ ${name} çš„è³‡æ–™ã€‚\nè«‹è¼¸å…¥å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        
        if (confirm(`ç¢ºå®šè¦æ‘§æ¯€ ${name} å—ï¼Ÿ`)) {
            // ğŸš¨ çµ‚æ¥µé€£é–æ‹”é™¤è¡“ï¼šæ¸…ç©ºæ‰€æœ‰é—œè¯è³‡æ–™è¡¨
            await supabaseClient.from('rewards').delete().eq('user_uid', uid);
            await supabaseClient.from('bookings').delete().eq('user_uid', uid);
            await supabaseClient.from('user_logs').delete().eq('user_uid', uid);
            await supabaseClient.from('filters_uid').update({ activated_by_uid: null }).eq('activated_by_uid', uid);
            
            // æ‹”é™¤å®Œç•¢ï¼Œæ­£å¼åˆªé™¤ User
            const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
            if (error) alert("æ‘§æ¯€å¤±æ•—ï¼š" + error.message); else { alert("âœ… éŠ·æ¯€æˆåŠŸï¼"); loadCRM(); }
        }
    }

    // ==============================================
    // ğŸŒŸ 4. UID ä¸Šå¸æ¨¡å¼ (å¼·åˆ¶éŠ·æ¯€èˆ‡ä¿®æ”¹)
    // ==============================================
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
        let html = '';
        data.forEach(d => { 
            html += `<tr><td><b>${d.uid}</b></td><td>${d.status}</td><td>${d.users?.name||'-'}</td>
            <td>
              <button class="btn btn-warn" style="padding:4px;" onclick="godModeEditUID('${d.uid}')">âœï¸ ä¿®æ”¹</button>
              <button class="btn btn-danger" style="padding:4px;" onclick="godModeDeleteUID('${d.uid}')">ğŸ—‘ï¸ å¼·åˆ¶åˆªé™¤</button>
            </td></tr>`; 
        });
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDeleteUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥å¼·åˆ¶åˆªé™¤ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        await supabaseClient.from('filters_uid').delete().eq('uid', uid);
        alert("å¼·åˆ¶åˆªé™¤æˆåŠŸï¼"); loadUIDs();
    }
    
    async function godModeEditUID(uid) {
        const pwd = prompt(`è¼¸å…¥å¯†ç¢¼ä»¥ä¿®æ”¹ UID [${uid}]ï¼š`);
        if(pwd !== "hypass888") return;
        const newStatus = prompt("è«‹è¼¸å…¥æ–°ç‹€æ…‹ (produced / sold / activated / replaced)ï¼š");
        if(newStatus) {
            await supabaseClient.from('filters_uid').update({status: newStatus}).eq('uid', uid);
            alert("ä¿®æ”¹æˆåŠŸï¼"); loadUIDs();
        }
    }

    async function generateSequentialUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); alert("âœ… ç”¢ç”ŸæˆåŠŸï¼"); loadUIDs();
    }

    // ==============================================
    // å‡ºè²¨æƒæé‚è¼¯
    // ==============================================
    let curUid = '';
    function handleScan(e, type) {
        if (e.key === 'Enter') {
            const text = e.target.value.trim();
            if (type === 'uid' && text.startsWith('HP-')) {
                curUid = text; document.getElementById('scan-status-msg').innerText = "âœ… UID OKï¼Œè«‹æƒæè¨‚å–®";
                document.getElementById('scan-uid-input').disabled = true; document.getElementById('scan-order-input').disabled = false; document.getElementById('scan-order-input').focus();
            } else if (type === 'order' && text.length > 5) {
                processOrder(curUid, text);
            }
        }
    }
    async function processOrder(uid, order) {
        document.getElementById('scan-status-msg').innerText = "ğŸ”„ å¯«å…¥ä¸­...";
        const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', order).maybeSingle();
        const payload = { status: 'sold', shopline_order_id: order };
        if(user) payload.activated_by_uid = user.line_uid;
        await supabaseClient.from('filters_uid').update(payload).eq('uid', uid);
        document.getElementById('scan-status-msg').innerHTML = `<span style="color:green;">âœ… ${uid} å‡ºè²¨æˆåŠŸï¼</span>`;
        document.getElementById('scan-uid-input').value = ''; document.getElementById('scan-order-input').value = '';
        document.getElementById('scan-uid-input').disabled = false; document.getElementById('scan-order-input').disabled = true; document.getElementById('scan-uid-input').focus();
    }

    loadCRM(); loadUIDs();
  </script>
</body>
</html>
