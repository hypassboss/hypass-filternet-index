<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V5.12 ç¸½éƒ¨æˆ°æƒ…å®¤ (ä¸Šå¸æ¨¡å¼çµ‚æ¥µç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; overflow: hidden;}
    
    /* å´é‚Šæ¬„è¨­è¨ˆ */
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; box-shadow: 2px 0 15px rgba(0,0,0,0.1); z-index: 10;}
    .nav-btn { display: block; width: 100%; padding: 16px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 15px; border-left: 4px solid transparent; transition: all 0.2s;}
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00e676; border-left-color: #00e676; background: #1a1e1a; font-weight: bold; }
    
    /* ä¸»å…§å®¹å€ */
    .main-content { flex: 1; padding: 30px; overflow-y: auto; background: #f8fafc; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* è¡¨æ ¼è¨­è¨ˆ */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 0 0 1px #eaedf1; }
    th, td { border-bottom: 1px solid #eaedf1; padding: 14px 16px; text-align: left; vertical-align: middle;}
    th { background: #f1f5f9; color: #475569; font-weight: 600; position: sticky; top: 0;}
    tr:hover { background-color: #f8fafc; }
    
    /* æŒ‰éˆ•è¨­è¨ˆ */
    .btn { background: #00e676; color: #000; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px;}
    .btn:hover { filter: brightness(0.95); transform: translateY(-1px); }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-edit { background: #3b82f6; color: #fff; }
    
    /* ä¸Šå¸æ¨¡å¼ç·¨è¼¯è¦–çª— Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #fff; padding: 30px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    .modal-box h3 { margin-top: 0; color: #0f172a; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-size: 12px; color: #64748b; font-weight: 600; margin-bottom: 5px; }
    .form-group input, .form-group select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; }
    .form-group input:focus, .form-group select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    
    /* å‡ºè²¨æƒæå€ */
    .scan-container { display: flex; gap: 20px; background: #1e293b; padding: 20px; border-radius: 12px; border-left: 5px solid #00e676; align-items: flex-start; margin-top: 15px;}
    .scan-input { width: 100%; padding: 18px; font-size: 20px; border-radius: 8px; background: #0f172a; border: 1px solid #334155; color: #00e676; font-family: monospace; text-align: center; outline: none;}
    #reader-container { width: 100%; margin-top: 15px; display: none; background: #f8fafc; padding: 15px; border-radius: 12px; text-align: center; border: 1px dashed #cbd5e1; box-sizing: border-box;}
    
    /* ESG æ•¸æ“šå¡ç‰‡ */
    .stat-card { background: #0f172a; color: #00e676; padding: 30px 20px; border-radius: 12px; text-align: center; flex: 1; border: 1px solid #1e293b; box-shadow: 0 10px 25px rgba(0,0,0,0.1);}
    .stat-card h1 { font-size: 42px; margin: 10px 0; }
    .stat-card p { color: #94a3b8; font-size: 14px; margin: 0; }

    /* æ¼”ç®—æ³•åƒæ•¸æ§åˆ¶å€ */
    .param-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 20px;}
    .param-group { display: flex; flex-direction: column; }
    .param-group label { font-size: 12px; color: #64748b; font-weight: bold; margin-bottom: 5px; }
    .param-group input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; }
    .param-group input:focus { border-color: #00e676; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 20px;">
      <h2 style="color:#00e676; padding: 0 20px; font-size: 22px; letter-spacing: 1px;">HYPASS<br><span style="color:#fff; font-size: 14px;">ç¸½éƒ¨æˆ°æƒ…å®¤</span></h2>
      <button class="nav-btn active" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç† (CRM)</button>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ ç¶ èƒ½æ¸›ç¢³ç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•èˆ‡ç’°å¢ƒ</button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘å¯©æ ¸</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ åˆä½œä¿ä¿®å» </button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-crm" class="panel active">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ç‰ˆ)</h2>
      <p style="color:#64748b; font-size:14px; margin-top:-10px;">ç¸½è¦½æ‰€æœ‰è¨»å†Šè»Šä¸»ï¼Œå…·å‚™æœ€é«˜æ¬Šé™ä¿®æ”¹èˆ‡é€£é–åˆªé™¤åŠŸèƒ½ã€‚</p>
      <table id="crm-table">
        <thead>
          <tr>
            <th>å®¢æˆ¶è³‡è¨Š</th>
            <th>è»Šè¼›èˆ‡è»Šç‰Œ</th>
            <th>å±…ä½åœ°å€</th>
            <th>ä½¿ç”¨çµ±è¨ˆ</th>
            <th style="text-align:center;">ä¸Šå¸æ¨¡å¼æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
      <p style="color:#64748b; font-size:14px; margin-top:-10px;">æ”¯æ´æ¢ç¢¼æ§æˆ–å¤–æ¥é¡é ­ï¼Œé€£çºŒæƒæç¶å®šå‡ºè²¨ã€‚</p>
      <button class="btn" style="background:#3b82f6; color:#fff; font-size:15px; padding:12px 20px;" onclick="startContinuousScanner()">ğŸš€ å•Ÿå‹•ç„¡é–“æ–·ç›¸æ©Ÿæƒæ</button>
      
      <div id="reader-container">
          <div id="reader" style="width:100%; max-width:400px; margin:0 auto; border-radius: 8px; overflow: hidden;"></div>
          <button class="btn btn-danger" style="margin-top:15px;" onclick="stopCamera()">é—œé–‰ç›¸æ©Ÿ</button>
      </div>

      <div class="scan-container">
        <div style="flex:1;">
          <label style="color:#94a3b8; font-size:13px; font-weight:bold;">1. æƒææ¿¾ç¶² UID æ¢ç¢¼</label>
          <input type="text" id="scan-uid-input" class="scan-input" placeholder="ç­‰å¾…æƒæ HP-..." onkeypress="handleScan(event, 'uid')">
        </div>
        <div style="flex:1;">
          <label style="color:#94a3b8; font-size:13px; font-weight:bold;">2. æƒæ Shopline è¨‚å–® / æ‰‹æ©Ÿè™Ÿç¢¼</label>
          <input type="text" id="scan-order-input" class="scan-input" placeholder="ç­‰å¾…æƒæ..." disabled onkeypress="handleScan(event, 'order')">
        </div>
      </div>
      <h3 id="scan-status-msg" style="color:#0f172a; margin-top:20px; font-weight:bold; background:#f1f5f9; padding:15px; border-radius:8px;">ğŸŸ¢ ç³»çµ±å¾…å‘½ï¼Œç­‰å¾…æƒæ UID...</h3>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ç®¡ç† (å«ä¸Šå¸æ¨¡å¼)</h2>
      <button class="btn" style="padding:12px 20px;" onclick="generateSequentialUIDs()">âš™ï¸ ä¸€éµç”¢ç”Ÿ 50 çµ„å…¨æ–° UID</button>
      <table id="uid-table">
        <thead>
          <tr>
            <th>ä¸€ç¶­æ¢ç¢¼ (UID)</th>
            <th>ç›®å‰ç‹€æ…‹</th>
            <th>æ‰€å±¬è»Šä¸»</th>
            <th>å•Ÿç”¨æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ ç¶ èƒ½æ¸›ç¢³ç¸½è¦½ (å…¨ç¶²ç´¯è¨ˆ)</h2>
      <p style="color:#64748b; font-size:14px; margin-top:-10px;">ç³»çµ±æ ¹æ“šæ‰€æœ‰æœå½¹ä¸­æ¿¾ç¶²çš„å•Ÿç”¨å¤©æ•¸è‡ªå‹•ç´¯åŠ è¨ˆç®—ã€‚</p>
      <div style="display:flex; gap:20px; margin-top:20px;">
        <div class="stat-card">
          <div style="font-size:36px;">ğŸ›¡ï¸</div>
          <h1><span id="esg-pm25">0</span> <span style="font-size:16px;">Âµg</span></h1>
          <p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p>
        </div>
        <div class="stat-card">
          <div style="font-size:36px;">ğŸŒ±</div>
          <h1><span id="esg-co2">0</span> <span style="font-size:16px;">kg</span></h1>
          <p>å…¨ç¶²ç´¯è¨ˆæ¸›å°‘ç¢³è¶³è·¡</p>
        </div>
        <div class="stat-card">
          <div style="font-size:36px;">âš¡</div>
          <h1><span id="esg-kwh">0</span> <span style="font-size:16px;">kWh</span></h1>
          <p>å…¨ç¶²ç´¯è¨ˆç¯€çœå†·æ°£é›»è€—</p>
        </div>
      </div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸å®Œæ•´å¾®èª¿æ§åˆ¶å°</h2>
      <p style="color:#64748b; font-size:14px; margin-top:-10px;">é€™è£¡ä¿®æ”¹çš„æ•¸å€¼æœƒç›´æ¥å½±éŸ¿å…¨ç¶²è»Šä¸»å‰å°çš„å„€è¡¨æ¿è¨ˆç®—çµæœã€‚</p>
      
      <div class="param-grid">
        <div class="param-group"><label>æ¯æ—¥åŸºç¤è€—æç‡ (%)</label><input type="text" id="p-wear" value="0.27"></div>
        <div class="param-group"><label>æ¯æ—¥ PM2.5 æ””æˆªåŸºæº– (Âµg)</label><input type="text" id="p-pm25" value="1250"></div>
        <div class="param-group"><label>AQI æ©˜å®³åŠ æ¬Šä¿‚æ•¸</label><input type="text" id="p-orange" value="1.4"></div>
        
        <div class="param-group"><label>AQI ç´«çˆ†åŠ æ¬Šä¿‚æ•¸</label><input type="text" id="p-red" value="1.8"></div>
        <div class="param-group"><label>HYPASS é¢¨é˜» (mmH2O)</label><input type="text" id="p-hypass" value="4"></div>
        <div class="param-group"><label>ä»–ç‰Œå¹³å‡é¢¨é˜» (mmH2O)</label><input type="text" id="p-other" value="8"></div>
        
        <div class="param-group"><label>æ¯æ—¥ç¯€çœé›»è€— (kWh)</label><input type="text" id="p-kwh" value="0.25"></div>
        <div class="param-group"><label>ç¢³æ’æ›ç®—ä¿‚æ•¸ (kg/kWh)</label><input type="text" id="p-co2" value="0.5"></div>
      </div>
      <button class="btn" style="padding:12px 25px; font-size:15px; width:100%;" onclick="saveParams()">ğŸ’¾ å„²å­˜æ‰€æœ‰åƒæ•¸ä¸¦ç™¼å¸ƒè‡³å…¨ç¶²å‰å°</button>

      <h3 style="margin-top:40px; border-bottom:2px solid #e2e8f0; padding-bottom:10px;">ğŸ‡¹ğŸ‡¼ å…¨å° 368 é„‰é®ç’°å¢ƒå¿«å–æ±  (Top 50 æ±¡æŸ“å€)</h3>
      <table id="env-table">
        <thead>
          <tr>
            <th>ç¸£å¸‚é„‰é®</th>
            <th>å³æ™‚ AQI</th>
            <th style="color:#d97706;">7 æ—¥å‡å€¼ (æ¼”ç®—æ³•æ¡ç”¨)</th>
            <th>æœ€å¾Œæ›´æ–°æ™‚é–“</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table">
        <thead>
          <tr>
            <th>ç”³è«‹è»Šä¸»</th>
            <th>ç”³è«‹é …ç›®</th>
            <th>ç”³è«‹æ™‚é–“</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ åˆä½œä¿ä¿®å» æ¸…å–®</h2>
      <table id="garage-table">
        <thead>
          <tr>
            <th>åº—å</th>
            <th>åœ°å€</th>
            <th>è¯çµ¡äºº / é›»è©±</th>
            <th>ç‹€æ…‹</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <div class="modal-overlay" id="god-mode-modal">
    <div class="modal-box">
      <h3>ğŸ› ï¸ ä¸Šå¸æ¨¡å¼ï¼šç·¨è¼¯å®¢æˆ¶è³‡æ–™</h3>
      <input type="hidden" id="god-uid">
      
      <div class="form-grid">
        <div class="form-group"><label>è»Šä¸»å§“å</label><input type="text" id="god-name"></div>
        <div class="form-group"><label>æ‰‹æ©Ÿè™Ÿç¢¼</label><input type="text" id="god-phone"></div>
        <div class="form-group"><label>é›»å­éƒµä»¶</label><input type="email" id="god-email"></div>
        <div class="form-group">
          <label>æ€§åˆ¥</label>
          <select id="god-gender"><option value="M">ç”·</option><option value="F">å¥³</option></select>
        </div>
        <div class="form-group"><label>è»Šç‰Œè™Ÿç¢¼</label><input type="text" id="god-plate" style="color:#eab308; font-weight:bold;"></div>
        <div class="form-group"><label>è»Šè¼›å“ç‰Œ</label><input type="text" id="god-brand"></div>
        <div class="form-group"><label>è»Šå‹</label><input type="text" id="god-model"></div>
        <div class="form-group"><label>å‡ºå» å¹´ä»½</label><input type="number" id="god-year"></div>
        <div class="form-group"><label>å±…ä½ç¸£å¸‚</label><input type="text" id="god-city"></div>
        <div class="form-group"><label>é„‰é®å¸‚å€</label><input type="text" id="god-district"></div>
        <div class="form-group" style="grid-column: span 2;"><label>è©³ç´°åœ°å€</label><input type="text" id="god-address"></div>
        <div class="form-group" style="grid-column: span 2;">
          <label>å¹´å¹³å‡é‡Œç¨‹ (å…¬é‡Œ)</label>
          <select id="god-mileage"><option value="10000">10,000 å…¬é‡Œ</option><option value="20000">20,000 å…¬é‡Œ</option><option value="30000">30,000 å…¬é‡Œ</option></select>
        </div>
      </div>

      <div style="display:flex; gap:15px; margin-top:10px;">
        <button class="btn" style="flex:1; padding:12px; font-size:16px;" onclick="submitGodModeEdit()">ğŸ’¾ å„²å­˜ä¿®æ”¹</button>
        <button class="btn btn-danger" style="flex:1; padding:12px; font-size:16px;" onclick="closeGodModeEdit()">âœ– å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // åˆå§‹åŒ– Supabase
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    // é¢æ¿åˆ‡æ›ç³»çµ±
    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); 
      btn.classList.add('active');
      
      if(id === 'crm') loadCRM(); 
      if(id === 'uid') loadUIDs(); 
      if(id === 'esg') loadESG(); 
      if(id === 'monitor') loadEnv(); 
      if(id === 'rewards') loadRewards(); 
      if(id === 'garage') loadGarages();
    }

    // ==============================================
    // ğŸŒŸ CRM æ¨¡çµ„ (æ¥µé€Ÿè®€å– + å®Œæ•´ä¸Šå¸æ¨¡å¼)
    // ==============================================
    async function loadCRM() {
      document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">è³‡æ–™è®€å–ä¸­...</td></tr>';
      
      const [resUsers, resFilters, resBookings] = await Promise.all([
          supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false }),
          supabaseClient.from('filters_uid').select('activated_by_uid'),
          supabaseClient.from('bookings').select('user_uid')
      ]);

      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });
      let bCounts = {}; resBookings.data?.forEach(b => { if(b.user_uid) bCounts[b.user_uid] = (bCounts[b.user_uid] || 0) + 1; });

      let html = '';
      resUsers.data?.forEach(u => {
          html += `<tr>
            <td>
              <div style="font-weight:bold; color:#0f172a; font-size:15px;">${u.name || 'æœªå¡«å¯«'}</div>
              <div style="font-size:12px; color:#64748b; margin-top:4px;">ğŸ“± ${u.phone || 'ç„¡'}</div>
              <div style="font-size:11px; color:#94a3b8; margin-top:2px;">è¨»å†Š: ${new Date(u.created_at).toLocaleDateString()}</div>
            </td>
            <td>
              <b>${u.car_brand || '-'} ${u.car_model || ''}</b><br>
              <span style="display:inline-block; margin-top:4px; padding:2px 8px; border:1px solid #cbd5e1; border-radius:4px; font-family:monospace; background:#f8fafc;">${u.license_plate || 'ç„¡è»Šç‰Œ'}</span>
            </td>
            <td>
              <span style="color:#334155;">${u.city || ''}${u.district || ''}</span><br>
              <span style="font-size:12px; color:#94a3b8;">${u.address || 'ç„¡è©³ç´°åœ°å€'}</span>
            </td>
            <td>
               <span style="color:#059669; font-weight:bold;">âœ“ å•Ÿç”¨æ¿¾ç¶²: ${pCounts[u.line_uid] || 0} ç‰‡</span><br>
               <span style="color:#3b82f6; font-size:12px;">ğŸ“ å» ç«¯é ç´„: ${bCounts[u.line_uid] || 0} æ¬¡</span>
            </td>
            <td style="text-align:center;">
              <button class="btn btn-edit" style="width:100%; margin-bottom:5px;" onclick="openGodModeEdit('${u.line_uid}')">âœï¸ æ·±åº¦ä¿®æ”¹</button>
              <button class="btn btn-danger" style="width:100%;" onclick="godModeDelete('${u.line_uid}', '${u.name}')">ğŸ—‘ï¸ å¾¹åº•éŠ·æ¯€</button>
            </td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    // ğŸ›¡ï¸ ä¸Šå¸æ¨¡å¼ï¼šé€£é–éŠ·æ¯€å®¢æˆ¶æ©Ÿåˆ¶
    async function godModeDelete(uid, name) {
        if(prompt(`âš ï¸ æ‚¨å³å°‡æ°¸ä¹…åˆªé™¤å®¢æˆ¶ã€${name}ã€‘çš„è³‡æ–™ã€‚\næ­¤å‹•ä½œå°‡è§£é™¤ä»–ç¶å®šçš„æ‰€æœ‰æ¿¾ç¶²ï¼Œä¸¦åˆªé™¤ç›¸é—œçš„çå‹µã€é ç´„ç­‰ä¸€åˆ‡è¶³è·¡ï¼\n\nè«‹è¼¸å…¥æœ€é«˜æ¬Šé™å¯†ç¢¼ï¼š`) !== "hypass888") {
            return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œå­˜å–è¢«æ‹’ï¼");
        }
        
        if(confirm(`æœ€çµ‚ç¢ºèªï¼šç¢ºå®šè¦è®“ã€${name}ã€‘å¾è³‡æ–™åº«å¾¹åº•æ¶ˆå¤±å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
            try {
                // 1. è§£é™¤æ¿¾ç¶²ç¶å®š (ä¿ç•™åº«å­˜ç´€éŒ„)
                await supabaseClient.from('filters_uid').update({activated_by_uid: null}).eq('activated_by_uid', uid);
                // 2. æ¸…é™¤è©²è»Šä¸»çš„é ç´„ç´€éŒ„
                await supabaseClient.from('bookings').delete().eq('user_uid', uid);
                // 3. æ¸…é™¤è©²è»Šä¸»çš„çå‹µé‡‘ç´€éŒ„
                await supabaseClient.from('rewards').delete().eq('user_uid', uid);
                // 4. æ¸…é™¤ä½¿ç”¨è€…æœ¬é«”
                const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
                if (error) throw error;
                
                alert("âœ… ç›®æ¨™å®¢æˆ¶çš„æ‰€æœ‰é—œè¯è³‡æ–™å·²å¾¹åº•éŠ·æ¯€ï¼"); 
                loadCRM(); 
            } catch(err) {
                alert("åˆªé™¤å¤±æ•—ï¼š" + err.message);
            }
        }
    }

    // ğŸ›¡ï¸ ä¸Šå¸æ¨¡å¼ï¼šé–‹å•Ÿæ·±åº¦ä¿®æ”¹é¢æ¿
    async function openGodModeEdit(uid) {
        if(prompt(`ğŸ› ï¸ å³å°‡é€²å…¥æ·±åº¦ä¿®æ”¹æ¨¡å¼ã€‚\nè«‹è¼¸å…¥è€é—†å°ˆå±¬å¯†ç¢¼ï¼š`) !== "hypass888") {
            return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œå­˜å–è¢«æ‹’ï¼");
        }

        const { data: user, error } = await supabaseClient.from('users').select('*').eq('line_uid', uid).maybeSingle();
        if (error || !user) return alert("ç„¡æ³•è®€å–æ­¤å®¢æˆ¶è³‡æ–™");

        document.getElementById('god-uid').value = user.line_uid;
        document.getElementById('god-name').value = user.name || '';
        document.getElementById('god-phone').value = user.phone || '';
        document.getElementById('god-email').value = user.email || '';
        document.getElementById('god-gender').value = user.gender || 'M';
        document.getElementById('god-plate').value = user.license_plate || '';
        document.getElementById('god-brand').value = user.car_brand || '';
        document.getElementById('god-model').value = user.car_model || '';
        document.getElementById('god-year').value = user.car_year || '';
        document.getElementById('god-city').value = user.city || '';
        document.getElementById('god-district').value = user.district || '';
        document.getElementById('god-address').value = user.address || '';
        document.getElementById('god-mileage').value = user.yearly_mileage || 10000;

        document.getElementById('god-mode-modal').style.display = 'flex';
    }

    function closeGodModeEdit() {
        document.getElementById('god-mode-modal').style.display = 'none';
    }

    // ğŸ›¡ï¸ ä¸Šå¸æ¨¡å¼ï¼šå„²å­˜ä¿®æ”¹
    async function submitGodModeEdit() {
        const uid = document.getElementById('god-uid').value;
        const payload = {
            name: document.getElementById('god-name').value,
            phone: document.getElementById('god-phone').value,
            email: document.getElementById('god-email').value,
            gender: document.getElementById('god-gender').value,
            license_plate: document.getElementById('god-plate').value,
            car_brand: document.getElementById('god-brand').value,
            car_model: document.getElementById('god-model').value,
            car_year: parseInt(document.getElementById('god-year').value) || null,
            city: document.getElementById('god-city').value,
            district: document.getElementById('god-district').value,
            address: document.getElementById('god-address').value,
            yearly_mileage: parseInt(document.getElementById('god-mileage').value)
        };

        const { error } = await supabaseClient.from('users').update(payload).eq('line_uid', uid);
        
        if (error) {
            alert("ä¿®æ”¹å¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… æ‰€æœ‰è³‡æ–™å·²å¼·åˆ¶æ›´æ–°æˆåŠŸï¼");
            closeGodModeEdit();
            loadCRM(); 
        }
    }

    // ==============================================
    // ğŸŒŸ å€‰å„²å‡ºè²¨æƒææ¨¡çµ„
    // ==============================================
    let html5QrCodeAdmin = null;
    function startContinuousScanner() {
        document.getElementById('reader-container').style.display = 'block';
        html5QrCodeAdmin = new Html5Qrcode("reader");
        html5QrCodeAdmin.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 120 } },
            (decodedText) => {
                if (scanState === 'uid') {
                    document.getElementById('scan-uid-input').value = decodedText;
                    handleScan({key: 'Enter', target: {value: decodedText}}, 'uid');
                } else if (scanState === 'order') {
                    document.getElementById('scan-order-input').value = decodedText;
                    handleScan({key: 'Enter', target: {value: decodedText}}, 'order');
                }
            }, (err) => {}
        ).catch(e => alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ¬Šé™ï¼"));
    }
    function stopCamera() {
        if(html5QrCodeAdmin) { 
            html5QrCodeAdmin.stop(); 
            document.getElementById('reader-container').style.display = 'none'; 
        }
    }

    let scanState = 'uid'; let curUid = '';
    function handleScan(e, type) {
        if (e.key === 'Enter') {
            const text = e.target.value.trim();
            if (type === 'uid' && text.startsWith('HP-')) {
                curUid = text; scanState = 'order'; 
                document.getElementById('scan-status-msg').innerHTML = `ğŸ“¦ å·²é–å®š <b>${curUid}</b><br><span style="color:#ef4444;">ğŸ‘‰ è«‹æƒæ Shopline è¨‚å–®æˆ–è¼¸å…¥å®¢äººæ‰‹æ©Ÿï¼</span>`;
                document.getElementById('scan-uid-input').disabled = true; 
                document.getElementById('scan-order-input').disabled = false; 
                document.getElementById('scan-order-input').focus();
            } else if (type === 'order' && text.length > 5) {
                processOrder(curUid, text);
            }
        }
    }

    async function processOrder(uid, order) {
        document.getElementById('scan-status-msg').innerText = "ğŸ”„ é›²ç«¯å¯«å…¥ç¶å®šä¸­...";
        
        const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', order).maybeSingle();
        
        const payload = { status: 'sold', shopline_order_id: order };
        if(user) payload.activated_by_uid = user.line_uid; 
        
        await supabaseClient.from('filters_uid').update(payload).eq('uid', uid);
        
        document.getElementById('scan-status-msg').innerHTML = `<span style="color:#059669;">âœ… æˆåŠŸï¼æ¿¾ç¶² <b>${uid}</b> å·²é…å°è‡³è¨‚å–® <b>${order}</b><br>è«‹ç›´æ¥æƒæä¸‹ä¸€ç‰‡æ¿¾ç¶²ï¼</span>`;
        
        document.getElementById('scan-uid-input').value = ''; 
        document.getElementById('scan-order-input').value = '';
        document.getElementById('scan-uid-input').disabled = false; 
        document.getElementById('scan-order-input').disabled = true; 
        scanState = 'uid';
        document.getElementById('scan-uid-input').focus();
    }

    // ==============================================
    // ğŸŒŸ UID åº«å­˜ç®¡ç†æ¨¡çµ„ (ä¸Šå¸æ¨¡å¼éŠ·æ¯€)
    // ==============================================
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(100);
        let html = ''; 
        data?.forEach(d => { 
            let statusColor = d.status === 'produced' ? '#64748b' : (d.status === 'sold' ? '#f59e0b' : '#059669');
            html += `<tr>
                <td style="font-family:monospace; font-size:16px; font-weight:bold;">${d.uid}</td>
                <td style="color:${statusColor}; font-weight:bold;">${d.status.toUpperCase()}</td>
                <td>${d.users?.name || '-'}</td>
                <td>${d.activated_at ? new Date(d.activated_at).toLocaleString() : '-'}</td>
                <td style="text-align:center;">
                  <button class="btn btn-danger" onclick="godModeDeleteUID('${d.uid}', '${d.status}')">ğŸ—‘ï¸ éŠ·æ¯€</button>
                </td>
            </tr>`; 
        });
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function generateSequentialUIDs() {
        document.querySelector('#panel-uid button').innerText = "ç”¢ç”Ÿä¸­...";
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; 
        for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        
        await supabaseClient.from('filters_uid').insert(ins); 
        alert("âœ… æˆåŠŸç”¢ç”Ÿ 50 çµ„å…¨æ–° UIDï¼"); 
        document.querySelector('#panel-uid button').innerText = "âš™ï¸ ä¸€éµç”¢ç”Ÿ 50 çµ„å…¨æ–° UID";
        loadUIDs();
    }

    // ğŸ›¡ï¸ UID ä¸Šå¸æ¨¡å¼åˆªé™¤
    async function godModeDeleteUID(uid, status) {
        let warnMsg = `âš ï¸ æ‚¨æº–å‚™åˆªé™¤ UID [${uid}]ã€‚`;
        if (status !== 'produced') {
            warnMsg = `ğŸš¨ åš´é‡è­¦å‘Šï¼šUID [${uid}] ç›®å‰ç‹€æ…‹ç‚ºã€${status}ã€‘ï¼\nåˆªé™¤å®ƒå¯èƒ½æœƒç ´å£è»Šä¸»çš„ä¿å›ºå±¥æ­·èˆ‡è³‡æ–™åº«é—œè¯ï¼`;
        }
        
        if(prompt(`${warnMsg}\n\nè«‹è¼¸å…¥è€é—†å°ˆå±¬å¯†ç¢¼ç¢ºèªå¼·åˆ¶åˆªé™¤ï¼š`) !== 'hypass888') {
            return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œæ“ä½œå–æ¶ˆï¼");
        }
        
        if(confirm(`æœ€çµ‚ç¢ºèªï¼šçœŸçš„è¦å°‡ UID [${uid}] å¾ç³»çµ±ä¸­æ°¸ä¹…æŠ¹é™¤å—ï¼Ÿ`)) {
            const { error } = await supabaseClient.from('filters_uid').delete().eq('uid', uid);
            if (error) alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
            else { alert("âœ… UID å¾¹åº•éŠ·æ¯€æˆåŠŸï¼"); loadUIDs(); }
        }
    }

    // ==============================================
    // ğŸŒŸ ESG æ¨¡çµ„
    // ==============================================
    async function loadESG() {
        const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status','activated');
        let totalDays = 0; 
        data?.forEach(x => {
            if(x.activated_at) totalDays += Math.floor((new Date() - new Date(x.activated_at)) / 86400000);
        });
        
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        let basePm25 = parseFloat(params.basePm25 || 1250);
        let kwhPerDay = parseFloat(params.kwhPerDay || 0.25);
        let co2Factor = parseFloat(params.co2Factor || 0.5);

        document.getElementById('esg-pm25').innerText = (totalDays * basePm25).toLocaleString(); 
        document.getElementById('esg-kwh').innerText = (totalDays * kwhPerDay).toFixed(1); 
        document.getElementById('esg-co2').innerText = (totalDays * kwhPerDay * co2Factor).toFixed(1);
    }

    // ==============================================
    // ğŸŒŸ æ¼”ç®—æ³•èˆ‡ç’°å¢ƒå¿«å–æ¨¡çµ„ (çµ•å°ä¸éš±è—åƒæ•¸ç‰ˆ)
    // ==============================================
    async function loadEnv() {
        // è®€å–ç›®å‰çš„åƒæ•¸é¡¯ç¤ºåœ¨è¼¸å…¥æ¡†
        const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
        document.getElementById('p-wear').value = params.baseWear || '0.27';
        document.getElementById('p-pm25').value = params.basePm25 || '1250';
        document.getElementById('p-orange').value = params.weightOrange || '1.4';
        document.getElementById('p-red').value = params.weightRed || '1.8';
        document.getElementById('p-hypass').value = params.paHypass || '4';
        document.getElementById('p-other').value = params.paOther || '8';
        document.getElementById('p-kwh').value = params.kwhPerDay || '0.25';
        document.getElementById('p-co2').value = params.co2Factor || '0.5';

        // è®€å–ç’°å¢ƒæ± 
        const { data } = await supabaseClient.from('env_cache').select('*').order('aqi', {ascending:false}).limit(50);
        let html = ''; 
        data?.forEach(d => { 
            html += `<tr>
                <td style="font-weight:bold;">${d.city}${d.district}</td>
                <td><span style="background:#e2e8f0; padding:4px 8px; border-radius:4px;">${d.aqi}</span></td>
                <td style="color:#d97706; font-weight:bold; font-size:16px;">${Math.round(d.aqi_7d_avg||d.aqi)}</td>
                <td style="font-size:12px; color:#64748b;">${new Date(d.updated_at).toLocaleString()}</td>
            </tr>`; 
        });
        document.getElementById('env-table').querySelector('tbody').innerHTML = html;
    }

    function saveParams() { 
        localStorage.setItem('hypass_algo_params', JSON.stringify({
            baseWear: document.getElementById('p-wear').value, 
            basePm25: document.getElementById('p-pm25').value,
            weightOrange: document.getElementById('p-orange').value,
            weightRed: document.getElementById('p-red').value,
            paHypass: document.getElementById('p-hypass').value,
            paOther: document.getElementById('p-other').value,
            kwhPerDay: document.getElementById('p-kwh').value,
            co2Factor: document.getElementById('p-co2').value
        })); 
        alert("âœ… æ‰€æœ‰æ¼”ç®—æ³•åƒæ•¸å·²å„²å­˜ï¼Œå°‡å³åˆ»å½±éŸ¿å…¨ç¶²å‰å°å„€è¡¨æ¿çš„è¨ˆç®—çµæœï¼"); 
    }

    // ==============================================
    // ğŸŒŸ çå‹µé‡‘èˆ‡ä¿ä¿®å» æ¨¡çµ„
    // ==============================================
    async function loadRewards() {
        const { data } = await supabaseClient.from('rewards').select('*, users(name)').eq('type', 'redeem').eq('status', 'pending');
        let html = ''; 
        data?.forEach(r => { 
            html += `<tr>
                <td style="font-weight:bold;">${r.users?.name || 'æœªçŸ¥è»Šä¸»'}</td>
                <td style="color:#eab308; font-weight:bold;">ç”³è«‹å…Œæ› ${r.points} é»</td>
                <td>${new Date(r.created_at).toLocaleString()}</td>
                <td><button class="btn" onclick="approveReward(${r.id})">âœ… äººå·¥çµæ¡ˆç™¼æ”¾</button></td>
            </tr>`; 
        });
        document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç›®å‰ç„¡å¾…è™•ç†æ¡ˆä»¶</td></tr>';
    }
    
    async function approveReward(id) {
        if(confirm("ç¢ºå®šå·²å°‡ LINE Points ç™¼çµ¦è»Šä¸»ä¸¦çµæ¡ˆå—ï¼Ÿ")) {
            await supabaseClient.from('rewards').update({status:'completed', details:'ç¸½éƒ¨äººå·¥å¯©æ ¸ç™¼æ”¾'}).eq('id',id); 
            alert("âœ… çµæ¡ˆæˆåŠŸï¼"); 
            loadRewards(); 
        }
    }
    
    async function loadGarages() {
        const { data } = await supabaseClient.from('garages').select('*').order('id');
        let html = ''; 
        data?.forEach(g => { 
            let sBadge = g.status === 'active' ? '<span style="color:#059669; font-weight:bold;">ç‡Ÿæ¥­ä¸­</span>' : '<span style="color:#ef4444;">å¯©æ ¸ä¸­</span>';
            html += `<tr>
                <td style="font-weight:bold;">${g.name}</td>
                <td>${g.city}${g.address}</td>
                <td>${g.contact_name || ''} / ${g.phone || ''}</td>
                <td>${sBadge}</td>
            </tr>`; 
        });
        document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
    }

    // ç³»çµ±å•Ÿå‹•ï¼Œé è¨­è¼‰å…¥ CRM
    loadCRM();
  </script>
</body>
</html>
