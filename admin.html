<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS ADMIN ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; position: sticky; top: 0; z-index: 2;}
    
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; transition: background 0.2s; }
    .btn:hover { background: #00b300; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card:last-child { margin-right: 0; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }
    
    .op-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .op-card h3 { margin: 0 0 10px 0; color: #555; }

    .param-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 6px;}
    .param-group label { font-size: 13px; color: #555; font-weight: bold; }
    .param-group input { width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-family: monospace; font-size: 14px;}
    .param-group select { width: 120px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; font-weight:bold; cursor:pointer;}

    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; align-items: flex-start; flex-wrap: wrap; position: relative;}
    .scan-input-group { flex: 1; min-width: 250px; }
    .scan-input { width: 100%; padding: 18px; font-size: 22px; border-radius: 5px; border: 3px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; transition: all 0.3s; text-align: center; font-family: monospace;}
    .scan-input:disabled { background: #111; color: #00D100; cursor: not-allowed; }
    .scan-label { color: #aaa; font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; }
    
    #reader-container { width: 100%; margin-bottom: 20px; display: none; background:#111; padding:15px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
    #reader { width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 8px; border: 2px solid #333;}
    #camera-target-hint { display: block; text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #222;}

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-content textarea { width: 100%; height: 120px; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-family: sans-serif; font-size: 14px; box-sizing: border-box; resize: vertical; }
    .modal-content select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 20px;">
      <h2 style="color:#00D100; padding: 0 20px; border:none; margin-bottom: 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ ç¶ èƒ½ç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('stats', this)">ğŸ“Š ç‡Ÿé‹åˆ†ä½ˆ</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•ç›£æ§</button>
      <button class="nav-btn" onclick="switchTab('push', this)">ğŸ’¬ æ™ºæ…§æ¨æ’­</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
      <button class="nav-btn active" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» </button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
    </div>
    <div style="margin-top: auto; padding: 20px; color: #666; font-size: 12px; font-family: monospace; border-top: 1px solid #222;">
      System Ver.<br><strong style="color: #00D100; font-size: 14px;">V4.32 é˜²å¿«å–ç©©å®šç‰ˆ</strong>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
          <h2 style="border:none; padding:0; margin:0;">ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
          <button class="btn" style="background:#1976d2; color:#fff; font-size:16px; padding:10px 20px;" onclick="startContinuousScanner()">ğŸš€ å•Ÿå‹•ç„¡é–“æ–·ç›¸æ©Ÿ</button>
      </div>
      <p style="color:#666; font-size:13px;">æ­è¼‰é›²ç«¯ä¸‰ç´šé˜²å‘†ã€‚å•Ÿå‹•å¾Œè‡ªå‹•å¼•å°ï¼šå…ˆæƒææ¿¾ç¶² UID â” æ¥è‘—æƒæè¨‚å–® â” è½åˆ°å®å™¹è²å¾Œç›´æ¥ä¸‹ä¸€ç‰‡ã€‚</p>
      
      <div id="reader-container">
        <div id="camera-target-hint">æº–å‚™ä¸­...</div>
        <div id="reader"></div>
        <div style="text-align:center; margin-top:15px;">
           <button class="btn btn-danger" style="padding:10px 30px;" onclick="stopCamera()">é—œé–‰ç›¸æ©Ÿ</button>
        </div>
      </div>

      <div class="scan-container">
        <div class="scan-input-group">
          <label class="scan-label" id="label-uid">ç¬¬ 1 æ­¥ï¼šæƒææ¿¾ç¶² UID æ¢ç¢¼</label>
          <input type="text" id="scan-uid-input" class="scan-input" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleManualScan(event, 'uid')">
        </div>
        <div class="scan-input-group">
          <div style="display:flex; justify-content:space-between;">
             <label class="scan-label" id="label-order">ç¬¬ 2 æ­¥ï¼šæƒæ Shopline è¨‚å–®å–®è™Ÿ</label>
             <button class="btn btn-danger" id="btn-reset-scan" style="padding: 2px 8px; font-size:11px; display:none;" onclick="resetScanState()">ğŸ”„ æ”¾æ£„æœ¬ç­†ï¼Œé‡ä¾†</button>
          </div>
          <input type="text" id="scan-order-input" class="scan-input" placeholder="ç­‰å¾…æƒæè¨‚å–®..." onkeypress="handleManualScan(event, 'order')">
        </div>
      </div>
      
      <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:#333;">ğŸ“‹ æœ¬æ¬¡æƒæå‡ºè²¨ç´€éŒ„</h3><span id="scan-status-msg" style="font-weight:bold; font-size:15px;"></span>
      </div>
      <div style="max-height: 350px; overflow-y:auto; border: 1px solid #ddd; margin-top:10px;">
        <table>
          <thead style="position:sticky; top:0; background:#f4f6f8;">
            <tr><th>æ¿¾ç¶² UID</th><th>ç¶å®šå–®è™Ÿ/è™Ÿç¢¼</th><th>å®¢æˆ¶ç‹€æ…‹</th><th>ä½œæ¥­çµæœ</th><th>æƒææ™‚é–“</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="dispatch-log-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-crm" class="panel active">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (å¤šç¶­åº¦å±¥æ­·)</h2>
      <table id="crm-table">
        <thead>
          <tr>
             <th>å®¢æˆ¶èˆ‡è¨»å†Šè³‡è¨Š</th>
             <th>è»Šè¼›èˆ‡é‡Œç¨‹</th>
             <th>é€šè¨Šåœ°å€</th>
             <th>äº’å‹•èˆ‡è©•åƒ¹æ•¸æ“š</th>
             <th style="text-align:center;">ç‹€æ…‹èˆ‡æ“ä½œ</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="5" style="text-align:center; font-weight:bold; padding:30px; color:#1976d2;">ğŸš€ ç³»çµ±ä¸¦è¡ŒåŠ é€Ÿè®€å–å¤§æ•¸æ“šä¸­...</td></tr></tbody>
      </table>
    </div>

    <div id="customer-modal" class="modal-overlay">
      <div class="modal-content" style="width: 650px;">
        <h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
           <span>ğŸ“„ å®¢æˆ¶å®Œæ•´å±¥æ­·</span>
           <button class="btn-danger" style="border:none; padding:4px 10px; border-radius:4px; cursor:pointer;" onclick="closeCustomerModal()">âœ–</button>
        </h3>
        <div id="c-detail-body" style="line-height:1.8; font-size:15px; color:#333;"></div>
      </div>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card"><h1><span id="esg-active">0</span> ç‰‡</h1><p>ç›®å‰é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š å…¨å°ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="op-card" style="border-top: 4px solid #00D100;"><h3>æ¿¾ç¶²æœƒå“¡ç¸½æ•¸</h3><h1 id="stat-total-users" style="font-size: 48px; margin: 10px 0; color: #00D100;">0</h1></div>
        <div class="op-card" style="border-top: 4px solid #FF9800;"><h3>é–‹é€šä¿ä¿®å» ç¸½æ•¸</h3><h1 id="stat-total-garages" style="font-size: 48px; margin: 10px 0; color: #FF9800;">0</h1></div>
      </div>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;"><table id="stat-users-city"><thead><tr><th>å±…ä½ç¸£å¸‚</th><th>æœƒå“¡äººæ•¸</th></tr></thead><tbody></tbody></table></div>
        <div style="flex: 1;"><table id="stat-garages-city"><thead><tr><th>æ‰€åœ¨ç¸£å¸‚</th><th>åˆä½œå®¶æ•¸</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸èˆ‡å…¨å°ç©ºæ±™å¤§æ•¸æ“š</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap:wrap;">
        <div style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fafafa; min-width:300px;">
          <h3 style="margin-top: 0; color: #1976d2; display:flex; align-items:center; gap:8px;">ğŸ§  æ¿¾ç¶²å‹•æ…‹æ¼”ç®—æ³• & è‡ªå‹•åŒ–åƒæ•¸</h3>
          <h4 style="margin: 15px 0 5px 0; color:#333; font-size:14px;">â–å‹•æ…‹å£½å‘½èˆ‡ç©ºæ°£æ¬Šé‡</h4>
          <div class="param-group"><label>åŸºæº–æ¯æ—¥è€—æç‡ (%)</label><input type="number" step="0.01" id="param-base-wear" value="0.27"></div>
          <div class="param-group"><label>åŸºæº– PM2.5 æ””æˆªé‡ (Âµg)</label><input type="number" id="param-base-pm25" value="1250"></div>
          <div class="param-group"><label>ğŸ”´ ç´«çˆ†åŠ æ¬Šä¿‚æ•¸ (AQI>150)</label><input type="number" step="0.1" id="param-weight-red" value="1.8"></div>
          <div class="param-group"><label>ğŸŸ  æ©˜å®³åŠ æ¬Šä¿‚æ•¸ (AQI>100)</label><input type="number" step="0.1" id="param-weight-orange" value="1.4"></div>
          <div class="param-group"><label>ğŸŒ¡ï¸ æ¥µç«¯æº«æ¿•åº¦åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-temp" value="1.2"></div>

          <h4 style="margin: 20px 0 5px 0; color:#d32f2f; font-size:14px;">â–ç³»çµ±è‡ªå‹•åŒ–èˆ‡é è­¦æ¨æ’­</h4>
          <div class="param-group"><label>ğŸ”„ æ•¸æ“šå¼·åˆ¶æ›´æ–°é »ç‡ (å°æ™‚)</label><input type="number" id="param-update-interval" value="2"></div>
          <div class="param-group">
             <label>ğŸ  è¿‘7æ—¥ AQI é‹ç®—æ¨¡å¼</label>
             <select id="param-aqi-mode">
                <option value="simulation">å³æ™‚æ“¾å‹•æ¨¡æ“¬ (è¼•é‡)</option>
                <option value="historical">æ­·å² DB å¯¦ç®— (é«˜è€—èƒ½)</option>
             </select>
          </div>
          <div class="param-group">
             <label>ğŸš¨ ç´«çˆ†æ™‚ä¸»å‹•ç™¼é€ LINE æé†’</label>
             <select id="param-auto-push-red">
                <option value="true">ğŸŸ¢ é–‹å•Ÿ</option>
                <option value="false">ğŸ”´ é—œé–‰</option>
             </select>
          </div>

          <h4 style="margin: 20px 0 5px 0; color:#2e7d32; font-size:14px;">â–ESG èˆ‡ææ–™ç‰©ç†ç‰¹æ€§</h4>
          <div class="param-group"><label>HYPASS æ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-hypass" value="4"></div>
          <div class="param-group"><label>ä»–ç‰Œæ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-other" value="8"></div>
          <div class="param-group"><label>æ¯æ—¥åŸºæº–çœé›» (kWh)</label><input type="number" step="0.01" id="param-kwh-day" value="0.25"></div>
          <div class="param-group"><label>ç¢³æ’è½‰æ›ä¿‚æ•¸ (kg/kWh)</label><input type="number" step="0.1" id="param-co2-factor" value="0.5"></div>
          
          <button class="btn" style="width:100%; margin-top:15px; background:#1976d2; color:#fff;" onclick="saveAlgorithmParams()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒè‡³ä¼ºæœå™¨</button>
        </div>
        
        <div style="flex: 1.2; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; background: #fffafb; min-width:300px;">
          <h3 style="margin-top: 0; color: #d32f2f;">ğŸš¨ å…¨å°å³æ™‚ 10 å¤§ç©ºæ±™é‡ç½å€</h3>
          <p style="font-size:12px; color:#d32f2f; margin-bottom:10px;">å¼·çƒˆå»ºè­°é‡å°ä»¥ä¸‹å€åŸŸåŠ å¼·ã€Œç´«çˆ†é˜²è­·ã€æ¨æ’­èˆ‡å»£å‘ŠæŠ•æ”¾ã€‚</p>
          <div id="top10-container"><table style="margin-top:0;"><thead><tr><th>æ’å</th><th>ç¸£å¸‚é„‰é®</th><th>AQI æŒ‡æ•¸</th><th>PM2.5</th></tr></thead><tbody><tr><td colspan="4" style="text-align:center;">è³‡æ–™åˆ†æä¸­...</td></tr></tbody></table></div>
        </div>
      </div>
      <h3 style="border-top:2px solid #eee; padding-top:20px; margin-bottom:15px;">ğŸŒ å°ç£ 368 é„‰é®å¸‚å€ç’°å¢ƒå¿«å–æ±  (æ¼”ç®—æ³•å…¨å‹•æ…‹ç›£æ§)</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <input type="text" id="monitor-search" placeholder="ğŸ” æœå°‹ç¸£å¸‚æˆ–é„‰é® (ä¾‹å¦‚: å°åŒ—)" onkeyup="filterMonitorTable()" style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ccc;">
        <div>
          <span id="monitor-count" style="font-size: 13px; color: #00D100; font-weight: bold; margin-right: 15px;">å…± 0 ç­†</span>
          <button class="btn" id="btn-force-update" style="background: #333; color: #fff;" onclick="forceUpdateCache()">âš¡ å¼·åˆ¶é‡æ–°æŠ“å– (ç´„40ç§’)</button>
        </div>
      </div>
      <div style="height: 400px; overflow-y: auto; border: 1px solid #eee;">
        <table id="monitor-table" style="margin-top: 0;">
          <thead><tr><th>ç¸£å¸‚ / é„‰é®</th><th>ç’°å¢ƒæº«æ¿•åº¦</th><th>AQI æŒ‡æ•¸</th><th>PM2.5 (Âµg)</th><th>å‹•æ…‹æ¼”ç®—æ³•è€—æå€ç‡</th><th style="background:#e8f5e9; color:#2e7d32;">ğŸ’¡ ç‡Ÿé‹ç­–ç•¥å»ºè­°</th><th>æœ€å¾Œæ›´æ–°æ™‚é–“ (å°åŒ—)</th></tr></thead>
          <tbody><tr><td colspan="7" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="panel-push" class="panel">
      <h2>ğŸ’¬ AI æ™ºæ…§æ¨æ’­å¼•æ“ (å‹•æ…‹æƒ…å¢ƒåº«)</h2>
      <table id="push-table"><thead><tr><th>é¡åˆ¥</th><th>æƒ…å¢ƒè¦å‰‡åç¨±</th><th>è§¸ç™¼é‚è¼¯æ¢ä»¶</th><th>è‡ªå‹•æ¨æ’­æ–‡æ¡ˆå…§å®¹</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID æ™ºæ…§æµæ°´è™Ÿç”Ÿæˆ</h2>
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight:bold;">é è¨ˆç”¢å‡ºçµ„æ•¸ï¼š</label>
        <input type="number" id="uid-gen-count" value="50" style="width: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ è‡ªå‹•æ¥çºŒç”¢å‡ºæ–° UID</button>
      </div>
      <table id="uid-table" style="margin-top:15px;">
          <thead><tr><th>UID æµæ°´è™Ÿ</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹/æ“æœ‰è€…</th><th>å®‰è£è»Šæ¬¾/åœ°é»</th><th>æ“ä½œæ™‚é–“</th><th style="text-align:center;">æ“ä½œç®¡ç†</th></tr></thead>
          <tbody></tbody>
      </table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>è¯çµ¡äºº/é›»è©±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>ç”³è«‹æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    // æ‚¨çš„ Supabase é‡‘é‘°
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k';
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', ANON_KEY);

    let fullMonitorData = []; 

    function formatTaipeiTime(dateString) {
      if (!dateString) return '-';
      try {
        const d = new Date(dateString);
        if (isNaN(d.getTime())) return '-';
        const options = { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
        return d.toLocaleString('zh-TW', options);
      } catch (e) { return '-'; }
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active');
      btn.classList.add('active');
      
      if (id === 'esg') loadESG(); 
      if (id === 'stats') loadStats(); 
      if (id === 'monitor') { loadMonitor(); loadAlgorithmParams(); }
      if (id === 'push') loadPushRules();
      if (id === 'uid') loadUIDs(); 
      if (id === 'crm') loadCRM(); 
      if (id === 'garage') loadGarages(); 
      if (id === 'rewards') loadRewards();
      if (id === 'dispatch') { 
          resetScanState();
          setTimeout(() => document.getElementById('scan-uid-input').focus(), 100);
      } else { stopCamera(); }
    }

    let fullCrmUsers = [];

    async function loadCRM() {
      try {
          document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px; font-weight:bold; color:#1976d2;">ğŸš€ ç³»çµ±ä¸¦è¡ŒåŠ é€Ÿè®€å–å¤§æ•¸æ“šä¸­...</td></tr>';
          
          const pUsers = supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
          const pFilters = supabaseClient.from('filters_uid').select('activated_by_uid').not('activated_by_uid', 'is', null).then(r=>r).catch(()=>({data:[]}));
          const pBookings = supabaseClient.from('bookings').select('user_uid').then(r=>r).catch(()=>({data:[]}));

          const [resUsers, resFilters, resBookings] = await Promise.all([pUsers, pFilters, pBookings]);
          
          if (resUsers.error) throw new Error(resUsers.error.message);
          const users = resUsers.data || [];
          
          if (users.length === 0) {
              document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">ç›®å‰å°šç„¡å®¢æˆ¶è¨»å†Šè³‡æ–™</td></tr>'; return;
          }
          fullCrmUsers = users;

          let pCounts = {};
          if (Array.isArray(resFilters.data)) { 
              resFilters.data.forEach(f => { if (f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; }); 
          }

          let bCounts = {};
          if (Array.isArray(resBookings.data)) { 
              resBookings.data.forEach(b => { if(b.user_uid) bCounts[b.user_uid] = (bCounts[b.user_uid] || 0) + 1; }); 
          }

          let html = '';
          users.forEach(u => {
              let actionBtn = u.is_blacklisted 
                  ? `<button class="btn" style="width:100%;" onclick="toggleBlacklist('${u.line_uid}', false, 'users')">è§£é™¤é»‘å–®</button>` 
                  : `<button class="btn btn-danger" style="width:100%;" onclick="toggleBlacklist('${u.line_uid}', true, 'users')">è¨­ç‚ºé»‘å–®</button>`;
              
              let fullAddress = `${u.city || ''}${u.district || ''}${u.address || ''}`;
              if (!fullAddress) fullAddress = '<span style="color:#aaa;">æœªå¡«å¯«</span>';
              
              let joinDate = formatTaipeiTime(u.created_at);
              let pCount = pCounts[u.line_uid] || 0;
              let bCount = bCounts[u.line_uid] || 0;
              
              let rating = pCount > 0 ? '<span style="color:#FF9800;">â­â­â­â­â­ (5.0)</span>' : '<span style="color:#aaa;">å°šç„¡è©•åƒ¹</span>'; 
              let mileage = u.yearly_mileage ? `${u.yearly_mileage} km/å¹´` : '<span style="color:#aaa;">æœªå¡«</span>';
              let genderStr = u.gender === 'M' ? 'ç”·' : (u.gender === 'F' ? 'å¥³' : 'æœªçŸ¥');

              html += `<tr>
                <td>
                  <div style="font-weight:bold; font-size:16px; color:#1976d2; margin-bottom:4px;">${u.name || 'ç„¡åæ°'} <span style="font-size:12px; color:#666; font-weight:normal;">(${genderStr})</span></div>
                  <div style="font-family:monospace; color:#444; font-size:13px;">${u.phone || 'ç„¡é›»è©±'}</div>
                  <div style="font-size:12px; color:#888; margin-top:6px; font-family:monospace;">ğŸ“¥ è¨»å†Š: ${joinDate}</div>
                </td>
                <td>
                  <div style="font-weight:bold; color:#333; margin-bottom:4px;">${u.car_brand || '-'} ${u.car_model || '-'}</div>
                  <div style="font-family:monospace; color:#FF9800; font-weight:bold; font-size:15px;">${u.license_plate || 'æœªç¶å®šè»Šç‰Œ'}</div>
                  <div style="font-size:12px; color:#666; margin-top:6px;">é‡Œç¨‹: ${mileage}</div>
                </td>
                <td style="font-size:13px; color:#444; max-width:200px;">${fullAddress}</td>
                <td>
                  <div style="font-size:13px; margin-bottom:4px;">ğŸ›’ è³¼è²·/å•Ÿç”¨: <strong style="color:#00D100; font-size:15px;">${pCount}</strong> æ¬¡</div>
                  <div style="font-size:13px; margin-bottom:4px;">ğŸ“ é ç´„å®‰è£: <strong style="color:#1976d2; font-size:15px;">${bCount}</strong> æ¬¡</div>
                  <div style="font-size:12px; margin-top:8px;">ğŸ’¬ è©•åƒ¹: ${rating}</div>
                </td>
                <td style="text-align:center; width:100px;">
                  ${u.is_blacklisted ? '<span style="color:red; font-weight:bold; font-size:12px; display:block; margin-bottom:8px;">ğŸ”´ é»‘åå–®</span>' : '<span style="color:green; font-size:12px; font-weight:bold; display:block; margin-bottom:8px;">ğŸŸ¢ æ­£å¸¸ç‹€æ…‹</span>'}
                  ${actionBtn}
                  <button class="btn" style="background:#444; color:#fff; margin-top:8px; font-size:12px; width:100%;" onclick="showCustomerDetails('${u.line_uid}')">ğŸ“„ å®Œæ•´å±¥æ­·</button>
                </td>
              </tr>`; 
          }); 
          document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
      } catch (err) {
          document.getElementById('crm-table').querySelector('tbody').innerHTML = `<tr><td colspan="5" style="text-align:center; color:red; font-weight:bold; padding:30px;">âš ï¸ CRM å®¢æˆ¶è³‡æ–™è¼‰å…¥å¤±æ•—<br>éŒ¯èª¤è¨Šæ¯ï¼š${err.message}</td></tr>`;
      }
    }

    function showCustomerDetails(uid) {
        const u = fullCrmUsers.find(x => x.line_uid === uid);
        if(!u) return;
        let joinDate = formatTaipeiTime(u.created_at);
        let gender = u.gender === 'M' ? 'ç”·æ€§' : (u.gender === 'F' ? 'å¥³æ€§' : 'æœªå¡«å¯«');
        let html = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background:#f4f6f8; padding:15px; border-radius:8px; border:1px solid #e0e0e0;">
                    <h4 style="margin-top:0; color:#1976d2; border-bottom:1px solid #ccc; padding-bottom:8px; margin-bottom:12px;">ğŸ‘¤ åŸºæœ¬è¯çµ¡è³‡è¨Š</h4>
                    <p style="margin:8px 0;"><b>å§“åï¼š</b> ${u.name || '-'}</p>
                    <p style="margin:8px 0;"><b>æ€§åˆ¥ï¼š</b> ${gender}</p>
                    <p style="margin:8px 0;"><b>é›»è©±ï¼š</b> <span style="font-family:monospace; font-weight:bold;">${u.phone || '-'}</span></p>
                    <p style="margin:8px 0;"><b>ä¿¡ç®±ï¼š</b> ${u.email || '<span style="color:#aaa;">æœªæä¾›</span>'}</p>
                    <p style="margin:8px 0;"><b>è¨»å†Šæ™‚é–“ï¼š</b> <br><span style="font-size:13px; color:#666;">${joinDate}</span></p>
                    <p style="margin:8px 0;"><b>å®Œæ•´åœ°å€ï¼š</b> <br><span style="font-size:13px;">${u.city || ''}${u.district || ''}${u.address || '<span style="color:#aaa;">æœªæä¾›</span>'}</span></p>
                </div>
                <div style="background:#fffaf0; padding:15px; border-radius:8px; border:1px solid #ffe0b2;">
                    <h4 style="margin-top:0; color:#e65100; border-bottom:1px solid #ffe0b2; padding-bottom:8px; margin-bottom:12px;">ğŸš— æ„›è»Šå°ˆå±¬æ•¸æ“š</h4>
                    <p style="margin:8px 0;"><b>å“ç‰Œï¼š</b> ${u.car_brand || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>è»Šå‹ï¼š</b> ${u.car_model || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>è»Šç‰Œè™Ÿç¢¼ï¼š</b> <br><span style="font-family:monospace; font-weight:bold; font-size:18px; color:#e65100;">${u.license_plate || 'æœªç¶å®š'}</span></p>
                    <p style="margin:8px 0;"><b>å‡ºå» å¹´ä»½ï¼š</b> ${u.car_year || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>å¹´å‡é‡Œç¨‹ï¼š</b> <br><span style="font-weight:bold; color:#d32f2f;">${u.yearly_mileage ? u.yearly_mileage + ' å…¬é‡Œ' : '<span style="color:#aaa; font-weight:normal;">æœªè¨­å®š</span>'}</span></p>
                </div>
            </div>
            <div style="background:#e8f5e9; padding:15px; border-radius:8px; margin-top:20px; border:1px solid #c8e6c9;">
                <h4 style="margin-top:0; color:#2e7d32; border-bottom:1px solid #c8e6c9; padding-bottom:8px; margin-bottom:10px;">ğŸ›¡ï¸ æ™ºèƒ½åº§è‰™æˆæ¬Šé‡‘é‘° (UID)</h4>
                <p style="margin:0; font-family:monospace; font-size:14px; word-break:break-all; color:#555;">${u.line_uid}</p>
            </div>
        `;
        document.getElementById('c-detail-body').innerHTML = html;
        document.getElementById('customer-modal').style.display = 'flex';
    }
    function closeCustomerModal() { document.getElementById('customer-modal').style.display = 'none'; }

    async function generateSequentialUIDs() { const count = parseInt(document.getElementById('uid-gen-count').value) || 50; if(count <= 0 || count > 500) return alert("è«‹è¼¸å…¥ 1 ~ 500 ä¹‹é–“çš„æ•¸é‡"); const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(200); let maxNum = 0; if (data && data.length > 0) { data.forEach(d => { const match = d.uid.match(/^HP-(\d+)$/); if (match) { const num = parseInt(match[1], 10); if (num > maxNum) maxNum = num; } }); } let ins = []; for(let i=1; i<=count; i++) { ins.push({ uid: 'HP-' + (maxNum + i).toString().padStart(6, '0') }); } await supabaseClient.from('filters_uid').insert(ins); alert(`âœ… æˆåŠŸæ¥çºŒç”¢å‡º ${count} çµ„æ–°æµæ°´è™Ÿï¼(è¿„è‡³ ${ins[ins.length-1].uid})`); loadUIDs(); }
    
    async function loadUIDs() { 
        try {
            const { data, error } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(100); 
            if(error) throw new Error(error.message);
            let html = ''; 
            if (data) { 
                data.forEach(d => { 
                    let statusIcon = d.status === 'produced' ? 'ğŸ·ï¸ ç¸½éƒ¨åº«å­˜' : d.status === 'sold' ? 'ğŸšš å·²å‡ºè²¨' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°'; 
                    html += `<tr>
                        <td style="font-family:monospace; font-size:16px;"><b>${d.uid}</b></td>
                        <td>${statusIcon}</td>
                        <td>${d.activation_type || (d.users ? d.users.name : '-')}</td>
                        <td>${d.installed_car_model || '-'}</td>
                        <td>${d.activated_at ? formatTaipeiTime(d.activated_at) : formatTaipeiTime(d.created_at)}</td>
                        <td style="text-align:center;">
                           <button class="btn" style="padding:4px 8px; font-size:12px; background:#444; color:#fff;" onclick="editUID('${d.uid}', '${d.status}')">ä¿®æ”¹</button>
                           <button class="btn btn-danger" style="padding:4px 8px; font-size:12px;" onclick="deleteUID('${d.uid}', '${d.status}')">åˆªé™¤</button>
                        </td>
                    </tr>`; 
                }); 
            } 
            document.getElementById('uid-table').querySelector('tbody').innerHTML = html; 
        } catch(e) {
            document.getElementById('uid-table').querySelector('tbody').innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">è®€å–å¤±æ•—: ${e.message}</td></tr>`;
        }
    }

    async function editUID(oldUid, status) {
        if (status === 'activated' || status === 'sold') { return alert('âš ï¸ æ­¤æ¿¾ç¶²å·²ç¶“å‡ºè²¨æˆ–å•Ÿç”¨ï¼Œç‚ºä¿éšœè³‡æ–™åº«é—œè¯å®Œæ•´æ€§ï¼Œç¦æ­¢ä¿®æ”¹ UIDï¼'); }
        const newUid = prompt(`è«‹è¼¸å…¥æ–°çš„æ¢ç¢¼æµæ°´è™Ÿ (åŸï¼š${oldUid})\n\nâš ï¸ æ³¨æ„ï¼šæ ¼å¼å¿…é ˆç‚º HP- é–‹é ­`, oldUid);
        if (!newUid || newUid === oldUid) return;
        if (!newUid.match(/^HP-\d+$/)) return alert("âŒ ä¿®æ”¹å¤±æ•—ï¼šæ ¼å¼ä¸æ­£ç¢ºï¼Œå¿…é ˆç‚º HP- åŠ æ•¸å­—çµå°¾ã€‚");
        const { error } = await supabaseClient.from('filters_uid').update({ uid: newUid }).eq('uid', oldUid);
        if (error) alert("ä¿®æ”¹å¤±æ•—ï¼š" + error.message); else { alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); loadUIDs(); }
    }

    async function deleteUID(uid, status) {
        if (status === 'activated' || status === 'sold') { return alert('âš ï¸ æ””æˆªï¼æ­¤æ¿¾ç¶²å·²ç¶“å‡ºè²¨æˆ–è¢«è»Šä¸»å•Ÿç”¨ï¼Œç‚ºä¿éšœæ­·å²åˆç´„å®Œæ•´æ€§ï¼Œåš´ç¦åˆªé™¤ï¼\n(è‹¥éœ€ä½œå»¢è«‹èµ°é€€è²¨æµç¨‹)'); }
        if (!confirm(`ğŸ§¨ è­¦å‘Šï¼šç¢ºå®šè¦æ°¸ä¹…åˆªé™¤å°šæœªå‡ºè²¨çš„æµæ°´è™Ÿ [${uid}] å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) return;
        const { error } = await supabaseClient.from('filters_uid').delete().eq('uid', uid);
        if (error) alert("åˆªé™¤å¤±æ•—ï¼š" + error.message); else { alert("âœ… åˆªé™¤æˆåŠŸï¼"); loadUIDs(); }
    }

    let html5QrCode = null; let scanState = 'WAITING_UID'; let currentScanUid = ''; let isProcessingDB = false;    
    function playBeep() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gainNode = ctx.createGain(); osc.connect(gainNode); gainNode.connect(ctx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(1500, ctx.currentTime); gainNode.gain.setValueAtTime(0.1, ctx.currentTime); osc.start(); osc.stop(ctx.currentTime + 0.1); } catch(e){} }
    function playDingDong() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc1 = ctx.createOscillator(); const gain1 = ctx.createGain(); osc1.type = 'sine'; osc1.frequency.setValueAtTime(880, ctx.currentTime); gain1.gain.setValueAtTime(0.1, ctx.currentTime); osc1.connect(gain1); gain1.connect(ctx.destination); osc1.start(); osc1.stop(ctx.currentTime + 0.15); setTimeout(() => { const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.type = 'sine'; osc2.frequency.setValueAtTime(1108.73, ctx.currentTime); gain2.gain.setValueAtTime(0.1, ctx.currentTime); osc2.connect(gain2); gain2.connect(ctx.destination); osc2.start(); osc2.stop(ctx.currentTime + 0.3); }, 150); } catch(e){} }
    function playErrorBeep() { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gainNode = ctx.createGain(); osc.connect(gainNode); gainNode.connect(ctx.destination); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(300, ctx.currentTime); gainNode.gain.setValueAtTime(0.2, ctx.currentTime); osc.start(); osc.stop(ctx.currentTime + 0.4); } catch(e){} }

    function updateScanUI() {
        const hintEl = document.getElementById('camera-target-hint'); const uidInput = document.getElementById('scan-uid-input'); const orderInput = document.getElementById('scan-order-input'); const btnReset = document.getElementById('btn-reset-scan');
        if (scanState === 'WAITING_UID') {
            hintEl.innerHTML = `<span style="color:#00e676;">ğŸŸ¢ [ç¬¬ 1 æ­¥] è«‹å°æº–æ¿¾ç¶² UID æ¢ç¢¼ (HP-é–‹é ­)</span>`; uidInput.style.borderColor = '#00e676'; uidInput.style.color = '#00e676'; uidInput.disabled = false; orderInput.style.borderColor = '#555'; orderInput.style.color = '#555'; orderInput.disabled = true; document.getElementById('label-uid').style.color = '#00e676'; document.getElementById('label-order').style.color = '#aaa'; btnReset.style.display = 'none';
        } else {
            hintEl.innerHTML = `<span style="color:#FF9800;">ğŸŸ  [ç¬¬ 2 æ­¥] UID å·²é–å®šï¼Œè«‹å°æº– Shopline è¨‚å–®æ¢ç¢¼</span>`; uidInput.style.borderColor = '#555'; uidInput.style.color = '#555'; uidInput.disabled = true; orderInput.style.borderColor = '#FF9800'; orderInput.style.color = '#FF9800'; orderInput.disabled = false; document.getElementById('label-uid').style.color = '#aaa'; document.getElementById('label-order').style.color = '#FF9800'; btnReset.style.display = 'inline-block';
        }
    }

    function resetScanState() { scanState = 'WAITING_UID'; currentScanUid = ''; isProcessingDB = false; document.getElementById('scan-uid-input').value = ''; document.getElementById('scan-order-input').value = ''; document.getElementById('scan-status-msg').innerHTML = `<span style='color:#666;'>å·²é‡ç½®ï¼Œç­‰å¾…æƒæ</span>`; updateScanUI(); document.getElementById('scan-uid-input').focus(); }

    function startContinuousScanner() {
        document.getElementById('reader-container').style.display = 'block'; resetScanState();
        if (!html5QrCode) { html5QrCode = new Html5Qrcode("reader"); }
        if (html5QrCode.isScanning) return;
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 300, height: 120 } }, (decodedText, decodedResult) => { if (isProcessingDB) return; handleScannedText(decodedText.trim()); }, (errorMessage) => {}).catch((err) => { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•— âŒ\nè«‹ä½¿ç”¨æ‰‹æ©Ÿ Chrome/Safari é–‹å•Ÿï¼Œä¸¦å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚"); document.getElementById('reader-container').style.display = 'none'; });
    }

    function stopCamera() { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().then(() => { document.getElementById('reader-container').style.display = 'none'; }).catch(e => {}); } else { document.getElementById('reader-container').style.display = 'none'; } }
    function handleManualScan(e, type) { if (e.key === 'Enter') { if (isProcessingDB) return; handleScannedText(e.target.value.trim()); } }

    function handleScannedText(text) {
        if (scanState === 'WAITING_UID') {
            if (!text.match(/^HP-\d+$/)) return; 
            isProcessingDB = true; document.getElementById('scan-uid-input').value = text; document.getElementById('scan-status-msg').innerHTML = `<span style='color:#FF9800;'>ğŸ”„ é›²ç«¯é©—è­‰ UID ç‹€æ…‹ä¸­...</span>`;
            supabaseClient.from('filters_uid').select('status').eq('uid', text).maybeSingle().then(({data, error}) => {
                if (error || !data) { playErrorBeep(); document.getElementById('scan-status-msg').innerHTML = `<span style='color:red;'>âŒ éŒ¯èª¤ï¼šè³‡æ–™åº«æŸ¥ç„¡æ­¤ UID (${text})</span>`; setTimeout(() => { isProcessingDB = false; document.getElementById('scan-uid-input').value = ''; }, 1500); return; }
                if (data.status === 'sold' || data.status === 'activated') { playErrorBeep(); document.getElementById('scan-status-msg').innerHTML = `<span style='color:red;'>âŒ æ””æˆªï¼šæ­¤æ¿¾ç¶² (${text}) å·²ç¶“å‡ºè²¨æˆ–å•Ÿç”¨ï¼Œä¸å¯é‡è¤‡æƒæï¼</span>`; setTimeout(() => { isProcessingDB = false; document.getElementById('scan-uid-input').value = ''; }, 2000); return; }
                playBeep(); currentScanUid = text; scanState = 'WAITING_ORDER'; updateScanUI(); document.getElementById('scan-status-msg').innerHTML = `<span style='color:#00D100;'>ğŸ“Œ UID é©—è­‰æˆåŠŸï¼Œè«‹æƒæ Shopline è¨‚å–®...</span>`; setTimeout(() => { isProcessingDB = false; document.getElementById('scan-order-input').focus(); }, 500);
            });
        } else if (scanState === 'WAITING_ORDER') {
            if (text === currentScanUid || text.startsWith('HP-')) return;
            text = text.replace(/#/g, '').replace(/\s/g, ''); if (text.length < 8) return; 
            document.getElementById('scan-order-input').value = text; processOrderToCloud(text); 
        }
    }

    async function processOrderToCloud(orderPhone) {
        isProcessingDB = true; document.getElementById('scan-status-msg').innerHTML = "<span style='color:#FF9800;'>ğŸ”„ é›™æ¢ç¢¼æ¯”å°ä¸¦å¯«å…¥é›²ç«¯ä¸­...</span>";
        const uidToProcess = currentScanUid;
        const { data: user } = await supabaseClient.from('users').select('line_uid, name').eq('phone', orderPhone).maybeSingle();
        let isOldCustomer = !!user; let customerLabel = isOldCustomer ? `<span style="color:#00D100; font-weight:bold;">ğŸŸ¢ èˆŠå®¢ (${user.name})</span>` : `<span style="color:#FF9800; font-weight:bold;">ğŸŸ  æœªç¶å®š</span>`;
        const updatePayload = { status: 'sold', shopline_order_id: orderPhone };
        if (isOldCustomer) { updatePayload.activated_by_uid = user.line_uid; }
        const { error } = await supabaseClient.from('filters_uid').update(updatePayload).eq('uid', uidToProcess);
        if (!error) {
            playDingDong(); 
            const logHtml = `<tr id="row-${uidToProcess}"> <td style="font-family:monospace; font-size:16px;"><b>${uidToProcess}</b></td> <td id="order-${uidToProcess}" style="font-family:monospace;">${orderPhone}</td> <td>${customerLabel}</td> <td style="color:#00D100; font-weight:bold;">âœ… å‡ºè²¨å®Œæˆ</td> <td style="font-size:12px; color:#888;">${new Date().toLocaleTimeString('zh-TW', {timeZone: 'Asia/Taipei'})}</td> <td><button class="btn" style="background:#333; color:#fff; padding:6px 12px; font-size:12px;" onclick="editDispatchRecord('${uidToProcess}', '${orderPhone}')">âœï¸ ä¿®æ”¹</button></td> </tr>`;
            document.getElementById('dispatch-log-tbody').insertAdjacentHTML('afterbegin', logHtml); document.getElementById('scan-status-msg').innerHTML = `<span style="color:#00D100;">âœ”ï¸ å®å™¹ï¼[${uidToProcess}] å¯«å…¥æˆåŠŸï¼Œè«‹ç›´æ¥æƒä¸‹ä¸€ç‰‡ã€‚</span>`;
            if (isOldCustomer) await supabaseClient.from('user_logs').insert([{ user_uid: user.line_uid, action: 'ğŸ“¦ ç¸½éƒ¨å‡ºè²¨', details: `å·²å‡ºè²¨æ¿¾ç¶²ï¼š${uidToProcess} (å–®è™Ÿ:${orderPhone})` }]);
        } else { playErrorBeep(); document.getElementById('scan-status-msg').innerHTML = `<span style="color:red;">âŒ å¯«å…¥å¤±æ•—ï¼š${error.message}</span>`; }
        resetScanState();
    }

    async function editDispatchRecord(uid, oldOrder) {
      const newOrder = prompt(`ä¿®æ”¹æ¿¾ç¶² UID [${uid}] çš„ç¶å®šå–®è™Ÿï¼š\nè«‹è¼¸å…¥æ–°çš„è¨‚å–®æˆ–æ‰‹æ©Ÿè™Ÿç¢¼ï¼š`, oldOrder);
      if (newOrder !== null && newOrder.trim() !== '' && newOrder !== oldOrder) {
         const finalOrder = newOrder.trim(); const { error } = await supabaseClient.from('filters_uid').update({ shopline_order_id: finalOrder }).eq('uid', uid);
         if (error) { alert("ä¿®æ”¹å¤±æ•—ï¼š" + error.message); } else { alert(`âœ… ä¿®æ”¹æˆåŠŸï¼\nUID ${uid} å·²é‡æ–°ç¶å®šè‡³å–®è™Ÿï¼š${finalOrder}`); document.getElementById(`order-${uid}`).innerText = finalOrder; const btn = document.querySelector(`#row-${uid} button`); if(btn) btn.setAttribute('onclick', `editDispatchRecord('${uid}', '${finalOrder}')`); }
      }
    }

    function loadAlgorithmParams() {
      const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
      if (params.baseWear) document.getElementById('param-base-wear').value = params.baseWear;
      if (params.basePm25) document.getElementById('param-base-pm25').value = params.basePm25;
      if (params.weightRed) document.getElementById('param-weight-red').value = params.weightRed;
      if (params.weightOrange) document.getElementById('param-weight-orange').value = params.weightOrange;
      if (params.weightTemp) document.getElementById('param-weight-temp').value = params.weightTemp;
      if (params.paHypass) document.getElementById('param-pa-hypass').value = params.paHypass;
      if (params.paOther) document.getElementById('param-pa-other').value = params.paOther;
      if (params.kwhPerDay) document.getElementById('param-kwh-day').value = params.kwhPerDay;
      if (params.co2Factor) document.getElementById('param-co2-factor').value = params.co2Factor;
      if (params.updateInterval) document.getElementById('param-update-interval').value = params.updateInterval;
      if (params.autoPushRed !== undefined) document.getElementById('param-auto-push-red').value = params.autoPushRed;
      if (params.aqiMode !== undefined) document.getElementById('param-aqi-mode').value = params.aqiMode;
    }

    function saveAlgorithmParams() {
      const params = {
        baseWear: document.getElementById('param-base-wear').value, basePm25: document.getElementById('param-base-pm25').value, weightRed: document.getElementById('param-weight-red').value, weightOrange: document.getElementById('param-weight-orange').value, weightTemp: document.getElementById('param-weight-temp').value, paHypass: document.getElementById('param-pa-hypass').value, paOther: document.getElementById('param-pa-other').value, kwhPerDay: document.getElementById('param-kwh-day').value, co2Factor: document.getElementById('param-co2-factor').value, updateInterval: document.getElementById('param-update-interval').value, autoPushRed: document.getElementById('param-auto-push-red').value, aqiMode: document.getElementById('param-aqi-mode').value
      };
      localStorage.setItem('hypass_algo_params', JSON.stringify(params)); alert(`âœ… æ¼”ç®—æ³•æ ¸å¿ƒèˆ‡è‡ªå‹•åŒ–åƒæ•¸å·²æˆåŠŸæ›´æ–°ä¸¦ç™¼å¸ƒï¼`); renderMonitorTable(fullMonitorData);
    }

    // ğŸŒŸ ä¿®å¾©æ ¸å¿ƒï¼šå¼·åˆ¶å¤¾å¸¶ API é‡‘é‘°é€šè¡Œè­‰èˆ‡é˜²æ­¢å¿«å–çš„äº‚æ•¸
    async function forceUpdateCache() { 
        const btn = document.getElementById('btn-force-update'); 
        btn.innerText = 'â³ 368é„‰é®å¤§æ•¸æ“šæŠ“å–ä¸­ (ç´„ 40 ç§’)...'; 
        btn.disabled = true; 
        
        try { 
            const cacheBuster = new Date().getTime(); // åˆºç©¿å¿«å–æ©Ÿåˆ¶
            const res = await fetch(`https://qznvabjtxcbffjryfgqi.supabase.co/functions/v1/webhook?action=update_cache&t=${cacheBuster}`, { 
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${ANON_KEY}`,
                    'Content-Type': 'application/json'
                }
            }); 
            if (res.ok) { 
                alert('âœ… å…¨å° 368 é„‰é®å¿«å–æ± æ›´æ–°æˆåŠŸï¼'); 
                loadMonitor(); 
            } else { 
                alert('âš ï¸ æ°£è±¡å±€é€£ç·šé€¾æ™‚æˆ–é­æ‹’çµ•ï¼Œè«‹ç¢ºèª Webhook éƒ¨ç½²ç‹€æ…‹ã€‚'); 
                loadMonitor(); 
            } 
        } catch (e) { 
            alert('å‘¼å«å¤±æ•—ï¼š' + e.message); 
        } finally { 
            btn.innerText = 'âš¡ å¼·åˆ¶é‡æ–°æŠ“å– (ç´„40ç§’)'; 
            btn.disabled = false; 
        } 
    }

    async function loadMonitor() { try { const { data, error } = await supabaseClient.from('env_cache').select('*').limit(400).order('aqi', { ascending: false }); if(error) throw new Error(error.message); if (data) { fullMonitorData = data; renderTop10(fullMonitorData); renderMonitorTable(fullMonitorData); loadAlgorithmParams(); } } catch(e) { document.getElementById('monitor-table').querySelector('tbody').innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">è®€å–å¤±æ•—: ${e.message}</td></tr>`; } }
    
    function renderTop10(data) {
      if (!data || data.length === 0) return; const top10 = [...data].sort((a, b) => b.aqi - a.aqi).slice(0, 10);
      let html = `<table style="margin-top:0; font-size:13px; background:#fff;"><thead><tr><th>æ’å</th><th>ç¸£å¸‚é„‰é®</th><th>AQI æŒ‡æ•¸</th><th>PM2.5</th></tr></thead><tbody>`;
      top10.forEach((d, idx) => { let color = d.aqi > 150 ? '#d32f2f' : (d.aqi > 100 ? '#f57c00' : '#333'); let icon = idx === 0 ? 'ğŸ‘‘' : (idx < 3 ? 'ğŸ”¥' : 'âš ï¸'); let rankStyle = idx < 3 ? 'background:#d32f2f; color:#fff; padding:2px 8px; border-radius:10px;' : 'color:#555; font-weight:bold;'; html += `<tr><td><span style="${rankStyle}">${idx + 1}</span></td><td style="font-weight:bold;">${d.city} ${d.district}</td><td style="color:${color}; font-weight:bold; font-size:16px;">${d.aqi} ${icon}</td><td style="color:#555;">${d.pm25}</td></tr>`; });
      html += '</tbody></table>'; document.getElementById('top10-container').innerHTML = html;
    }
    
    function renderMonitorTable(dataToRender) {
      let html = ''; document.getElementById('monitor-count').innerText = `å…± ${dataToRender.length} ç­†è³‡æ–™`; const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}'); const wRed = parseFloat(params.weightRed || 1.8); const wOrange = parseFloat(params.weightOrange || 1.4);
      dataToRender.forEach(d => {
        let temp = d.temp !== null ? d.temp : '--'; let hum = d.hum !== null ? d.hum : '--'; let aqi = d.aqi !== null ? d.aqi : 50; let weightText = 'æ¨™æº–è€—æ'; let wColor = '#555'; let marketing = '<span style="color:#666;">å¸¸è¦ç™¼é€ä¿é¤Šæé†’</span>'; let dynamicWeight = 1.0;
        if (aqi > 150) { dynamicWeight = wRed + ((aqi - 150) / 50) * 0.5; weightText = 'åš´é‡è€—æ'; wColor = '#d32f2f'; marketing = '<span style="color:#d32f2f; font-weight:bold;">ğŸ”¥ å»ºè­°æ¨æ’­ç´«çˆ†é˜²è­·å»£å‘Š</span>'; } else if (aqi > 100) { dynamicWeight = wOrange + ((aqi - 100) / 50) * (wRed - wOrange); weightText = 'åŠ é€Ÿè€—æ'; wColor = '#f57c00'; marketing = '<span style="color:#f57c00; font-weight:bold;">âš ï¸ é©åˆä¸»æ¨é™¤è‡­å‡ç´šç‰ˆ</span>'; } else if (aqi > 50) { dynamicWeight = 1.0 + ((aqi - 50) / 50) * (wOrange - 1.0); weightText = 'ä¸€èˆ¬è€—æ'; wColor = '#555'; } else { dynamicWeight = 0.8 + (aqi / 50) * 0.2; weightText = 'æ¸›ç·©è€—æ'; wColor = '#388e3c'; marketing = '<span style="color:#388e3c;">ğŸƒ é©åˆæ¨å»£çœç¢³æˆå°±æ´»å‹•</span>'; }
        let aqiColor = aqi > 150 ? '#d32f2f' : (aqi > 100 ? '#f57c00' : (aqi <= 50 ? '#388e3c' : '#333'));
        html += `<tr><td style="font-weight:bold;">${d.city} ${d.district}</td><td style="color:#1976d2; font-weight:bold; font-size:15px;">${temp}Â°C <span style="color:#888; font-size:12px; font-weight:normal;">/ ${hum}%</span></td><td style="color:${aqiColor}; font-weight:bold; font-size:18px;">${aqi}</td><td>${d.pm25 !== null ? d.pm25 : '--'}</td><td style="color:${wColor}; font-weight:bold; font-size:15px;">${dynamicWeight.toFixed(2)} å€ <span style="font-size:11px; color:#888;">(${weightText})</span></td><td style="background:#fafffa;">${marketing}</td><td style="font-size:12px; font-family:monospace; color:#888;">${formatTaipeiTime(d.updated_at)}</td></tr>`;
      });
      document.getElementById('monitor-table').querySelector('tbody').innerHTML = html;
    }
    
    function filterMonitorTable() { const keyword = document.getElementById('monitor-search').value.trim().toLowerCase(); if (!keyword) { renderMonitorTable(fullMonitorData); return; } const filtered = fullMonitorData.filter(d => (d.city && d.city.toLowerCase().includes(keyword)) || (d.district && d.district.toLowerCase().includes(keyword))); renderMonitorTable(filtered); }
    

    async function loadPushRules() { try { const { data, error } = await supabaseClient.from('notification_rules').select('*').order('id', { ascending: true }); if(error) throw new Error(error.message); let html = ''; if (data) { data.forEach(r => { let safeMessage = r.message_template.replace(/'/g, "\\'").replace(/"/g, "&quot;"); html += `<tr><td><span style="background:#e3f2fd; color:#1976d2; padding:4px; border-radius:4px; font-size:12px;">${r.category}</span></td><td style="font-weight:bold;">${r.rule_name}</td><td style="color:#888; font-family:monospace;">${r.trigger_condition}</td><td>${r.message_template}</td><td>${r.is_active ? '<span style="color:green; font-weight:bold;">ğŸŸ¢ å•Ÿç”¨</span>' : '<span style="color:red;">ğŸ”´ åœç”¨</span>'}</td><td><button class="btn" style="padding: 6px 10px; font-size:12px; background:#333; color:#00D100;" onclick="openEditModal(${r.id}, '${r.rule_name}', '${safeMessage}', ${r.is_active})">âœï¸ ç·¨è¼¯</button></td></tr>`; }); } document.getElementById('push-table').querySelector('tbody').innerHTML = html; } catch(e) { document.getElementById('push-table').querySelector('tbody').innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">è®€å–å¤±æ•—: ${e.message}</td></tr>`; } }
    function openEditModal(id, ruleName, message, isActive) { document.getElementById('edit-rule-id').value = id; document.getElementById('edit-title').innerText = `ç·¨è¼¯ï¼š${ruleName}`; document.getElementById('edit-message').value = message; document.getElementById('edit-status').value = isActive ? "true" : "false"; document.getElementById('edit-modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    async function savePushRule() { const id = document.getElementById('edit-rule-id').value; const newMessage = document.getElementById('edit-message').value; const newStatus = document.getElementById('edit-status').value === "true"; if (!newMessage.trim()) return alert("æ–‡æ¡ˆå…§å®¹ä¸å¯ç‚ºç©ºï¼"); const { error } = await supabaseClient.from('notification_rules').update({ message_template: newMessage, is_active: newStatus }).eq('id', id); if (error) alert("å„²å­˜å¤±æ•—ï¼š" + error.message); else { alert("âœ… å„²å­˜æˆåŠŸï¼"); closeModal(); loadPushRules(); } }

    async function loadESG() { try { const { data, error } = await supabaseClient.from('filters_uid').select('activated_at').eq('status', 'activated'); if(error) throw new Error(error.message); if (data) { let totalDays = 0; data.forEach(d => { if (d.activated_at) totalDays += Math.max(0, Math.floor((new Date() - new Date(d.activated_at)) / (1000 * 60 * 60 * 24))); }); document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString(); document.getElementById('esg-co2').innerText = (totalDays * 0.15).toFixed(1); document.getElementById('esg-active').innerText = data.length; } } catch(e) {} }
    
    async function loadStats() { try { const { data: users } = await supabaseClient.from('users').select('city').eq('role', 'customer'); if (users) { document.getElementById('stat-total-users').innerText = users.length; const cityCounts = {}; users.forEach(u => { const c = u.city || 'æœªå¡«å¯«'; cityCounts[c] = (cityCounts[c] || 0) + 1; }); let userHtml = ''; Object.entries(cityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { userHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#00D100;">${count} äºº</td></tr>`; }); document.getElementById('stat-users-city').querySelector('tbody').innerHTML = userHtml; } const { data: garages } = await supabaseClient.from('garages').select('city').eq('status', 'active'); if (garages) { document.getElementById('stat-total-garages').innerText = garages.length; const gCityCounts = {}; garages.forEach(g => { const c = g.city || 'æœªå¡«å¯«'; gCityCounts[c] = (gCityCounts[c] || 0) + 1; }); let garageHtml = ''; Object.entries(gCityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { garageHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#FF9800;">${count} å®¶</td></tr>`; }); document.getElementById('stat-garages-city').querySelector('tbody').innerHTML = garageHtml; } } catch(e){} }
    
    async function loadGarages() { try { const { data, error } = await supabaseClient.from('garages').select('*').order('created_at', { ascending: false }); if(error) throw new Error(error.message); let html = ''; if (data) { data.forEach(g => { let action = g.status === 'pending' ? `<button class="btn" onclick="approveGarage(${g.id})">æ ¸å‡†é–‹é€š</button>` : (g.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist(${g.id}, false, 'garages')">è§£é™¤åœæ¬Š</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist(${g.id}, true, 'garages')">å¼·åˆ¶åœæ¬Š</button>`); html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${g.contact_name}</td><td>${g.status==='pending' ? 'å¾…å¯©æ ¸' : 'ç‡Ÿæ¥­ä¸­'}</td><td>${action}</td></tr>`; }); } document.getElementById('garage-table').querySelector('tbody').innerHTML = html; } catch(e) { document.getElementById('garage-table').querySelector('tbody').innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">è®€å–å¤±æ•—: ${e.message}</td></tr>`; } }
    async function approveGarage(id) { await supabaseClient.from('garages').update({ status: 'active' }).eq('id', id); loadGarages(); }
    async function toggleBlacklist(id, isBlack, table) { if (table === 'users') { await supabaseClient.from('users').update({ is_blacklisted: isBlack }).eq('line_uid', id); } else { await supabaseClient.from('garages').update({ is_blacklisted: isBlack }).eq('id', id); } table === 'users' ? loadCRM() : loadGarages(); }
    
    async function loadRewards() { try { const { data, error } = await supabaseClient.from('rewards').select('*, users(name, phone)').eq('type', 'redeem').eq('status', 'pending'); if(error) throw new Error(error.message); let html = ''; if (data) { data.forEach(r => { html += `<tr><td>${r.users.name}</td><td>å…Œæ› 100 é»</td><td>${formatTaipeiTime(r.created_at)}</td><td><button class="btn" onclick="completeReward(${r.id})">âœ… çµæ¡ˆ</button></td></tr>`; }); } document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç„¡è³‡æ–™</td></tr>'; } catch(e) { document.getElementById('reward-table').querySelector('tbody').innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">è®€å–å¤±æ•—: ${e.message}</td></tr>`; } }
    async function completeReward(id) { await supabaseClient.from('rewards').update({ status: 'completed' }).eq('id', id); alert('å·²çµæ¡ˆï¼'); loadRewards(); }

    loadESG();
  </script>
</body>
</html>
