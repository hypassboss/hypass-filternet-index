<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V5.7 ç¸½éƒ¨æˆ°æƒ…å®¤ (ä¸Šå¸æ¨¡å¼ç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; position: sticky; top: 0;}
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; }
    .btn-danger { background: #ff4444; color: #fff; }
    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; align-items: flex-start; }
    .scan-input { width: 100%; padding: 18px; font-size: 22px; border-radius: 5px; background: #000; color: #00D100; font-family: monospace; text-align: center;}
    #reader-container { width: 100%; margin-bottom: 20px; display: none; background:#111; padding:15px; border-radius:12px; text-align:center; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div style="padding-top: 20px;"><h2 style="color:#00D100; padding: 0 20px; margin-bottom: 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn active" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel">
      <h2>ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
      <button class="btn" style="background:#1976d2; color:#fff; font-size:16px; padding:10px 20px;" onclick="startContinuousScanner()">ğŸš€ å•Ÿå‹•ç„¡é–“æ–·ç›¸æ©Ÿ</button>
      <div id="reader-container"><div id="reader" style="width:300px; margin:0 auto;"></div><button class="btn btn-danger" style="margin-top:10px;" onclick="stopCamera()">é—œé–‰ç›¸æ©Ÿ</button></div>
      <div class="scan-container">
        <div style="flex:1;"><label style="color:#aaa;">1. æƒæ UID</label><input type="text" id="scan-uid-input" class="scan-input" onkeypress="handleScan(event, 'uid')"></div>
        <div style="flex:1;"><label style="color:#aaa;">2. æƒæ Shopline è¨‚å–®</label><input type="text" id="scan-order-input" class="scan-input" disabled onkeypress="handleScan(event, 'order')"></div>
      </div>
      <h3 id="scan-status-msg" style="color:#333; margin-top:15px;">ç­‰å¾…æƒæ...</h3>
    </div>

    <div id="panel-crm" class="panel active">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ç‰ˆ)</h2>
      <table id="crm-table"><thead><tr><th>å®¢æˆ¶è³‡è¨Š</th><th>è»Šè¼›</th><th>åœ°å€</th><th>çµ±è¨ˆ</th><th>ä¸Šå¸æ¨¡å¼æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ UID åº«å­˜ç®¡ç†</h2>
      <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ ç”¢ç”Ÿ 50 çµ„æ–° UID</button>
      <table id="uid-table"><thead><tr><th>UID</th><th>ç‹€æ…‹</th><th>æ“æœ‰è€…</th><th>å•Ÿç”¨æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>ç”³è«‹æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); btn.classList.add('active');
      if (id === 'crm') loadCRM(); if (id === 'uid') loadUIDs(); if (id === 'rewards') loadRewards();
    }

    // ğŸŒŸ CRM æ¥µé€Ÿè®€å–èˆ‡ä¸Šå¸æ¨¡å¼
    async function loadCRM() {
      document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr>';
      const [resUsers, resFilters, resBookings] = await Promise.all([
          supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false }),
          supabaseClient.from('filters_uid').select('activated_by_uid'),
          supabaseClient.from('bookings').select('user_uid')
      ]);
      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });
      let bCounts = {}; resBookings.data?.forEach(b => { if(b.user_uid) bCounts[b.user_uid] = (bCounts[b.user_uid] || 0) + 1; });

      let html = '';
      resUsers.data?.forEach(u => {
          html += `<tr>
            <td><div style="font-weight:bold; color:#1976d2;">${u.name}</div><div style="font-size:12px; color:#666;">${u.phone}</div></td>
            <td><b>${u.car_brand}</b><br><span style="color:#FF9800;">${u.license_plate}</span></td>
            <td>${u.city}${u.district}</td>
            <td>å•Ÿç”¨: ${pCounts[u.line_uid]||0} | é ç´„: ${bCounts[u.line_uid]||0}</td>
            <td style="text-align:center;">
              <button class="btn" style="background:#444; color:#fff; font-size:11px; padding:4px 8px;" onclick="godModeEdit('${u.line_uid}', '${u.name}')">âœï¸ ä¿®æ”¹</button>
              <button class="btn btn-danger" style="font-size:11px; padding:4px 8px; margin-top:4px;" onclick="godModeDelete('${u.line_uid}', '${u.name}')">ğŸ—‘ï¸ åˆªé™¤</button>
            </td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDelete(uid, name) {
        const pwd = prompt(`âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡æ°¸ä¹…åˆªé™¤å®¢æˆ¶ã€${name}ã€‘çš„è³‡æ–™ã€‚\nè«‹è¼¸å…¥æœ€é«˜æ¬Šé™å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");
        if (confirm(`æœ€çµ‚ç¢ºèªï¼šç¢ºå®šåˆªé™¤ã€${name}ã€‘å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼`)) {
            await supabaseClient.from('filters_uid').update({ activated_by_uid: null }).eq('activated_by_uid', uid);
            const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
            if (error) alert("åˆªé™¤å¤±æ•—ï¼š" + error.message); else { alert("âœ… å·²å¾¹åº•éŠ·æ¯€ï¼"); loadCRM(); }
        }
    }

    async function godModeEdit(uid, currentName) {
        const pwd = prompt(`ğŸ› ï¸ é€²å…¥ä¿®æ”¹æ¨¡å¼ã€‚\nè«‹è¼¸å…¥æœ€é«˜æ¬Šé™å¯†ç¢¼ï¼š`);
        if (pwd !== "hypass888") return alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼");
        const newPhone = prompt(`è¼¸å…¥æ–°æ‰‹æ©Ÿè™Ÿç¢¼ (ç•™ç©ºä¸ä¿®æ”¹)ï¼š`);
        const newPlate = prompt(`è¼¸å…¥æ–°è»Šç‰Œè™Ÿç¢¼ (ç•™ç©ºä¸ä¿®æ”¹)ï¼š`);
        let updates = {}; if (newPhone) updates.phone = newPhone; if (newPlate) updates.license_plate = newPlate;
        if (Object.keys(updates).length > 0) {
            await supabaseClient.from('users').update(updates).eq('line_uid', uid); alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); loadCRM();
        }
    }

    // UID ç”Ÿæˆèˆ‡å‡ºè²¨
    async function loadUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
        let html = '';
        if(data) data.forEach(d => { 
            html += `<tr><td><b>${d.uid}</b></td><td>${d.status}</td><td>${d.users?.name||'-'}</td><td>${d.activated_at||'-'}</td>
            <td><button class="btn btn-danger" style="padding:4px;" onclick="deleteUID('${d.uid}', '${d.status}')">åˆªé™¤</button></td></tr>`; 
        });
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }
    async function deleteUID(uid, status) {
        if(status !== 'produced') return alert("å·²å‡ºè²¨æˆ–å•Ÿç”¨ï¼Œä¸å¯åˆªé™¤ï¼");
        if(confirm(`åˆªé™¤ ${uid} ?`)) { await supabaseClient.from('filters_uid').delete().eq('uid', uid); loadUIDs(); }
    }
    async function generateSequentialUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0;
        let ins = []; for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); alert("âœ… æˆåŠŸç”¢ç”Ÿ 50 çµ„ï¼"); loadUIDs();
    }

    let scanState = 'uid'; let curUid = '';
    function handleScan(e, type) {
        if (e.key === 'Enter') {
            const text = e.target.value.trim();
            if (type === 'uid' && text.startsWith('HP-')) {
                curUid = text; scanState = 'order'; document.getElementById('scan-status-msg').innerText = "âœ… UID OKï¼Œè«‹æƒæè¨‚å–®";
                document.getElementById('scan-uid-input').disabled = true; document.getElementById('scan-order-input').disabled = false; document.getElementById('scan-order-input').focus();
            } else if (type === 'order' && text.length > 5) {
                processOrder(curUid, text);
            }
        }
    }
    async function processOrder(uid, order) {
        document.getElementById('scan-status-msg').innerText = "ğŸ”„ å¯«å…¥ä¸­...";
        const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', order).maybeSingle();
        const payload = { status: 'sold', shopline_order_id: order };
        if(user) payload.activated_by_uid = user.line_uid;
        await supabaseClient.from('filters_uid').update(payload).eq('uid', uid);
        document.getElementById('scan-status-msg').innerHTML = `<span style="color:green;">âœ… ${uid} å‡ºè²¨æˆåŠŸï¼ç›´æ¥æƒä¸‹ä¸€ç‰‡UID</span>`;
        document.getElementById('scan-uid-input').value = ''; document.getElementById('scan-order-input').value = '';
        document.getElementById('scan-uid-input').disabled = false; document.getElementById('scan-order-input').disabled = true; document.getElementById('scan-uid-input').focus();
    }

    async function loadRewards() {
        const { data } = await supabaseClient.from('rewards').select('*, users(name)').eq('type', 'redeem').eq('status', 'pending');
        let html = ''; if(data) data.forEach(r => { html += `<tr><td>${r.users?.name}</td><td>å…Œæ› 100 é»</td><td>${r.created_at}</td><td><button class="btn" onclick="approveReward(${r.id})">âœ… çµæ¡ˆ</button></td></tr>`; });
        document.getElementById('reward-table').querySelector('tbody').innerHTML = html;
    }
    async function approveReward(id) { await supabaseClient.from('rewards').update({status:'completed'}).eq('id',id); alert("å·²ç™¼æ”¾ï¼"); loadRewards(); }

    loadCRM();
  </script>
</body>
</html>
