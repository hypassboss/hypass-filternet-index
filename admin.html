<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V4.0 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; position: sticky; top: 0; z-index: 2;}
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; transition: background 0.2s; }
    .btn:hover { background: #00b300; }
    
    .param-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 6px;}
    .param-group label { font-size: 13px; color: #555; font-weight: bold; }
    .param-group input { width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-family: monospace; font-size: 14px;}
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 20px;">
      <h2 style="color:#00D100; padding: 0 20px; border:none; margin-bottom: 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn active" onclick="switchTab('esg', this)">ğŸŒ ESG æˆ°æƒ…å®¤</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•èˆ‡å¤§æ•¸æ“šç›£æ§</button>
    </div>
    <div style="margin-top: auto; padding: 20px; color: #666; font-size: 12px; font-family: monospace; border-top: 1px solid #222;">System Ver.<br><strong style="color: #00D100; font-size: 14px;">V4.0-åœ‹éš›ç²¾å“ç‰ˆ</strong></div>
  </div>

  <div class="main-content">
    <div id="panel-esg" class="panel active"><h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2><p>æ•¸æ“šè¼‰å…¥ä¸­...</p></div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸èˆ‡å…¨å°ç©ºæ±™å¤§æ•¸æ“š</h2>
      
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fafafa;">
          <h3 style="margin-top: 0; color: #1976d2; display:flex; align-items:center; gap:8px;">ğŸ§  ç”Ÿå‘½é€±æœŸèˆ‡ ESG æ¼”ç®—æ³•åƒæ•¸</h3>
          
          <h4 style="margin: 15px 0 5px 0; color:#333; font-size:14px;">â–å‹•æ…‹å£½å‘½èˆ‡ç©ºæ°£æ¬Šé‡</h4>
          <div class="param-group"><label>åŸºæº–æ¯æ—¥è€—æç‡ (%)</label><input type="number" step="0.01" id="param-base-wear" value="0.27"></div>
          <div class="param-group"><label>åŸºæº– PM2.5 æ””æˆªé‡ (Âµg)</label><input type="number" id="param-base-pm25" value="1250"></div>
          <div class="param-group"><label>ğŸ”´ ç´«çˆ†åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-red" value="1.8"></div>
          <div class="param-group"><label>ğŸŸ  æ©˜å®³åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-orange" value="1.4"></div>
          
          <h4 style="margin: 20px 0 5px 0; color:#2e7d32; font-size:14px;">â–ESG èˆ‡ææ–™ç‰©ç†ç‰¹æ€§</h4>
          <div class="param-group"><label>HYPASS æ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-hypass" value="4"></div>
          <div class="param-group"><label>ä»–ç‰Œæ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-other" value="8"></div>
          <div class="param-group"><label>æ¯æ—¥åŸºæº–çœé›» (kWh)</label><input type="number" step="0.01" id="param-kwh-day" value="0.25"></div>
          <div class="param-group"><label>ç¢³æ’è½‰æ›ä¿‚æ•¸ (kg/kWh)</label><input type="number" step="0.1" id="param-co2-factor" value="0.5"></div>
          
          <button class="btn" style="width:100%; margin-top:15px; background:#1976d2; color:#fff;" onclick="saveAlgorithmParams()">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥è‡³å‰å°</button>
        </div>

        <div style="flex: 1.2; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; background: #fffafb;">
          <h3 style="margin-top: 0; color: #d32f2f;">ğŸš¨ å…¨å°å³æ™‚ 10 å¤§ç©ºæ±™é‡ç½å€</h3>
          <p style="font-size:12px; color:#666;">(è‹¥åªæœ‰1ç­†ï¼Œè«‹é»æ“Šä¸‹æ–¹å¼·åˆ¶æŠ“å–æŒ‰éˆ•)</p>
          <div id="top10-container">è®€å–ä¸­...</div>
        </div>
      </div>
      
      <h3 style="border-top:2px solid #eee; padding-top:20px; margin-bottom:15px; display:flex; justify-content:space-between;">
        <span>ğŸŒ å°ç£ 368 é„‰é®å¸‚å€ç’°å¢ƒå¿«å–æ± </span>
        <button class="btn" id="btn-force-update" style="background: #333; color: #fff; font-size: 14px;" onclick="forceUpdateCache()">âš¡ å¼·åˆ¶é‡æ–°æŠ“å– 368 é„‰é® (ç´„éœ€40ç§’)</button>
      </h3>
      <div style="height: 350px; overflow-y: auto; border: 1px solid #eee;">
        <table id="monitor-table" style="margin-top: 0;">
          <thead><tr><th>ç¸£å¸‚é„‰é®</th><th>æº«æ¿•åº¦</th><th>AQI</th><th>PM2.5</th><th>è€—æå€ç‡</th><th>æœ€å¾Œæ›´æ–°æ™‚é–“ (å°åŒ—)</th></tr></thead>
          <tbody><tr><td colspan="6" style="text-align:center;">è®€å–ä¸­...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    // ğŸŒŸ å°åŒ—æ™‚å€æ ¼å¼åŒ–å·¥å…·
    function formatTaipeiTime(dateString) {
      if (!dateString) return '-';
      const options = { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      return new Date(dateString).toLocaleString('zh-TW', options);
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active');
      btn.classList.add('active');
      if (id === 'monitor') { loadMonitor(); loadAlgorithmParams(); }
    }

    function loadAlgorithmParams() {
      const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
      if (params.baseWear) document.getElementById('param-base-wear').value = params.baseWear;
      if (params.weightRed) document.getElementById('param-weight-red').value = params.weightRed;
      if (params.weightOrange) document.getElementById('param-weight-orange').value = params.weightOrange;
      if (params.paHypass) document.getElementById('param-pa-hypass').value = params.paHypass;
      if (params.paOther) document.getElementById('param-pa-other').value = params.paOther;
      if (params.kwhPerDay) document.getElementById('param-kwh-day').value = params.kwhPerDay;
      if (params.co2Factor) document.getElementById('param-co2-factor').value = params.co2Factor;
    }

    function saveAlgorithmParams() {
      const params = {
        baseWear: document.getElementById('param-base-wear').value,
        basePm25: document.getElementById('param-base-pm25').value,
        weightRed: document.getElementById('param-weight-red').value,
        weightOrange: document.getElementById('param-weight-orange').value,
        paHypass: document.getElementById('param-pa-hypass').value,
        paOther: document.getElementById('param-pa-other').value,
        kwhPerDay: document.getElementById('param-kwh-day').value,
        co2Factor: document.getElementById('param-co2-factor').value
      };
      localStorage.setItem('hypass_algo_params', JSON.stringify(params));
      alert(`âœ… æ¼”ç®—æ³•æ ¸å¿ƒåƒæ•¸å·²æˆåŠŸæ›´æ–°ï¼`);
      loadMonitor();
    }

    async function forceUpdateCache() {
      const btn = document.getElementById('btn-force-update');
      btn.innerText = 'â³ 368é„‰é®å¤§æ•¸æ“šæŠ“å–ä¸­ (è«‹è€å¿ƒç­‰å¾…ç´„ 40 ç§’)...';
      btn.disabled = true;
      try {
        const res = await fetch('https://qznvabjtxcbffjryfgqi.supabase.co/functions/v1/webhook?action=update_cache', { method: 'POST' });
        if (res.ok) { alert('âœ… å…¨å° 368 é„‰é®å¿«å–æ± æ›´æ–°æˆåŠŸï¼'); loadMonitor(); }
        else { alert('âš ï¸ æ°£è±¡å±€é€£ç·šé€¾æ™‚ï¼Œä½†å·²æŠ“å–éƒ¨åˆ†è³‡æ–™ï¼Œè«‹é‡æ•´ç•«é¢ã€‚'); loadMonitor(); }
      } catch (e) { alert('å‘¼å«å¤±æ•—ï¼š' + e.message); } 
      finally { btn.innerText = 'âš¡ å¼·åˆ¶é‡æ–°æŠ“å– 368 é„‰é®'; btn.disabled = false; }
    }

    async function loadMonitor() {
      const { data } = await supabaseClient.from('env_cache').select('*').limit(400).order('aqi', { ascending: false });
      if (data) {
        // æ¸²æŸ“ 368 åˆ—è¡¨ (å¥—ç”¨å°åŒ—æ™‚é–“)
        let html = ''; 
        data.forEach(d => { 
          let w = d.aqi>150?'1.8å€':(d.aqi>100?'1.4å€':'1.0å€');
          html += `<tr><td>${d.city}${d.district}</td><td>${d.temp}Â°C / ${d.hum}%</td><td><b>${d.aqi}</b></td><td>${d.pm25}</td><td>${w}</td><td style="font-family:monospace; color:#888;">${formatTaipeiTime(d.updated_at)}</td></tr>`; 
        });
        document.getElementById('monitor-table').querySelector('tbody').innerHTML = html;
        
        // æ¸²æŸ“ Top 10
        let top10Html = '<table style="font-size:13px;"><thead><tr><th>æ’å</th><th>åœ°å€</th><th>AQI</th></tr></thead><tbody>';
        data.slice(0,10).forEach((d, i) => { 
          let icon = i === 0 ? 'ğŸ‘‘' : (i < 3 ? 'ğŸ”¥' : '');
          top10Html += `<tr><td style="font-weight:bold;">${i+1}</td><td>${d.city}${d.district}</td><td style="color:#d32f2f; font-weight:bold; font-size:16px;">${d.aqi} ${icon}</td></tr>`; 
        });
        top10Html += '</tbody></table>';
        document.getElementById('top10-container').innerHTML = top10Html;
      }
    }
  </script>
</body>
</html>
