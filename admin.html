<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HYPASS V4.15 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f8f9fa; color: #555; position: sticky; top: 0; z-index: 2;}
    
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; transition: background 0.2s; }
    .btn:hover { background: #00b300; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card:last-child { margin-right: 0; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }
    
    .op-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .op-card h3 { margin: 0 0 10px 0; color: #555; }

    .param-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 6px;}
    .param-group label { font-size: 13px; color: #555; font-weight: bold; }
    .param-group input { width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-family: monospace; font-size: 14px;}

    /* å‡ºè²¨æƒæç«™æ¨£å¼ */
    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; align-items: flex-start; flex-wrap: wrap;}
    .scan-input-group { flex: 1; min-width: 250px; }
    .scan-input { width: 100%; padding: 18px; font-size: 20px; border-radius: 5px; border: 2px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; transition: all 0.3s; }
    .scan-input:focus { border-color: #00D100; outline: none; box-shadow: 0 0 10px rgba(0,209,0,0.3); }
    .scan-input:disabled { background: #333; color: #888; cursor: not-allowed; border-color: #444; }
    .scan-label { color: #aaa; font-size: 13px; font-weight: bold; margin-bottom: 5px; display: block; }
    
    /* é¡é ­å€å¡Š */
    #reader-container { width: 100%; margin-top: 15px; display: none; background:#000; padding:10px; border-radius:8px;}
    #reader { width: 100%; max-width: 500px; margin: 0 auto; }

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-content textarea { width: 100%; height: 120px; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-family: sans-serif; font-size: 14px; box-sizing: border-box; resize: vertical; }
    .modal-content select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    
    @media (max-width: 768px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; white-space: nowrap; padding-bottom:10px;}
        .nav-btn { display: inline-block; width: auto; border-left: none; border-bottom: 4px solid transparent; padding: 10px 15px;}
        .nav-btn.active { border-bottom-color: #00D100; border-left:none;}
        .scan-container { flex-direction: column; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 10px;">
      <h2 style="color:#00D100; padding: 0 20px; border:none; margin-bottom: 10px; font-size:18px;">HYPASS æˆ°æƒ…å®¤</h2>
      <button class="nav-btn active" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ ç¶ èƒ½ç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('stats', this)">ğŸ“Š ç‡Ÿé‹åˆ†ä½ˆ</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•ç›£æ§</button>
      <button class="nav-btn" onclick="switchTab('push', this)">ğŸ’¬ æ™ºæ…§æ¨æ’­</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
      <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» </button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel active">
      <h2>ğŸ“¦ B2C å€‰å„²ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
      <p style="color:#666; font-size:13px;">æ”¯æ´ã€Œå¯¦é«”æ¢ç¢¼æ§ã€èˆ‡ã€Œæ‰‹æ©Ÿç›¸æ©Ÿã€ã€‚å¿…é ˆå…ˆæƒææ¿¾ç¶² UIDï¼Œå†æƒæè¨‚å–®ã€‚</p>
      
      <div id="reader-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <span style="color:#00D100; font-weight:bold;" id="camera-target-hint">æ­£åœ¨æƒæ...</span>
          <button class="btn btn-danger" onclick="stopCamera()">é—œé–‰ç›¸æ©Ÿ</button>
        </div>
        <div id="reader"></div>
      </div>

      <div class="scan-container">
        <div class="scan-input-group">
          <label class="scan-label">ç¬¬ 1 æ­¥ï¼šæƒæå¯¦é«”æ¿¾ç¶² UID æ¢ç¢¼</label>
          <div style="display:flex; gap:10px;">
            <input type="text" id="scan-uid-input" class="scan-input" style="margin-bottom:0;" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleUIDScan(event)">
            <button class="btn" style="padding:0 20px; font-size:24px;" onclick="startCamera('uid')" title="é–‹å•Ÿç›¸æ©Ÿ">ğŸ“·</button>
          </div>
        </div>
        <div class="scan-input-group">
          <label class="scan-label">ç¬¬ 2 æ­¥ï¼šæƒæ Shopline è¨‚å–® (æˆ–æ‰‹æ©Ÿè™Ÿç¢¼)</label>
          <div style="display:flex; gap:10px;">
            <input type="text" id="scan-order-input" class="scan-input" style="margin-bottom:0;" placeholder="ç­‰å¾…æƒæè¨‚å–®..." onkeypress="handleOrderScan(event)">
            <button class="btn" style="padding:0 20px; font-size:24px;" onclick="startCamera('order')" title="é–‹å•Ÿç›¸æ©Ÿ">ğŸ“·</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:#333;">ğŸ“‹ æœ¬æ¬¡æƒæå‡ºè²¨ç´€éŒ„</h3><span id="scan-status-msg" style="font-weight:bold; font-size:14px;"></span>
      </div>
      <div style="max-height: 350px; overflow-y:auto; border: 1px solid #ddd; margin-top:10px;">
        <table>
          <thead style="position:sticky; top:0; background:#f4f6f8;">
            <tr><th>æ¿¾ç¶² UID</th><th>ç¶å®šå–®è™Ÿ/è™Ÿç¢¼</th><th>å®¢æˆ¶ç‹€æ…‹</th><th>ä½œæ¥­çµæœ</th><th>æƒææ™‚é–“</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="dispatch-log-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card"><h1><span id="esg-active">0</span> ç‰‡</h1><p>ç›®å‰é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š å…¨å°ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="op-card" style="border-top: 4px solid #00D100;"><h3>æ¿¾ç¶²æœƒå“¡ç¸½æ•¸</h3><h1 id="stat-total-users" style="font-size: 48px; margin: 10px 0; color: #00D100;">0</h1></div>
        <div class="op-card" style="border-top: 4px solid #FF9800;"><h3>é–‹é€šä¿ä¿®å» ç¸½æ•¸</h3><h1 id="stat-total-garages" style="font-size: 48px; margin: 10px 0; color: #FF9800;">0</h1></div>
      </div>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;"><table id="stat-users-city"><thead><tr><th>å±…ä½ç¸£å¸‚</th><th>æœƒå“¡äººæ•¸</th></tr></thead><tbody></tbody></table></div>
        <div style="flex: 1;"><table id="stat-garages-city"><thead><tr><th>æ‰€åœ¨ç¸£å¸‚</th><th>åˆä½œå®¶æ•¸</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸èˆ‡å…¨å°ç©ºæ±™å¤§æ•¸æ“š</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap:wrap;">
        <div style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fafafa; min-width:300px;">
          <h3 style="margin-top: 0; color: #1976d2; display:flex; align-items:center; gap:8px;">ğŸ§  æ¿¾ç¶²å‹•æ…‹æ¼”ç®—æ³• & ESG åƒæ•¸</h3>
          <h4 style="margin: 15px 0 5px 0; color:#333; font-size:14px;">â–å‹•æ…‹å£½å‘½èˆ‡ç©ºæ°£æ¬Šé‡</h4>
          <div class="param-group"><label>åŸºæº–æ¯æ—¥è€—æç‡ (%)</label><input type="number" step="0.01" id="param-base-wear" value="0.27"></div>
          <div class="param-group"><label>åŸºæº– PM2.5 æ””æˆªé‡ (Âµg)</label><input type="number" id="param-base-pm25" value="1250"></div>
          <div class="param-group"><label>ğŸ”´ ç´«çˆ†åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-red" value="1.8"></div>
          <div class="param-group"><label>ğŸŸ  æ©˜å®³åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-orange" value="1.4"></div>
          <h4 style="margin: 20px 0 5px 0; color:#2e7d32; font-size:14px;">â–ESG èˆ‡ææ–™ç‰©ç†ç‰¹æ€§</h4>
          <div class="param-group"><label>HYPASS æ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-hypass" value="4"></div>
          <div class="param-group"><label>ä»–ç‰Œæ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-other" value="8"></div>
          <div class="param-group"><label>æ¯æ—¥åŸºæº–çœé›» (kWh)</label><input type="number" step="0.01" id="param-kwh-day" value="0.25"></div>
          <div class="param-group"><label>ç¢³æ’è½‰æ›ä¿‚æ•¸ (kg/kWh)</label><input type="number" step="0.1" id="param-co2-factor" value="0.5"></div>
          <button class="btn" style="width:100%; margin-top:15px; background:#1976d2; color:#fff;" onclick="saveAlgorithmParams()">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥ç™¼å¸ƒè‡³å‰å°</button>
        </div>
        <div style="flex: 1.2; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; background: #fffafb; min-width:300px;">
          <h3 style="margin-top: 0; color: #d32f2f;">ğŸš¨ å…¨å°å³æ™‚ 10 å¤§ç©ºæ±™é‡ç½å€</h3>
          <p style="font-size:12px; color:#d32f2f; margin-bottom:10px;">å¼·çƒˆå»ºè­°é‡å°ä»¥ä¸‹å€åŸŸåŠ å¼·ã€Œç´«çˆ†é˜²è­·ã€æ¨æ’­èˆ‡å»£å‘ŠæŠ•æ”¾ã€‚</p>
          <div id="top10-container"><table style="margin-top:0;"><thead><tr><th>æ’å</th><th>ç¸£å¸‚é„‰é®</th><th>AQI æŒ‡æ•¸</th><th>PM2.5</th></tr></thead><tbody><tr><td colspan="4" style="text-align:center;">è³‡æ–™åˆ†æä¸­...</td></tr></tbody></table></div>
        </div>
      </div>
      <h3 style="border-top:2px solid #eee; padding-top:20px; margin-bottom:15px;">ğŸŒ å°ç£ 368 é„‰é®å¸‚å€ç’°å¢ƒå¿«å–æ±  (æ¼”ç®—æ³•å…¨å‹•æ…‹ç›£æ§)</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <input type="text" id="monitor-search" placeholder="ğŸ” æœå°‹ç¸£å¸‚æˆ–é„‰é® (ä¾‹å¦‚: å°åŒ—)" onkeyup="filterMonitorTable()" style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ccc;">
        <div>
          <span id="monitor-count" style="font-size: 13px; color: #00D100; font-weight: bold; margin-right: 15px;">å…± 0 ç­†</span>
          <button class="btn" id="btn-force-update" style="background: #333; color: #fff;" onclick="forceUpdateCache()">âš¡ å¼·åˆ¶é‡æ–°æŠ“å– (ç´„40ç§’)</button>
        </div>
      </div>
      <div style="height: 400px; overflow-y: auto; border: 1px solid #eee;">
        <table id="monitor-table" style="margin-top: 0;">
          <thead><tr><th>ç¸£å¸‚ / é„‰é®</th><th>ç’°å¢ƒæº«æ¿•åº¦</th><th>AQI æŒ‡æ•¸</th><th>PM2.5 (Âµg)</th><th>å‹•æ…‹æ¼”ç®—æ³•è€—æå€ç‡</th><th style="background:#e8f5e9; color:#2e7d32;">ğŸ’¡ ç‡Ÿé‹ç­–ç•¥å»ºè­°</th><th>æœ€å¾Œæ›´æ–°æ™‚é–“ (å°åŒ—)</th></tr></thead>
          <tbody><tr><td colspan="7" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="panel-push" class="panel">
      <h2>ğŸ’¬ AI æ™ºæ…§æ¨æ’­å¼•æ“ (å‹•æ…‹æƒ…å¢ƒåº«)</h2>
      <table id="push-table"><thead><tr><th>é¡åˆ¥</th><th>æƒ…å¢ƒè¦å‰‡åç¨±</th><th>è§¸ç™¼é‚è¼¯æ¢ä»¶</th><th>è‡ªå‹•æ¨æ’­æ–‡æ¡ˆå…§å®¹</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="edit-modal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="edit-title">ç·¨è¼¯æ¨æ’­æ–‡æ¡ˆ</h3>
        <input type="hidden" id="edit-rule-id">
        <textarea id="edit-message"></textarea>
        <select id="edit-status"><option value="true">ğŸŸ¢ å•Ÿç”¨ä¸­</option><option value="false">ğŸ”´ åœç”¨</option></select>
        <div style="margin-top: 20px; display:flex; gap:10px; justify-content: flex-end;">
          <button class="btn" style="background:#eee; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="btn" onclick="savePushRule()">å„²å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID æ™ºæ…§æµæ°´è™Ÿç”Ÿæˆ</h2>
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight:bold;">é è¨ˆç”¢å‡ºçµ„æ•¸ï¼š</label>
        <input type="number" id="uid-gen-count" value="50" style="width: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ è‡ªå‹•æ¥çºŒç”¢å‡ºæ–° UID</button>
      </div>
      <table id="uid-table" style="margin-top:15px;"><thead><tr><th>UID æµæ°´è™Ÿ</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹/æ“æœ‰è€…</th><th>å®‰è£è»Šæ¬¾/åœ°é»</th><th>æ“ä½œæ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM</h2>
      <table id="crm-table">
        <thead>
          <tr><th>å§“å</th><th>é›»è©±</th><th>å®Œæ•´é€šè¨Šåœ°å€</th><th>è»Šè¼›èˆ‡è»Šç‰Œ</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>è¯çµ¡äºº/é›»è©±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>ç”³è«‹æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );

    let fullMonitorData = []; 

    function formatTaipeiTime(dateString) {
      if (!dateString) return '-';
      const options = { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      return new Date(dateString).toLocaleString('zh-TW', options);
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active');
      btn.classList.add('active');
      
      if (id === 'esg') loadESG(); 
      if (id === 'stats') loadStats(); 
      if (id === 'monitor') { loadMonitor(); loadAlgorithmParams(); }
      if (id === 'push') loadPushRules();
      if (id === 'uid') loadUIDs(); 
      if (id === 'crm') loadCRM(); 
      if (id === 'garage') loadGarages(); 
      if (id === 'rewards') loadRewards();
      if (id === 'dispatch') { 
          setTimeout(() => document.getElementById('scan-uid-input').focus(), 100);
          stopCamera(); // åˆ‡æ›é é¢æ™‚é—œé–‰ç›¸æ©Ÿ
      }
    }

    // ----------------------------------------------------
    // ğŸŒŸ ç›¸æ©Ÿæƒæå¼•æ“é‚è¼¯ (html5-qrcode)
    // ----------------------------------------------------
    let html5QrcodeScanner = null;
    let cameraTarget = ''; // 'uid' æˆ–æ˜¯ 'order'

    function startCamera(target) {
      cameraTarget = target;
      document.getElementById('reader-container').style.display = 'block';
      document.getElementById('camera-target-hint').innerText = target === 'uid' ? 'æ­£åœ¨æƒæï¼šç¬¬ä¸€æ­¥ æ¿¾ç¶² UID' : 'æ­£åœ¨æƒæï¼šç¬¬äºŒæ­¥ è¨‚å–®æ¢ç¢¼';
      
      if(html5QrcodeScanner) { stopCamera(); } // å¦‚æœåŸæœ¬æœ‰é–‹ï¼Œå…ˆé—œæ‰

      // åˆå§‹åŒ–ç›¸æ©Ÿ
      html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: {width: 250, height: 250} }, false);
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    }

    function stopCamera() {
      if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
      }
      document.getElementById('reader-container').style.display = 'none';
    }

    function onScanSuccess(decodedText, decodedResult) {
      playSuccessBeep();
      stopCamera(); // æƒææˆåŠŸå¾Œè‡ªå‹•é—œé–‰ç›¸æ©Ÿ
      
      if (cameraTarget === 'uid') {
         document.getElementById('scan-uid-input').value = decodedText;
         currentScanUid = decodedText;
         document.getElementById('scan-status-msg').innerHTML = `<span style='color:#FF9800;'>ğŸ“Œ UID å·²ç¢ºèªï¼Œè«‹æ¥è‘—æƒæè¨‚å–®...</span>`;
         document.getElementById('scan-order-input').focus();
      } else if (cameraTarget === 'order') {
         document.getElementById('scan-order-input').value = decodedText;
         processOrder(decodedText); // å‘¼å«å…±ç”¨çš„è™•ç†é‚è¼¯
      }
    }

    function onScanFailure(error) { /* æƒæä¸­æœƒæŒçºŒè§¸ç™¼éŒ¯èª¤ï¼Œæ­¤è™•å¿½ç•¥ä¸å°å‡º */ }

    // ----------------------------------------------------
    // ğŸŒŸ å¯¦é«”æ¢ç¢¼æ§é‚è¼¯èˆ‡é˜²å‘†
    // ----------------------------------------------------
    let currentScanUid = '';
    
    function playSuccessBeep() {
      const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gainNode = ctx.createGain();
      osc.connect(gainNode); gainNode.connect(ctx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(1200, ctx.currentTime);
      gainNode.gain.setValueAtTime(0.2, ctx.currentTime); osc.start(); osc.stop(ctx.currentTime + 0.1);
    }

    function handleUIDScan(e) { 
      if (e.key === 'Enter') { 
        currentScanUid = e.target.value.trim(); 
        if (currentScanUid) {
          document.getElementById('scan-status-msg').innerHTML = `<span style='color:#FF9800;'>ğŸ“Œ UID å·²ç¢ºèªï¼Œè«‹æ¥è‘—æƒæè¨‚å–®...</span>`;
          document.getElementById('scan-order-input').focus(); 
        }
      } 
    }

    function handleOrderScan(e) {
      if (e.key === 'Enter') {
        const orderPhone = e.target.value.trim(); 
        if (!orderPhone) return;
        processOrder(orderPhone);
      }
    }

    // ğŸŒŸ å…±ç”¨çš„è³‡æ–™åº«å¯«å…¥é‚è¼¯ (æ¢ç¢¼æ§èˆ‡ç›¸æ©Ÿå…±ç”¨)
    async function processOrder(orderPhone) {
        if (!currentScanUid) {
           alert("âš ï¸ è«‹å…ˆæƒæã€Œç¬¬ 1 æ­¥ã€çš„æ¿¾ç¶² UID æ¢ç¢¼ï¼");
           document.getElementById('scan-uid-input').focus();
           return;
        }

        // é–å®šè¼¸å…¥æ¡†é˜²å‘†
        document.getElementById('scan-uid-input').disabled = true;
        document.getElementById('scan-order-input').disabled = true;
        document.getElementById('scan-status-msg').innerHTML = "<span style='color:#FF9800;'>ğŸ”„ é›™æ¢ç¢¼æ¯”å°ä¸¦å¯«å…¥é›²ç«¯ä¸­...</span>";

        const { data: user } = await supabaseClient.from('users').select('line_uid, name').eq('phone', orderPhone).maybeSingle();
        let isOldCustomer = !!user;
        let customerLabel = isOldCustomer ? `<span style="color:#00D100; font-weight:bold;">ğŸŸ¢ èˆŠå®¢ (${user.name})</span>` : `<span style="color:#FF9800; font-weight:bold;">ğŸŸ  æœªç¶å®š</span>`;
        
        const updatePayload = { status: 'sold', shopline_order_id: orderPhone };
        if (isOldCustomer) { updatePayload.activated_by_uid = user.line_uid; }
        
        const { error } = await supabaseClient.from('filters_uid').update(updatePayload).eq('uid', currentScanUid);
        
        if (!error) {
          playSuccessBeep();
          const rowId = `row-${currentScanUid}`;
          const logHtml = `<tr id="${rowId}">
            <td style="font-family:monospace; font-size:16px;"><b>${currentScanUid}</b></td>
            <td id="order-${currentScanUid}" style="font-family:monospace;">${orderPhone}</td>
            <td>${customerLabel}</td>
            <td style="color:#00D100; font-weight:bold;">âœ… å·²ç¶å®š</td>
            <td style="font-size:12px; color:#888;">${new Date().toLocaleTimeString('zh-TW', {timeZone: 'Asia/Taipei'})}</td>
            <td><button class="btn" style="background:#333; color:#fff; padding:6px 12px; font-size:12px;" onclick="editDispatchRecord('${currentScanUid}', '${orderPhone}')">âœï¸ æ‰‹å‹•ä¿®æ”¹</button></td>
          </tr>`;
          
          document.getElementById('dispatch-log-tbody').insertAdjacentHTML('afterbegin', logHtml);
          document.getElementById('scan-status-msg').innerHTML = `<span style="color:#00D100;">âœ”ï¸ é›™é‡å¯«å…¥æˆåŠŸï¼å¯ç¹¼çºŒæƒæä¸‹ä¸€ç­†ã€‚</span>`;
          
          if (isOldCustomer) await supabaseClient.from('user_logs').insert([{ user_uid: user.line_uid, action: 'ğŸ“¦ ç¸½éƒ¨å‡ºè²¨', details: `å·²å‡ºè²¨æ¿¾ç¶²ï¼š${currentScanUid} (è¨‚å–®:${orderPhone})` }]);
        } else { 
          document.getElementById('scan-status-msg').innerHTML = `<span style="color:red;">âŒ å¯«å…¥å¤±æ•—ï¼š${error.message}</span>`; 
        }
        
        // é‡‹æ”¾è¼¸å…¥æ¡†ä¸¦è‡ªå‹•è·³å›ç¬¬ä¸€æ­¥
        currentScanUid = ''; 
        document.getElementById('scan-uid-input').value = ''; 
        document.getElementById('scan-order-input').value = ''; 
        document.getElementById('scan-uid-input').disabled = false;
        document.getElementById('scan-order-input').disabled = false;
        document.getElementById('scan-uid-input').focus();
    }

    // ğŸŒŸ æ‰‹å‹•ä¿®æ”¹å–®ç­†å‡ºè²¨è³‡æ–™
    async function editDispatchRecord(uid, oldOrder) {
      const newOrder = prompt(`ä¿®æ”¹æ¿¾ç¶² UID [${uid}] çš„ç¶å®šå–®è™Ÿï¼š\nè«‹è¼¸å…¥æ–°çš„è¨‚å–®æˆ–æ‰‹æ©Ÿè™Ÿç¢¼ï¼š`, oldOrder);
      if (newOrder !== null && newOrder.trim() !== '' && newOrder !== oldOrder) {
         const finalOrder = newOrder.trim();
         const { error } = await supabaseClient.from('filters_uid').update({ shopline_order_id: finalOrder }).eq('uid', uid);
         if (error) {
            alert("ä¿®æ”¹å¤±æ•—ï¼š" + error.message);
         } else {
            alert(`âœ… ä¿®æ”¹æˆåŠŸï¼\nUID ${uid} å·²é‡æ–°ç¶å®šè‡³å–®è™Ÿï¼š${finalOrder}`);
            document.getElementById(`order-${uid}`).innerText = finalOrder;
            const btn = document.querySelector(`#row-${uid} button`);
            if(btn) btn.setAttribute('onclick', `editDispatchRecord('${uid}', '${finalOrder}')`);
         }
      }
    }


    // ----------------------------------------------------
    // å…¶é¤˜å¾Œå°åŠŸèƒ½ (åƒæ•¸ã€å¿«å–ã€CRM ç­‰) ä¿æŒä¸è®Š
    // ----------------------------------------------------
    function loadAlgorithmParams() {
      const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
      if (params.baseWear) document.getElementById('param-base-wear').value = params.baseWear;
      if (params.basePm25) document.getElementById('param-base-pm25').value = params.basePm25;
      if (params.weightRed) document.getElementById('param-weight-red').value = params.weightRed;
      if (params.weightOrange) document.getElementById('param-weight-orange').value = params.weightOrange;
      if (params.paHypass) document.getElementById('param-pa-hypass').value = params.paHypass;
      if (params.paOther) document.getElementById('param-pa-other').value = params.paOther;
      if (params.kwhPerDay) document.getElementById('param-kwh-day').value = params.kwhPerDay;
      if (params.co2Factor) document.getElementById('param-co2-factor').value = params.co2Factor;
    }
    function saveAlgorithmParams() {
      const params = {
        baseWear: document.getElementById('param-base-wear').value, basePm25: document.getElementById('param-base-pm25').value,
        weightRed: document.getElementById('param-weight-red').value, weightOrange: document.getElementById('param-weight-orange').value,
        paHypass: document.getElementById('param-pa-hypass').value, paOther: document.getElementById('param-pa-other').value,
        kwhPerDay: document.getElementById('param-kwh-day').value, co2Factor: document.getElementById('param-co2-factor').value
      };
      localStorage.setItem('hypass_algo_params', JSON.stringify(params));
      alert(`âœ… æ¼”ç®—æ³•æ ¸å¿ƒåƒæ•¸å·²æˆåŠŸæ›´æ–°ä¸¦åŒæ­¥è‡³å‰å°ï¼`);
      renderMonitorTable(fullMonitorData);
    }

    async function loadMonitor() {
      const { data } = await supabaseClient.from('env_cache').select('*').limit(400).order('aqi', { ascending: false });
      if (data) { fullMonitorData = data; renderTop10(fullMonitorData); renderMonitorTable(fullMonitorData); }
    }
    function renderTop10(data) {
      if (!data || data.length === 0) return;
      const top10 = [...data].sort((a, b) => b.aqi - a.aqi).slice(0, 10);
      let html = `<table style="margin-top:0; font-size:13px; background:#fff;"><thead><tr><th>æ’å</th><th>ç¸£å¸‚é„‰é®</th><th>AQI æŒ‡æ•¸</th><th>PM2.5</th></tr></thead><tbody>`;
      top10.forEach((d, idx) => {
        let color = d.aqi > 150 ? '#d32f2f' : (d.aqi > 100 ? '#f57c00' : '#333');
        let icon = idx === 0 ? 'ğŸ‘‘' : (idx < 3 ? 'ğŸ”¥' : 'âš ï¸');
        let rankStyle = idx < 3 ? 'background:#d32f2f; color:#fff; padding:2px 8px; border-radius:10px;' : 'color:#555; font-weight:bold;';
        html += `<tr><td><span style="${rankStyle}">${idx + 1}</span></td><td style="font-weight:bold;">${d.city} ${d.district}</td><td style="color:${color}; font-weight:bold; font-size:16px;">${d.aqi} ${icon}</td><td style="color:#555;">${d.pm25}</td></tr>`;
      });
      html += '</tbody></table>'; document.getElementById('top10-container').innerHTML = html;
    }
    
    function renderMonitorTable(dataToRender) {
      let html = ''; document.getElementById('monitor-count').innerText = `å…± ${dataToRender.length} ç­†è³‡æ–™`;
      const params = JSON.parse(localStorage.getItem('hypass_algo_params') || '{}');
      const wRed = parseFloat(params.weightRed || 1.8); 
      const wOrange = parseFloat(params.weightOrange || 1.4);
      
      dataToRender.forEach(d => {
        let temp = d.temp !== null ? d.temp : '--';
        let hum = d.hum !== null ? d.hum : '--';
        let aqi = d.aqi !== null ? d.aqi : 50;

        let weightText = 'æ¨™æº–è€—æ';
        let wColor = '#555'; 
        let marketing = '<span style="color:#666;">å¸¸è¦ç™¼é€ä¿é¤Šæé†’</span>';
        let dynamicWeight = 1.0;

        if (aqi > 150) { 
            dynamicWeight = wRed + ((aqi - 150) / 50) * 0.5; 
            weightText = 'åš´é‡è€—æ'; wColor = '#d32f2f'; marketing = '<span style="color:#d32f2f; font-weight:bold;">ğŸ”¥ å»ºè­°æ¨æ’­ç´«çˆ†é˜²è­·å»£å‘Š</span>'; 
        } else if (aqi > 100) { 
            dynamicWeight = wOrange + ((aqi - 100) / 50) * (wRed - wOrange);
            weightText = 'åŠ é€Ÿè€—æ'; wColor = '#f57c00'; marketing = '<span style="color:#f57c00; font-weight:bold;">âš ï¸ é©åˆä¸»æ¨é™¤è‡­å‡ç´šç‰ˆ</span>'; 
        } else if (aqi > 50) {
            dynamicWeight = 1.0 + ((aqi - 50) / 50) * (wOrange - 1.0);
            weightText = 'ä¸€èˆ¬è€—æ'; wColor = '#555';
        } else { 
            dynamicWeight = 0.8 + (aqi / 50) * 0.2;
            weightText = 'æ¸›ç·©è€—æ'; wColor = '#388e3c'; marketing = '<span style="color:#388e3c;">ğŸƒ é©åˆæ¨å»£çœç¢³æˆå°±æ´»å‹•</span>'; 
        }

        let aqiColor = aqi > 150 ? '#d32f2f' : (aqi > 100 ? '#f57c00' : (aqi <= 50 ? '#388e3c' : '#333'));
        
        html += `<tr>
          <td style="font-weight:bold;">${d.city} ${d.district}</td>
          <td style="color:#1976d2; font-weight:bold; font-size:15px;">${temp}Â°C <span style="color:#888; font-size:12px; font-weight:normal;">/ ${hum}%</span></td>
          <td style="color:${aqiColor}; font-weight:bold; font-size:18px;">${aqi}</td>
          <td>${d.pm25 !== null ? d.pm25 : '--'}</td>
          <td style="color:${wColor}; font-weight:bold; font-size:15px;">${dynamicWeight.toFixed(2)} å€ <span style="font-size:11px; color:#888;">(${weightText})</span></td>
          <td style="background:#fafffa;">${marketing}</td>
          <td style="font-size:12px; font-family:monospace; color:#888;">${formatTaipeiTime(d.updated_at)}</td>
        </tr>`;
      });
      document.getElementById('monitor-table').querySelector('tbody').innerHTML = html;
    }
    
    function filterMonitorTable() {
      const keyword = document.getElementById('monitor-search').value.trim().toLowerCase();
      if (!keyword) { renderMonitorTable(fullMonitorData); return; }
      const filtered = fullMonitorData.filter(d => (d.city && d.city.toLowerCase().includes(keyword)) || (d.district && d.district.toLowerCase().includes(keyword)));
      renderMonitorTable(filtered);
    }
    async function forceUpdateCache() {
      const btn = document.getElementById('btn-force-update'); btn.innerText = 'â³ 368é„‰é®å¤§æ•¸æ“šæŠ“å–ä¸­ (è«‹è€å¿ƒç­‰å¾…ç´„ 40 ç§’)...'; btn.disabled = true;
      try {
        const res = await fetch('https://qznvabjtxcbffjryfgqi.supabase.co/functions/v1/webhook?action=update_cache', { method: 'POST' });
        if (res.ok) { alert('âœ… å…¨å° 368 é„‰é®å¿«å–æ± æ›´æ–°æˆåŠŸï¼'); loadMonitor(); } else { alert('âš ï¸ æ°£è±¡å±€é€£ç·šé€¾æ™‚ï¼Œä½†å·²æŠ“å–éƒ¨åˆ†è³‡æ–™ï¼Œè«‹é‡æ•´ç•«é¢ã€‚'); loadMonitor(); }
      } catch (e) { alert('å‘¼å«å¤±æ•—ï¼š' + e.message); } finally { btn.innerText = 'âš¡ å¼·åˆ¶é‡æ–°æŠ“å– 368 é„‰é®'; btn.disabled = false; }
    }

    async function generateSequentialUIDs() {
      const count = parseInt(document.getElementById('uid-gen-count').value) || 50;
      if(count <= 0 || count > 500) return alert("è«‹è¼¸å…¥ 1 ~ 500 ä¹‹é–“çš„æ•¸é‡");
      const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(200);
      let maxNum = 0;
      if (data && data.length > 0) {
        data.forEach(d => { const match = d.uid.match(/^HP-(\d+)$/); if (match) { const num = parseInt(match[1], 10); if (num > maxNum) maxNum = num; } });
      }
      let ins = []; for(let i=1; i<=count; i++) { ins.push({ uid: 'HP-' + (maxNum + i).toString().padStart(6, '0') }); }
      await supabaseClient.from('filters_uid').insert(ins);
      alert(`âœ… æˆåŠŸæ¥çºŒç”¢å‡º ${count} çµ„æ–°æµæ°´è™Ÿï¼(è¿„è‡³ ${ins[ins.length-1].uid})`); loadUIDs();
    }
    async function loadUIDs() {
      const { data } = await supabaseClient.from('filters_uid').select('*, users(name)').order('uid', { ascending: false }).limit(50);
      let html = ''; if (data) { data.forEach(d => { let status = d.status === 'produced' ? 'ğŸ·ï¸ ç¸½éƒ¨åº«å­˜' : d.status === 'sold' ? 'ğŸšš å·²å‡ºè²¨' : d.status === 'activated' ? 'ğŸŸ¢ æœå½¹ä¸­' : 'ğŸ—‘ï¸ å·²æ·˜æ±°'; html += `<tr><td style="font-family:monospace; font-size:16px;"><b>${d.uid}</b></td><td>${status}</td><td>${d.activation_type || (d.users ? d.users.name : '-')}</td><td>${d.installed_car_model || '-'}</td><td>${d.activated_at ? formatTaipeiTime(d.activated_at) : formatTaipeiTime(d.created_at)}</td></tr>`; }); }
      document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function loadPushRules() {
      const { data } = await supabaseClient.from('notification_rules').select('*').order('id', { ascending: true });
      let html = ''; if (data) { data.forEach(r => { 
        let safeMessage = r.message_template.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        html += `<tr><td><span style="background:#e3f2fd; color:#1976d2; padding:4px; border-radius:4px; font-size:12px;">${r.category}</span></td><td style="font-weight:bold;">${r.rule_name}</td><td style="color:#888; font-family:monospace;">${r.trigger_condition}</td><td>${r.message_template}</td><td>${r.is_active ? '<span style="color:green; font-weight:bold;">ğŸŸ¢ å•Ÿç”¨</span>' : '<span style="color:red;">ğŸ”´ åœç”¨</span>'}</td><td><button class="btn" style="padding: 6px 10px; font-size:12px; background:#333; color:#00D100;" onclick="openEditModal(${r.id}, '${r.rule_name}', '${safeMessage}', ${r.is_active})">âœï¸ ç·¨è¼¯</button></td></tr>`; 
      }); }
      document.getElementById('push-table').querySelector('tbody').innerHTML = html;
    }
    function openEditModal(id, ruleName, message, isActive) { 
      document.getElementById('edit-rule-id').value = id; document.getElementById('edit-title').innerText = `ç·¨è¼¯ï¼š${ruleName}`; 
      document.getElementById('edit-message').value = message; document.getElementById('edit-status').value = isActive ? "true" : "false"; 
      document.getElementById('edit-modal').style.display = 'flex'; 
    }
    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    async function savePushRule() {
      const id = document.getElementById('edit-rule-id').value; const newMessage = document.getElementById('edit-message').value; const newStatus = document.getElementById('edit-status').value === "true";
      if (!newMessage.trim()) return alert("æ–‡æ¡ˆå…§å®¹ä¸å¯ç‚ºç©ºï¼");
      const { error } = await supabaseClient.from('notification_rules').update({ message_template: newMessage, is_active: newStatus }).eq('id', id);
      if (error) alert("å„²å­˜å¤±æ•—ï¼š" + error.message); else { alert("âœ… å„²å­˜æˆåŠŸï¼"); closeModal(); loadPushRules(); }
    }

    async function loadCRM() {
      const { data } = await supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
      let html = ''; if (data) { data.forEach(u => { 
        let action = u.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist('${u.line_uid}', false, 'users')">è§£é™¤é»‘åå–®</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist('${u.line_uid}', true, 'users')">è¨­ç‚ºé»‘åå–®</button>`;
        let fullAddress = `${u.city || ''}${u.district || ''}${u.address || ''}`;
        if (!fullAddress) fullAddress = '<span style="color:#aaa;">æœªå¡«å¯«</span>';
        html += `<tr><td style="font-weight:bold;">${u.name}</td><td style="font-family:monospace;">${u.phone}</td><td style="font-size:13px;">${fullAddress}</td><td>${u.car_brand} ${u.car_model}<br><span style="font-size:12px; color:#888;">${u.license_plate||''}</span></td><td>${u.is_blacklisted ? '<span style="color:red; font-weight:bold;">é»‘åå–®</span>' : '<span style="color:green;">æ­£å¸¸</span>'}</td><td>${action}</td></tr>`; 
      }); }
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function loadESG() {
      const { data } = await supabaseClient.from('filters_uid').select('activated_at').eq('status', 'activated');
      if (data) {
        let totalDays = 0; data.forEach(d => { if (d.activated_at) totalDays += Math.floor((new Date() - new Date(d.activated_at)) / (1000 * 60 * 60 * 24)); });
        document.getElementById('esg-pm25').innerText = (totalDays * 1250).toLocaleString(); document.getElementById('esg-co2').innerText = (totalDays * 0.15).toFixed(1); document.getElementById('esg-active').innerText = data.length;
      }
    }
    async function loadStats() {
      const { data: users } = await supabaseClient.from('users').select('city').eq('role', 'customer');
      if (users) {
        document.getElementById('stat-total-users').innerText = users.length;
        const cityCounts = {}; users.forEach(u => { const c = u.city || 'æœªå¡«å¯«'; cityCounts[c] = (cityCounts[c] || 0) + 1; });
        let userHtml = ''; Object.entries(cityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { userHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#00D100;">${count} äºº</td></tr>`; });
        document.getElementById('stat-users-city').querySelector('tbody').innerHTML = userHtml;
      }
      const { data: garages } = await supabaseClient.from('garages').select('city').eq('status', 'active');
      if (garages) {
        document.getElementById('stat-total-garages').innerText = garages.length;
        const gCityCounts = {}; garages.forEach(g => { const c = g.city || 'æœªå¡«å¯«'; gCityCounts[c] = (gCityCounts[c] || 0) + 1; });
        let garageHtml = ''; Object.entries(gCityCounts).sort((a,b) => b[1] - a[1]).forEach(([city, count]) => { garageHtml += `<tr><td>${city}</td><td style="font-weight:bold; color:#FF9800;">${count} å®¶</td></tr>`; });
        document.getElementById('stat-garages-city').querySelector('tbody').innerHTML = garageHtml;
      }
    }
    async function loadGarages() {
      const { data } = await supabaseClient.from('garages').select('*').order('created_at', { ascending: false });
      let html = ''; if (data) { data.forEach(g => { 
        let action = g.status === 'pending' ? `<button class="btn" onclick="approveGarage(${g.id})">æ ¸å‡†é–‹é€š</button>` : (g.is_blacklisted ? `<button class="btn" onclick="toggleBlacklist(${g.id}, false, 'garages')">è§£é™¤åœæ¬Š</button>` : `<button class="btn btn-danger" onclick="toggleBlacklist(${g.id}, true, 'garages')">å¼·åˆ¶åœæ¬Š</button>`);
        html += `<tr><td>${g.name}</td><td>${g.city}${g.address}</td><td>${g.contact_name}</td><td>${g.status==='pending' ? 'å¾…å¯©æ ¸' : 'ç‡Ÿæ¥­ä¸­'}</td><td>${action}</td></tr>`; 
      }); }
      document.getElementById('garage-table').querySelector('tbody').innerHTML = html;
    }
    async function approveGarage(id) { await supabaseClient.from('garages').update({ status: 'active' }).eq('id', id); loadGarages(); }
    async function toggleBlacklist(id, isBlack, table) { if (table === 'users') { await supabaseClient.from('users').update({ is_blacklisted: isBlack }).eq('line_uid', id); } else { await supabaseClient.from('garages').update({ is_blacklisted: isBlack }).eq('id', id); } table === 'users' ? loadCRM() : loadGarages(); }
    async function loadRewards() {
      const { data } = await supabaseClient.from('rewards').select('*, users(name, phone)').eq('type', 'redeem').eq('status', 'pending');
      let html = ''; if (data) { data.forEach(r => { html += `<tr><td>${r.users.name}</td><td>å…Œæ› 100 é»</td><td>${formatTaipeiTime(r.created_at)}</td><td><button class="btn" onclick="completeReward(${r.id})">âœ… çµæ¡ˆ</button></td></tr>`; }); }
      document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç„¡è³‡æ–™</td></tr>';
    }
    async function completeReward(id) { await supabaseClient.from('rewards').update({ status: 'completed' }).eq('id', id); alert('å·²çµæ¡ˆï¼'); loadRewards(); }

    loadESG();
  </script>
</body>
</html>
