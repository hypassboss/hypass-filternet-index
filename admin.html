<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>HYPASS V9.9 ç¸½éƒ¨æˆ°æƒ…å®¤ (30çµ„AIè·‘é¦¬ç‡ˆå…§å»ºç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto;}
    .sidebar-title { color: #00e676; padding: 25px 20px 20px 20px; font-size: 20px; font-weight: 900; margin: 0; letter-spacing: 1px;}
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 14px; border-left: 4px solid transparent; transition: 0.2s;}
    .nav-btn:hover { background: #222; color: #fff; }
    .nav-btn.active { color: #00e676; border-left-color: #00e676; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    .panel { display: none; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    h2 { margin-top: 0; color: #111; font-size: 22px; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;}
    .table-container { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; min-width: 600px;}
    th, td { border: 1px solid #eee; padding: 12px 15px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; font-weight: 600; white-space: nowrap;}
    tr:hover { background: #fcfcfc; }
    input[type="text"], textarea, select, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit;}
    .btn { background: #00e676; color: #000; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s;}
    .btn:hover { filter: brightness(1.1); transform: scale(0.98);}
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-warn { background: #f59e0b; color: #fff; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-dark { background: #111; color: #fff; }
    .dispatch-container { background: #111; padding: 25px; border-radius: 12px; color: white; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);}
    .scan-input { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; background: #222; color: #00e676; text-align: center; border: 1px solid #444; box-sizing: border-box; font-family: monospace; outline: none;}
    #scanner-box { width: 100%; max-width: 450px; margin: 0 auto 20px auto; overflow: hidden; border-radius: 12px; display: none; border: 2px solid #00e676;}
    #video-box { width: 100%; max-width: 450px; background: #000; border-radius: 12px; border: 2px solid #ef4444; display: none; margin: 0 auto 20px auto;}
    .recording-dot { color: #ef4444; font-weight: bold; animation: blink 1s infinite; display: none; margin-left: 10px;}
    @keyframes blink { 50% { opacity: 0; } }
    .env-stats { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;}
    .env-card { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 8px; flex: 1; min-width: 200px; text-align: center; }
    .env-card h3 { margin: 0 0 5px 0; font-size: 14px; color: #555; }
    .env-card p { margin: 0; font-size: 24px; font-weight: bold; color: #00e676; }
    .emergency-box { background: rgba(239, 68, 68, 0.1); border: 2px dashed #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 25px;}
    @media (max-width: 768px) {
        body { flex-direction: column; height: auto; }
        .sidebar { width: 100%; display: flex; flex-direction: row; flex-wrap: wrap; height: auto; padding-bottom: 10px; border-bottom: 2px solid #333;}
        .sidebar-title { width: 100%; text-align: center; padding: 15px; }
        .nav-btn { width: auto; flex: 1 1 30%; font-size: 11px; padding: 8px; text-align: center; border-left: none; border-bottom: 2px solid transparent; }
        .nav-btn.active { border-left: none; border-bottom-color: #00e676; }
        .main-content { padding: 15px; }
        .panel { padding: 15px; }
    }
  </style>
</head>
<body>

  <div class="sidebar">
    <h2 class="sidebar-title">HYPASS Admin</h2>
    <button class="nav-btn active" onclick="switchTab('dispatch', this)">ğŸ“¦ å‡ºè²¨éŒ„å½±ç«™</button>
    <button class="nav-btn" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID ç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('marquee', this)">ğŸ’¬ è·‘é¦¬ç‡ˆç®¡ç†</button>
    <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ± ESG ç¸½è¡¨</button>
    <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
    <button class="nav-btn" onclick="switchTab('garages', this)">ğŸª ä¿ä¿®å» </button>
    <button class="nav-btn" onclick="switchTab('bookings', this)">ğŸ“… é ç´„å–®</button>
    <button class="nav-btn" onclick="switchTab('bulletins', this)">ğŸ“¢ å¸ƒå‘Šæ¬„</button>
    <button class="nav-btn" onclick="switchTab('env', this)">ğŸŒ ç’°å¢ƒæ•¸æ“š</button>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel active">
      <h2>ğŸ“¦ B2C è‡ªå‹•æƒæèˆ‡å‡ºè²¨éŒ„å½± (é˜²å½å­˜è­‰ç³»çµ±)</h2>
      <div class="dispatch-container">
        <div id="scanner-box"></div>
        <video id="video-box" autoplay muted playsinline></video>
        <h3 id="flow-status" style="text-align:center; color:#00e676; margin-bottom:20px; font-size:18px;">è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å•Ÿå‹•ä½œæ¥­</h3>
        <div style="display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;"><label style="color:#aaa; font-size:13px; margin-bottom:5px; display:block;">ğŸ“ Shopline è¨‚å–®è™Ÿç¢¼</label><input type="text" id="inp-order" class="scan-input" style="font-size:20px; padding:16px;" readonly placeholder="ç­‰å¾…æƒæ..."></div>
            <div style="flex:1; min-width:200px;"><label style="color:#aaa; font-size:13px; margin-bottom:5px; display:block;">ğŸ“¦ æ¿¾ç¶² UID</label><input type="text" id="inp-uid" class="scan-input" style="font-size:20px; padding:16px;" readonly placeholder="ç­‰å¾…æƒæ..."></div>
        </div>
        <div style="text-align:center; margin-top: 10px;">
            <button id="btn-scan" class="btn btn-primary" style="font-size:16px; padding: 14px 24px;" onclick="startScanFlow()">1. å•Ÿå‹•é¡é ­æƒææ¢ç¢¼</button>
            <button id="btn-record" class="btn btn-warn" style="font-size:16px; padding: 14px 24px; display:none;" onclick="startRecording()">ğŸ¥ 2. é–‹å§‹åŒ…è£éŒ„å½± <span class="recording-dot" id="rec-dot">âº REC</span></button>
            <button id="btn-stop" class="btn btn-danger" style="font-size:16px; padding: 14px 24px; display:none;" onclick="stopAndSave()">ğŸ›‘ 3. çµæŸéŒ„å½±ä¸¦ä¸‹è¼‰å­˜æª”</button>
        </div>
      </div>
    </div>

    <div id="panel-marquee" class="panel">
        <h2>ğŸ’¬ å‰å°è·‘é¦¬ç‡ˆ AI å‹•æ…‹è¨Šæ¯ç®¡ç† (æ”¯æ´ 50 çµ„å„ªå…ˆæ¬Šæ¢ä»¶)</h2>
        <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
            <h4 style="margin-top:0; color:#333;">æ–°å¢å‹•æ…‹è¦å‰‡</h4>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <select id="mq-type" style="flex:1; min-width:180px;" onchange="document.getElementById('mq-val').style.display = this.value === 'default' ? 'none' : 'block'">
                    <option value="health_low">âš ï¸ ç•¶æ¿¾ç¶²å£½å‘½ä½æ–¼ (%)</option>
                    <option value="aqi_high">ğŸ˜· ç•¶å®¤å¤– AQI é«˜æ–¼ (æ•¸å€¼)</option>
                    <option value="pm25_high">ğŸŒ«ï¸ ç•¶ PM2.5 é«˜æ–¼ (Âµg)</option>
                    <option value="temp_high">ğŸ”¥ ç•¶å®¤å¤–æº«åº¦é«˜æ–¼ (Â°C)</option>
                    <option value="temp_low">â„ï¸ ç•¶å®¤å¤–æº«åº¦ä½æ–¼ (Â°C)</option>
                    <option value="default">ğŸ“Œ é è¨­å¸¸é§è¨Šæ¯ (éš¨æ©Ÿè¼ªæ’­)</option>
                </select>
                <input type="number" id="mq-val" placeholder="è§¸ç™¼æ•¸å€¼ (ä¾‹: 30)" style="flex:1; min-width:120px;">
            </div>
            <input type="text" id="mq-text" placeholder="è·‘é¦¬ç‡ˆæ–‡å­—ï¼Œæ”¯æ´è®Šæ•¸ï¼š{aqi}, {pm25}, {health}, {temp}" style="margin-top:10px; width:100%;">
            <p style="font-size:11px; color:#888; margin:8px 0;">è®Šæ•¸ç¯„ä¾‹å¯«æ³•ï¼šã€Œè­¦å‘Šï¼ç›®å‰ç•¶åœ° AQI é«˜é” {aqi}ï¼Œå·²ç‚ºæ‚¨å•Ÿå‹•å¼·æ•ˆéæ¿¾ï¼Œç›®å‰å£½å‘½å‰©é¤˜ {health}%ã€</p>
            <button class="btn btn-primary" style="margin-top:5px;" onclick="addMarqueeRule()">â• åŠ å…¥è¦å‰‡åˆ—è¡¨</button>
        </div>
        
        <p style="font-size:13px; color:#ef4444; font-weight:bold;">â€» æ’åºè¶Šä¸Šé¢çš„è¦å‰‡ï¼Œæ“æœ‰è¶Šé«˜çš„è§¸ç™¼å„ªå…ˆæ¬Šï¼ç•¶çš†æœªè§¸ç™¼æ™‚ï¼Œç³»çµ±å°‡è‡ªå‹•å¾ã€Œå¸¸é§è¼ªæ’­ã€ä¸­éš¨æ©ŸæŠ½æ’­ã€‚</p>
        <div class="table-container">
            <table id="marquee-table">
                <thead><tr><th>å„ªå…ˆæ¬Š</th><th>è§¸ç™¼æ¢ä»¶</th><th>é¡¯ç¤ºæ–‡å­—</th><th>ç‹€æ…‹</th><th style="text-align:center;">æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-warn" style="width:100%; margin-top:20px; font-size:16px; padding:12px; margin-bottom: 10px;" onclick="resetMarqueeRules()">ğŸ”„ ä¸€éµè¼‰å…¥åŸå»  30 çµ„è·‘é¦¬ç‡ˆé è¨­åº« (è¦†è“‹ç›®å‰è¨­å®š)</button>
        <button class="btn btn-primary" style="width:100%; font-size:16px; padding:12px;" onclick="saveMarqueeToDB()">ğŸ’¾ å„²å­˜æ‰€æœ‰è·‘é¦¬ç‡ˆè¦å‰‡è‡³é›²ç«¯</button>
    </div>

    <div id="panel-crm" class="panel">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (ä¸Šå¸æ¨¡å¼ï¼šå¼·åˆ¶é€£é–æ‹”é™¤)</h2>
      <div class="table-container">
        <table id="crm-table"><thead><tr><th>å®¢æˆ¶è³‡è¨Š</th><th>è»Šè¼›é…ç½®</th><th>ç³»çµ±æ•¸æ“š</th><th style="text-align:center;">ä¸Šå¸æ“ä½œ (éœ€å¯†ç¢¼)</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
          <h2 style="margin:0; border:none; padding:0;">ğŸ·ï¸ UID åº«å­˜ç®¡ç† (å³æ™‚å‹•æ…‹å£½å‘½)</h2>
          <button id="btn-unlock-god" class="btn btn-danger" onclick="unlockUIDGodMode()">ğŸ”’ é»æ“Šè¼¸å…¥å¯†ç¢¼è§£é–ä¿®æ”¹æ¬Šé™</button>
      </div>
      <button class="btn btn-primary" style="margin-bottom: 15px;" onclick="generateSequentialUIDs()">âš™ï¸ ä¸€éµç”¢ç”Ÿ 50 çµ„æ–° UID (å·¥å» å…¥åº«)</button>
      <div class="table-container">
        <table id="uid-table"><thead><tr><th>UID æ¢ç¢¼</th><th>ç¶å®šè»Šæ¬¾</th><th>å®‰è£æ‰€åœ¨åœ°</th><th style="text-align:center;">å‹•æ…‹å£½å‘½(åŒæ­¥App)</th><th style="text-align:center;">æ¬Šé™æ“ä½œå€</th></tr></thead><tbody></tbody></table>
      </div>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ± å…¨å° AI åº§è‰™ ESG æ¸›ç¢³ç¸½è¡¨</h2>
      <div class="env-stats" style="margin-top:30px;">
        <div class="env-card" style="border-color:#10b981; background:#f0fdf4;"><h3>ğŸ›¡ï¸ ç¸½æ””æˆª PM2.5 æ‡¸æµ®å¾®ç²’</h3><p id="esg-total-pm25" style="color:#059669; font-size:36px;">è¨ˆç®—ä¸­...</p><span style="font-size:12px; color:#666;">å–®ä½: å¾®å…‹ (Âµg)</span></div>
        <div class="env-card" style="border-color:#3b82f6; background:#eff6ff;"><h3>âš¡ï¸ ç¸½å†·æ°£çœé›»æ•ˆèƒ½</h3><p id="esg-total-kwh" style="color:#2563eb; font-size:36px;">è¨ˆç®—ä¸­...</p><span style="font-size:12px; color:#666;">å–®ä½: åº¦ (kWh)</span></div>
        <div class="env-card" style="border-color:#f59e0b; background:#fffbeb;"><h3>ğŸŒ± ç¸½æ¸›å°‘ç¢³æ’é‡</h3><p id="esg-total-co2" style="color:#d97706; font-size:36px;">è¨ˆç®—ä¸­...</p><span style="font-size:12px; color:#666;">å–®ä½: å…¬æ–¤ (kg)</span></div>
      </div>
      <p style="text-align:center; color:#888; font-size:13px; margin-top:20px;">* æ•¸æ“šç”± AI æ¼”ç®—æ³•å³æ™‚æŠ“å–å…¨å°æœ‰æ•ˆç¶å®šä¹‹æ¿¾ç¶²ï¼Œä¸¦äº¤å‰é‹ç®—è»Šæ¬¾ã€å¹´é‡Œç¨‹èˆ‡ç’°å¢ƒéƒ¨æ‰€åœ¨åœ°æ•¸æ“šå¾—å‡ºã€‚</p>
    </div>

    <div id="panel-rewards" class="panel"><h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2><div class="table-container"><table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹æ‰£é™¤é»æ•¸</th><th>ç”³è«‹æ™‚é–“</th><th style="text-align:center;">å¯©æ ¸æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div>
    <div id="panel-garages" class="panel"><h2>ğŸª ä¿ä¿®å» åŠ ç›Ÿå¯©æ ¸ç®¡ç†</h2><div class="table-container"><table id="garage-table"><thead><tr><th>ä¿ä¿®å» è³‡è¨Š</th><th>è¯çµ¡äºº</th><th>ç›®å‰ç‹€æ…‹</th><th style="text-align:center;">å¯©æ ¸æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div>
    <div id="panel-bookings" class="panel"><h2>ğŸ“… å…¨å°é ç´„å–®ç¸½è¡¨</h2><div class="table-container"><table id="booking-table"><thead><tr><th>é ç´„è»Šä¸»</th><th>æŒ‡å®šä¿ä¿®å» </th><th>é ç´„æ—¥æœŸ</th><th>è¨‚å–®ç‹€æ…‹</th><th style="text-align:center;">æ“ä½œ</th></tr></thead><tbody></tbody></table></div></div>
    <div id="panel-bulletins" class="panel">
      <h2>ğŸ“¢ å‰å°é›»å­å¸ƒå‘Šæ¬„ç™¼å¸ƒä¸­å¿ƒ</h2>
      <div style="background:#f9f9f9; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
          <input type="text" id="bul-title" placeholder="å…¬å‘Šæ¨™é¡Œ (ä¾‹å¦‚: æ­¡æ…¶çªç ´ä¸€è¬åè»Šä¸»)" style="margin-bottom:10px;">
          <textarea id="bul-content" rows="3" placeholder="å…¬å‘Šå…§å®¹..."></textarea>
          <button class="btn btn-primary" style="margin-top:10px;" onclick="createBulletin()">ç™¼å¸ƒè‡³å‰å°</button>
      </div>
      <div class="table-container"><table id="bulletin-table"><thead><tr><th>å…¬å‘Šæ¨™é¡Œ</th><th>ç™¼å¸ƒæ™‚é–“</th><th>ç‹€æ…‹</th><th style="text-align:center;">æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="panel-env" class="panel">
      <h2>ğŸŒ å°ç£ 368 é„‰é®ç’°å¢ƒå¤§æ•¸æ“šèˆ‡ AI æ¼”ç®—æ³•ä¸­æ§å°</h2>
      <div class="emergency-box">
          <h3 style="margin-top:0; color:#ef4444;">ğŸš¨ çªç™¼ç½é›£/ç«ç½ç·Šæ€¥é›·é” (å¾®å€ç²¾æº–å®šä½)</h3>
          <p style="font-size:13px; color:#555; margin-bottom:15px;">ç•¶æŸåœ°ç™¼ç”Ÿé‡å¤§äº‹æ•…æ™‚ï¼Œè«‹åœ¨æ­¤æ‰‹å‹•é¸æ“‡å—ç½é„‰é®ã€‚ç³»çµ±å°‡å•Ÿå‹•åœ‹éš›è¡›æ˜Ÿå®šä½ï¼Œå¼·è¿«å–®é»è¦†è“‹æœ€æ–°æ¥µç«¯æ•¸æ“šï¼Œç„¡è¦–å…©å°æ™‚æ’ç¨‹ï¼</p>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <select id="em-city" onchange="updateEmDistricts()" style="flex:1; min-width:150px; background:#fff;"><option value="">é¸æ“‡å—ç½ç¸£å¸‚</option></select>
              <select id="em-district" style="flex:1; min-width:150px; background:#fff;"><option value="">é¸æ“‡å—ç½é„‰é®</option></select>
              <button class="btn btn-danger" style="flex:1; min-width:150px; font-size:15px;" onclick="triggerEmergencyRadar()">ğŸ¯ é–å®šåº§æ¨™å¼·åˆ¶åˆ·æ–°</button>
          </div>
      </div>
      <div style="background:#1e1e1e; padding:20px; border-radius:8px; margin-bottom:25px; color:white;">
        <h3 style="margin-top:0; color:#00e676; border-bottom:1px solid #444; padding-bottom:10px;">ğŸ§  å£½å‘½æ¼”ç®— AI åƒæ•¸ä¸­æ§å°</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top:15px;">
           <div><label style="font-size:11px;color:#aaa;">åŸºç¤æ—¥è€—æ (%)</label><input type="number" id="algo-baseWear" step="0.01" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#f59e0b;">AQIæ©˜å®³ (100-150)</label><input type="number" id="algo-aqiOrange" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#ef4444;">AQIç´…å®³ (>150)</label><input type="number" id="algo-aqiRed" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#ef4444;">é«˜æº« (>30Â°C) å€æ•¸</label><input type="number" id="algo-tempHigh" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#3b82f6;">ä½æº« (<15Â°C) å€æ•¸</label><input type="number" id="algo-tempLow" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#3b82f6;">é«˜æ¿• (>80%) å€æ•¸</label><input type="number" id="algo-humHigh" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#aaa;">å¤§å‹è»Šè¼› å€æ•¸</label><input type="number" id="algo-carLarge" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#aaa;">å°å‹è»Šè¼› å€æ•¸</label><input type="number" id="algo-carSmall" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#f59e0b;">å¹´é‡Œç¨‹åŠ æ¬Š(æ¯è¬km)</label><input type="number" id="algo-mileageWeight" step="0.1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#00e676;">æ¯æ—¥ PM2.5 (Âµg)</label><input type="number" id="algo-basePm25" step="10" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#00e676;">æ—¥å‡çœé›» (kWh)</label><input type="number" id="algo-kwhPerDay" step="0.01" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#00e676;">æ¸›ç¢³è½‰æ›ä¿‚æ•¸</label><input type="number" id="algo-co2Factor" step="0.001" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#00e676;">HYPASS é¢¨é˜» (Pa)</label><input type="number" id="algo-paHypass" step="1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#00e676;">ä»–ç‰Œé¢¨é˜» (Pa)</label><input type="number" id="algo-paOther" step="1" class="scan-input" style="padding:8px; font-size:14px;"></div>
           <div><label style="font-size:11px;color:#fff;">çˆ¬èŸ²é »ç‡ (å°æ™‚)</label><input type="number" id="algo-updateFreqHours" step="1" class="scan-input" style="padding:8px; font-size:14px;"></div>
        </div>
        <button class="btn btn-primary" style="margin-top:15px; width:100%; font-size:15px; padding:12px;" onclick="saveAlgoParams()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒè‡³å…¨å°åº§è‰™</button>
      </div>

      <div class="env-stats">
        <div class="env-card"><h3>è³‡æ–™åº«ç¸½ç­†æ•¸ (é„‰é®)</h3><p id="env-total-count">--</p></div>
        <div class="env-card"><h3>OWM åœ‹éš›è¡›æ˜Ÿå¤§æ•¸æ“š - æœ€å¾ŒåŒæ­¥</h3><p id="env-last-update" style="font-size:16px;">--</p></div>
      </div>

      <div style="margin-bottom: 20px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="triggerGlobalEnvUpdate()">ğŸŒ å•Ÿå‹•é›²ç«¯ OWM å…¨å°é›·é” (ç„¡è¦–æ”¿åºœå°é–)</button>
        <button class="btn btn-dark" onclick="downloadEnvCSV()">ğŸ“¥ åŒ¯å‡ºã€OWM åœ‹éš›å¤§æ•¸æ“šã€‘é›™æ•¸æ“šåº«æ•´åˆåŒ… (CSV)</button>
      </div>

      <div class="table-container">
        <table id="env-table">
          <thead><tr><th>ç¸£å¸‚</th><th>é„‰é®å¸‚å€</th><th>æº«åº¦ (Â°C)</th><th>æ¿•åº¦ (%)</th><th>å³æ™‚ AQI <span style="font-size:10px; color:#aaa;">(US EPA)</span></th><th>PM 2.5</th><th>7æ—¥å‡å€¼ (æ¼”ç®—æ³•)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient('https://qznvabjtxcbffjryfgqi.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k');

    let isGodModeUnlocked = false; 
    let marqueeRules = []; 

    // ğŸŒŸ åŸå»  30 çµ„ AI è·‘é¦¬ç‡ˆå¤§è…¦åº«
    const DEFAULT_MARQUEE_RULES = [
      { id: 1, type: 'health_low', val: 5, text: 'ğŸš¨ åš´é‡è­¦å‘Šï¼æ¿¾ç¶²å£½å‘½åƒ…å‰© {health}%ï¼Œå·²å®Œå…¨å¤±å»é˜²è­·èƒ½åŠ›ï¼Œè«‹ç«‹å³å›å» æ›´æ›ä»¥ä¿è­·å‘¼å¸é“ï¼', active: true },
      { id: 2, type: 'aqi_high', val: 200, text: 'â˜ ï¸ ç´«çˆ†è­¦å ±ï¼æˆ¶å¤– AQI é” {aqi}ï¼Œæ¥µåº¦å±éšªï¼åº§è‰™å·²å¼·åˆ¶å•Ÿå‹•æœ€é«˜ç´šåˆ¥å…§å¾ªç’°é˜²è­·ï¼', active: true },
      { id: 3, type: 'pm25_high', val: 100, text: 'â˜ ï¸ æ¯’éœ¾ä¾†è¥²ï¼æˆ¶å¤– PM2.5 é£†å‡è‡³ {pm25}Âµgï¼Œè«‹å‹¿é–‹çª—ï¼Œç³»çµ±æ­£ä»¥æœ€å¤§åŠŸç‡æ·±åº¦æ·¨åŒ–ï¼', active: true },
      { id: 4, type: 'health_low', val: 10, text: 'âš ï¸ æ³¨æ„ï¼æ¿¾ç¶²é˜²è­·åŠ›åš´é‡è¡°é€€ï¼Œå‰©é¤˜å£½å‘½ {health}%ï¼Œè«‹ç›¡é€Ÿé ç´„ä¿ä¿®å» é€²è¡Œæ›´æ›ã€‚', active: true },
      { id: 5, type: 'aqi_high', val: 150, text: 'ğŸš¨ ç´…å®³è­¦å‘Šï¼ç•¶åœ° AQI é” {aqi}ï¼Œç©ºæ°£æ¥µåº¦ä¸è‰¯ï¼ŒHYPASS éœé›»å±¤æ­£åœ¨å…¨é€Ÿæ””æˆªæœ‰å®³å¾®ç²’ã€‚', active: true },
      { id: 6, type: 'pm25_high', val: 54, text: 'ğŸš¨ é«˜æ¿ƒåº¦æ‡¸æµ®å¾®ç²’ ({pm25}Âµg) è­¦æˆ’ï¼é†«ç™‚ç´šé˜²è­·ç¶²å·²å•Ÿå‹•ï¼Œè»Šå…§ç©ºæ°£æŒçºŒæ·¨åŒ–ä¸­ã€‚', active: true },
      { id: 7, type: 'health_low', val: 20, text: 'âš ï¸ æé†’æ‚¨ï¼ŒHYPASS æ¿¾ç¶²å£½å‘½å‰©é¤˜ {health}%ï¼Œéæ¿¾æ•ˆèƒ½å³å°‡ä¸‹é™ï¼Œå»ºè­°æ‚¨ææ—©å®‰æ’æ›´æ›ã€‚', active: true },
      { id: 8, type: 'aqi_high', val: 100, text: 'ğŸ˜· æ©˜å®³æé†’ï¼šæˆ¶å¤– AQI {aqi}ï¼Œå°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·ï¼Œè«‹å®‰å¿ƒç•™åœ¨è»Šå…§å¤§å£æ·±å‘¼å¸ã€‚', active: true },
      { id: 9, type: 'pm25_high', val: 35, text: 'âš ï¸ æˆ¶å¤– PM2.5 é” {pm25}Âµgï¼Œåº§è‰™å°ˆå±¬æ´»æ€§ç¢³èˆ‡é«˜é›»è·éœé›»å±¤æ­£åœ¨é«˜é€Ÿéæ¿¾ä¸­ã€‚', active: true },
      { id: 10, type: 'health_low', val: 30, text: 'æé†’ï¼šæ¿¾ç¶²å¥åº·åº¦å·²é™è‡³ {health}%ï¼Œç‚ºç¶­æŒæœ€ä½³è»Šå…§ç©ºæ°£å“è³ªï¼Œè«‹ç•™æ„å¾ŒçºŒä¿é¤ŠæœŸç¨‹ã€‚', active: true },
      { id: 11, type: 'temp_high', val: 35, text: 'ğŸ”¥ æˆ¶å¤–æ¥µç«¯é«˜æº« ({temp}Â°C)ï¼HYPASS æ¥µè‡´ä½é¢¨é˜»è¨­è¨ˆï¼Œæ­£å”åŠ©æ‚¨çš„å†·æ°£å¿«é€Ÿé™æº«ä¸¦çœé›»ï¼', active: true },
      { id: 12, type: 'temp_low', val: 10, text: 'â„ï¸ æˆ¶å¤–åš´å¯’ ({temp}Â°C)ï¼Œè»Šçª—ç·Šé–‰æ˜“æ‚¶ç†±ã€‚ç³»çµ±æŒçºŒç‚ºæ‚¨éæ¿¾å°é–‰ç©ºæ°£ï¼Œè«‹æ³¨æ„ä¿æš–ã€‚', active: true },
      { id: 13, type: 'health_low', val: 50, text: 'æ¿¾ç¶²å£½å‘½å·²éåŠ (å‰©é¤˜ {health}%)ï¼ŒHYPASS AI é›²ç«¯å¤§è…¦æŒçºŒç‚ºæ‚¨ç²¾æº–ç›£æ§è€—æç‹€æ…‹ã€‚', active: true },
      { id: 14, type: 'aqi_high', val: 60, text: 'â˜ï¸ ç›®å‰æ‰€åœ¨åœ° AQI ç‚º {aqi}ï¼Œç©ºæ°£å“è³ªæ™®é€šï¼Œåº§è‰™æ™ºèƒ½é˜²è­·ç¶²ç©©å®šé‹è¡Œä¸­ã€‚', active: true },
      { id: 15, type: 'pm25_high', val: 15, text: 'ğŸ“¡ åµæ¸¬åˆ°æˆ¶å¤–å¾®é‡ç²‰å¡µ (PM2.5: {pm25}Âµg)ï¼Œç›®å‰è»Šå…§ç©ºæ°£å·²ç©©å®šç¶­æŒåœ¨é†«ç™‚ç´šç„¡å¡µç‹€æ…‹ã€‚', active: true },
      { id: 16, type: 'temp_high', val: 30, text: 'â˜€ï¸ æ°£æº«é” {temp}Â°Cï¼Œåº§è‰™ç©ºèª¿è¼•è² è¼‰é‹è½‰ä¸­ï¼ŒHYPASS æŒçºŒç‚ºæ‚¨æä¾›å¼·æ•ˆå¤§é¢¨é‡ã€‚', active: true },
      { id: 17, type: 'temp_low', val: 15, text: 'ğŸŒ¬ï¸ æ°£æº«å¾®æ¶¼ ({temp}Â°C)ï¼ŒHYPASS æ¤°æ®¼æ´»æ€§ç¢³æŒçºŒå¸é™„è»Šå…§ç•°å‘³ï¼Œä¿æŒç©ºæ°£æ¸…æ–°ã€‚', active: true },
      { id: 18, type: 'health_low', val: 80, text: 'âœ… æ–°æ¿¾ç¶²ç£¨åˆå®Œç•¢ï¼ç›®å‰å¥åº·åº¦ {health}%ï¼Œæ­£è™•æ–¼éœé›»å¸é™„åŠ›æœ€å¼·çš„é»ƒé‡‘é˜²è­·æœŸã€‚', active: true },
      { id: 19, type: 'default', val: 0, text: 'ğŸ›¡ï¸ HYPASS AI æ™ºèƒ½åº§è‰™é€£ç·šæ­£å¸¸ï¼Œç³»çµ±æ­£é€é US EPA æ¨™æº–æ¼”ç®—æ³•å³æ™‚å®ˆè­·æ‚¨çš„å¥åº·ã€‚', active: true },
      { id: 20, type: 'default', val: 0, text: 'ğŸŒ± æ„Ÿè¬ä½¿ç”¨ HYPASS ç¯€èƒ½æ¿¾ç¶²ï¼ç›®å‰å¥åº·åº¦ {health}%ï¼Œæˆ‘å€‘æ­£åœ¨ä¸€èµ·ç‚ºåœ°çƒæ¸›å°‘ç¢³è¶³è·¡ã€‚', active: true },
      { id: 21, type: 'default', val: 0, text: 'âš¡ ç¨å®¶æ¥µè‡´ä½é¢¨é˜»æŠ€è¡“ï¼Œè®“æ‚¨çš„å†·æ°£è² è¼‰æ›´è¼•ï¼Œç„¡å½¢ä¸­ç‚ºæ‚¨çœä¸‹æ›´å¤šé›»èƒ½èˆ‡æ²¹è€—ã€‚', active: true },
      { id: 22, type: 'default', val: 0, text: 'ğŸ‡¹ğŸ‡¼ å …æŒå°ç£è£½é€ ï¼HYPASS çµåˆé«˜ç¢˜å€¼æ¤°æ®¼æ´»æ€§ç¢³èˆ‡é«˜é›»è·éœé›»ï¼Œé›™æ•ˆåˆä¸€ã€‚', active: true },
      { id: 23, type: 'default', val: 0, text: 'ğŸ¥¥ åº§è‰™å·²è‡ªå‹•å•Ÿå‹• Ecoshell æ¤°æ®¼æ´»æ€§ç¢³é™¤è‡­æ©Ÿåˆ¶ï¼Œè»Šå…§å»¢æ°£èˆ‡ç•°å‘³æ­£åœ¨å¿«é€Ÿæ¶ˆé™¤ä¸­ã€‚', active: true },
      { id: 24, type: 'default', val: 0, text: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ HYPASS ç‚ºå…¨å®¶äººæŠŠé—œå‘¼å¸é“å¥åº·ï¼Œè®“éæ•å…’ä¹Ÿèƒ½åœ¨è»Šå…§å®‰å¿ƒã€å¤§å£åœ°æ·±å‘¼å¸ï¼', active: true },
      { id: 25, type: 'default', val: 0, text: 'ğŸ“¡ å…¨å° 368 é„‰é®ç’°å¢ƒå¤§æ•¸æ“šå³æ™‚é€£ç·šä¸­... ç›®å‰å®¤å¤– AQI {aqi}ï¼Œé˜²è­·ç¶²ç„¡æ‡ˆå¯æ“Šã€‚', active: true },
      { id: 26, type: 'default', val: 0, text: 'ğŸ† æ¥­ç•Œå”¯ä¸€ï¼é›™æ•¸æ“šåº«å³æ™‚é‹ç®—åŠ ä¸Šå‹•æ…‹å£½å‘½è¿½è¹¤ï¼Œçµ¦æ‚¨è¶…è¶Šç™¾è¬é€²å£è»Šçš„åº§è‰™é«”é©—ã€‚', active: true },
      { id: 27, type: 'default', val: 0, text: 'ğŸŒ¬ï¸ HYPASS å¼·æ•ˆå¤§é¢¨é‡è¨­è¨ˆï¼Œèƒ½åœ¨æœ€çŸ­æ™‚é–“å…§å®Œæˆè»Šå…§ç©ºæ°£å¾ªç’°ï¼Œæ·¨åŒ–ç„¡æ­»è§’ã€‚', active: true },
      { id: 28, type: 'default', val: 0, text: 'ğŸ’³ å°ˆå±¬å•†åŸéš±è—å„ªæƒ ç¢¼ã€AIRPLUS2026ã€‘ï¼Œç¾åœ¨å‰å¾€é¸è³¼å‚™ç”¨æ¿¾ç¶²äº«å°Šæ¦®æŠ˜æ‰£ï¼', active: true },
      { id: 29, type: 'default', val: 0, text: 'ğŸ é‚€è«‹è»Šå‹åŠ å…¥æ™ºèƒ½åº§è‰™ï¼Œè¨»å†Šå³å¯ç²å¾— 10 é»çå‹µé‡‘ï¼Œé¦–æƒç¶å®šå†é€ 100 é»ï¼', active: true },
      { id: 30, type: 'default', val: 0, text: 'âœ¨ æ‚¨çš„æ¯ä¸€å£ç´”æ·¨å‘¼å¸ï¼Œéƒ½æ˜¯ HYPASS çš„æœ€é«˜ä½¿å‘½ã€‚ä»Šæ—¥ç¥æ‚¨è¡Œè»Šå¹³å®‰ã€é †å¿ƒã€‚', active: true }
    ];

    const OWM_API_KEY = "bea2c21fc2a2f8e03c63d44e3e75e13e";
    const taiwanDistricts = {
      "åŸºéš†å¸‚": ["ä»æ„›å€", "ä¿¡ç¾©å€", "ä¸­æ­£å€", "ä¸­å±±å€", "å®‰æ¨‚å€", "æš–æš–å€", "ä¸ƒå µå€"], "å°åŒ—å¸‚": ["ä¸­æ­£å€", "å¤§åŒå€", "ä¸­å±±å€", "æ¾å±±å€", "å¤§å®‰å€", "è¬è¯å€", "ä¿¡ç¾©å€", "å£«æ—å€", "åŒ—æŠ•å€", "å…§æ¹–å€", "å—æ¸¯å€", "æ–‡å±±å€"],
      "æ–°åŒ—å¸‚": ["æ¿æ©‹å€", "ä¸‰é‡å€", "ä¸­å’Œå€", "æ°¸å’Œå€", "æ–°èŠå€", "æ–°åº—å€", "æ¨¹æ—å€", "é¶¯æ­Œå€", "ä¸‰å³½å€", "æ·¡æ°´å€", "æ±æ­¢å€", "ç‘èŠ³å€", "åœŸåŸå€", "è˜†æ´²å€", "äº”è‚¡å€", "æ³°å±±å€", "æ—å£å€", "æ·±å‘å€", "çŸ³ç¢‡å€", "åªæ—å€", "ä¸‰èŠå€", "çŸ³é–€å€", "å…«é‡Œå€", "å¹³æºªå€", "é›™æºªå€", "è²¢å¯®å€", "é‡‘å±±å€", "è¬é‡Œå€", "çƒä¾†å€"],
      "æ¡ƒåœ’å¸‚": ["æ¡ƒåœ’å€", "ä¸­å£¢å€", "å¤§æºªå€", "æ¥Šæ¢…å€", "è˜†ç«¹å€", "å¤§åœ’å€", "é¾œå±±å€", "å…«å¾·å€", "é¾æ½­å€", "å¹³é®å€", "æ–°å±‹å€", "è§€éŸ³å€", "å¾©èˆˆå€"], "æ–°ç«¹å¸‚": ["æ±å€", "åŒ—å€", "é¦™å±±å€"],
      "æ–°ç«¹ç¸£": ["ç«¹åŒ—å¸‚", "ç«¹æ±é®", "æ–°åŸ”é®", "é—œè¥¿é®", "æ¹–å£é„‰", "æ–°è±é„‰", "èŠæ—é„‰", "æ©«å±±é„‰", "åŒ—åŸ”é„‰", "å¯¶å±±é„‰", "å³¨çœ‰é„‰", "å°–çŸ³é„‰", "äº”å³°é„‰"],
      "å°ä¸­å¸‚": ["ä¸­å€", "æ±å€", "å—å€", "è¥¿å€", "åŒ—å€", "åŒ—å±¯å€", "è¥¿å±¯å€", "å—å±¯å€", "å¤ªå¹³å€", "å¤§é‡Œå€", "éœ§å³°å€", "çƒæ—¥å€", "è±åŸå€", "åé‡Œå€", "çŸ³å²¡å€", "æ±å‹¢å€", "å’Œå¹³å€", "æ–°ç¤¾å€", "æ½­å­å€", "å¤§é›…å€", "ç¥å²¡å€", "å¤§è‚šå€", "æ²™é¹¿å€", "é¾äº•å€", "æ¢§æ£²å€", "æ¸…æ°´å€", "å¤§ç”²å€", "å¤–åŸ”å€", "å¤§å®‰å€"],
      "å°å—å¸‚": ["æ–°ç‡Ÿå€", "é¹½æ°´å€", "ç™½æ²³å€", "æŸ³ç‡Ÿå€", "å¾Œå£å€", "æ±å±±å€", "éº»è±†å€", "ä¸‹ç‡Ÿå€", "å…­ç”²å€", "å®˜ç”°å€", "å¤§å…§å€", "ä½³é‡Œå€", "å­¸ç”²å€", "è¥¿æ¸¯å€", "ä¸ƒè‚¡å€", "å°‡è»å€", "åŒ—é–€å€", "æ–°åŒ–å€", "å–„åŒ–å€", "æ–°å¸‚å€", "å®‰å®šå€", "å±±ä¸Šå€", "ç‰äº•å€", "æ¥ è¥¿å€", "å—åŒ–å€", "å·¦é®å€", "ä»å¾·å€", "æ­¸ä»å€", "é—œå»Ÿå€", "é¾å´å€", "æ°¸åº·å€", "æ±å€", "å—å€", "åŒ—å€", "å®‰å—å€", "å®‰å¹³å€", "ä¸­è¥¿å€"],
      "é«˜é›„å¸‚": ["é¹½åŸ•å€", "é¼“å±±å€", "å·¦ç‡Ÿå€", "æ¥ æ¢“å€", "ä¸‰æ°‘å€", "æ–°èˆˆå€", "å‰é‡‘å€", "è‹“é›…å€", "å‰é®å€", "æ——æ´¥å€", "å°æ¸¯å€", "é³³å±±å€", "æ—åœ’å€", "å¤§å¯®å€", "å¤§æ¨¹å€", "å¤§ç¤¾å€", "ä»æ­¦å€", "é³¥æ¾å€", "å²¡å±±å€", "æ©‹é ­å€", "ç‡•å·¢å€", "ç”°å¯®å€", "é˜¿è“®å€", "è·¯ç«¹å€", "æ¹–å…§å€", "èŒ„è£å€", "æ°¸å®‰å€", "å½Œé™€å€", "æ¢“å®˜å€", "æ——å±±å€", "ç¾æ¿ƒå€", "å…­é¾œå€", "ç”²ä»™å€", "æ‰æ—å€", "å…§é–€å€", "èŒ‚æ—å€", "æ¡ƒæºå€", "é‚£ç‘ªå¤å€"],
      "å®œè˜­ç¸£": ["å®œè˜­å¸‚", "ç¾…æ±é®", "è˜‡æ¾³é®", "é ­åŸé®", "ç¤æºªé„‰", "å£¯åœé„‰", "å“¡å±±é„‰", "å†¬å±±é„‰", "äº”çµé„‰", "ä¸‰æ˜Ÿé„‰", "å¤§åŒé„‰", "å—æ¾³é„‰"],
      "èŠ±è“®ç¸£": ["èŠ±è“®å¸‚", "é³³æ—é®", "ç‰é‡Œé®", "æ–°åŸé„‰", "å‰å®‰é„‰", "å£½è±é„‰", "å…‰å¾©é„‰", "è±æ¿±é„‰", "ç‘ç©—é„‰", "å¯Œé‡Œé„‰", "ç§€æ—é„‰", "è¬æ¦®é„‰", "å“æºªé„‰"],
      "å°æ±ç¸£": ["å°æ±å¸‚", "æˆåŠŸé®", "é—œå±±é®", "å‘å—é„‰", "é¹¿é‡é„‰", "æ± ä¸Šé„‰", "æ±æ²³é„‰", "é•·æ¿±é„‰", "å¤ªéº»é‡Œé„‰", "å¤§æ­¦é„‰", "ç¶ å³¶é„‰", "æµ·ç«¯é„‰", "å»¶å¹³é„‰", "é‡‘å³°é„‰", "é”ä»é„‰", "è˜­å¶¼é„‰"],
      "æ¾æ¹–ç¸£": ["é¦¬å…¬å¸‚", "æ¹–è¥¿é„‰", "ç™½æ²™é„‰", "è¥¿å¶¼é„‰", "æœ›å®‰é„‰", "ä¸ƒç¾é„‰"], "é‡‘é–€ç¸£": ["é‡‘åŸé®", "é‡‘æ¹–é®", "é‡‘æ²™é®", "é‡‘å¯§é„‰", "çƒˆå¶¼é„‰", "çƒåµé„‰"], "é€£æ±Ÿç¸£": ["å—ç«¿é„‰", "åŒ—ç«¿é„‰", "è’å…‰é„‰", "æ±å¼•é„‰"],
      "è‹—æ —ç¸£": ["è‹—æ —å¸‚", "è‹‘è£¡é®", "é€šéœ„é®", "ç«¹å—é®", "é ­ä»½å¸‚", "å¾Œé¾é®", "å“è˜­é®", "å¤§æ¹–é„‰", "å…¬é¤¨é„‰", "éŠ…é‘¼é„‰", "å—åº„é„‰", "é ­å±‹é„‰", "ä¸‰ç¾©é„‰", "è¥¿æ¹–é„‰", "é€ æ©‹é„‰", "ä¸‰ç£é„‰", "ç…æ½­é„‰", "æ³°å®‰é„‰"],
      "å½°åŒ–ç¸£": ["å½°åŒ–å¸‚", "é¹¿æ¸¯é®", "å’Œç¾é®", "ç·šè¥¿é„‰", "ä¼¸æ¸¯é„‰", "ç¦èˆˆé„‰", "ç§€æ°´é„‰", "èŠ±å£‡é„‰", "èŠ¬åœ’é„‰", "å“¡æ—å¸‚", "æºªæ¹–é®", "ç”°ä¸­é®", "å¤§æ‘é„‰", "åŸ”é¹½é„‰", "åŸ”å¿ƒé„‰", "æ°¸é–é„‰", "ç¤¾é ­é„‰", "äºŒæ°´é„‰", "åŒ—æ–—é®", "äºŒæ—é®", "ç”°å°¾é„‰", "åŸ¤é ­é„‰", "èŠ³è‹‘é„‰", "å¤§åŸé„‰", "ç«¹å¡˜é„‰", "æºªå·é„‰"],
      "å—æŠ•ç¸£": ["å—æŠ•å¸‚", "åŸ”é‡Œé®", "è‰å±¯é®", "ç«¹å±±é®", "é›†é›†é®", "åé–“é„‰", "é¹¿è°·é„‰", "ä¸­å¯®é„‰", "é­šæ± é„‰", "åœ‹å§“é„‰", "æ°´é‡Œé„‰", "ä¿¡ç¾©é„‰", "ä»æ„›é„‰"],
      "é›²æ—ç¸£": ["æ–—å…­å¸‚", "æ–—å—é®", "è™å°¾é®", "è¥¿èºé®", "åœŸåº«é®", "åŒ—æ¸¯é®", "å¤å‘é„‰", "å¤§åŸ¤é„‰", "è¿æ¡é„‰", "æ—å…§é„‰", "äºŒå´™é„‰", "å´™èƒŒé„‰", "éº¥å¯®é„‰", "æ±å‹¢é„‰", "è¤’å¿ é„‰", "è‡ºè¥¿é„‰", "å…ƒé•·é„‰", "å››æ¹–é„‰", "å£æ¹–é„‰", "æ°´æ—é„‰"],
      "å˜‰ç¾©å¸‚": ["æ±å€", "è¥¿å€"],
      "å˜‰ç¾©ç¸£": ["å¤ªä¿å¸‚", "æœ´å­å¸‚", "å¸ƒè¢‹é®", "å¤§æ—é®", "æ°‘é›„é„‰", "æºªå£é„‰", "æ–°æ¸¯é„‰", "å…­è…³é„‰", "æ±çŸ³é„‰", "ç¾©ç«¹é„‰", "é¹¿è‰é„‰", "æ°´ä¸Šé„‰", "ä¸­åŸ”é„‰", "ç«¹å´é„‰", "æ¢…å±±é„‰", "ç•ªè·¯é„‰", "å¤§åŸ”é„‰", "é˜¿é‡Œå±±é„‰"],
      "å±æ±ç¸£": ["å±æ±å¸‚", "æ½®å·é®", "æ±æ¸¯é®", "æ†æ˜¥é®", "è¬ä¸¹é„‰", "é•·æ²»é„‰", "éºŸæ´›é„‰", "ä¹å¦‚é„‰", "é‡Œæ¸¯é„‰", "é¹½åŸ”é„‰", "é«˜æ¨¹é„‰", "è¬å·’é„‰", "å…§åŸ”é„‰", "ç«¹ç”°é„‰", "æ–°åŸ¤é„‰", "æ‹å¯®é„‰", "æ–°åœ’é„‰", "å´é ‚é„‰", "æ—é‚Šé„‰", "å—å·é„‰", "ä½³å†¬é„‰", "ç‰çƒé„‰", "è»ŠåŸé„‰", "æ»¿å·é„‰", "æ‹å±±é„‰", "ä¸‰åœ°é–€é„‰", "éœ§è‡ºé„‰", "ç‘ªå®¶é„‰", "æ³°æ­¦é„‰", "ä¾†ç¾©é„‰", "æ˜¥æ—¥é„‰", "ç…å­é„‰", "ç‰¡ä¸¹é„‰"]
    };

    const emCitySel = document.getElementById('em-city');
    for (const city in taiwanDistricts) { emCitySel.innerHTML += `<option value="${city}">${city}</option>`; }
    function updateEmDistricts() {
        const city = document.getElementById('em-city').value;
        const distSel = document.getElementById('em-district');
        distSel.innerHTML = '<option value="">é¸æ“‡å—ç½é„‰é®</option>';
        if(taiwanDistricts[city]) { taiwanDistricts[city].forEach(d => distSel.innerHTML += `<option value="${d}">${d}</option>`); }
    }

    function calcUSEpaAqi(pm25) {
        if (pm25 <= 12.0) return Math.round((50 / 12.0) * pm25);
        if (pm25 <= 35.4) return Math.round(((100 - 51) / (35.4 - 12.1)) * (pm25 - 12.1) + 51);
        if (pm25 <= 55.4) return Math.round(((150 - 101) / (55.4 - 35.5)) * (pm25 - 35.5) + 101);
        if (pm25 <= 150.4) return Math.round(((200 - 151) / (150.4 - 55.5)) * (pm25 - 55.5) + 151);
        if (pm25 <= 250.4) return Math.round(((300 - 201) / (250.4 - 150.5)) * (pm25 - 150.5) + 201);
        return 300; 
    }

    async function triggerEmergencyRadar() {
        const city = document.getElementById('em-city').value;
        const dist = document.getElementById('em-district').value;
        if (!city || !dist) return alert("è«‹å…ˆé¸æ“‡å—ç½ç¸£å¸‚èˆ‡é„‰é®ï¼");
        if(!confirm(`âš ï¸ è­¦å‘Šï¼šæ‚¨å³å°‡å¼·åˆ¶æ›´æ–°ã€${city}${dist}ã€‘çš„ç©ºæ°£æ•¸æ“šã€‚\næ­¤æ“ä½œå°‡ç«‹åˆ»å½±éŸ¿è©²å€è»Šä¸» Appï¼ç¢ºå®šåŸ·è¡Œï¼Ÿ`)) return;

        try {
            const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=å°ç£${city}${dist}`);
            const geoData = await geoRes.json();
            if(!geoData || geoData.length === 0) throw new Error("ç„¡æ³•å®šä½åº§æ¨™ã€‚");
            
            const lat = geoData[0].lat; const lon = geoData[0].lon;
            const wRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric`);
            const pRes = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
            const wData = await wRes.json(); const pData = await pRes.json();
            
            const temp = wData.main.temp; const hum = wData.main.humidity;
            const pm25 = pData.list[0].components.pm2_5; const aqi = calcUSEpaAqi(pm25);

            const { data: oldCache } = await supabaseClient.from('env_cache').select('aqi_7d_avg').eq('city', city).eq('district', dist).maybeSingle();
            let avgAqi = aqi; if (oldCache?.aqi_7d_avg) { avgAqi = (oldCache.aqi_7d_avg * 83 + aqi) / 84; }

            await supabaseClient.from('env_cache').upsert({ 
                city: city, district: dist, aqi: aqi, pm25: pm25, temp: temp, hum: hum, aqi_7d_avg: avgAqi, updated_at: new Date() 
            }, { onConflict: 'city, district' });

            alert(`ğŸš¨ ç·Šæ€¥é›·é”é–å®šæˆåŠŸï¼\n\nã€${city}${dist}ã€‘\nç¾å ´æº«åº¦: ${temp}Â°C\nå³æ™‚ PM2.5: ${pm25} Âµg\nè½‰æ› AQI: ${aqi}`);
            loadEnvData();
        } catch(e) { alert("âŒ éŒ¯èª¤: " + e.message); }
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active'); btn.classList.add('active');
      if (id === 'crm') loadCRM(); if (id === 'uid') loadUIDs(); if (id === 'esg') loadESG(); if (id === 'rewards') loadRewards();
      if (id === 'garages') loadGarages(); if (id === 'bookings') loadBookings(); if (id === 'bulletins') loadBulletins();
      if (id === 'env') { loadEnvData(); loadAlgoParams(); }
      if (id === 'marquee') loadMarquee();
    }

    // ğŸŒŸ è·‘é¦¬ç‡ˆæ ¸å¿ƒç®¡ç†é‚è¼¯
    async function loadMarquee() {
        document.getElementById('marquee-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">è®€å–ä¸­...</td></tr>';
        const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'marquee_rules').maybeSingle();
        // å¦‚æœé›²ç«¯æœ‰å°±ç”¨é›²ç«¯çš„ï¼Œå¦‚æœæ²’æœ‰æˆ–è¢«åˆªå…‰ï¼Œå°±è‡ªå‹•æ³¨å…¥ 30 çµ„åŸå» é è¨­
        if (data && data.value && data.value.length > 0) {
            marqueeRules = data.value;
        } else {
            marqueeRules = JSON.parse(JSON.stringify(DEFAULT_MARQUEE_RULES));
            saveMarqueeToDB(true); // éœé»˜å„²å­˜
        }
        renderMarqueeTable();
    }

    function renderMarqueeTable() {
        let html = '';
        marqueeRules.forEach((rule, index) => {
            let typeStr = '';
            if(rule.type==='health_low') typeStr = `å£½å‘½ä½æ–¼ <b>${rule.val}%</b>`;
            if(rule.type==='aqi_high') typeStr = `AQI é«˜æ–¼ <b>${rule.val}</b>`;
            if(rule.type==='pm25_high') typeStr = `PM2.5 é«˜æ–¼ <b>${rule.val}</b>`;
            if(rule.type==='temp_high') typeStr = `æº«åº¦é«˜æ–¼ <b>${rule.val}Â°C</b>`;
            if(rule.type==='temp_low') typeStr = `æº«åº¦ä½æ–¼ <b>${rule.val}Â°C</b>`;
            if(rule.type==='default') typeStr = `ğŸ“Œ å¸¸é§è¼ªæ’­`;

            html += `<tr>
                <td style="text-align:center; font-weight:bold; color:#00e676;">#${index + 1}</td>
                <td>${typeStr}</td>
                <td style="color:#555;">${rule.text}</td>
                <td style="text-align:center;">
                    <button class="btn ${rule.active ? 'btn-primary' : 'btn-dark'}" style="padding:4px 8px; font-size:11px;" onclick="toggleMarquee(${index})">${rule.active ? 'é¡¯ç¤ºä¸­' : 'å·²é—œé–‰'}</button>
                </td>
                <td style="text-align:center;">
                    <button class="btn btn-warn" style="padding:4px 8px; font-size:11px;" onclick="moveMarquee(${index}, -1)" ${index===0?'disabled':''}>â¬†ï¸</button>
                    <button class="btn btn-warn" style="padding:4px 8px; font-size:11px;" onclick="moveMarquee(${index}, 1)" ${index===marqueeRules.length-1?'disabled':''}>â¬‡ï¸</button>
                    <button class="btn btn-danger" style="padding:4px 8px; font-size:11px;" onclick="deleteMarquee(${index})">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        });
        document.getElementById('marquee-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;">å°šç„¡è¦å‰‡</td></tr>';
    }

    function addMarqueeRule() {
        if(marqueeRules.length >= 50) return alert("æœ€å¤šåªèƒ½è¨­å®š 50 çµ„è¦å‰‡ï¼");
        const type = document.getElementById('mq-type').value;
        const val = parseFloat(document.getElementById('mq-val').value) || 0;
        const text = document.getElementById('mq-text').value;
        if(!text) return alert("è«‹è¼¸å…¥è·‘é¦¬ç‡ˆé¡¯ç¤ºæ–‡å­—ï¼");
        if(type !== 'default' && document.getElementById('mq-val').value === '') return alert("è«‹è¼¸å…¥è§¸ç™¼æ•¸å€¼ï¼");
        
        marqueeRules.unshift({ id: Date.now(), type, val, text, active: true }); 
        document.getElementById('mq-val').value = ''; document.getElementById('mq-text').value = '';
        renderMarqueeTable();
    }

    function toggleMarquee(index) { marqueeRules[index].active = !marqueeRules[index].active; renderMarqueeTable(); }
    function deleteMarquee(index) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¦å‰‡ï¼Ÿ")) { marqueeRules.splice(index, 1); renderMarqueeTable(); } }
    function moveMarquee(index, dir) {
        if(index + dir < 0 || index + dir >= marqueeRules.length) return;
        let temp = marqueeRules[index]; marqueeRules[index] = marqueeRules[index + dir]; marqueeRules[index + dir] = temp;
        renderMarqueeTable();
    }

    function resetMarqueeRules() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‚¨æ‰‹å‹•å»ºç«‹çš„è¦å‰‡ï¼Œä¸¦è¦†è“‹å›åŸå» çš„ 30 çµ„ AI è·‘é¦¬ç‡ˆåº«ï¼Œç¢ºå®šåŸ·è¡Œå—ï¼Ÿ")) {
            marqueeRules = JSON.parse(JSON.stringify(DEFAULT_MARQUEE_RULES));
            renderMarqueeTable();
            alert("âœ… å·²è¼‰å…¥åŸå» è¨­å®šï¼Œè«‹è¨˜å¾—é»æ“Šã€Œå„²å­˜è‡³é›²ç«¯ã€æ‰æœƒç”Ÿæ•ˆå–”ï¼");
        }
    }

    async function saveMarqueeToDB(silent = false) {
        const { error } = await supabaseClient.from('system_settings').upsert({ key: 'marquee_rules', value: marqueeRules });
        if(!silent) {
            if(error) alert("å„²å­˜å¤±æ•—: " + error.message); else alert("âœ… è·‘é¦¬ç‡ˆè¦å‰‡å·²å„²å­˜ä¸¦ç™¼å¸ƒè‡³å…¨å° Appï¼");
        }
    }

    let html5QrcodeScanner = null; let mediaRecorder = null; let recordedChunks = []; let currentOrder = ""; let currentUID = ""; let videoStream = null;

    function startScanFlow() {
        currentOrder = ""; currentUID = ""; document.getElementById('inp-order').value = ""; document.getElementById('inp-uid').value = "";
        document.getElementById('btn-scan').style.display = 'none'; document.getElementById('scanner-box').style.display = 'block'; document.getElementById('flow-status').innerText = "ç¬¬ä¸€æ­¥ï¼šè«‹å°‡é¡é ­å°æº– Shopline è¨‚å–®æ¢ç¢¼";
        html5QrcodeScanner = new Html5Qrcode("scanner-box");
        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 280, height: 100 } }, 
            (text) => {
                const scannedText = text.trim();
                if (!currentOrder) { if(!scannedText.startsWith('HP-')) { currentOrder = scannedText; document.getElementById('inp-order').value = currentOrder; document.getElementById('flow-status').innerText = "âœ… è¨‚å–® OKï¼ç¬¬äºŒæ­¥ï¼šè«‹æƒææ¿¾ç¶² UID (HP- é–‹é ­)"; }
                } else if (!currentUID) {
                    if(scannedText.startsWith('HP-')) {
                        currentUID = scannedText; document.getElementById('inp-uid').value = currentUID;
                        html5QrcodeScanner.stop().then(() => { document.getElementById('scanner-box').style.display = 'none'; document.getElementById('flow-status').innerText = "âœ… æƒæå®Œæˆï¼è«‹é»æ“Šã€é–‹å§‹åŒ…è£éŒ„å½±ã€é€²è¡Œè£ç®±"; document.getElementById('btn-record').style.display = 'inline-block'; });
                    }
                }
            }, (err) => { }
        ).catch(err => { alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹å…è¨±æ¬Šé™ï¼"); document.getElementById('btn-scan').style.display = 'inline-block'; document.getElementById('scanner-box').style.display = 'none'; });
    }

    async function startRecording() {
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            const videoElement = document.getElementById('video-box'); videoElement.style.display = 'block'; videoElement.srcObject = videoStream;
            mediaRecorder = new MediaRecorder(videoStream); mediaRecorder.ondataavailable = function(e) { if (e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.start(); document.getElementById('btn-record').style.display = 'none'; document.getElementById('btn-stop').style.display = 'inline-block';
            document.getElementById('rec-dot').style.display = 'inline'; document.getElementById('flow-status').innerText = "ğŸ¥ éŒ„å½±ä¸­... è«‹é–‹å§‹åŒ…è²¨ã€‚å®Œæˆå¾Œé»æ“ŠçµæŸ";
        } catch (err) { alert("ç„¡æ³•å–å¾—ç›¸æ©Ÿæ¬Šé™éŒ„å½±ï¼š" + err.message); }
    }

    async function stopAndSave() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            document.getElementById('flow-status').innerText = "ğŸ”„ è™•ç†å½±ç‰‡èˆ‡å¯«å…¥è³‡æ–™åº«ä¸­..."; document.getElementById('btn-stop').style.display = 'none'; document.getElementById('rec-dot').style.display = 'none';
            mediaRecorder.stop();
            mediaRecorder.onstop = async function() {
                const blob = new Blob(recordedChunks, { type: 'video/webm' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; 
                a.download = `${currentOrder}_${currentUID}.webm`; a.click(); recordedChunks = []; videoStream.getTracks().forEach(track => track.stop()); document.getElementById('video-box').style.display = 'none';
                try {
                    const { data: user } = await supabaseClient.from('users').select('line_uid').eq('phone', currentOrder).maybeSingle(); 
                    const payload = { status: 'sold', shopline_order_id: currentOrder }; if(user) payload.activated_by_uid = user.line_uid;
                    const { error } = await supabaseClient.from('filters_uid').update(payload).eq('uid', currentUID); if (error) throw error; alert("âœ… å‡ºè²¨æˆåŠŸï¼å½±ç‰‡å·²ä¸‹è¼‰ã€‚");
                } catch(dbErr) { alert("âš ï¸ å½±ç‰‡å·²ä¸‹è¼‰ï¼Œä½†è³‡æ–™åº«æ›´æ–°å¤±æ•—ï¼š" + dbErr.message); }
                document.getElementById('btn-scan').style.display = 'inline-block'; document.getElementById('flow-status').innerText = "æº–å‚™å°±ç·’ã€‚è«‹å•Ÿå‹•é¡é ­æƒæä¸‹ä¸€ç­†"; document.getElementById('inp-order').value = ""; document.getElementById('inp-uid').value = "";
            };
        }
    }

    async function loadCRM() {
      document.getElementById('crm-table').querySelector('tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;">è®€å–ä¸­...</td></tr>';
      const [resUsers, resFilters, resRewards] = await Promise.all([ supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false }), supabaseClient.from('filters_uid').select('activated_by_uid'), supabaseClient.from('rewards').select('user_uid') ]);
      let pCounts = {}; resFilters.data?.forEach(f => { if(f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1; });
      let rCounts = {}; resRewards.data?.forEach(r => { if(r.user_uid) rCounts[r.user_uid] = (rCounts[r.user_uid] || 0) + 1; });
      let html = '';
      resUsers.data?.forEach(u => { html += `<tr><td><div style="font-weight:bold; color:#1976d2; font-size:16px;">${u.name}</div><div style="color:#666; margin-top:4px;">${u.phone}</div></td><td><b>${u.car_brand}</b><br><span style="color:#f59e0b; font-family:monospace; font-size:16px;">${u.license_plate}</span></td><td>æ¿¾ç¶²: <b>${pCounts[u.line_uid]||0}</b><br>çå‹µ: <b>${rCounts[u.line_uid]||0}</b></td><td style="text-align:center;"><button class="btn btn-warn" onclick="godModeEdit('${u.line_uid}', '${u.name}')">ä¿®æ”¹</button> <button class="btn btn-danger" onclick="godModeDelete('${u.line_uid}', '${u.name}')">éŠ·æ¯€</button></td></tr>`; }); document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    async function godModeDelete(uid, name) {
        if (prompt(`ã€æœ€é«˜æ¬Šé™ã€‘æ°¸ä¹…éŠ·æ¯€å®¢æˆ¶ã€${name}ã€‘ã€‚\nè«‹è¼¸å…¥ä¸Šå¸å¯†ç¢¼ï¼š`) !== "hypass888") return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        if (confirm(`âš ï¸ ç¢ºå®šè¦æ‘§æ¯€ ${name} å—ï¼Ÿæ­¤å‹•ä½œå°‡é€£é–æ‹”é™¤ä»–æ‰€æœ‰ç´€éŒ„ï¼`)) {
            try {
                await supabaseClient.from('rewards').delete().eq('user_uid', uid); await supabaseClient.from('bookings').delete().eq('user_uid', uid);
                await supabaseClient.from('filters_uid').update({ activated_by_uid: null, status: 'sold' }).eq('activated_by_uid', uid);
                await supabaseClient.from('users').update({ referrer_uid: null }).eq('referrer_uid', uid);
                const { error } = await supabaseClient.from('users').delete().eq('line_uid', uid);
                if (error) throw error; alert("âœ… ç›®æ¨™å·²å¾¹åº•éŠ·æ¯€ï¼"); loadCRM();
            } catch (err) { alert("âŒ æ‘§æ¯€å¤±æ•—ï¼\n\n" + err.message); }
        }
    }

    async function godModeEdit(uid, currentName) {
        if (prompt(`ã€ä¿®æ”¹æ¨¡å¼ã€‘ç›®æ¨™: ${currentName}ã€‚\nè«‹è¼¸å…¥å¯†ç¢¼ï¼š`) !== "hypass888") return alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        const newPhone = prompt(`è¼¸å…¥æ–°æ‰‹æ©Ÿè™Ÿ (ç•™ç©ºä¸æ”¹)ï¼š`); const newPlate = prompt(`è¼¸å…¥æ–°è»Šç‰Œè™Ÿ (ç•™ç©ºä¸æ”¹)ï¼š`);
        let updates = {}; if (newPhone) updates.phone = newPhone; if (newPlate) updates.license_plate = newPlate;
        if (Object.keys(updates).length > 0) { await supabaseClient.from('users').update(updates).eq('line_uid', uid); alert("ä¿®æ”¹æˆåŠŸï¼"); loadCRM(); }
    }

    function unlockUIDGodMode() {
        if (prompt("è«‹è¼¸å…¥ä¸Šå¸å¯†ç¢¼è§£é–ä¿®æ”¹æ¬Šé™ï¼š") === "hypass888") {
            isGodModeUnlocked = true; document.getElementById('btn-unlock-god').style.display = 'none'; alert("ğŸ”“ æ¬Šé™å·²è§£é–ï¼å¯ç›´æ¥ä¿®æ”¹ UID ç‹€æ…‹ã€‚"); loadUIDs();
        } else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
    }

    async function loadUIDs() {
        document.getElementById('uid-table').querySelector('tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;">è¨ˆç®—å‹•æ…‹å£½å‘½ä¸­...</td></tr>';
        const [resUIDs, resSettings, resEnv] = await Promise.all([
            supabaseClient.from('filters_uid').select('*, users(city, district, car_brand, car_model, yearly_mileage)').order('uid', { ascending: false }).limit(50),
            supabaseClient.from('system_settings').select('value').eq('key', 'algo_params').maybeSingle(), supabaseClient.from('env_cache').select('*')
        ]);
        let p = resSettings.data ? resSettings.data.value : { baseWear: 0.27, aqiOrange: 1.4, aqiRed: 1.8, tempHigh: 1.2, tempLow: 0.9, humHigh: 1.2, carLarge: 1.3, carSmall: 0.8, mileageWeight: 0.5 };
        let envDataList = resEnv.data || []; let html = '';

        if(resUIDs.data) {
            resUIDs.data.forEach(d => {
                let healthStr = '<span style="color:#888;">--</span>'; let carStr = d.users ? `${d.users.car_brand}<br>${d.users.car_model}` : '-'; let locStr = d.users ? `${d.users.city||''}<br>${d.users.district||''}` : '-';
                if (d.status === 'activated' && d.activated_at && d.users) {
                    const today = new Date(); const actDate = new Date(d.activated_at); const days = Math.max(0, Math.floor((today - actDate) / (1000 * 60 * 60 * 24)));
                    let myEnv = envDataList.find(e => e.city === d.users.city && e.district === d.users.district) || { aqi: 50, temp: 25, hum: 60 };
                    let aqi = myEnv.aqi || 50; let aRate = aqi > 150 ? (p.aqiRed||1.8) : (aqi > 100 ? (p.aqiOrange||1.4) : 1.0); let cRate = 1.0;
                    const l=['Model X','Model Y','RAV4','CR-V','X-Trail','Kuga','CX-5','Tucson','Sportage','NX','RX','GLC','X3','X5','XC60','Defender','Cayenne','Macan'];
                    const s=['Yaris','Fit','Swift','Colt Plus','Venue','Kamiq','UX','Picanto','Ignis'];
                    if(l.includes(d.users.car_model)) cRate = p.carLarge || 1.3; if(s.includes(d.users.car_model)) cRate = p.carSmall || 0.8;
                    let mileageRate = d.users.yearly_mileage ? (1 + ((d.users.yearly_mileage / 10000) - 1) * (p.mileageWeight||0.5)) : 1.0;
                    let tempRate = myEnv.temp > 30 ? (p.tempHigh||1.2) : (myEnv.temp < 15 ? (p.tempLow||0.9) : 1.0); let humRate = myEnv.hum > 80 ? (p.humHigh||1.2) : 1.0;
                    let totalMultiplier = mileageRate * aRate * cRate * tempRate * humRate; let health = Math.max(0, Math.round(100 - (days * (p.baseWear||0.27) * totalMultiplier)));
                    let color = health >= 60 ? '#00e676' : (health > 30 ? '#f59e0b' : '#ef4444'); healthStr = `<span style="color:${color}; font-weight:900; font-size:18px;">${health}%</span>`;
                } else if (d.status === 'replaced') { healthStr = `<span style="color:#555; font-weight:bold;">å·²éŠ·æ¯€</span>`; } else if (d.status === 'produced') { healthStr = `<span style="color:#aaa;">å…¥åº«å¾…å”®</span>`; } else if (d.status === 'sold') { healthStr = `<span style="color:#3b82f6;">ç­‰å¾…ç¶å®š</span>`; }

                let controlHtml = `<span style="color:#888; font-size:12px;">ğŸ”’ é–å®šä¸­</span>`;
                if(isGodModeUnlocked) {
                    controlHtml = `
                        <select onchange="directUpdateUID('${d.uid}', this.value)" style="padding:4px; font-size:12px; border-radius:4px; width:100%; background:#222; color:#fff; border:1px solid #444; margin-bottom:5px;">
                            <option value="produced" ${d.status==='produced'?'selected':''}>å…¥åº« (produced)</option>
                            <option value="sold" ${d.status==='sold'?'selected':''}>å‡ºè²¨ (sold)</option>
                            <option value="activated" ${d.status==='activated'?'selected':''}>å•Ÿç”¨ (activated)</option>
                            <option value="replaced" ${d.status==='replaced'?'selected':''}>éŠ·æ¯€ (replaced)</option>
                        </select>
                        <button class="btn btn-danger" style="padding:4px 8px; width:100%; font-size:11px;" onclick="godModeDeleteUID('${d.uid}')">ğŸ—‘ï¸ åˆªé™¤æ¢ç¢¼</button>
                    `;
                }
                html += `<tr><td style="font-family:monospace; font-size:14px; color:#00e676;"><b>${d.uid}</b><br><span style="font-size:10px; color:#888;">${d.activated_at ? new Date(d.activated_at).toLocaleDateString() : 'æœªå•Ÿç”¨'}</span></td><td style="font-size:12px; color:#ddd;">${carStr}</td><td style="font-size:12px; color:#ddd;">${locStr}</td><td style="text-align:center;">${healthStr}</td><td style="text-align:center;">${controlHtml}</td></tr>`;
            });
        }
        document.getElementById('uid-table').querySelector('tbody').innerHTML = html;
    }

    async function generateSequentialUIDs() {
        const { data } = await supabaseClient.from('filters_uid').select('uid').order('uid', {ascending: false}).limit(1);
        let maxNum = data && data.length > 0 ? parseInt(data[0].uid.replace('HP-','')) : 0; let ins = []; for(let i=1; i<=50; i++) ins.push({ uid: 'HP-' + String(maxNum + i).padStart(6, '0') });
        await supabaseClient.from('filters_uid').insert(ins); alert("âœ… 50 çµ„ UID å·²å…¥åº«ï¼"); loadUIDs();
    }
    
    async function directUpdateUID(uid, newStatus) { await supabaseClient.from('filters_uid').update({status: newStatus}).eq('uid', uid); loadUIDs(); }
    async function godModeDeleteUID(uid) { if(confirm(`âš ï¸ ç¢ºå®šè¦å¾¹åº•åˆªé™¤æ¢ç¢¼ [${uid}] å—ï¼Ÿ`)) { await supabaseClient.from('filters_uid').delete().eq('uid', uid); loadUIDs(); } }

    async function loadESG() {
        document.getElementById('esg-total-pm25').innerText = "è¨ˆç®—ä¸­..."; document.getElementById('esg-total-kwh').innerText = "è¨ˆç®—ä¸­..."; document.getElementById('esg-total-co2').innerText = "è¨ˆç®—ä¸­...";
        const [resUIDs, resSettings, resEnv] = await Promise.all([
            supabaseClient.from('filters_uid').select('activated_at, users(city, district, car_brand, car_model, yearly_mileage)').eq('status', 'activated'),
            supabaseClient.from('system_settings').select('value').eq('key', 'algo_params').maybeSingle(), supabaseClient.from('env_cache').select('*')
        ]);
        let p = resSettings.data ? resSettings.data.value : { basePm25: 1500, kwhPerDay: 0.25, co2Factor: 0.495, mileageWeight: 0.5, aqiOrange: 1.4, aqiRed: 1.8, tempHigh: 1.2, tempLow: 0.9, humHigh: 1.2, carLarge: 1.3, carSmall: 0.8 };
        let envDataList = resEnv.data || []; let totalPm25 = 0; let totalKwh = 0; let totalCo2 = 0;

        if(resUIDs.data) {
            resUIDs.data.forEach(d => {
                if(d.activated_at && d.users) {
                    const today = new Date(); const actDate = new Date(d.activated_at); const days = Math.max(0, Math.floor((today - actDate) / (1000 * 60 * 60 * 24)));
                    let myEnv = envDataList.find(e => e.city === d.users.city && e.district === d.users.district) || { aqi: 50, temp: 25, hum: 60 };
                    let aqi = myEnv.aqi || 50; let aRate = aqi > 150 ? (p.aqiRed||1.8) : (aqi > 100 ? (p.aqiOrange||1.4) : 1.0); let cRate = 1.0;
                    const l=['Model X','Model Y','RAV4','CR-V','X-Trail','Kuga','CX-5','Tucson','Sportage','NX','RX','GLC','X3','X5','XC60','Defender','Cayenne','Macan']; const s=['Yaris','Fit','Swift','Colt Plus','Venue','Kamiq','UX','Picanto','Ignis'];
                    if(l.includes(d.users.car_model)) cRate = p.carLarge || 1.3; if(s.includes(d.users.car_model)) cRate = p.carSmall || 0.8;
                    let mileageRate = d.users.yearly_mileage ? (1 + ((d.users.yearly_mileage / 10000) - 1) * (p.mileageWeight||0.5)) : 1.0; let tempRate = myEnv.temp > 30 ? (p.tempHigh||1.2) : (myEnv.temp < 15 ? (p.tempLow||0.9) : 1.0); let humRate = myEnv.hum > 80 ? (p.humHigh||1.2) : 1.0;
                    let totalMultiplier = mileageRate * aRate * cRate * tempRate * humRate;
                    totalPm25 += Math.round(days * (p.basePm25||1500) * totalMultiplier); totalKwh += (days * (p.kwhPerDay||0.25) * mileageRate); totalCo2 += (days * (p.kwhPerDay||0.25) * mileageRate * (p.co2Factor||0.495));
                }
            });
        }
        document.getElementById('esg-total-pm25').innerText = totalPm25.toLocaleString(); document.getElementById('esg-total-kwh').innerText = totalKwh.toFixed(1).toLocaleString(); document.getElementById('esg-total-co2').innerText = totalCo2.toFixed(1).toLocaleString();
    }

    // (Rewards, Garages, Bookings, Bulletins, Env Data logic follows...)
    async function loadRewards() {
        const { data } = await supabaseClient.from('rewards').select('*, users(name)').eq('type', 'redeem').eq('status', 'pending'); let html = ''; 
        if(data) { data.forEach(r => { html += `<tr><td><b>${r.users?.name}</b></td><td style="color:#ef4444; font-weight:bold;">-${r.points} é»</td><td>${new Date(r.created_at).toLocaleString()}</td><td style="text-align:center;"><button class="btn" onclick="approveReward(${r.id})">âœ… æ ¸ç™¼</button></td></tr>`; }); }
        document.getElementById('reward-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">ç„¡å¾…å¯©æ ¸ç”³è«‹</td></tr>';
    }
    async function approveReward(id) { if(confirm("ç¢ºèªå·²åŒ¯å‡º LINE Points çµ¦è©²è»Šä¸»ï¼Ÿ")) { await supabaseClient.from('rewards').update({status:'completed'}).eq('id',id); loadRewards(); } }

    async function loadGarages() {
        const { data } = await supabaseClient.from('garages').select('*').order('created_at', { ascending: false }); let html = '';
        if(data) { data.forEach(g => { html += `<tr><td><b>${g.name}</b><br><span style="font-size:12px;">${g.city}${g.address}</span></td><td>${g.contact_name||'-'}<br>${g.phone||'-'}</td><td>${g.status === 'active' ? '<span style="color:green;font-weight:bold;">ç‡Ÿé‹ä¸­</span>' : '<span style="color:#f59e0b;">å¾…å¯©æ ¸</span>'}</td><td style="text-align:center;">${g.status !== 'active' ? `<button class="btn" onclick="approveGarage(${g.id})">âœ… ä¸Šæ¶</button>` : ''} <button class="btn btn-danger" onclick="deleteGarage(${g.id})">ğŸ—‘ï¸ åˆªé™¤</button></td></tr>`; }); }
        document.getElementById('garage-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4">å°šç„¡ä¿ä¿®å» è³‡æ–™</td></tr>';
    }
    async function approveGarage(id) { await supabaseClient.from('garages').update({status:'active'}).eq('id',id); loadGarages(); }
    async function deleteGarage(id) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤ä¿ä¿®å» ï¼Ÿ")) { await supabaseClient.from('garages').delete().eq('id',id); loadGarages(); } }

    async function loadBookings() {
        const { data } = await supabaseClient.from('bookings').select('*, users(name), garages(name)').order('created_at', { ascending: false }); let html = '';
        if(data) { data.forEach(b => { html += `<tr><td><b>${b.users?.name||'æœªçŸ¥è»Šä¸»'}</b></td><td>${b.garages?.name||'æœªçŸ¥å» '}</td><td>${b.book_date}</td><td>${b.status}</td><td style="text-align:center;"><button class="btn btn-danger" style="padding:4px 8px;" onclick="cancelBooking(${b.id})">ä½œå»¢</button></td></tr>`; }); }
        document.getElementById('booking-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="5">å°šç„¡é ç´„ç´€éŒ„</td></tr>';
    }
    async function cancelBooking(id) { if(confirm("ç¢ºå®šä½œå»¢æ­¤é ç´„å–®ï¼Ÿ")) { await supabaseClient.from('bookings').update({status:'cancelled'}).eq('id',id); loadBookings(); } }

    async function loadBulletins() {
        const { data } = await supabaseClient.from('bulletins').select('*').order('created_at', { ascending: false }); let html = '';
        if(data) { data.forEach(b => { html += `<tr><td><b>${b.title}</b></td><td>${new Date(b.created_at).toLocaleString()}</td><td>${b.is_active ? '<span style="color:green;">é¡¯ç¤ºä¸­</span>' : '<span style="color:#aaa;">å·²éš±è—</span>'}</td><td style="text-align:center;"><button class="btn btn-warn" onclick="toggleBulletin(${b.id}, ${!b.is_active})">${b.is_active ? 'éš±è—' : 'é¡¯ç¤º'}</button> <button class="btn btn-danger" onclick="deleteBulletin(${b.id})">åˆªé™¤</button></td></tr>`; }); }
        document.getElementById('bulletin-table').querySelector('tbody').innerHTML = html || '<tr><td colspan="4">ç„¡å…¬å‘Š</td></tr>';
    }
    async function createBulletin() { const title = document.getElementById('bul-title').value; const content = document.getElementById('bul-content').value; if(!title || !content) return alert("è«‹å¡«å¯«å®Œæ•´å…¬å‘Šï¼"); await supabaseClient.from('bulletins').insert([{ title, content, is_active: true }]); document.getElementById('bul-title').value = ''; document.getElementById('bul-content').value = ''; alert("ç™¼å¸ƒæˆåŠŸï¼"); loadBulletins(); }
    async function toggleBulletin(id, status) { await supabaseClient.from('bulletins').update({is_active: status}).eq('id',id); loadBulletins(); }
    async function deleteBulletin(id) { if(confirm("ç¢ºå®šåˆªé™¤å…¬å‘Šï¼Ÿ")) { await supabaseClient.from('bulletins').delete().eq('id',id); loadBulletins(); } }

    let globalEnvData = [];
    async function loadAlgoParams() {
        const { data } = await supabaseClient.from('system_settings').select('value').eq('key', 'algo_params').maybeSingle();
        const p = data ? data.value : { baseWear: 0.27, aqiOrange: 1.4, aqiRed: 1.8, tempHigh: 1.2, tempLow: 0.9, humHigh: 1.2, carLarge: 1.3, carSmall: 0.8, basePm25: 1500, kwhPerDay: 0.25, co2Factor: 0.495, paHypass: 4, paOther: 8, mileageWeight: 0.5, updateFreqHours: 2 };
        document.getElementById('algo-baseWear').value = p.baseWear || 0.27; document.getElementById('algo-aqiOrange').value = p.aqiOrange || 1.4; document.getElementById('algo-aqiRed').value = p.aqiRed || 1.8;
        document.getElementById('algo-tempHigh').value = p.tempHigh || 1.2; document.getElementById('algo-tempLow').value = p.tempLow || 0.9; document.getElementById('algo-humHigh').value = p.humHigh || 1.2;
        document.getElementById('algo-carLarge').value = p.carLarge || 1.3; document.getElementById('algo-carSmall').value = p.carSmall || 0.8;
        document.getElementById('algo-mileageWeight').value = p.mileageWeight || 0.5;
        document.getElementById('algo-basePm25').value = p.basePm25 || 1500; document.getElementById('algo-kwhPerDay').value = p.kwhPerDay || 0.25; document.getElementById('algo-co2Factor').value = p.co2Factor || 0.495;
        document.getElementById('algo-paHypass').value = p.paHypass || 4; document.getElementById('algo-paOther').value = p.paOther || 8;
        document.getElementById('algo-updateFreqHours').value = p.updateFreqHours || 2;
    }
    async function saveAlgoParams() {
        const p = {
            baseWear: parseFloat(document.getElementById('algo-baseWear').value), aqiOrange: parseFloat(document.getElementById('algo-aqiOrange').value), aqiRed: parseFloat(document.getElementById('algo-aqiRed').value),
            tempHigh: parseFloat(document.getElementById('algo-tempHigh').value), tempLow: parseFloat(document.getElementById('algo-tempLow').value), humHigh: parseFloat(document.getElementById('algo-humHigh').value),
            carLarge: parseFloat(document.getElementById('algo-carLarge').value), carSmall: parseFloat(document.getElementById('algo-carSmall').value),
            mileageWeight: parseFloat(document.getElementById('algo-mileageWeight').value), updateFreqHours: parseInt(document.getElementById('algo-updateFreqHours').value),
            basePm25: parseFloat(document.getElementById('algo-basePm25').value), kwhPerDay: parseFloat(document.getElementById('algo-kwhPerDay').value), co2Factor: parseFloat(document.getElementById('algo-co2Factor').value),
            paHypass: parseFloat(document.getElementById('algo-paHypass').value), paOther: parseFloat(document.getElementById('algo-paOther').value)
        };
        const { error } = await supabaseClient.from('system_settings').upsert({ key: 'algo_params', value: p });
        if(error) alert("å„²å­˜å¤±æ•—: " + error.message); else alert("âœ… åƒæ•¸å·²æ›´æ–°ï¼å…¨å° App èˆ‡é›²ç«¯çˆ¬èŸ²å°‡è‡ªå‹•å¥—ç”¨æœ€æ–°è¨­å®šã€‚");
    }

    async function loadEnvData() {
        document.getElementById('env-table').querySelector('tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;">è¼‰å…¥å¤§æ•¸æ“šåº«ä¸­...</td></tr>';
        const { data, error } = await supabaseClient.from('env_cache').select('*').order('city', { ascending: true }).order('district', { ascending: true });
        if (error) return alert("ç„¡æ³•è®€å–ç’°å¢ƒæ•¸æ“šï¼š" + error.message);
        globalEnvData = data; document.getElementById('env-total-count').innerText = data.length + " ç­†";
        if(data.length > 0) document.getElementById('env-last-update').innerText = new Date(data[0].updated_at).toLocaleString();
        let html = '';
        data.forEach(d => { html += `<tr><td><b>${d.city}</b></td><td>${d.district}</td><td>${d.temp !== null ? d.temp : '--'}</td><td>${d.hum !== null ? d.hum : '--'}</td><td style="color:${d.aqi > 100 ? 'red' : 'green'}; font-weight:bold;">${d.aqi}</td><td>${d.pm25 !== null ? d.pm25 : '--'}</td><td style="color:#f59e0b; font-weight:bold;">${d.aqi_7d_avg !== null ? Math.round(d.aqi_7d_avg) : '--'}</td></tr>`; });
        document.getElementById('env-table').querySelector('tbody').innerHTML = html;
    }

    function downloadEnvCSV() {
        if(globalEnvData.length === 0) return alert("æ²’æœ‰è³‡æ–™å¯ä¾›ä¸‹è¼‰");
        const headers = ["ç¸£å¸‚", "é„‰é®å¸‚å€", "ä¸­å¤®æ°£è±¡ç½²(CWA)_æº«åº¦(Â°C)", "ä¸­å¤®æ°£è±¡ç½²(CWA)_æ¿•åº¦(%)", "ç’°å¢ƒéƒ¨(MOENV)_å³æ™‚AQI", "ç’°å¢ƒéƒ¨(MOENV)_PM2.5", "AI_7æ—¥å‡å€¼æ¼”ç®—", "æœ€å¾ŒåŒæ­¥æ™‚é–“"];
        let csvContent = "\uFEFF" + headers.join(",") + "\n"; 
        globalEnvData.forEach(d => { const row = [d.city, d.district, d.temp, d.hum, d.aqi, d.pm25, d.aqi_7d_avg ? Math.round(d.aqi_7d_avg) : '', new Date(d.updated_at).toLocaleString()]; csvContent += row.join(",") + "\n"; });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `ç’°å¢ƒéƒ¨èˆ‡æ°£è±¡ç½²_é›™æ•¸æ“šåº«æ•´åˆåŒ…_${new Date().getTime()}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
  </script>
</body>
</html>
