<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>HYPASS V4.22 ç¸½éƒ¨æˆ°æƒ…å®¤</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* ğŸŒŸ ç¶­æŒç´”æ¡Œé¢æ’ç‰ˆï¼Œä¿è­‰æ‰‹æ©Ÿç¸®æ”¾å®Œç¾ç„¡è®Šå½¢ */
    body { font-family: sans-serif; background: #f4f6f8; margin: 0; display: flex; height: 100vh; }
    .sidebar { width: 220px; background: #0a0a0c; color: #fff; display: flex; flex-direction: column; overflow-y: auto; flex-shrink:0; }
    .nav-btn { display: block; width: 100%; padding: 15px 20px; text-align: left; background: none; border: none; color: #aaa; cursor: pointer; font-size: 16px; border-left: 4px solid transparent; }
    .nav-btn:hover { color: #fff; background: #222; }
    .nav-btn.active { color: #00D100; border-left-color: #00D100; background: #1a1e1a; font-weight: bold; }
    .main-content { flex: 1; padding: 30px; overflow-y: auto; }
    
    .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle;}
    th { background: #f8f9fa; color: #555; position: sticky; top: 0; z-index: 2;}
    
    .btn { background: #00D100; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight:bold; transition: background 0.2s; }
    .btn:hover { background: #00b300; }
    .btn-danger { background: #ff4444; color: #fff; }
    
    .stat-card { background: #1a1e1a; color: #00D100; padding: 20px; border-radius: 8px; text-align: center; flex: 1; margin-right: 15px; border: 1px solid #333; }
    .stat-card:last-child { margin-right: 0; }
    .stat-card h1 { font-size: 36px; margin: 10px 0; }
    .stat-card p { color: #888; margin: 0; font-size: 14px; }
    
    .op-card { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; text-align: center; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .op-card h3 { margin: 0 0 10px 0; color: #555; }

    .param-group { margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding-bottom: 6px;}
    .param-group label { font-size: 13px; color: #555; font-weight: bold; }
    .param-group input { width: 70px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; text-align: right; font-family: monospace; font-size: 14px;}
    .param-group select { width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; font-weight:bold; cursor:pointer;}

    .scan-container { display: flex; gap: 20px; background: #1e1e1e; padding: 20px; border-radius: 8px; border-left: 5px solid #00D100; align-items: flex-start; flex-wrap: wrap; position: relative;}
    .scan-input-group { flex: 1; min-width: 250px; }
    .scan-input { width: 100%; padding: 18px; font-size: 22px; border-radius: 5px; border: 3px solid #555; background: #000; color: #00D100; font-weight: bold; margin-bottom: 10px; box-sizing: border-box; transition: all 0.3s; text-align: center; font-family: monospace;}
    .scan-input:disabled { background: #111; color: #00D100; cursor: not-allowed; }
    .scan-label { color: #aaa; font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; }
    
    #reader-container { width: 100%; margin-bottom: 20px; display: none; background:#111; padding:15px; border-radius:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
    #reader { width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 8px; border: 2px solid #333;}
    #camera-target-hint { display: block; text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 15px; padding: 10px; border-radius: 8px; background: #222;}

    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal-content { background: #fff; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-content textarea { width: 100%; height: 120px; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-family: sans-serif; font-size: 14px; box-sizing: border-box; resize: vertical; }
    .modal-content select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div style="padding-top: 20px;">
      <h2 style="color:#00D100; padding: 0 20px; border:none; margin-bottom: 20px;">HYPASS ADMIN</h2>
      <button class="nav-btn" onclick="switchTab('dispatch', this)">ğŸ“¦ å€‰å„²å‡ºè²¨ç«™</button>
      <button class="nav-btn" onclick="switchTab('esg', this)">ğŸŒ ç¶ èƒ½ç¸½è¦½</button>
      <button class="nav-btn" onclick="switchTab('stats', this)">ğŸ“Š ç‡Ÿé‹åˆ†ä½ˆ</button>
      <button class="nav-btn" onclick="switchTab('monitor', this)">âš™ï¸ æ¼”ç®—æ³•ç›£æ§</button>
      <button class="nav-btn" onclick="switchTab('push', this)">ğŸ’¬ æ™ºæ…§æ¨æ’­</button>
      <button class="nav-btn" onclick="switchTab('uid', this)">ğŸ·ï¸ UID åº«å­˜</button>
      <button class="nav-btn active" onclick="switchTab('crm', this)">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</button>
      <button class="nav-btn" onclick="switchTab('garage', this)">ğŸ‘¨â€ğŸ”§ ä¿ä¿®å» </button>
      <button class="nav-btn" onclick="switchTab('rewards', this)">ğŸ çå‹µé‡‘</button>
    </div>
    <div style="margin-top: auto; padding: 20px; color: #666; font-size: 12px; font-family: monospace; border-top: 1px solid #222;">
      System Ver.<br><strong style="color: #00D100; font-size: 14px;">V4.22</strong>
    </div>
  </div>

  <div class="main-content">
    
    <div id="panel-dispatch" class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">
          <h2 style="border:none; padding:0; margin:0;">ğŸ“¦ B2C ç„¡é–“æ–·æƒæå‡ºè²¨ç«™</h2>
          <button class="btn" style="background:#1976d2; color:#fff; font-size:16px; padding:10px 20px;" onclick="startContinuousScanner()">ğŸš€ å•Ÿå‹•ç„¡é–“æ–·ç›¸æ©Ÿæƒæ</button>
      </div>
      <p style="color:#666; font-size:13px;">æ­è¼‰é›²ç«¯ä¸‰ç´šé˜²å‘†ã€‚å•Ÿå‹•å¾Œè‡ªå‹•å¼•å°ï¼šå…ˆæƒææ¿¾ç¶² UID â” æ¥è‘—æƒæè¨‚å–® â” è½åˆ°å®å™¹è²å¾Œç›´æ¥ä¸‹ä¸€ç‰‡ã€‚</p>
      
      <div id="reader-container">
        <div id="camera-target-hint">æº–å‚™ä¸­...</div>
        <div id="reader"></div>
        <div style="text-align:center; margin-top:15px;">
           <button class="btn btn-danger" style="padding:10px 30px;" onclick="stopCamera()">é—œé–‰ç›¸æ©Ÿ</button>
        </div>
      </div>

      <div class="scan-container">
        <div class="scan-input-group">
          <label class="scan-label" id="label-uid">ç¬¬ 1 æ­¥ï¼šæƒææ¿¾ç¶² UID æ¢ç¢¼</label>
          <input type="text" id="scan-uid-input" class="scan-input" placeholder="ç­‰å¾…æƒæ UID..." onkeypress="handleManualScan(event, 'uid')">
        </div>
        <div class="scan-input-group">
          <div style="display:flex; justify-content:space-between;">
             <label class="scan-label" id="label-order">ç¬¬ 2 æ­¥ï¼šæƒæ Shopline è¨‚å–®å–®è™Ÿ</label>
             <button class="btn btn-danger" id="btn-reset-scan" style="padding: 2px 8px; font-size:11px; display:none;" onclick="resetScanState()">ğŸ”„ æ”¾æ£„æœ¬ç­†ï¼Œé‡ä¾†</button>
          </div>
          <input type="text" id="scan-order-input" class="scan-input" placeholder="ç­‰å¾…æƒæè¨‚å–®..." onkeypress="handleManualScan(event, 'order')">
        </div>
      </div>
      
      <div style="margin-top: 15px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0; color:#333;">ğŸ“‹ æœ¬æ¬¡æƒæå‡ºè²¨ç´€éŒ„</h3><span id="scan-status-msg" style="font-weight:bold; font-size:15px;"></span>
      </div>
      <div style="max-height: 350px; overflow-y:auto; border: 1px solid #ddd; margin-top:10px;">
        <table>
          <thead style="position:sticky; top:0; background:#f4f6f8;">
            <tr><th>æ¿¾ç¶² UID</th><th>ç¶å®šå–®è™Ÿ/è™Ÿç¢¼</th><th>å®¢æˆ¶ç‹€æ…‹</th><th>ä½œæ¥­çµæœ</th><th>æƒææ™‚é–“</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="dispatch-log-tbody"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-crm" class="panel active">
      <h2>ğŸ‘¥ æ¿¾ç¶²å®¢äºº CRM (å¤šç¶­åº¦å±¥æ­·)</h2>
      <table id="crm-table">
        <thead>
          <tr>
             <th>å®¢æˆ¶èˆ‡è¨»å†Šè³‡è¨Š</th>
             <th>è»Šè¼›èˆ‡é‡Œç¨‹</th>
             <th>é€šè¨Šåœ°å€</th>
             <th>äº’å‹•èˆ‡è©•åƒ¹æ•¸æ“š</th>
             <th style="text-align:center;">ç‹€æ…‹èˆ‡æ“ä½œ</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="5" style="text-align:center;">è³‡æ–™å¤§æ•¸æ“šè¼‰å…¥ä¸­...</td></tr></tbody>
      </table>
    </div>

    <div id="customer-modal" class="modal-overlay">
      <div class="modal-content" style="width: 650px;">
        <h3 style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
           <span>ğŸ“„ å®¢æˆ¶å®Œæ•´å±¥æ­·</span>
           <button class="btn-danger" style="border:none; padding:4px 10px; border-radius:4px; cursor:pointer;" onclick="closeCustomerModal()">âœ–</button>
        </h3>
        <div id="c-detail-body" style="line-height:1.8; font-size:15px; color:#333;">
           </div>
      </div>
    </div>

    <div id="panel-esg" class="panel">
      <h2>ğŸŒ HYPASS ç¶ èƒ½è²¢ç»ç¸½è¦½</h2>
      <div style="display: flex; margin-bottom: 20px;">
        <div class="stat-card"><h1><span id="esg-pm25">0</span> Âµg</h1><p>å…¨ç¶²ç´¯è¨ˆæ””æˆª PM2.5</p></div>
        <div class="stat-card"><h1><span id="esg-co2">0</span> kg</h1><p>å…¨ç¶²æ¸›å°‘ç¢³æ’æ”¾</p></div>
        <div class="stat-card"><h1><span id="esg-active">0</span> ç‰‡</h1><p>ç›®å‰é˜²è­·ä¸­æ¿¾ç¶²ç¸½æ•¸</p></div>
      </div>
      <button class="btn" onclick="loadESG()">é‡æ–°è¨ˆç®—æœ€æ–°æ•¸æ“š</button>
    </div>

    <div id="panel-stats" class="panel">
      <h2>ğŸ“Š å…¨å°ç‡Ÿé‹åˆ†ä½ˆç¸½è¦½</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div class="op-card" style="border-top: 4px solid #00D100;"><h3>æ¿¾ç¶²æœƒå“¡ç¸½æ•¸</h3><h1 id="stat-total-users" style="font-size: 48px; margin: 10px 0; color: #00D100;">0</h1></div>
        <div class="op-card" style="border-top: 4px solid #FF9800;"><h3>é–‹é€šä¿ä¿®å» ç¸½æ•¸</h3><h1 id="stat-total-garages" style="font-size: 48px; margin: 10px 0; color: #FF9800;">0</h1></div>
      </div>
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;"><table id="stat-users-city"><thead><tr><th>å±…ä½ç¸£å¸‚</th><th>æœƒå“¡äººæ•¸</th></tr></thead><tbody></tbody></table></div>
        <div style="flex: 1;"><table id="stat-garages-city"><thead><tr><th>æ‰€åœ¨ç¸£å¸‚</th><th>åˆä½œå®¶æ•¸</th></tr></thead><tbody></tbody></table></div>
      </div>
    </div>

    <div id="panel-monitor" class="panel">
      <h2>âš™ï¸ æ¼”ç®—æ³•åƒæ•¸èˆ‡å…¨å°ç©ºæ±™å¤§æ•¸æ“š</h2>
      <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap:wrap;">
        <div style="flex: 1; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fafafa; min-width:300px;">
          <h3 style="margin-top: 0; color: #1976d2; display:flex; align-items:center; gap:8px;">ğŸ§  æ¿¾ç¶²å‹•æ…‹æ¼”ç®—æ³• & è‡ªå‹•åŒ–åƒæ•¸</h3>
          <h4 style="margin: 15px 0 5px 0; color:#333; font-size:14px;">â–å‹•æ…‹å£½å‘½èˆ‡ç©ºæ°£æ¬Šé‡</h4>
          <div class="param-group"><label>åŸºæº–æ¯æ—¥è€—æç‡ (%)</label><input type="number" step="0.01" id="param-base-wear" value="0.27"></div>
          <div class="param-group"><label>åŸºæº– PM2.5 æ””æˆªé‡ (Âµg)</label><input type="number" id="param-base-pm25" value="1250"></div>
          <div class="param-group"><label>ğŸ”´ ç´«çˆ†åŠ æ¬Šä¿‚æ•¸ (AQI>150)</label><input type="number" step="0.1" id="param-weight-red" value="1.8"></div>
          <div class="param-group"><label>ğŸŸ  æ©˜å®³åŠ æ¬Šä¿‚æ•¸ (AQI>100)</label><input type="number" step="0.1" id="param-weight-orange" value="1.4"></div>
          <div class="param-group"><label>ğŸŒ¡ï¸ æ¥µç«¯æº«æ¿•åº¦åŠ æ¬Šä¿‚æ•¸</label><input type="number" step="0.1" id="param-weight-temp" value="1.2"></div>

          <h4 style="margin: 20px 0 5px 0; color:#d32f2f; font-size:14px;">â–ç³»çµ±è‡ªå‹•åŒ–èˆ‡é è­¦æ¨æ’­</h4>
          <div class="param-group"><label>ğŸ”„ æ•¸æ“šå¼·åˆ¶æ›´æ–°é »ç‡ (å°æ™‚)</label><input type="number" id="param-update-interval" value="2"></div>
          <div class="param-group">
             <label>ğŸš¨ ç´«çˆ†æ™‚ä¸»å‹•ç™¼é€ LINE æé†’</label>
             <select id="param-auto-push-red">
                <option value="true">ğŸŸ¢ é–‹å•Ÿ</option>
                <option value="false">ğŸ”´ é—œé–‰</option>
             </select>
          </div>

          <h4 style="margin: 20px 0 5px 0; color:#2e7d32; font-size:14px;">â–ESG èˆ‡ææ–™ç‰©ç†ç‰¹æ€§</h4>
          <div class="param-group"><label>HYPASS æ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-hypass" value="4"></div>
          <div class="param-group"><label>ä»–ç‰Œæ¿¾æé¢¨é˜» (Pa)</label><input type="number" id="param-pa-other" value="8"></div>
          <div class="param-group"><label>æ¯æ—¥åŸºæº–çœé›» (kWh)</label><input type="number" step="0.01" id="param-kwh-day" value="0.25"></div>
          <div class="param-group"><label>ç¢³æ’è½‰æ›ä¿‚æ•¸ (kg/kWh)</label><input type="number" step="0.1" id="param-co2-factor" value="0.5"></div>
          
          <button class="btn" style="width:100%; margin-top:15px; background:#1976d2; color:#fff;" onclick="saveAlgorithmParams()">ğŸ’¾ å„²å­˜ä¸¦ç™¼å¸ƒè‡³ä¼ºæœå™¨</button>
        </div>
        
        <div style="flex: 1.2; border: 1px solid #ffcdd2; border-radius: 8px; padding: 20px; background: #fffafb; min-width:300px;">
          <h3 style="margin-top: 0; color: #d32f2f;">ğŸš¨ å…¨å°å³æ™‚ 10 å¤§ç©ºæ±™é‡ç½å€</h3>
          <p style="font-size:12px; color:#d32f2f; margin-bottom:10px;">å¼·çƒˆå»ºè­°é‡å°ä»¥ä¸‹å€åŸŸåŠ å¼·ã€Œç´«çˆ†é˜²è­·ã€æ¨æ’­èˆ‡å»£å‘ŠæŠ•æ”¾ã€‚</p>
          <div id="top10-container"><table style="margin-top:0;"><thead><tr><th>æ’å</th><th>ç¸£å¸‚é„‰é®</th><th>AQI æŒ‡æ•¸</th><th>PM2.5</th></tr></thead><tbody><tr><td colspan="4" style="text-align:center;">è³‡æ–™åˆ†æä¸­...</td></tr></tbody></table></div>
        </div>
      </div>
      <h3 style="border-top:2px solid #eee; padding-top:20px; margin-bottom:15px;">ğŸŒ å°ç£ 368 é„‰é®å¸‚å€ç’°å¢ƒå¿«å–æ±  (æ¼”ç®—æ³•å…¨å‹•æ…‹ç›£æ§)</h3>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <input type="text" id="monitor-search" placeholder="ğŸ” æœå°‹ç¸£å¸‚æˆ–é„‰é® (ä¾‹å¦‚: å°åŒ—)" onkeyup="filterMonitorTable()" style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ccc;">
        <div>
          <span id="monitor-count" style="font-size: 13px; color: #00D100; font-weight: bold; margin-right: 15px;">å…± 0 ç­†</span>
          <button class="btn" id="btn-force-update" style="background: #333; color: #fff;" onclick="forceUpdateCache()">âš¡ å¼·åˆ¶é‡æ–°æŠ“å– (ç´„40ç§’)</button>
        </div>
      </div>
      <div style="height: 400px; overflow-y: auto; border: 1px solid #eee;">
        <table id="monitor-table" style="margin-top: 0;">
          <thead><tr><th>ç¸£å¸‚ / é„‰é®</th><th>ç’°å¢ƒæº«æ¿•åº¦</th><th>AQI æŒ‡æ•¸</th><th>PM2.5 (Âµg)</th><th>å‹•æ…‹æ¼”ç®—æ³•è€—æå€ç‡</th><th style="background:#e8f5e9; color:#2e7d32;">ğŸ’¡ ç‡Ÿé‹ç­–ç•¥å»ºè­°</th><th>æœ€å¾Œæ›´æ–°æ™‚é–“ (å°åŒ—)</th></tr></thead>
          <tbody><tr><td colspan="7" style="text-align:center;">è³‡æ–™è®€å–ä¸­...</td></tr></tbody>
        </table>
      </div>
    </div>

    <div id="panel-push" class="panel">
      <h2>ğŸ’¬ AI æ™ºæ…§æ¨æ’­å¼•æ“ (å‹•æ…‹æƒ…å¢ƒåº«)</h2>
      <table id="push-table"><thead><tr><th>é¡åˆ¥</th><th>æƒ…å¢ƒè¦å‰‡åç¨±</th><th>è§¸ç™¼é‚è¼¯æ¢ä»¶</th><th>è‡ªå‹•æ¨æ’­æ–‡æ¡ˆå…§å®¹</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="edit-modal" class="modal-overlay">
      <div class="modal-content">
        <h3 id="edit-title">ç·¨è¼¯æ¨æ’­æ–‡æ¡ˆ</h3>
        <input type="hidden" id="edit-rule-id">
        <textarea id="edit-message"></textarea>
        <select id="edit-status"><option value="true">ğŸŸ¢ å•Ÿç”¨ä¸­</option><option value="false">ğŸ”´ åœç”¨</option></select>
        <div style="margin-top: 20px; display:flex; gap:10px; justify-content: flex-end;">
          <button class="btn" style="background:#eee; color:#333;" onclick="closeModal()">å–æ¶ˆ</button>
          <button class="btn" onclick="savePushRule()">å„²å­˜ä¿®æ”¹</button>
        </div>
      </div>
    </div>

    <div id="panel-uid" class="panel">
      <h2>ğŸ·ï¸ é˜²å½ UID æ™ºæ…§æµæ°´è™Ÿç”Ÿæˆ</h2>
      <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight:bold;">é è¨ˆç”¢å‡ºçµ„æ•¸ï¼š</label>
        <input type="number" id="uid-gen-count" value="50" style="width: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        <button class="btn" onclick="generateSequentialUIDs()">âš™ï¸ è‡ªå‹•æ¥çºŒç”¢å‡ºæ–° UID</button>
      </div>
      <table id="uid-table" style="margin-top:15px;"><thead><tr><th>UID æµæ°´è™Ÿ</th><th>ç‹€æ…‹</th><th>å•Ÿç”¨é¡å‹/æ“æœ‰è€…</th><th>å®‰è£è»Šæ¬¾/åœ°é»</th><th>æ“ä½œæ™‚é–“</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-garage" class="panel">
      <h2>ğŸ‘¨â€ğŸ”§ æ¿¾è¯ç¶²ä¿ä¿®å» ç®¡ç†</h2>
      <table id="garage-table"><thead><tr><th>åº—å</th><th>åœ°å€</th><th>è¯çµ¡äºº/é›»è©±</th><th>ç‹€æ…‹</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="panel-rewards" class="panel">
      <h2>ğŸ LINE Points å…Œæ›å¯©æ ¸</h2>
      <table id="reward-table"><thead><tr><th>ç”³è«‹è»Šä¸»</th><th>ç”³è«‹é …ç›®</th><th>ç”³è«‹æ™‚é–“</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
    </div>

  </div>

  <script>
    const supabaseClient = supabase.createClient(
      'https://qznvabjtxcbffjryfgqi.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bnZhYmp0eGNiZmZqcnlmZ3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1Nzc2NzUsImV4cCI6MjA4NzE1MzY3NX0.chreegQgxCJI4cZcvwsED8Cvh7XJ-E0P7G_wzpVMe6k'
    );

    let fullMonitorData = []; 

    function formatTaipeiTime(dateString) {
      if (!dateString) return '-';
      const options = { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      return new Date(dateString).toLocaleString('zh-TW', options);
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('panel-' + id).classList.add('active');
      btn.classList.add('active');
      
      if (id === 'esg') loadESG(); 
      if (id === 'stats') loadStats(); 
      if (id === 'monitor') { loadMonitor(); loadAlgorithmParams(); }
      if (id === 'push') loadPushRules();
      if (id === 'uid') loadUIDs(); 
      if (id === 'crm') loadCRM(); 
      if (id === 'garage') loadGarages(); 
      if (id === 'rewards') loadRewards();
      if (id === 'dispatch') { 
          resetScanState();
          setTimeout(() => document.getElementById('scan-uid-input').focus(), 100);
      } else {
          stopCamera();
      }
    }

    // ==========================================
    // ğŸŒŸ å…¨æ–°é€²åŒ–ï¼šé ‚ç´š CRM èˆ‡å±¥æ­·ç®¡ç†
    // ==========================================
    let fullCrmUsers = [];

    async function loadCRM() {
      // 1. æŠ“å–æ‰€æœ‰å®¢æˆ¶åŸºæœ¬è³‡æ–™
      const { data: users } = await supabaseClient.from('users').select('*').eq('role', 'customer').order('created_at', { ascending: false });
      if (!users) return;
      fullCrmUsers = users;

      // 2. æŠ“å–æ¿¾ç¶²å‡ºè²¨/å•Ÿç”¨æ¬¡æ•¸ (è¨ˆç®—è³¼è²·æ¬¡æ•¸)
      const { data: filters } = await supabaseClient.from('filters_uid').select('activated_by_uid');
      let pCounts = {};
      if (filters) {
          filters.forEach(f => {
              if (f.activated_by_uid) pCounts[f.activated_by_uid] = (pCounts[f.activated_by_uid] || 0) + 1;
          });
      }

      // 3. å®‰å…¨æŠ“å–é ç´„ç´€éŒ„ (è‹¥ç„¡è³‡æ–™è¡¨å‰‡é˜²å‘†ç•¥é)
      let bCounts = {};
      try {
          const { data: bookings } = await supabaseClient.from('bookings').select('user_uid');
          if (bookings) bookings.forEach(b => { if(b.user_uid) bCounts[b.user_uid] = (bCounts[b.user_uid] || 0) + 1; });
      } catch(e) {}

      let html = '';
      users.forEach(u => {
          let actionBtn = u.is_blacklisted 
              ? `<button class="btn" style="width:100%;" onclick="toggleBlacklist('${u.line_uid}', false, 'users')">è§£é™¤é»‘å–®</button>` 
              : `<button class="btn btn-danger" style="width:100%;" onclick="toggleBlacklist('${u.line_uid}', true, 'users')">è¨­ç‚ºé»‘å–®</button>`;
          
          let fullAddress = `${u.city || ''}${u.district || ''}${u.address || ''}`;
          if (!fullAddress) fullAddress = '<span style="color:#aaa;">æœªå¡«å¯«</span>';
          
          let joinDate = formatTaipeiTime(u.created_at);
          let pCount = pCounts[u.line_uid] || 0;
          let bCount = bCounts[u.line_uid] || 0;
          
          // è©•åƒ¹é‚è¼¯ï¼šæœ‰è³¼è²·çš„é è¨­çµ¦äºˆå„ªè‰¯è©•åƒ¹é«”é©—ï¼Œç„¡è³¼è²·é¡¯ç¤ºç„¡è©•åƒ¹
          let rating = pCount > 0 ? '<span style="color:#FF9800;">â­â­â­â­â­ (5.0)</span>' : '<span style="color:#aaa;">å°šç„¡è©•åƒ¹</span>'; 
          
          let mileage = u.yearly_mileage ? `${u.yearly_mileage} km/å¹´` : '<span style="color:#aaa;">æœªå¡«</span>';
          let genderStr = u.gender === 'M' ? 'ç”·' : (u.gender === 'F' ? 'å¥³' : 'æœªçŸ¥');

          html += `<tr>
            <td>
              <div style="font-weight:bold; font-size:16px; color:#1976d2; margin-bottom:4px;">${u.name} <span style="font-size:12px; color:#666; font-weight:normal;">(${genderStr})</span></div>
              <div style="font-family:monospace; color:#444; font-size:13px;">${u.phone}</div>
              <div style="font-size:12px; color:#888; margin-top:6px; font-family:monospace;">ğŸ“¥ è¨»å†Š: ${joinDate}</div>
            </td>
            <td>
              <div style="font-weight:bold; color:#333; margin-bottom:4px;">${u.car_brand || '-'} ${u.car_model || '-'}</div>
              <div style="font-family:monospace; color:#FF9800; font-weight:bold; font-size:15px;">${u.license_plate || 'æœªç¶å®šè»Šç‰Œ'}</div>
              <div style="font-size:12px; color:#666; margin-top:6px;">é‡Œç¨‹: ${mileage}</div>
            </td>
            <td style="font-size:13px; color:#444; max-width:200px;">${fullAddress}</td>
            <td>
              <div style="font-size:13px; margin-bottom:4px;">ğŸ›’ è³¼è²·/å•Ÿç”¨: <strong style="color:#00D100; font-size:15px;">${pCount}</strong> æ¬¡</div>
              <div style="font-size:13px; margin-bottom:4px;">ğŸ“ é ç´„å®‰è£: <strong style="color:#1976d2; font-size:15px;">${bCount}</strong> æ¬¡</div>
              <div style="font-size:12px; margin-top:8px;">ğŸ’¬ è©•åƒ¹: ${rating}</div>
            </td>
            <td style="text-align:center; width:100px;">
              ${u.is_blacklisted ? '<span style="color:red; font-weight:bold; font-size:12px; display:block; margin-bottom:8px;">ğŸ”´ é»‘åå–®</span>' : '<span style="color:green; font-size:12px; font-weight:bold; display:block; margin-bottom:8px;">ğŸŸ¢ æ­£å¸¸ç‹€æ…‹</span>'}
              ${actionBtn}
              <button class="btn" style="background:#444; color:#fff; margin-top:8px; font-size:12px; width:100%;" onclick="showCustomerDetails('${u.line_uid}')">ğŸ“„ å®Œæ•´å±¥æ­·</button>
            </td>
          </tr>`; 
      }); 
      document.getElementById('crm-table').querySelector('tbody').innerHTML = html;
    }

    // å±•é–‹å®¢æˆ¶å®Œæ•´å±¥æ­·è¦–çª—
    function showCustomerDetails(uid) {
        const u = fullCrmUsers.find(x => x.line_uid === uid);
        if(!u) return;
        
        let joinDate = formatTaipeiTime(u.created_at);
        let gender = u.gender === 'M' ? 'ç”·æ€§' : (u.gender === 'F' ? 'å¥³æ€§' : 'æœªå¡«å¯«');
        
        let html = `
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background:#f4f6f8; padding:15px; border-radius:8px; border:1px solid #e0e0e0;">
                    <h4 style="margin-top:0; color:#1976d2; border-bottom:1px solid #ccc; padding-bottom:8px; margin-bottom:12px;">ğŸ‘¤ åŸºæœ¬è¯çµ¡è³‡è¨Š</h4>
                    <p style="margin:8px 0;"><b>å§“åï¼š</b> ${u.name}</p>
                    <p style="margin:8px 0;"><b>æ€§åˆ¥ï¼š</b> ${gender}</p>
                    <p style="margin:8px 0;"><b>é›»è©±ï¼š</b> <span style="font-family:monospace; font-weight:bold;">${u.phone}</span></p>
                    <p style="margin:8px 0;"><b>ä¿¡ç®±ï¼š</b> ${u.email || '<span style="color:#aaa;">æœªæä¾›</span>'}</p>
                    <p style="margin:8px 0;"><b>è¨»å†Šæ™‚é–“ï¼š</b> <br><span style="font-size:13px; color:#666;">${joinDate}</span></p>
                    <p style="margin:8px 0;"><b>å®Œæ•´åœ°å€ï¼š</b> <br><span style="font-size:13px;">${u.city || ''}${u.district || ''}${u.address || '<span style="color:#aaa;">æœªæä¾›</span>'}</span></p>
                </div>
                <div style="background:#fffaf0; padding:15px; border-radius:8px; border:1px solid #ffe0b2;">
                    <h4 style="margin-top:0; color:#e65100; border-bottom:1px solid #ffe0b2; padding-bottom:8px; margin-bottom:12px;">ğŸš— æ„›è»Šå°ˆå±¬æ•¸æ“š</h4>
                    <p style="margin:8px 0;"><b>å“ç‰Œï¼š</b> ${u.car_brand || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>è»Šå‹ï¼š</b> ${u.car_model || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>è»Šç‰Œè™Ÿç¢¼ï¼š</b> <br><span style="font-family:monospace; font-weight:bold; font-size:18px; color:#e65100;">${u.license_plate || 'æœªç¶å®š'}</span></p>
                    <p style="margin:8px 0;"><b>å‡ºå» å¹´ä»½ï¼š</b> ${u.car_year || '<span style="color:#aaa;">æœªå¡«å¯«</span>'}</p>
                    <p style="margin:8px 0;"><b>å¹´å‡é‡Œç¨‹è¨­å®šï¼š</b> <br><span style="font-weight:bold; color:#d32f2f;">${u.yearly_mileage ? u.yearly_mileage + ' å…¬é‡Œ
